<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="索引" href="../../genindex.html" /><link rel="search" title="搜索" href="../../search.html" /><link rel="copyright" title="版权所有" href="../../copyright.html" />

    <link rel="shortcut icon" href="../../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>celery.canvas - Celery 5.5.1 文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=3ee1c6c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/my.css?v=112ca36d" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">Celery 5.5.1 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/celery_512_1.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Celery 5.5.1 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../copyright.html">版权</a></li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../getting-started/index.html">快速开始</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 快速开始</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/introduction.html">Celery 简介</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../getting-started/backends-and-brokers/index.html">Backends 和 Brokers</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Backends 和 Brokers</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../getting-started/backends-and-brokers/rabbitmq.html">使用 RabbitMQ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../getting-started/backends-and-brokers/redis.html">使用 Redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../getting-started/backends-and-brokers/sqs.html">使用 Amazon SQS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../getting-started/backends-and-brokers/kafka.html">使用 Kafka</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../getting-started/backends-and-brokers/gcpubsub.html">使用 Google Pub/Sub</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/first-steps-with-celery.html">使用 Celery 的第一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/next-steps.html">下一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/resources.html">资源</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../userguide/index.html">用户指南</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 用户指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/application.html">应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/tasks.html">任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/calling.html">调用任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/canvas.html">Canvas：设计工作流</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/workers.html">Workers 指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/daemonizing.html">守护进程</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/periodic-tasks.html">周期性任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/routing.html">路由任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/monitoring.html">监控和管理指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/security.html">安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/optimizing.html">优化</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/debugging.html">调试</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../userguide/concurrency/index.html">并发</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 并发</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../userguide/concurrency/eventlet.html">Eventlet 并发</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../userguide/concurrency/gevent.html">gevent 并发</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/signals.html">信号</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/testing.html">使用 Celery 进行测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/extending.html">扩展 和 Bootsteps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/configuration.html">配置和默认值</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../userguide/sphinx.html">使用 Sphinx 文档化任务</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../django/index.html">Django</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Django</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../django/first-steps-with-django.html">使用 Django 的第一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community.html">社区资源</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorials/index.html">教程</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 教程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/task-cookbook.html">Task Cookbook</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">更改历史</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../reference/index.html">API 参考</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of API 参考</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../reference/cli.html">命令行接口</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">celery</span></code> --- Distributed processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.html">Proxies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.html#functions">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.task.html"><code class="docutils literal notranslate"><span class="pre">celery.app.task</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.amqp.html">AMQP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.amqp.html#queues">Queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.defaults.html"><code class="docutils literal notranslate"><span class="pre">celery.app.defaults</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.control.html"><code class="docutils literal notranslate"><span class="pre">celery.app.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.registry.html"><code class="docutils literal notranslate"><span class="pre">celery.app.registry</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.backends.html"><code class="docutils literal notranslate"><span class="pre">celery.app.backends</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.builtins.html"><code class="docutils literal notranslate"><span class="pre">celery.app.builtins</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.events.html"><code class="docutils literal notranslate"><span class="pre">celery.app.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.log.html"><code class="docutils literal notranslate"><span class="pre">celery.app.log</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.app.utils</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.app.autoretry.html"><code class="docutils literal notranslate"><span class="pre">celery.app.autoretry</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bootsteps.html"><code class="docutils literal notranslate"><span class="pre">celery.bootsteps</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.result.html"><code class="docutils literal notranslate"><span class="pre">celery.result</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.schedules.html"><code class="docutils literal notranslate"><span class="pre">celery.schedules</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.signals.html"><code class="docutils literal notranslate"><span class="pre">celery.signals</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.security.html"><code class="docutils literal notranslate"><span class="pre">celery.security</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.utils.debug.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.debug</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.exceptions.html"><code class="docutils literal notranslate"><span class="pre">celery.exceptions</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.loaders.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.loaders.app.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.app</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.loaders.default.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.default</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.loaders.base.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.base</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html">States</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html#sets">Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html#misc">Misc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html#celery.states.FAILURE"><code class="docutils literal notranslate"><span class="pre">FAILURE</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html#celery.states.PENDING"><code class="docutils literal notranslate"><span class="pre">PENDING</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html#celery.states.RECEIVED"><code class="docutils literal notranslate"><span class="pre">RECEIVED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html#celery.states.RETRY"><code class="docutils literal notranslate"><span class="pre">RETRY</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html#celery.states.REVOKED"><code class="docutils literal notranslate"><span class="pre">REVOKED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html#celery.states.STARTED"><code class="docutils literal notranslate"><span class="pre">STARTED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html#celery.states.SUCCESS"><code class="docutils literal notranslate"><span class="pre">SUCCESS</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html#celery.states.precedence"><code class="docutils literal notranslate"><span class="pre">precedence()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.states.html#celery.states.state"><code class="docutils literal notranslate"><span class="pre">state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.contrib.abortable.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.abortable</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.contrib.django.task.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.django.task</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.contrib.migrate.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.migrate</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.contrib.pytest.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.pytest</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.contrib.sphinx.html">celery.contrib.sphinx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.contrib.testing.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.contrib.testing.app.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.app</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.contrib.testing.manager.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.manager</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.contrib.testing.mocks.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.mocks</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.contrib.rdb.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.rdb</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.events.html"><code class="docutils literal notranslate"><span class="pre">celery.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.events.receiver.html"><code class="docutils literal notranslate"><span class="pre">celery.events.receiver</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.events.dispatcher.html"><code class="docutils literal notranslate"><span class="pre">celery.events.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.events.event.html"><code class="docutils literal notranslate"><span class="pre">celery.events.event</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.events.state.html"><code class="docutils literal notranslate"><span class="pre">celery.events.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.apps.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.apps.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.apps.multi.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.multi</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.request.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.request</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.state.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.strategy.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.strategy</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.consumer.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.consumer.agent.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.agent</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.consumer.connection.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.connection</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.consumer.consumer.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.consumer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.consumer.control.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.consumer.events.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.consumer.gossip.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.gossip</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.consumer.heart.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.heart</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.consumer.mingle.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.mingle</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.consumer.tasks.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.tasks</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.worker.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.base.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.base</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.celery.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.celery</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.events.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.logtool.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.logtool</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.amqp.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.amqp</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.graph.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.graph</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.multi.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.multi</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.call.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.call</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.control.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.list.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.list</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.migrate.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.migrate</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.purge.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.purge</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.result.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.result</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.shell.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.shell</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/celery.bin.upgrade.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.upgrade</span></code></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../internals/index.html">内部</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of 内部</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../internals/guide.html">代码贡献指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internals/deprecation.html">Celery 弃用时间表</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internals/worker.html">内部的 worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internals/protocol.html">消息协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../internals/app-overview.html">“大实例”重构</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../internals/reference/index.html">内部模块参考</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 内部模块参考</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.worker.components.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.components</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.worker.loops.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.loops</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.worker.heartbeat.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.heartbeat</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.worker.control.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.control</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.worker.pidbox.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.pidbox</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.worker.autoscale.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.autoscale</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.concurrency.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.concurrency.solo.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.solo</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.concurrency.prefork.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.prefork</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.concurrency.eventlet.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.eventlet</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.concurrency.gevent.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.gevent</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.concurrency.thread.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.thread</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.concurrency.base.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.base</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.html"><code class="docutils literal notranslate"><span class="pre">celery.backends</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.base.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.base</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.asynchronous.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.asynchronous</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.azureblockblob.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.azureblockblob</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.rpc.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.rpc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.database.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.cache.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cache</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.consul.html">celery.backends.consul</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.couchdb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.couchdb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.mongodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.mongodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.elasticsearch.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.elasticsearch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.redis.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.redis</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.cassandra.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cassandra</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.couchbase.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.couchbase</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.arangodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.arangodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.dynamodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.dynamodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.filesystem.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.filesystem</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.cosmosdbsql.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cosmosdbsql</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.s3.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.s3</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.gcs.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.gcs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.app.trace.html"><code class="docutils literal notranslate"><span class="pre">celery.app.trace</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.app.annotations.html"><code class="docutils literal notranslate"><span class="pre">celery.app.annotations</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.app.routes.html"><code class="docutils literal notranslate"><span class="pre">celery.app.routes</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.security.certificate.html"><code class="docutils literal notranslate"><span class="pre">celery.security.certificate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.security.key.html"><code class="docutils literal notranslate"><span class="pre">celery.security.key</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.security.serialization.html"><code class="docutils literal notranslate"><span class="pre">celery.security.serialization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.security.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.security.utils</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.events.snapshot.html"><code class="docutils literal notranslate"><span class="pre">celery.events.snapshot</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.events.cursesmon.html"><code class="docutils literal notranslate"><span class="pre">celery.events.cursesmon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.events.dumper.html"><code class="docutils literal notranslate"><span class="pre">celery.events.dumper</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.database.models.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database.models</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.backends.database.session.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database.session</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.utils</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.abstract.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.abstract</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.collections.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.collections</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.nodenames.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.nodenames</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.deprecated.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.deprecated</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.functional.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.functional</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.graph.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.graph</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.objects.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.objects</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.term.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.term</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.time.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.time</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.iso8601.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.iso8601</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.saferepr.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.saferepr</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.serialization.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.serialization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.sysinfo.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.sysinfo</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.threads.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.threads</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.timer2.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.timer2</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.imports.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.imports</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.log.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.text.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.text</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.dispatch.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.dispatch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.utils.dispatch.signal.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.dispatch.signal</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery.platforms.html"><code class="docutils literal notranslate"><span class="pre">celery.platforms</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../internals/reference/celery._state.html"><code class="docutils literal notranslate"><span class="pre">celery._state</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../history/index.html">历史</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of 历史</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-5.5.html">What's new in Celery 5.5 (Immunity)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-5.5.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-5.4.html">What's new in Celery 5.4 (Opalescent)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-5.4.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-5.3.html">What's new in Celery 5.3 (Emerald Rush)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-5.3.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-5.1.html">What's new in Celery 5.1 (Sun Harmonics)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-5.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-5.0.html">What's new in Celery 5.0 (singularity)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-5.0.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-4.4.html">What's new in Celery 4.4 (Cliffs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-4.4.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-4.3.html">What's new in Celery 4.3 (rhubarb)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-4.3.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-4.2.html">What's new in Celery 4.2 (windowlicker)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-4.2.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-4.1.html">What's new in Celery 4.1 (latentcall)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-4.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-4.0.html">What's new in Celery 4.0 (latentcall)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-4.0.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-3.1.html">What's new in Celery 3.1 (Cipater)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-3.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-3.0.html">What's new in Celery 3.0 (Chiastic Slide)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-3.0.html">Change history for Celery 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/whatsnew-2.5.html">What's new in Celery 2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-2.5.html">Change history for Celery 2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-2.4.html">Change history for Celery 2.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-2.3.html">Change history for Celery 2.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-2.2.html">Change history for Celery 2.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-2.1.html">Change history for Celery 2.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-2.0.html">Change history for Celery 2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../history/changelog-1.0.html">Change history for Celery 1.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">术语</a></li>
</ul>

</div>
<!-- <iframe src="https://ghbtns.com/github-btn.html?user=celery&repo=celery&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe> -->
<div id="donate">
  <h5>捐赠</h5>
  <p>请捐赠以支持这个社区项目</p>
  <a href="https://opencollective.com/celery/donate" target="_blank">
    <!-- <img src="https://opencollective.com/celery/donate/button@2x.png?color=blue" /> -->
    <img src="https://opencollective.com/celery/donate/button.png?color=blue" />
  </a>
</div></div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>celery.canvas 源代码</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Composing task work-flows.</span>

<span class="sd">.. seealso:</span>

<span class="sd">    You should import these from :mod:`celery` and not this module.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">MutableSequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span> <span class="k">as</span> <span class="n">_partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">operator</span><span class="w"> </span><span class="kn">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">GeneratorType</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">kombu.utils.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">fxrange</span><span class="p">,</span> <span class="n">reprcall</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">kombu.utils.objects</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">kombu.utils.uuid</span><span class="w"> </span><span class="kn">import</span> <span class="n">uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vine</span><span class="w"> </span><span class="kn">import</span> <span class="n">barrier</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">celery._state</span><span class="w"> </span><span class="kn">import</span> <span class="n">current_app</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">CPendingDeprecationWarning</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.result</span><span class="w"> </span><span class="kn">import</span> <span class="n">GroupResult</span><span class="p">,</span> <span class="n">allow_join_result</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">abstract</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.utils.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChainMap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.utils.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">_regen</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.utils.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">chunks</span> <span class="k">as</span> <span class="n">_chunks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.utils.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_list</span><span class="p">,</span> <span class="n">maybe_list</span><span class="p">,</span> <span class="n">regen</span><span class="p">,</span> <span class="n">seq_concat_item</span><span class="p">,</span> <span class="n">seq_concat_seq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.utils.objects</span><span class="w"> </span><span class="kn">import</span> <span class="n">getitem_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.utils.text</span><span class="w"> </span><span class="kn">import</span> <span class="n">remove_repeating_from_task</span><span class="p">,</span> <span class="n">truncate</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;Signature&#39;</span><span class="p">,</span> <span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="s1">&#39;xmap&#39;</span><span class="p">,</span> <span class="s1">&#39;xstarmap&#39;</span><span class="p">,</span> <span class="s1">&#39;chunks&#39;</span><span class="p">,</span>
    <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;chord&#39;</span><span class="p">,</span> <span class="s1">&#39;signature&#39;</span><span class="p">,</span> <span class="s1">&#39;maybe_signature&#39;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">maybe_unroll_group</span><span class="p">(</span><span class="n">group</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Unroll group with only one member.</span>
<span class="sd">    This allows treating a group of a single task as if it</span>
<span class="sd">    was a single task without pre-knowledge.&quot;&quot;&quot;</span>
    <span class="c1"># Issue #1656</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="fm">__length_hint__</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">group</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">tasks</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">group</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">group</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">group</span>


<span class="k">def</span><span class="w"> </span><span class="nf">task_name_from</span><span class="p">(</span><span class="n">task</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_stamp_regen_task</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;When stamping a sequence of tasks created by a generator,</span>
<span class="sd">    we use this function to stamp each task in the generator</span>
<span class="sd">    without exhausting it.&quot;&quot;&quot;</span>

    <span class="n">task</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">task</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_merge_dictionaries</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">aggregate_duplicates</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge two dictionaries recursively into the first one.</span>

<span class="sd">    Example:</span>
<span class="sd">    &gt;&gt;&gt; d1 = {&#39;dict&#39;: {&#39;a&#39;: 1}, &#39;list&#39;: [1, 2], &#39;tuple&#39;: (1, 2)}</span>
<span class="sd">    &gt;&gt;&gt; d2 = {&#39;dict&#39;: {&#39;b&#39;: 2}, &#39;list&#39;: [3, 4], &#39;set&#39;: {&#39;a&#39;, &#39;b&#39;}}</span>
<span class="sd">    &gt;&gt;&gt; _merge_dictionaries(d1, d2)</span>

<span class="sd">    d1 will be modified to: {</span>
<span class="sd">        &#39;dict&#39;: {&#39;a&#39;: 1, &#39;b&#39;: 2},</span>
<span class="sd">        &#39;list&#39;: [1, 2, 3, 4],</span>
<span class="sd">        &#39;tuple&#39;: (1, 2),</span>
<span class="sd">        &#39;set&#39;: {&#39;a&#39;, &#39;b&#39;}</span>
<span class="sd">    }</span>

<span class="sd">    Arguments:</span>
<span class="sd">        d1 (dict): Dictionary to merge into.</span>
<span class="sd">        d2 (dict): Dictionary to merge from.</span>
<span class="sd">        aggregate_duplicates (bool):</span>
<span class="sd">            If True, aggregate duplicated items (by key) into a list of all values in d1 in the same key.</span>
<span class="sd">            If False, duplicate keys will be taken from d2 and override the value in d1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">d2</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">_merge_dictionaries</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="k">if</span> <span class="n">aggregate_duplicates</span> <span class="k">else</span> <span class="n">value</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">aggregate_duplicates</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d2</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">d2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d1</span><span class="p">:</span>
            <span class="n">d1</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">class</span><span class="w"> </span><span class="nc">StampingVisitor</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stamping API.  A class that provides a stamping API possibility for</span>
<span class="sd">    canvas primitives. If you want to implement stamping behavior for</span>
<span class="sd">    a canvas primitive override method that represents it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_group_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that is called on group stamping start.</span>

<span class="sd">         Arguments:</span>
<span class="sd">             group (group): Group that is stamped.</span>
<span class="sd">             headers (Dict): Partial headers that could be merged with existing headers.</span>
<span class="sd">         Returns:</span>
<span class="sd">             Dict: headers to update.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_group_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that is called on group stamping end.</span>

<span class="sd">         Arguments:</span>
<span class="sd">             group (group): Group that is stamped.</span>
<span class="sd">             headers (Dict): Partial headers that could be merged with existing headers.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_chain_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that is called on chain stamping start.</span>

<span class="sd">         Arguments:</span>
<span class="sd">             chain (chain): Chain that is stamped.</span>
<span class="sd">             headers (Dict): Partial headers that could be merged with existing headers.</span>
<span class="sd">         Returns:</span>
<span class="sd">             Dict: headers to update.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_chain_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that is called on chain stamping end.</span>

<span class="sd">         Arguments:</span>
<span class="sd">             chain (chain): Chain that is stamped.</span>
<span class="sd">             headers (Dict): Partial headers that could be merged with existing headers.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that is called on signature stamping.</span>

<span class="sd">         Arguments:</span>
<span class="sd">             sig (Signature): Signature that is stamped.</span>
<span class="sd">             headers (Dict): Partial headers that could be merged with existing headers.</span>
<span class="sd">         Returns:</span>
<span class="sd">             Dict: headers to update.</span>
<span class="sd">         &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_chord_header_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that is called on сhord header stamping start.</span>

<span class="sd">         Arguments:</span>
<span class="sd">             sig (chord): chord that is stamped.</span>
<span class="sd">             headers (Dict): Partial headers that could be merged with existing headers.</span>
<span class="sd">         Returns:</span>
<span class="sd">             Dict: headers to update.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
            <span class="n">sig</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_group_start</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_chord_header_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that is called on сhord header stamping end.</span>

<span class="sd">           Arguments:</span>
<span class="sd">               sig (chord): chord that is stamped.</span>
<span class="sd">               headers (Dict): Partial headers that could be merged with existing headers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_group_end</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_chord_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that is called on chord body stamping.</span>

<span class="sd">         Arguments:</span>
<span class="sd">             sig (chord): chord that is stamped.</span>
<span class="sd">             headers (Dict): Partial headers that could be merged with existing headers.</span>
<span class="sd">         Returns:</span>
<span class="sd">             Dict: headers to update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that is called on callback stamping.</span>

<span class="sd">         Arguments:</span>
<span class="sd">             callback (Signature): callback that is stamped.</span>
<span class="sd">             headers (Dict): Partial headers that could be merged with existing headers.</span>
<span class="sd">         Returns:</span>
<span class="sd">             Dict: headers to update.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_errback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errback</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method that is called on errback stamping.</span>

<span class="sd">         Arguments:</span>
<span class="sd">             errback (Signature): errback that is stamped.</span>
<span class="sd">             headers (Dict): Partial headers that could be merged with existing headers.</span>
<span class="sd">         Returns:</span>
<span class="sd">             Dict: headers to update.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>


<div class="viewcode-block" id="Signature">
<a class="viewcode-back" href="../../reference/celery.html#celery.Signature">[文档]</a>
<span class="nd">@abstract</span><span class="o">.</span><span class="n">CallableSignature</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Signature</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Task Signature.</span>

<span class="sd">    Class that wraps the arguments and execution options</span>
<span class="sd">    for a single task invocation.</span>

<span class="sd">    Used as the parts in a :class:`group` and other constructs,</span>
<span class="sd">    or to pass tasks around as callbacks while being compatible</span>
<span class="sd">    with serializers with a strict type subset.</span>

<span class="sd">    Signatures can also be created from tasks:</span>

<span class="sd">    - Using the ``.signature()`` method that has the same signature</span>
<span class="sd">      as ``Task.apply_async``:</span>

<span class="sd">        .. code-block:: pycon</span>

<span class="sd">            &gt;&gt;&gt; add.signature(args=(1,), kwargs={&#39;kw&#39;: 2}, options={})</span>

<span class="sd">    - or the ``.s()`` shortcut that works for star arguments:</span>

<span class="sd">        .. code-block:: pycon</span>

<span class="sd">            &gt;&gt;&gt; add.s(1, kw=2)</span>

<span class="sd">    - the ``.s()`` shortcut does not allow you to specify execution options</span>
<span class="sd">      but there&#39;s a chaining `.set` method that returns the signature:</span>

<span class="sd">        .. code-block:: pycon</span>

<span class="sd">            &gt;&gt;&gt; add.s(2, 2).set(countdown=10).set(expires=30).delay()</span>

<span class="sd">    Note:</span>
<span class="sd">        You should use :func:`~celery.signature` to create new signatures.</span>
<span class="sd">        The ``Signature`` class is the type returned by that function and</span>
<span class="sd">        should be used for ``isinstance`` checks for signatures.</span>

<span class="sd">    See Also:</span>
<span class="sd">        :ref:`guide-canvas` for the complete guide.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        task (Union[Type[celery.app.task.Task], str]): Either a task</span>
<span class="sd">            class/instance, or the name of a task.</span>
<span class="sd">        args (Tuple): Positional arguments to apply.</span>
<span class="sd">        kwargs (Dict): Keyword arguments to apply.</span>
<span class="sd">        options (Dict): Additional options to :meth:`Task.apply_async`.</span>

<span class="sd">    Note:</span>
<span class="sd">        If the first argument is a :class:`dict`, the other</span>
<span class="sd">        arguments will be ignored and the values in the dict will be used</span>
<span class="sd">        instead::</span>

<span class="sd">            &gt;&gt;&gt; s = signature(&#39;tasks.add&#39;, args=(2, 2))</span>
<span class="sd">            &gt;&gt;&gt; signature(s)</span>
<span class="sd">            {&#39;task&#39;: &#39;tasks.add&#39;, args=(2, 2), kwargs={}, options={}}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">TYPES</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_app</span> <span class="o">=</span> <span class="n">_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># The following fields must not be changed during freezing/merging because</span>
    <span class="c1"># to do so would disrupt completion of parent tasks</span>
    <span class="n">_IMMUTABLE_OPTIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;group_id&quot;</span><span class="p">,</span> <span class="s2">&quot;stamped_headers&quot;</span><span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a new type of signature.</span>
<span class="sd">        Used as a class decorator, for example:</span>
<span class="sd">        &gt;&gt;&gt; @Signature.register_type()</span>
<span class="sd">        &gt;&gt;&gt; class mysig(Signature):</span>
<span class="sd">        &gt;&gt;&gt;     pass</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_inner</span><span class="p">(</span><span class="n">subclass</span><span class="p">):</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">TYPES</span><span class="p">[</span><span class="n">name</span> <span class="ow">or</span> <span class="n">subclass</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">subclass</span>
            <span class="k">return</span> <span class="n">subclass</span>

        <span class="k">return</span> <span class="n">_inner</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new signature from a dict.</span>
<span class="sd">        Subclasses can override this method to customize how are</span>
<span class="sd">        they created from a dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subtask_type&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">typ</span><span class="p">:</span>
            <span class="n">target_cls</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TYPES</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">target_cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">target_cls</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Signature</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subtask_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">immutable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">ex</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span> <span class="o">=</span> <span class="n">app</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>  <span class="c1"># works like dict(d)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Also supports using task class/instance instead of string name.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">task_name</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">name</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">task_name</span> <span class="o">=</span> <span class="n">task</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="n">task</span>

            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
                <span class="n">task</span><span class="o">=</span><span class="n">task_name</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="p">()),</span>
                <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span> <span class="ow">or</span> <span class="p">{},</span>
                <span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">options</span> <span class="ow">or</span> <span class="p">{},</span> <span class="o">**</span><span class="n">ex</span><span class="p">),</span>
                <span class="n">subtask_type</span><span class="o">=</span><span class="n">subtask_type</span><span class="p">,</span>
                <span class="n">immutable</span><span class="o">=</span><span class="n">immutable</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">partial_args</span><span class="p">,</span> <span class="o">**</span><span class="n">partial_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call the task directly (in the current process).&quot;&quot;&quot;</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge</span><span class="p">(</span><span class="n">partial_args</span><span class="p">,</span> <span class="n">partial_kwargs</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">partial_args</span><span class="p">,</span> <span class="o">**</span><span class="n">partial_kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shortcut to :meth:`apply_async` using star arguments.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">partial_args</span><span class="p">,</span> <span class="n">partial_kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Call task locally.</span>

<span class="sd">        Same as :meth:`apply_async` but executed the task inline instead</span>
<span class="sd">        of sending a task message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="c1"># Extra options set to None are dismissed</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        <span class="c1"># For callbacks: extra args are prepended to the stored args.</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply this task asynchronously.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            args (Tuple): Partial args to be prepended to the existing args.</span>
<span class="sd">            kwargs (Dict): Partial kwargs to be merged with existing kwargs.</span>
<span class="sd">            options (Dict): Partial options to be merged</span>
<span class="sd">                with existing options.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ~@AsyncResult: promise of future evaluation.</span>

<span class="sd">        See also:</span>
<span class="sd">            :meth:`~@Task.apply_async` and the :ref:`guide-calling` guide.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="c1"># Extra options set to None are dismissed</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_apply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_async</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="c1"># no tasks for chain, etc to find type</span>
            <span class="k">return</span>
        <span class="c1"># For callbacks: extra args are prepended to the stored args.</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="c1"># pylint: disable=too-many-function-args</span>
        <span class="c1">#   Works on this, as it&#39;s a property</span>
        <span class="k">return</span> <span class="n">_apply</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Merge partial args/kwargs/options with existing ones.</span>

<span class="sd">        If the signature is immutable and ``force`` is False, the existing</span>
<span class="sd">        args/kwargs will be returned as-is and only the options will be merged.</span>

<span class="sd">        Stamped headers are considered immutable and will not be merged regardless.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            args (Tuple): Partial args to be prepended to the existing args.</span>
<span class="sd">            kwargs (Dict): Partial kwargs to be merged with existing kwargs.</span>
<span class="sd">            options (Dict): Partial options to be merged with existing options.</span>
<span class="sd">            force (bool): If True, the args/kwargs will be merged even if the signature is</span>
<span class="sd">                immutable. The stamped headers are not affected by this option and will not</span>
<span class="sd">                be merged regardless.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple: (args, kwargs, options)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We build a new options dictionary where values in `options`</span>
            <span class="c1"># override values in `self.options` except for keys which are</span>
            <span class="c1"># noted as being immutable (unrelated to signature immutability)</span>
            <span class="c1"># implying that allowing their value to change would stall tasks</span>
            <span class="n">immutable_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IMMUTABLE_OPTIONS</span>
            <span class="k">if</span> <span class="s2">&quot;stamped_headers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
                <span class="n">immutable_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IMMUTABLE_OPTIONS</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stamped_headers&quot;</span><span class="p">,</span> <span class="p">[])))</span>
            <span class="c1"># merge self.options with options without overriding stamped headers from self.options</span>
            <span class="n">new_options</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">immutable_options</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
            <span class="p">}}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">immutable</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">new_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="n">new_options</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a copy of this signature.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            args (Tuple): Partial args to be prepended to the existing args.</span>
<span class="sd">            kwargs (Dict): Partial kwargs to be merged with existing kwargs.</span>
<span class="sd">            options (Dict): Partial options to be merged with</span>
<span class="sd">                existing options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="c1"># need to deepcopy options so origins links etc. is not modified.</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">Signature</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span>
                                         <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">),</span>
                                         <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">,</span>
                                         <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">opts</span><span class="p">),</span>
                                         <span class="s1">&#39;subtask_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtask_type</span><span class="p">,</span>
                                         <span class="s1">&#39;immutable&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">immutable</span><span class="p">},</span>
                                        <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span>
        <span class="n">signature</span><span class="o">.</span><span class="n">_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span>
        <span class="k">return</span> <span class="n">signature</span>

    <span class="n">partial</span> <span class="o">=</span> <span class="n">clone</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">freeze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">root_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finalize the signature by adding a concrete task id.</span>

<span class="sd">        The task won&#39;t be called and you shouldn&#39;t call the signature</span>
<span class="sd">        twice after freezing it as that&#39;ll result in two task messages</span>
<span class="sd">        using the same task id.</span>

<span class="sd">        The arguments are used to override the signature&#39;s headers during</span>
<span class="sd">        freezing.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            _id (str): Task id to use if it didn&#39;t already have one.</span>
<span class="sd">                New UUID is generated if not provided.</span>
<span class="sd">            group_id (str): Group id to use if it didn&#39;t already have one.</span>
<span class="sd">            chord (Signature): Chord body when freezing a chord header.</span>
<span class="sd">            root_id (str): Root id to use.</span>
<span class="sd">            parent_id (str): Parent id to use.</span>
<span class="sd">            group_index (int): Group index to use.</span>

<span class="sd">        Returns:</span>
<span class="sd">            ~@AsyncResult: promise of future evaluation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=redefined-outer-name</span>
        <span class="c1">#   XXX chord is also a class in outer scope.</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># if there is already an id for this task, return it</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># otherwise, use the _id sent to this function, falling back on a generated UUID</span>
            <span class="n">tid</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_id</span> <span class="ow">or</span> <span class="n">uuid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">root_id</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;root_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_id</span>
        <span class="k">if</span> <span class="n">parent_id</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_id</span>
        <span class="k">if</span> <span class="s1">&#39;reply_to&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="c1"># fall back on unique ID for this thread in the app</span>
            <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;reply_to&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">thread_oid</span>
        <span class="k">if</span> <span class="n">group_id</span> <span class="ow">and</span> <span class="s2">&quot;group_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_id</span>
        <span class="k">if</span> <span class="n">chord</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;chord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chord</span>
        <span class="k">if</span> <span class="n">group_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;group_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_index</span>
        <span class="c1"># pylint: disable=too-many-function-args</span>
        <span class="c1">#   Works on this, as it&#39;s a property.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">AsyncResult</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>

    <span class="n">_freeze</span> <span class="o">=</span> <span class="n">freeze</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Replace the args, kwargs or options set for this signature.</span>

<span class="sd">        These are only replaced if the argument for the section is</span>
<span class="sd">        not :const:`None`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signature</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signature</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">signature</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="k">return</span> <span class="n">signature</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">immutable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set arbitrary execution options (same as ``.options.update(…)``).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Signature: This is a chaining method call</span>
<span class="sd">                (i.e., it will return ``self``).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">immutable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_immutable</span><span class="p">(</span><span class="n">immutable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_immutable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">immutable</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">immutable</span> <span class="o">=</span> <span class="n">immutable</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_stamp_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor_headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append_stamps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">self_headers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect all stamps from visitor, headers and self,</span>
<span class="sd">        and return an idempotent dictionary of stamps.</span>

<span class="sd">        .. versionadded:: 5.3</span>

<span class="sd">        Arguments:</span>
<span class="sd">            visitor_headers (Dict): Stamps from a visitor method.</span>
<span class="sd">            append_stamps (bool):</span>
<span class="sd">                If True, duplicated stamps will be appended to a list.</span>
<span class="sd">                If False, duplicated stamps will be replaced by the last stamp.</span>
<span class="sd">            self_headers (bool):</span>
<span class="sd">                If True, stamps from self.options will be added.</span>
<span class="sd">                If False, stamps from self.options will be ignored.</span>
<span class="sd">            headers (Dict): Stamps that should be added to headers.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict: Merged stamps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use append_stamps=False to prioritize visitor_headers over headers in case of duplicated stamps.</span>
        <span class="c1"># This will lose duplicated headers from the headers argument, but that is the best effort solution</span>
        <span class="c1"># to avoid implicitly casting the duplicated stamp into a list of both stamps from headers and</span>
        <span class="c1"># visitor_headers of the same key.</span>
        <span class="c1"># Example:</span>
        <span class="c1">#   headers = {&quot;foo&quot;: &quot;bar1&quot;}</span>
        <span class="c1">#   visitor_headers = {&quot;foo&quot;: &quot;bar2&quot;}</span>
        <span class="c1">#   _merge_dictionaries(headers, visitor_headers, aggregate_duplicates=True)</span>
        <span class="c1">#   headers[&quot;foo&quot;] == [&quot;bar1&quot;, &quot;bar2&quot;] -&gt; The stamp is now a list</span>
        <span class="c1">#   _merge_dictionaries(headers, visitor_headers, aggregate_duplicates=False)</span>
        <span class="c1">#   headers[&quot;foo&quot;] == &quot;bar2&quot; -&gt; &quot;bar1&quot; is lost, but the stamp is according to the visitor</span>

        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;stamped_headers&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;stamped_headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Merge headers with visitor headers</span>
        <span class="k">if</span> <span class="n">visitor_headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visitor_headers</span> <span class="o">=</span> <span class="n">visitor_headers</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="s2">&quot;stamped_headers&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visitor_headers</span><span class="p">:</span>
                <span class="n">visitor_headers</span><span class="p">[</span><span class="s2">&quot;stamped_headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">visitor_headers</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># Sync from visitor</span>
            <span class="n">_merge_dictionaries</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">visitor_headers</span><span class="p">,</span> <span class="n">aggregate_duplicates</span><span class="o">=</span><span class="n">append_stamps</span><span class="p">)</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;stamped_headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;stamped_headers&quot;</span><span class="p">]))</span>

        <span class="c1"># Merge headers with self.options</span>
        <span class="k">if</span> <span class="n">self_headers</span><span class="p">:</span>
            <span class="n">stamped_headers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stamped_headers&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">stamped_headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stamped_headers&quot;</span><span class="p">,</span> <span class="p">[]))</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;stamped_headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stamped_headers</span><span class="p">)</span>
            <span class="c1"># Only merge stamps that are in stamped_headers from self.options</span>
            <span class="n">redacted_options</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;stamped_headers&quot;</span><span class="p">]}</span>

            <span class="c1"># Sync from self.options</span>
            <span class="n">_merge_dictionaries</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">redacted_options</span><span class="p">,</span> <span class="n">aggregate_duplicates</span><span class="o">=</span><span class="n">append_stamps</span><span class="p">)</span>
            <span class="n">headers</span><span class="p">[</span><span class="s2">&quot;stamped_headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;stamped_headers&quot;</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">headers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append_stamps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stamp this signature with additional custom headers.</span>
<span class="sd">        Using a visitor will pass on responsibility for the stamping</span>
<span class="sd">        to the visitor.</span>

<span class="sd">        .. versionadded:: 5.3</span>

<span class="sd">        Arguments:</span>
<span class="sd">            visitor (StampingVisitor): Visitor API object.</span>
<span class="sd">            append_stamps (bool):</span>
<span class="sd">                If True, duplicated stamps will be appended to a list.</span>
<span class="sd">                If False, duplicated stamps will be replaced by the last stamp.</span>
<span class="sd">            headers (Dict): Stamps that should be added to headers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stamp_links</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">visitor_headers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">visitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visitor_headers</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">on_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stamp_headers</span><span class="p">(</span><span class="n">visitor_headers</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stamp_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stamp this signature links (callbacks and errbacks).</span>
<span class="sd">        Using a visitor will pass on responsibility for the stamping</span>
<span class="sd">        to the visitor.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            visitor (StampingVisitor): Visitor API object.</span>
<span class="sd">            append_stamps (bool):</span>
<span class="sd">                If True, duplicated stamps will be appended to a list.</span>
<span class="sd">                If False, duplicated stamps will be replaced by the last stamp.</span>
<span class="sd">            headers (Dict): Stamps that should be added to headers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">non_visitor_headers</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># When we are stamping links, we want to avoid adding stamps from the linked signature itself</span>
        <span class="c1"># so we turn off self_headers to stamp the link only with the visitor and the headers.</span>
        <span class="c1"># If it&#39;s enabled, the link copies the stamps of the linked signature, and we don&#39;t want that.</span>
        <span class="n">self_headers</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Stamp all of the callbacks of this signature</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">non_visitor_headers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">maybe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">link</span> <span class="o">=</span> <span class="n">maybe_signature</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
            <span class="n">visitor_headers</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">visitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">visitor_headers</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">on_callback</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stamp_headers</span><span class="p">(</span>
                <span class="n">visitor_headers</span><span class="o">=</span><span class="n">visitor_headers</span><span class="p">,</span>
                <span class="n">append_stamps</span><span class="o">=</span><span class="n">append_stamps</span><span class="p">,</span>
                <span class="n">self_headers</span><span class="o">=</span><span class="n">self_headers</span><span class="p">,</span>
                <span class="o">**</span><span class="n">headers</span>
            <span class="p">)</span>
            <span class="n">link</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>

        <span class="c1"># Stamp all of the errbacks of this signature</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">non_visitor_headers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">maybe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link_error&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">link</span> <span class="o">=</span> <span class="n">maybe_signature</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
            <span class="n">visitor_headers</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">visitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">visitor_headers</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">on_errback</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stamp_headers</span><span class="p">(</span>
                <span class="n">visitor_headers</span><span class="o">=</span><span class="n">visitor_headers</span><span class="p">,</span>
                <span class="n">append_stamps</span><span class="o">=</span><span class="n">append_stamps</span><span class="p">,</span>
                <span class="n">self_headers</span><span class="o">=</span><span class="n">self_headers</span><span class="p">,</span>
                <span class="o">**</span><span class="n">headers</span>
            <span class="p">)</span>
            <span class="n">link</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_with_list_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the value at the given self.options[key] as a list.</span>

<span class="sd">        If the value is not a list, it will be converted to one and saved in self.options.</span>
<span class="sd">        If the key does not exist, an empty list will be set and returned instead.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            key (str): The key to get the value for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List: The value at the given key as a list or an empty list if the key does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">items</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">items</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">append_to_list_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Appends the given value to the list at the given key in self.options.&quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_with_list_option</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extend_list_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extends the list at the given key in self.options with the given value.</span>

<span class="sd">        If the value is not a list, it will be converted to one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_with_list_option</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">maybe_list</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add callback task to be applied if this task succeeds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Signature: the argument passed, for chaining</span>
<span class="sd">                or use with :func:`~functools.reduce`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_to_list_option</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">link_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add callback task to be applied on error in task execution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Signature: the argument passed, for chaining</span>
<span class="sd">                or use with :func:`~functools.reduce`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_to_list_option</span><span class="p">(</span><span class="s1">&#39;link_error&#39;</span><span class="p">,</span> <span class="n">errback</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Version of :meth:`link_error` that supports chaining.</span>

<span class="sd">        on_error chains the original signature, not the errback so::</span>

<span class="sd">            &gt;&gt;&gt; add.s(2, 2).on_error(errback.s()).delay()</span>

<span class="sd">        calls the ``add`` task, not the ``errback`` task, but the</span>
<span class="sd">        reverse is true for :meth:`link_error`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_error</span><span class="p">(</span><span class="n">errback</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">flatten_links</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a recursive list of dependencies.</span>

<span class="sd">        &quot;unchain&quot; if you will, but with links intact.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
            <span class="p">[[</span><span class="bp">self</span><span class="p">]],</span>
            <span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">flatten_links</span><span class="p">()</span>
             <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">maybe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Chaining operator.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; add.s(2, 2) | add.s(4) | add.s(8)</span>

<span class="sd">        Returns:</span>
<span class="sd">            chain: Constructs a :class:`~celery.canvas.chain` of the given signatures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_chain</span><span class="p">):</span>
            <span class="c1"># task | chain -&gt; chain</span>
            <span class="k">return</span> <span class="n">_chain</span><span class="p">(</span><span class="n">seq_concat_seq</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="p">,),</span> <span class="n">other</span><span class="o">.</span><span class="n">unchain_tasks</span><span class="p">()),</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
            <span class="c1"># unroll group with one member</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">maybe_unroll_group</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="c1"># task | group() -&gt; chain</span>
            <span class="k">return</span> <span class="n">_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Signature</span><span class="p">):</span>
            <span class="c1"># task | task -&gt; chain</span>
            <span class="k">return</span> <span class="n">_chain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__ior__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># Python 3.9 introduces | as the merge operator for dicts.</span>
        <span class="c1"># We override the in-place version of that operator</span>
        <span class="c1"># so that canvases continue to work as they did before.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__or__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">election</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
        <span class="n">app</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="n">app</span>
        <span class="n">tid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">uuid</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">producer_or_acquire</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="k">as</span> <span class="n">producer</span><span class="p">:</span>
            <span class="n">props</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">on_task_call</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">tid</span><span class="p">)</span>
            <span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">election</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="s1">&#39;task&#39;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="n">tid</span><span class="p">,</span> <span class="o">**</span><span class="n">props</span><span class="p">),</span>
                                 <span class="n">connection</span><span class="o">=</span><span class="n">producer</span><span class="o">.</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">type</span><span class="o">.</span><span class="n">AsyncResult</span><span class="p">(</span><span class="n">tid</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reprcall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string representation of the signature.</span>

<span class="sd">        Merges the given arguments with the signature&#39;s arguments</span>
<span class="sd">        only for the purpose of generating the string representation.</span>
<span class="sd">        The signature itself is not modified.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; add.s(2, 2).reprcall()</span>
<span class="sd">            &#39;add(2, 2)&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="p">{},</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reprcall</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">],</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># TODO: Potential bug of being a shallow copy</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__invert__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># for serialization, the task type is lazily loaded,</span>
        <span class="c1"># and not stored in the dict itself.</span>
        <span class="k">return</span> <span class="n">signature</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">),)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__json__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reprcall</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">k</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># for duck typing compatibility with Task.name</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_type</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]]</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span> <span class="ow">or</span> <span class="n">current_app</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">AsyncResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">AsyncResult</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># task not registered</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">AsyncResult</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">apply_async</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">send_task</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">])</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;options.task_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Task UUID&#39;</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;options.parent_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Task parent UUID.&#39;</span><span class="p">)</span>
    <span class="n">root_id</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;options.root_id&#39;</span><span class="p">,</span> <span class="s1">&#39;Task root UUID.&#39;</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="s1">&#39;Name of task.&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="s1">&#39;Positional arguments to task.&#39;</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;kwargs&#39;</span><span class="p">,</span> <span class="s1">&#39;Keyword arguments to task.&#39;</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="s1">&#39;Task execution options.&#39;</span><span class="p">)</span>
    <span class="n">subtask_type</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;subtask_type&#39;</span><span class="p">,</span> <span class="s1">&#39;Type of signature&#39;</span><span class="p">)</span>
    <span class="n">immutable</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span>
        <span class="s1">&#39;immutable&#39;</span><span class="p">,</span> <span class="s1">&#39;Flag set if no longer accepts new arguments&#39;</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_prepare_chain_from_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">use_link</span><span class="p">):</span>
    <span class="c1"># When we publish groups we reuse the same options dictionary for all of</span>
    <span class="c1"># the tasks in the group. See:</span>
    <span class="c1"># https://github.com/celery/celery/blob/fb37cb0b8/celery/canvas.py#L1022.</span>
    <span class="c1"># Issue #5354 reported that the following type of canvases</span>
    <span class="c1"># causes a Celery worker to hang:</span>
    <span class="c1"># group(</span>
    <span class="c1">#   add.s(1, 1),</span>
    <span class="c1">#   add.s(1, 1)</span>
    <span class="c1"># ) | tsum.s() | add.s(1) | group(add.s(1), add.s(1))</span>
    <span class="c1"># The resolution of #5354 in PR #5681 was to only set the `chain` key</span>
    <span class="c1"># in the options dictionary if it is not present.</span>
    <span class="c1"># Otherwise we extend the existing list of tasks in the chain with the new</span>
    <span class="c1"># tasks: options[&#39;chain&#39;].extend(chain_).</span>
    <span class="c1"># Before PR #5681 we overrode the `chain` key in each iteration</span>
    <span class="c1"># of the loop which applies all the tasks in the group:</span>
    <span class="c1"># options[&#39;chain&#39;] = tasks if not use_link else None</span>
    <span class="c1"># This caused Celery to execute chains correctly in most cases since</span>
    <span class="c1"># in each iteration the `chain` key would reset itself to a new value</span>
    <span class="c1"># and the side effect of mutating the key did not propagate</span>
    <span class="c1"># to the next task in the group.</span>
    <span class="c1"># Since we now mutated the `chain` key, a *list* which is passed</span>
    <span class="c1"># by *reference*, the next task in the group will extend the list</span>
    <span class="c1"># of tasks in the chain instead of setting a new one from the chain_</span>
    <span class="c1"># variable above.</span>
    <span class="c1"># This causes Celery to execute a chain, even though there might not be</span>
    <span class="c1"># one to begin with. Alternatively, it causes Celery to execute more tasks</span>
    <span class="c1"># that were previously present in the previous task in the group.</span>
    <span class="c1"># The solution is to be careful and never mutate the options dictionary</span>
    <span class="c1"># to begin with.</span>
    <span class="c1"># Here is an example of a canvas which triggers this issue:</span>
    <span class="c1"># add.s(5, 6) | group((add.s(1) | add.s(2), add.s(3))).</span>
    <span class="c1"># The expected result is [14, 14]. However, when we extend the `chain`</span>
    <span class="c1"># key the `add.s(3)` task erroneously has `add.s(2)` in its chain since</span>
    <span class="c1"># it was previously applied to `add.s(1)`.</span>
    <span class="c1"># Without being careful not to mutate the options dictionary, the result</span>
    <span class="c1"># in this case is [16, 14].</span>
    <span class="c1"># To avoid deep-copying the entire options dictionary every single time we</span>
    <span class="c1"># run a chain we use a ChainMap and ensure that we never mutate</span>
    <span class="c1"># the original `chain` key, hence we use list_a + list_b to create a new</span>
    <span class="c1"># list.</span>
    <span class="k">if</span> <span class="n">use_link</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ChainMap</span><span class="p">({</span><span class="s1">&#39;chain&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span> <span class="n">options</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">&#39;chain&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ChainMap</span><span class="p">({</span><span class="s1">&#39;chain&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">},</span> <span class="n">options</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">tasks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># chain option may already be set, resulting in</span>
        <span class="c1"># &quot;multiple values for keyword argument &#39;chain&#39;&quot; error.</span>
        <span class="c1"># Issue #3379.</span>
        <span class="c1"># If a chain already exists, we need to extend it with the next</span>
        <span class="c1"># tasks in the chain.</span>
        <span class="c1"># Issue #5354.</span>
        <span class="c1"># WARNING: Be careful not to mutate `options[&#39;chain&#39;]`.</span>
        <span class="k">return</span> <span class="n">ChainMap</span><span class="p">({</span><span class="s1">&#39;chain&#39;</span><span class="p">:</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;chain&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">tasks</span><span class="p">},</span>
                        <span class="n">options</span><span class="p">)</span>


<span class="nd">@Signature</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;chain&#39;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_chain</span><span class="p">(</span><span class="n">Signature</span><span class="p">):</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;kwargs.tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;Tasks in chain.&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;tasks&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>  <span class="c1"># aaaargh</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">][</span><span class="s1">&#39;tasks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">maybe_signature</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">(</span><span class="n">regen</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">is_list</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                 <span class="k">else</span> <span class="n">tasks</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;celery.chain&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">},</span> <span class="o">**</span><span class="n">options</span>
                         <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_link</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;use_link&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtask_type</span> <span class="o">=</span> <span class="s1">&#39;chain&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frozen</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
            <span class="c1"># unroll group with one member</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">maybe_unroll_group</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__or__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="c1"># chain | group() -&gt; chain</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unchain_tasks</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="c1"># If the chain is empty, return the group</span>
                <span class="k">return</span> <span class="n">other</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">chord</span><span class="p">):</span>
                <span class="c1"># CHAIN [last item is chord] | GROUP -&gt; chain with chord body.</span>
                <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">body</span> <span class="o">|</span> <span class="n">other</span>
                <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
            <span class="c1"># use type(self) for _chain subclasses</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">seq_concat_item</span><span class="p">(</span>
                <span class="n">tasks</span><span class="p">,</span> <span class="n">other</span><span class="p">),</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_chain</span><span class="p">):</span>
            <span class="c1"># chain | chain -&gt; chain</span>
            <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">unchain_tasks</span><span class="p">(),</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Signature</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">group</span><span class="p">):</span>
                <span class="c1"># CHAIN [last item is group] | TASK -&gt; chord</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chord</span><span class="p">(</span>
                    <span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">other</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span>
                <span class="c1"># In the scenario where the second-to-last item in a chain is a chord,</span>
                <span class="c1"># it leads to a situation where two consecutive chords are formed.</span>
                <span class="c1"># In such cases, a further upgrade can be considered.</span>
                <span class="c1"># This would involve chaining the body of the second-to-last chord with the last chord.&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">chord</span><span class="p">):</span>
                    <span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">body</span> <span class="o">|</span> <span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">sig</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">sig</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">chord</span><span class="p">):</span>
                <span class="c1"># CHAIN [last item is chord] -&gt; chain with chord body.</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                <span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">body</span> <span class="o">|</span> <span class="n">other</span>
                <span class="k">return</span> <span class="n">sig</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># chain | task -&gt; chain</span>
                <span class="c1"># use type(self) for _chain subclasses</span>
                <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">seq_concat_item</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unchain_tasks</span><span class="p">(),</span> <span class="n">other</span><span class="p">),</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">to_signature</span> <span class="o">=</span> <span class="n">maybe_signature</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">signature</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">to_signature</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">,</span> <span class="n">clone</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">signature</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">unchain_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of tasks in the chain.</span>

<span class="sd">        The tasks list would be cloned from the chain&#39;s tasks.</span>
<span class="sd">        All of the chain callbacks would be added to the last task in the (cloned) chain.</span>
<span class="sd">        All of the tasks would be linked to the same error callback</span>
<span class="sd">        as the chain itself, to ensure that the correct error callback is called</span>
<span class="sd">        if any of the (cloned) tasks of the chain fail.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Clone chain&#39;s tasks assigning signatures from link_error</span>
        <span class="c1"># to each task and adding the chain&#39;s links to the last task.</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">maybe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">maybe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;link_error&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">link_error</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tasks</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="c1"># python is best at unpacking kwargs, so .run is here to do that.</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>

        <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">task_always_eager</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">allow_join_result</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">task_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">link_error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">publisher</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">producer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">root_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">group_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Executes the chain.</span>

<span class="sd">        Responsible for executing the chain in the correct order.</span>
<span class="sd">        In a case of a chain of a single task, the task is executed directly</span>
<span class="sd">        and the result is returned for that task specifically.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=redefined-outer-name</span>
        <span class="c1">#   XXX chord is also a class in outer scope.</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>
        <span class="n">use_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_link</span>
        <span class="k">if</span> <span class="n">use_link</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">task_protocol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">use_link</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">immutable</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

        <span class="c1"># Unpack nested chains/groups/chords</span>
        <span class="n">tasks</span><span class="p">,</span> <span class="n">results_from_prepare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_steps</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">link_error</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span>
            <span class="n">task_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">group_index</span><span class="o">=</span><span class="n">group_index</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># For a chain of single task, execute the task directly and return the result for that task</span>
        <span class="c1"># For a chain of multiple tasks, execute all of the tasks and return the AsyncResult for the chain</span>
        <span class="k">if</span> <span class="n">results_from_prepare</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extend_list_option</span><span class="p">(</span><span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
            <span class="n">first_task</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">_prepare_chain_from_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">use_link</span><span class="p">)</span>

            <span class="n">result_from_apply</span> <span class="o">=</span> <span class="n">first_task</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
            <span class="c1"># If we only have a single task, it may be important that we pass</span>
            <span class="c1"># the real result object rather than the one obtained via freezing.</span>
            <span class="c1"># e.g. For `GroupResult`s, we need to pass back the result object</span>
            <span class="c1"># which will actually have its promise fulfilled by the subtasks,</span>
            <span class="c1"># something that will never occur for the frozen result.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result_from_apply</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">results_from_prepare</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># in order for a chain to be frozen, each of the members of the chain individually needs to be frozen</span>
    <span class="c1"># TODO figure out why we are always cloning before freeze</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">freeze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">root_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># pylint: disable=redefined-outer-name</span>
        <span class="c1">#   XXX chord is also a class in outer scope.</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frozen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_steps</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">_id</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">clone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">group_index</span><span class="o">=</span><span class="n">group_index</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append_stamps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">):</span>
        <span class="n">visitor_headers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">visitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visitor_headers</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">on_chain_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stamp_headers</span><span class="p">(</span><span class="n">visitor_headers</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stamp_links</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">visitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visitor</span><span class="o">.</span><span class="n">on_chain_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prepare_steps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span>
                      <span class="n">root_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">link_error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">last_task_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chord_body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">clone</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">from_dict</span><span class="o">=</span><span class="n">Signature</span><span class="o">.</span><span class="n">from_dict</span><span class="p">,</span>
                      <span class="n">group_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the chain for execution.</span>

<span class="sd">        To execute a chain, we first need to unpack it correctly.</span>
<span class="sd">        During the unpacking, we might encounter other chains, groups, or chords</span>
<span class="sd">        which we need to unpack as well.</span>

<span class="sd">        For example:</span>
<span class="sd">        chain(signature1, chain(signature2, signature3)) --&gt; Upgrades to chain(signature1, signature2, signature3)</span>
<span class="sd">        chain(group(signature1, signature2), signature3) --&gt; Upgrades to chord([signature1, signature2], signature3)</span>

<span class="sd">        The responsibility of this method is to ensure that the chain is</span>
<span class="sd">        correctly unpacked, and then the correct callbacks are set up along the way.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            args (Tuple): Partial args to be prepended to the existing args.</span>
<span class="sd">            kwargs (Dict): Partial kwargs to be merged with existing kwargs.</span>
<span class="sd">            tasks (List[Signature]): The tasks of the chain.</span>
<span class="sd">            root_id (str): The id of the root task.</span>
<span class="sd">            parent_id (str): The id of the parent task.</span>
<span class="sd">            link_error (Union[List[Signature], Signature]): The error callback.</span>
<span class="sd">                will be set for all tasks in the chain.</span>
<span class="sd">            app (Celery): The Celery app instance.</span>
<span class="sd">            last_task_id (str): The id of the last task in the chain.</span>
<span class="sd">            group_id (str): The id of the group that the chain is a part of.</span>
<span class="sd">            chord_body (Signature): The body of the chord, used to synchronize with the chain&#39;s</span>
<span class="sd">                last task and the chord&#39;s body when used together.</span>
<span class="sd">            clone (bool): Whether to clone the chain&#39;s tasks before modifying them.</span>
<span class="sd">            from_dict (Callable): A function that takes a dict and returns a Signature.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[List[Signature], List[AsyncResult]]: The frozen tasks of the chain, and the async results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>
        <span class="c1"># use chain message field for protocol 2 and later.</span>
        <span class="c1"># this avoids pickle blowing the stack on the recursion</span>
        <span class="c1"># required by linking task together in a tree structure.</span>
        <span class="c1"># (why is pickle using recursion? or better yet why cannot python</span>
        <span class="c1">#  do tail call optimization making recursion actually useful?)</span>
        <span class="n">use_link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_link</span>
        <span class="k">if</span> <span class="n">use_link</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">task_protocol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">use_link</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>

        <span class="c1"># optimization: now the pop func is a local variable</span>
        <span class="n">steps_pop</span> <span class="o">=</span> <span class="n">steps</span><span class="o">.</span><span class="n">pop</span>
        <span class="n">steps_extend</span> <span class="o">=</span> <span class="n">steps</span><span class="o">.</span><span class="n">extend</span>

        <span class="n">prev_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">prev_res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tasks</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># NOTE: We are doing this in reverse order.</span>
        <span class="c1"># The result is a list of tasks in reverse order, that is</span>
        <span class="c1"># passed as the ``chain`` message field.</span>
        <span class="c1"># As it&#39;s reversed the worker can just do ``chain.pop()`` to</span>
        <span class="c1"># get the next task in the chain.</span>
        <span class="k">while</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">steps_pop</span><span class="p">()</span>
            <span class="c1"># if steps is not empty, this is the first task - reverse order</span>
            <span class="c1"># if i = 0, this is the last task - again, because we&#39;re reversed</span>
            <span class="n">is_first_task</span><span class="p">,</span> <span class="n">is_last_task</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">steps</span><span class="p">,</span> <span class="ow">not</span> <span class="n">i</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">abstract</span><span class="o">.</span><span class="n">CallableSignature</span><span class="p">):</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">from_dict</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
                <span class="c1"># when groups are nested, they are unrolled - all tasks within</span>
                <span class="c1"># groups should be called in parallel</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">maybe_unroll_group</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="c1"># first task gets partial args from chain</span>
            <span class="k">if</span> <span class="n">clone</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_first_task</span><span class="p">:</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">is_first_task</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">_chain</span><span class="p">):</span>
                <span class="c1"># splice (unroll) the chain</span>
                <span class="n">steps_extend</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># TODO why isn&#39;t this asserting is_last_task == False?</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prev_task</span><span class="p">:</span>
                <span class="c1"># automatically upgrade group(...) | s to chord(group, s)</span>
                <span class="c1"># for chords we freeze by pretending it&#39;s a normal</span>
                <span class="c1"># signature instead of a group.</span>
                <span class="n">tasks</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">results</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">chord</span><span class="p">(</span>
                        <span class="n">task</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">prev_task</span><span class="p">,</span>
                        <span class="n">task_id</span><span class="o">=</span><span class="n">prev_res</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="c1"># A GroupResult does not have a task_id since it consists</span>
                    <span class="c1"># of multiple tasks.</span>
                    <span class="c1"># We therefore, have to construct the chord without it.</span>
                    <span class="c1"># Issues #5467, #3585.</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">chord</span><span class="p">(</span>
                        <span class="n">task</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">prev_task</span><span class="p">,</span>
                        <span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">tasks</span><span class="p">:</span>
                    <span class="n">prev_task</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">prev_res</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prev_task</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">prev_res</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">is_last_task</span><span class="p">:</span>
                <span class="c1"># chain(task_id=id) means task id is set for the last task</span>
                <span class="c1"># in the chain.  If the chord is part of a chord/group</span>
                <span class="c1"># then that chord/group must synchronize based on the</span>
                <span class="c1"># last task in the chain, so we only set the group_id and</span>
                <span class="c1"># chord callback for the last task.</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span>
                    <span class="n">last_task_id</span><span class="p">,</span>
                    <span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span> <span class="n">chord</span><span class="o">=</span><span class="n">chord_body</span><span class="p">,</span>
                    <span class="n">group_index</span><span class="o">=</span><span class="n">group_index</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">)</span>

            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">prev_task</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">use_link</span><span class="p">:</span>
                    <span class="c1"># link previous task to this task.</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">prev_task</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">prev_res</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">prev_res</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                    <span class="n">prev_res</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">res</span>

            <span class="k">if</span> <span class="n">link_error</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">errback</span> <span class="ow">in</span> <span class="n">maybe_list</span><span class="p">(</span><span class="n">link_error</span><span class="p">):</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">link_error</span><span class="p">(</span><span class="n">errback</span><span class="p">)</span>

            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

            <span class="n">prev_task</span><span class="p">,</span> <span class="n">prev_res</span> <span class="o">=</span> <span class="n">task</span><span class="p">,</span> <span class="n">res</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">chord</span><span class="p">):</span>
                <span class="n">app</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">ensure_chords_allowed</span><span class="p">()</span>
                <span class="c1"># If the task is a chord, and the body is a chain</span>
                <span class="c1"># the chain has already been prepared, and res is</span>
                <span class="c1"># set to the last task in the callback chain.</span>

                <span class="c1"># We need to change that so that it points to the</span>
                <span class="c1"># group result object.</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">res</span>
                <span class="k">while</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
                <span class="n">prev_res</span> <span class="o">=</span> <span class="n">node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">last_task_id</span>
        <span class="k">return</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">last</span><span class="p">,</span> <span class="p">(</span><span class="n">fargs</span><span class="p">,</span> <span class="n">fkwargs</span><span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">fargs</span><span class="p">,</span> <span class="n">fkwargs</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="n">last</span> <span class="ow">and</span> <span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">get</span><span class="p">(),),</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">))</span>
            <span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">last</span><span class="p">,</span> <span class="p">(</span><span class="n">fargs</span><span class="p">,</span> <span class="n">fkwargs</span><span class="p">)</span> <span class="o">=</span> <span class="n">last</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">last</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_app</span>
            <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">app</span> <span class="ow">or</span> <span class="n">current_app</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">:</span><span class="s1">#x</span><span class="si">}</span><span class="s1">: empty&gt;&#39;</span>
        <span class="k">return</span> <span class="n">remove_repeating_from_task</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;task&#39;</span><span class="p">],</span>
            <span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">))</span>


<div class="viewcode-block" id="chain">
<a class="viewcode-back" href="../../reference/celery.html#celery.chain">[文档]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">chain</span><span class="p">(</span><span class="n">_chain</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Chain tasks together.</span>

<span class="sd">    Each tasks follows one another,</span>
<span class="sd">    by being applied as a callback of the previous task.</span>

<span class="sd">    Note:</span>
<span class="sd">        If called with only one argument, then that argument must</span>
<span class="sd">        be an iterable of tasks to chain: this allows us</span>
<span class="sd">        to use generator expressions.</span>

<span class="sd">    Example:</span>
<span class="sd">        This is effectively :math:`((2 + 2) + 4)`:</span>

<span class="sd">        .. code-block:: pycon</span>

<span class="sd">            &gt;&gt;&gt; res = chain(add.s(2, 2), add.s(4))()</span>
<span class="sd">            &gt;&gt;&gt; res.get()</span>
<span class="sd">            8</span>

<span class="sd">        Calling a chain will return the result of the last task in the chain.</span>
<span class="sd">        You can get to the other tasks by following the ``result.parent``&#39;s:</span>

<span class="sd">        .. code-block:: pycon</span>

<span class="sd">            &gt;&gt;&gt; res.parent.get()</span>
<span class="sd">            4</span>

<span class="sd">        Using a generator expression:</span>

<span class="sd">        .. code-block:: pycon</span>

<span class="sd">            &gt;&gt;&gt; lazy_chain = chain(add.s(i) for i in range(10))</span>
<span class="sd">            &gt;&gt;&gt; res = lazy_chain(3)</span>

<span class="sd">    Arguments:</span>
<span class="sd">        *tasks (Signature): List of task signatures to chain.</span>
<span class="sd">            If only one argument is passed and that argument is</span>
<span class="sd">            an iterable, then that&#39;ll be used as the list of signatures</span>
<span class="sd">            to chain instead.  This means that you can use a generator</span>
<span class="sd">            expression.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ~celery.chain: A lazy signature that can be called to apply the first</span>
<span class="sd">            task in the chain.  When that task succeeds the next task in the</span>
<span class="sd">            chain is applied, and so on.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># could be function, but must be able to reference as :class:`chain`.</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># This forces `chain(X, Y, Z)` to work the same way as `X | Y | Z`</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">tasks</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">is_list</span><span class="p">(</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">tasks</span>
                <span class="c1"># if is_list(tasks) and len(tasks) == 1:</span>
                <span class="c1">#     return super(chain, cls).__new__(cls, tasks, **kwargs)</span>
                <span class="n">new_instance</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">_chain</span><span class="p">())</span>
                <span class="k">if</span> <span class="bp">cls</span> <span class="o">!=</span> <span class="n">chain</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_instance</span><span class="p">,</span> <span class="n">_chain</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_instance</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">new_instance</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">new_instance</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">_basemap</span><span class="p">(</span><span class="n">Signature</span><span class="p">):</span>
    <span class="n">_task_name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_unpack_args</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="s1">&#39;it&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">_unpack_args</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]),</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_name</span><span class="p">,</span> <span class="p">(),</span>
                         <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span> <span class="s1">&#39;it&#39;</span><span class="p">:</span> <span class="n">regen</span><span class="p">(</span><span class="n">it</span><span class="p">)},</span> <span class="n">immutable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span>
                         <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="c1"># need to evaluate generators</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">task</span><span class="p">,</span> <span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
            <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span> <span class="s1">&#39;it&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">it</span><span class="p">)},</span>
            <span class="n">route_name</span><span class="o">=</span><span class="n">task_name_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">)),</span> <span class="o">**</span><span class="n">opts</span>
        <span class="p">)</span>


<span class="nd">@Signature</span><span class="o">.</span><span class="n">register_type</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">xmap</span><span class="p">(</span><span class="n">_basemap</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Map operation for tasks.</span>

<span class="sd">    Note:</span>
<span class="sd">        Tasks executed sequentially in process, this is not a</span>
<span class="sd">        parallel operation like :class:`group`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_task_name</span> <span class="o">=</span> <span class="s1">&#39;celery.map&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span><span class="p">,</span> <span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">task</span><span class="si">}</span><span class="s1">(x) for x in </span><span class="si">{</span><span class="n">truncate</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">it</span><span class="p">),</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span>


<span class="nd">@Signature</span><span class="o">.</span><span class="n">register_type</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">xstarmap</span><span class="p">(</span><span class="n">_basemap</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Map operation for tasks, using star arguments.&quot;&quot;&quot;</span>

    <span class="n">_task_name</span> <span class="o">=</span> <span class="s1">&#39;celery.starmap&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span><span class="p">,</span> <span class="n">it</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">task</span><span class="si">}</span><span class="s1">(*x) for x in </span><span class="si">{</span><span class="n">truncate</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">it</span><span class="p">),</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s1">]&#39;</span>


<span class="nd">@Signature</span><span class="o">.</span><span class="n">register_type</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">chunks</span><span class="p">(</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Partition of tasks into chunks of size n.&quot;&quot;&quot;</span>

    <span class="n">_unpack_args</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="s1">&#39;it&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="bp">cls</span><span class="o">.</span><span class="n">_unpack_args</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]),</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;celery.chunks&#39;</span><span class="p">,</span> <span class="p">(),</span>
                         <span class="p">{</span><span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span><span class="p">,</span> <span class="s1">&#39;it&#39;</span><span class="p">:</span> <span class="n">regen</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="n">n</span><span class="p">},</span>
                         <span class="n">immutable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span>
                         <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span>
            <span class="n">route_name</span><span class="o">=</span><span class="n">task_name_from</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">)),</span> <span class="o">**</span><span class="n">opts</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># need to evaluate generators</span>
        <span class="n">task</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unpack_args</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">group</span><span class="p">((</span><span class="n">xstarmap</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">part</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">_chunks</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">it</span><span class="p">),</span> <span class="n">n</span><span class="p">)),</span>
                     <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_chunks</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_maybe_group</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">_chain</span><span class="p">)):</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">tasks</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">abstract</span><span class="o">.</span><span class="n">CallableSignature</span><span class="p">):</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tasks</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">GeneratorType</span><span class="p">):</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="n">regen</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">signature</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tasks</span>


<div class="viewcode-block" id="group">
<a class="viewcode-back" href="../../reference/celery.html#celery.group">[文档]</a>
<span class="nd">@Signature</span><span class="o">.</span><span class="n">register_type</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">group</span><span class="p">(</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates a group of tasks to be executed in parallel.</span>

<span class="sd">    A group is lazy so you must call it to take action and evaluate</span>
<span class="sd">    the group.</span>

<span class="sd">    Note:</span>
<span class="sd">        If only one argument is passed, and that argument is an iterable</span>
<span class="sd">        then that&#39;ll be used as the list of tasks instead: this</span>
<span class="sd">        allows us to use ``group`` with generator expressions.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; lazy_group = group([add.s(2, 2), add.s(4, 4)])</span>
<span class="sd">        &gt;&gt;&gt; promise = lazy_group()  # &lt;-- evaluate: returns lazy result.</span>
<span class="sd">        &gt;&gt;&gt; promise.get()  # &lt;-- will wait for the task to return</span>
<span class="sd">        [4, 8]</span>

<span class="sd">    Arguments:</span>
<span class="sd">        *tasks (List[Signature]): A list of signatures that this group will</span>
<span class="sd">            call. If there&#39;s only one argument, and that argument is an</span>
<span class="sd">            iterable, then that&#39;ll define the list of signatures instead.</span>
<span class="sd">        **options (Any): Execution options applied to all tasks</span>
<span class="sd">            in the group.</span>

<span class="sd">    Returns:</span>
<span class="sd">        ~celery.group: signature that when called will then call all of the</span>
<span class="sd">            tasks in the group (and return a :class:`GroupResult` instance</span>
<span class="sd">            that can be used to inspect the state of the group).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;kwargs.tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;Tasks in group.&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a group signature from a dictionary that represents a group.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; group_dict = {</span>
<span class="sd">                &quot;task&quot;: &quot;celery.group&quot;,</span>
<span class="sd">                &quot;args&quot;: [],</span>
<span class="sd">                &quot;kwargs&quot;: {</span>
<span class="sd">                    &quot;tasks&quot;: [</span>
<span class="sd">                        {</span>
<span class="sd">                            &quot;task&quot;: &quot;add&quot;,</span>
<span class="sd">                            &quot;args&quot;: [</span>
<span class="sd">                                1,</span>
<span class="sd">                                2</span>
<span class="sd">                            ],</span>
<span class="sd">                            &quot;kwargs&quot;: {},</span>
<span class="sd">                            &quot;options&quot;: {},</span>
<span class="sd">                            &quot;subtask_type&quot;: None,</span>
<span class="sd">                            &quot;immutable&quot;: False</span>
<span class="sd">                        },</span>
<span class="sd">                        {</span>
<span class="sd">                            &quot;task&quot;: &quot;add&quot;,</span>
<span class="sd">                            &quot;args&quot;: [</span>
<span class="sd">                                3,</span>
<span class="sd">                                4</span>
<span class="sd">                            ],</span>
<span class="sd">                            &quot;kwargs&quot;: {},</span>
<span class="sd">                            &quot;options&quot;: {},</span>
<span class="sd">                            &quot;subtask_type&quot;: None,</span>
<span class="sd">                            &quot;immutable&quot;: False</span>
<span class="sd">                        }</span>
<span class="sd">                    ]</span>
<span class="sd">                },</span>
<span class="sd">                &quot;options&quot;: {},</span>
<span class="sd">                &quot;subtask_type&quot;: &quot;group&quot;,</span>
<span class="sd">                &quot;immutable&quot;: False</span>
<span class="sd">            }</span>
<span class="sd">            &gt;&gt;&gt; group_sig = group.from_dict(group_dict)</span>

<span class="sd">        Iterates over the given tasks in the dictionary and convert them to signatures.</span>
<span class="sd">        Tasks needs to be defined in d[&#39;kwargs&#39;][&#39;tasks&#39;] as a sequence</span>
<span class="sd">        of tasks.</span>

<span class="sd">        The tasks themselves can be dictionaries or signatures (or both).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># We need to mutate the `kwargs` element in place to avoid confusing</span>
        <span class="c1"># `freeze()` implementations which end up here and expect to be able to</span>
        <span class="c1"># access elements from that dictionary later and refer to objects</span>
        <span class="c1"># canonicalized here</span>
        <span class="n">orig_tasks</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;tasks&quot;</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">][</span><span class="s2">&quot;tasks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rebuilt_tasks</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">orig_tasks</span><span class="p">)(</span>
            <span class="n">maybe_signature</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">orig_tasks</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">rebuilt_tasks</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">tasks</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">tasks</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">abstract</span><span class="o">.</span><span class="n">CallableSignature</span><span class="p">):</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tasks</span><span class="o">.</span><span class="n">clone</span><span class="p">()]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">_regen</span><span class="p">):</span>
                <span class="c1"># May potentially cause slow downs when using a</span>
                <span class="c1"># generator of many tasks - Issue #6973</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="n">regen</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;celery.group&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;tasks&#39;</span><span class="p">:</span> <span class="n">tasks</span><span class="p">},</span> <span class="o">**</span><span class="n">options</span>
                         <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtask_type</span> <span class="o">=</span> <span class="s1">&#39;group&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">partial_args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">partial_args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># group() | task -&gt; chord</span>
        <span class="k">return</span> <span class="n">chord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">other</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">skew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="c1"># TODO: Not sure if this is still used anywhere (besides its own tests). Consider removing.</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">fxrange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">repeatlast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_to_parent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">producer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">link_error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="k">if</span> <span class="n">link</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Cannot add link to group: use a chord&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">link_error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot add link to group: do that on individual tasks&#39;</span><span class="p">)</span>
        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>
        <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">task_always_eager</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>

        <span class="n">options</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">root_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_gid</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepared</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="p">[],</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">barrier</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_apply_tasks</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">producer</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
                                         <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">GroupResult</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">ready_barrier</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>

        <span class="c1"># - Special case of group(A.s() | group(B.s(), C.s()))</span>
        <span class="c1"># That is, group with single item that&#39;s a chain but the</span>
        <span class="c1"># last task in that chain is a group.</span>
        <span class="c1">#</span>
        <span class="c1"># We cannot actually support arbitrary GroupResults in chains,</span>
        <span class="c1"># but this special case we can.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">GroupResult</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">parent_task</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">current_worker_task</span>
        <span class="k">if</span> <span class="n">add_to_parent</span> <span class="ow">and</span> <span class="n">parent_task</span><span class="p">:</span>
            <span class="n">parent_task</span><span class="o">.</span><span class="n">add_trail</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>  <span class="c1"># empty group returns GroupResult</span>
        <span class="n">options</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">root_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freeze_gid</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepared</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="p">[],</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">GroupResult</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="p">[</span>
            <span class="n">sig</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span> <span class="k">for</span> <span class="n">sig</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tasks</span>
        <span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_immutable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">immutable</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_immutable</span><span class="p">(</span><span class="n">immutable</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append_stamps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">):</span>
        <span class="n">visitor_headers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">visitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visitor_headers</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">on_group_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stamp_headers</span><span class="p">(</span><span class="n">visitor_headers</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stamp_links</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">_regen</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_partial</span><span class="p">(</span><span class="n">_stamp_regen_task</span><span class="p">,</span> <span class="n">visitor</span><span class="o">=</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="o">=</span><span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_tasks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">maybe_signature</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
                <span class="n">task</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>
                <span class="n">new_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_tasks</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">new_tasks</span>

        <span class="k">if</span> <span class="n">visitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visitor</span><span class="o">.</span><span class="n">on_group_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
        <span class="c1"># Simply link to first task. Doing this is slightly misleading because</span>
        <span class="c1"># the callback may be executed before all children in the group are</span>
        <span class="c1"># completed and also if any children other than the first one fail.</span>
        <span class="c1">#</span>
        <span class="c1"># The callback signature is cloned and made immutable since it the</span>
        <span class="c1"># first task isn&#39;t actually capable of passing the return values of its</span>
        <span class="c1"># siblings to the callback task.</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">immutable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">link_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">):</span>
        <span class="c1"># Any child task might error so we need to ensure that they are all</span>
        <span class="c1"># capable of calling the linked error signature. This opens the</span>
        <span class="c1"># possibility that the task is called more than once but that&#39;s better</span>
        <span class="c1"># than it not being called at all.</span>
        <span class="c1">#</span>
        <span class="c1"># We return a concretised tuple of the signatures actually applied to</span>
        <span class="c1"># each child task signature, of which there might be none!</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">maybe_signature</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">child_task</span><span class="o">.</span><span class="n">link_error</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">immutable</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="k">for</span> <span class="n">child_task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">partial_args</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span>
                  <span class="n">CallableSignature</span><span class="o">=</span><span class="n">abstract</span><span class="o">.</span><span class="n">CallableSignature</span><span class="p">,</span>
                  <span class="n">from_dict</span><span class="o">=</span><span class="n">Signature</span><span class="o">.</span><span class="n">from_dict</span><span class="p">,</span>
                  <span class="nb">isinstance</span><span class="o">=</span><span class="nb">isinstance</span><span class="p">,</span> <span class="nb">tuple</span><span class="o">=</span><span class="nb">tuple</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively unroll the group into a generator of its tasks.</span>

<span class="sd">        This is used by :meth:`apply_async` and :meth:`apply` to</span>
<span class="sd">        unroll the group into a list of tasks that can be evaluated.</span>

<span class="sd">        Note:</span>
<span class="sd">            This does not change the group itself, it only returns</span>
<span class="sd">            a generator of the tasks that the group would evaluate to.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            tasks (list): List of tasks in the group (may contain nested groups).</span>
<span class="sd">            partial_args (list): List of arguments to be prepended to</span>
<span class="sd">                the arguments of each task.</span>
<span class="sd">            group_id (str): The group id of the group.</span>
<span class="sd">            root_id (str): The root id of the group.</span>
<span class="sd">            app (Celery): The Celery app instance.</span>
<span class="sd">            CallableSignature (class): The signature class of the group&#39;s tasks.</span>
<span class="sd">            from_dict (fun): Function to create a signature from a dict.</span>
<span class="sd">            isinstance (fun): Function to check if an object is an instance</span>
<span class="sd">                of a class.</span>
<span class="sd">            tuple (class): A tuple-like class.</span>

<span class="sd">        Returns:</span>
<span class="sd">            generator: A generator for the unrolled group tasks.</span>
<span class="sd">                The generator yields tuples of the form ``(task, AsyncResult, group_id)``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">CallableSignature</span><span class="p">):</span>
                <span class="c1"># local sigs are always of type Signature, and we</span>
                <span class="c1"># clone them to make sure we don&#39;t modify the originals.</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># serialized sigs must be converted to Signature.</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">from_dict</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
                <span class="c1"># needs yield_from :(</span>
                <span class="n">unroll</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">_prepared</span><span class="p">(</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">partial_args</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">yield from</span> <span class="n">unroll</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">partial_args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">immutable</span><span class="p">:</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">partial_args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">task</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span> <span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">,</span> <span class="n">group_index</span><span class="o">=</span><span class="n">index</span><span class="p">),</span> <span class="n">group_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">producer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">add_to_parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run all the tasks in the group.</span>

<span class="sd">        This is used by :meth:`apply_async` to run all the tasks in the group</span>
<span class="sd">        and return a generator of their results.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            tasks (list): List of tasks in the group.</span>
<span class="sd">            producer (Producer): The producer to use to publish the tasks.</span>
<span class="sd">            app (Celery): The Celery app instance.</span>
<span class="sd">            p (barrier): Barrier object to synchronize the tasks results.</span>
<span class="sd">            args (list): List of arguments to be prepended to</span>
<span class="sd">                the arguments of each task.</span>
<span class="sd">            kwargs (dict): Dict of keyword arguments to be merged with</span>
<span class="sd">                the keyword arguments of each task.</span>
<span class="sd">            **options (dict): Options to be merged with the options of each task.</span>

<span class="sd">        Returns:</span>
<span class="sd">            generator: A generator for the AsyncResult of the tasks in the group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=redefined-outer-name</span>
        <span class="c1">#   XXX chord is also a class in outer scope.</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>
        <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">producer_or_acquire</span><span class="p">(</span><span class="n">producer</span><span class="p">)</span> <span class="k">as</span> <span class="n">producer</span><span class="p">:</span>
            <span class="c1"># Iterate through tasks two at a time. If tasks is a generator,</span>
            <span class="c1"># we are able to tell when we are at the end by checking if</span>
            <span class="c1"># next_task is None.  This enables us to set the chord size</span>
            <span class="c1"># without burning through the entire generator.  See #3021.</span>
            <span class="n">chord_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">tasks_shifted</span><span class="p">,</span> <span class="n">tasks</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">tasks</span><span class="p">)</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">tasks_shifted</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">next_task</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tasks_shifted</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">task_index</span><span class="p">,</span> <span class="n">current_task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">):</span>
                <span class="c1"># We expect that each task must be part of the same group which</span>
                <span class="c1"># seems sensible enough. If that&#39;s somehow not the case we&#39;ll</span>
                <span class="c1"># end up messing up chord counts and there are all sorts of</span>
                <span class="c1"># awful race conditions to think about. We&#39;ll hope it&#39;s not!</span>
                <span class="n">sig</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">group_id</span> <span class="o">=</span> <span class="n">current_task</span>
                <span class="n">chord_obj</span> <span class="o">=</span> <span class="n">chord</span> <span class="k">if</span> <span class="n">chord</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sig</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chord&quot;</span><span class="p">)</span>
                <span class="c1"># We need to check the chord size of each contributing task so</span>
                <span class="c1"># that when we get to the final one, we can correctly set the</span>
                <span class="c1"># size in the backend and the chord can be sensible completed.</span>
                <span class="n">chord_size</span> <span class="o">+=</span> <span class="n">_chord</span><span class="o">.</span><span class="n">_descend</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">chord_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">next_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Per above, sanity check that we only saw one group</span>
                    <span class="n">app</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">set_chord_size</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">chord_size</span><span class="p">)</span>
                <span class="n">sig</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">producer</span><span class="o">=</span><span class="n">producer</span><span class="p">,</span> <span class="n">add_to_parent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">chord</span><span class="o">=</span><span class="n">chord_obj</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">options</span><span class="p">)</span>
                <span class="c1"># adding callback to result, such that it will gradually</span>
                <span class="c1"># fulfill the barrier.</span>
                <span class="c1">#</span>
                <span class="c1"># Using barrier.add would use result.then, but we need</span>
                <span class="c1"># to add the weak argument here to only create a weak</span>
                <span class="c1"># reference to the object.</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">cancelled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">size</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">weak</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">next_task</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">tasks_shifted</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">res</span>  <span class="c1"># &lt;-- r.parent, etc set in the frozen result.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_freeze_gid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Freeze the group id by the existing task_id or a new UUID.&quot;&quot;&quot;</span>
        <span class="c1"># remove task_id and use that as the group_id,</span>
        <span class="c1"># if we don&#39;t remove it then every task will have the same id...</span>
        <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_IMMUTABLE_OPTIONS</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="p">}}</span>
        <span class="n">options</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_id</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;task_id&#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">options</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;root_id&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_freeze_group_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">root_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Freeze the tasks in the group.</span>

<span class="sd">        Note:</span>
<span class="sd">            If the group tasks are created from a generator, the tasks generator would</span>
<span class="sd">            not be exhausted, and the tasks would be frozen lazily.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple of the group id, and the AsyncResult of each of the group tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=redefined-outer-name</span>
        <span class="c1">#  XXX chord is also a class in outer scope.</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gid</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">gid</span> <span class="o">=</span> <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_id</span> <span class="ow">or</span> <span class="n">uuid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">group_id</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_id</span>
        <span class="k">if</span> <span class="n">chord</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;chord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chord</span>
        <span class="k">if</span> <span class="n">group_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s1">&#39;group_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_index</span>
        <span class="n">root_id</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;root_id&#39;</span><span class="p">,</span> <span class="n">root_id</span><span class="p">)</span>
        <span class="n">parent_id</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">_regen</span><span class="p">):</span>
            <span class="c1"># When the group tasks are a generator, we need to make sure we don&#39;t</span>
            <span class="c1"># exhaust it during the freeze process. We use two generators to do this.</span>
            <span class="c1"># One generator will be used to freeze the tasks to get their AsyncResult.</span>
            <span class="c1"># The second generator will be used to replace the tasks in the group with an unexhausted state.</span>

            <span class="c1"># Create two new generators from the original generator of the group tasks (cloning the tasks).</span>
            <span class="n">tasks1</span><span class="p">,</span> <span class="n">tasks2</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unroll_tasks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">))</span>
            <span class="c1"># Use the first generator to freeze the group tasks to acquire the AsyncResult for each task.</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">regen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freeze_tasks</span><span class="p">(</span><span class="n">tasks1</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">))</span>
            <span class="c1"># Use the second generator to replace the exhausted generator of the group tasks.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">regen</span><span class="p">(</span><span class="n">tasks2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_tasks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Need to unroll subgroups early so that chord gets the</span>
            <span class="c1"># right result instance for chord_unlock etc.</span>
            <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_freeze_unroll</span><span class="p">(</span>
                <span class="n">new_tasks</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span>
            <span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">MutableSequence</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new_tasks</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">new_tasks</span>
        <span class="k">return</span> <span class="n">gid</span><span class="p">,</span> <span class="n">results</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">freeze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">root_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">GroupResult</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_freeze_group_tasks</span><span class="p">(</span>
            <span class="n">_id</span><span class="o">=</span><span class="n">_id</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
            <span class="n">chord</span><span class="o">=</span><span class="n">chord</span><span class="p">,</span> <span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">group_index</span><span class="o">=</span><span class="n">group_index</span>
        <span class="p">))</span>

    <span class="n">_freeze</span> <span class="o">=</span> <span class="n">freeze</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_freeze_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a generator for the AsyncResult of each task in the tasks argument.&quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
                                <span class="n">chord</span><span class="o">=</span><span class="n">chord</span><span class="p">,</span>
                                <span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">,</span>
                                <span class="n">parent_id</span><span class="o">=</span><span class="n">parent_id</span><span class="p">,</span>
                                <span class="n">group_index</span><span class="o">=</span><span class="n">group_index</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">group_index</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tasks</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_unroll_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tasks</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Creates a generator for the cloned tasks of the tasks argument.&quot;&quot;&quot;</span>
        <span class="c1"># should be refactored to: (maybe_signature(task, app=self._app, clone=True) for task in tasks)</span>
        <span class="k">yield from</span> <span class="p">(</span><span class="n">maybe_signature</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_freeze_unroll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_tasks</span><span class="p">,</span> <span class="n">group_id</span><span class="p">,</span> <span class="n">chord</span><span class="p">,</span> <span class="n">root_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generator for the frozen flattened group tasks.</span>

<span class="sd">        Creates a flattened list of the tasks in the group, and freezes</span>
<span class="sd">        each task in the group. Nested groups will be recursively flattened.</span>

<span class="sd">        Exhausting the generator will create a new list of the flattened</span>
<span class="sd">        tasks in the group and will return it in the new_tasks argument.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            new_tasks (list): The list to append the flattened tasks to.</span>
<span class="sd">            group_id (str): The group_id to use for the tasks.</span>
<span class="sd">            chord (Chord): The chord to use for the tasks.</span>
<span class="sd">            root_id (str): The root_id to use for the tasks.</span>
<span class="sd">            parent_id (str): The parent_id to use for the tasks.</span>

<span class="sd">        Yields:</span>
<span class="sd">            AsyncResult: The frozen task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=redefined-outer-name</span>
        <span class="c1">#   XXX chord is also a class in outer scope.</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
        <span class="n">group_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">maybe_signature</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">popleft</span><span class="p">(),</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="c1"># if this is a group, flatten it by adding all of the group&#39;s tasks to the stack</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">extendleft</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">task</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
                                  <span class="n">chord</span><span class="o">=</span><span class="n">chord</span><span class="p">,</span> <span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">,</span>
                                  <span class="n">parent_id</span><span class="o">=</span><span class="n">parent_id</span><span class="p">,</span>
                                  <span class="n">group_index</span><span class="o">=</span><span class="n">group_index</span><span class="p">)</span>
                <span class="n">group_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">remove_repeating_from_task</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;task&#39;</span><span class="p">],</span>
                <span class="sa">f</span><span class="s1">&#39;group(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="si">!r}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;group(&lt;empty&gt;)&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">app</span>
            <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">app</span> <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">current_app</span></div>



<span class="nd">@Signature</span><span class="o">.</span><span class="n">register_type</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;chord&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_chord</span><span class="p">(</span><span class="n">Signature</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Barrier synchronization primitive.</span>

<span class="sd">    A chord consists of a header and a body.</span>

<span class="sd">    The header is a group of tasks that must complete before the callback is</span>
<span class="sd">    called.  A chord is essentially a callback for a group of tasks.</span>

<span class="sd">    The body is applied with the return values of all the header</span>
<span class="sd">    tasks as a list.</span>

<span class="sd">    Example:</span>

<span class="sd">        The chord:</span>

<span class="sd">        .. code-block:: pycon</span>

<span class="sd">            &gt;&gt;&gt; res = chord([add.s(2, 2), add.s(4, 4)])(sum_task.s())</span>

<span class="sd">        is effectively :math:`\Sigma ((2 + 2) + (4 + 4))`:</span>

<span class="sd">        .. code-block:: pycon</span>

<span class="sd">            &gt;&gt;&gt; res.get()</span>
<span class="sd">            12</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a chord signature from a dictionary that represents a chord.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; chord_dict = {</span>
<span class="sd">                &quot;task&quot;: &quot;celery.chord&quot;,</span>
<span class="sd">                &quot;args&quot;: [],</span>
<span class="sd">                &quot;kwargs&quot;: {</span>
<span class="sd">                    &quot;kwargs&quot;: {},</span>
<span class="sd">                    &quot;header&quot;: [</span>
<span class="sd">                        {</span>
<span class="sd">                            &quot;task&quot;: &quot;add&quot;,</span>
<span class="sd">                            &quot;args&quot;: [</span>
<span class="sd">                                1,</span>
<span class="sd">                                2</span>
<span class="sd">                            ],</span>
<span class="sd">                            &quot;kwargs&quot;: {},</span>
<span class="sd">                            &quot;options&quot;: {},</span>
<span class="sd">                            &quot;subtask_type&quot;: None,</span>
<span class="sd">                            &quot;immutable&quot;: False</span>
<span class="sd">                        },</span>
<span class="sd">                        {</span>
<span class="sd">                            &quot;task&quot;: &quot;add&quot;,</span>
<span class="sd">                            &quot;args&quot;: [</span>
<span class="sd">                                3,</span>
<span class="sd">                                4</span>
<span class="sd">                            ],</span>
<span class="sd">                            &quot;kwargs&quot;: {},</span>
<span class="sd">                            &quot;options&quot;: {},</span>
<span class="sd">                            &quot;subtask_type&quot;: None,</span>
<span class="sd">                            &quot;immutable&quot;: False</span>
<span class="sd">                        }</span>
<span class="sd">                    ],</span>
<span class="sd">                    &quot;body&quot;: {</span>
<span class="sd">                        &quot;task&quot;: &quot;xsum&quot;,</span>
<span class="sd">                        &quot;args&quot;: [],</span>
<span class="sd">                        &quot;kwargs&quot;: {},</span>
<span class="sd">                        &quot;options&quot;: {},</span>
<span class="sd">                        &quot;subtask_type&quot;: None,</span>
<span class="sd">                        &quot;immutable&quot;: False</span>
<span class="sd">                    }</span>
<span class="sd">                },</span>
<span class="sd">                &quot;options&quot;: {},</span>
<span class="sd">                &quot;subtask_type&quot;: &quot;chord&quot;,</span>
<span class="sd">                &quot;immutable&quot;: False</span>
<span class="sd">            }</span>
<span class="sd">            &gt;&gt;&gt; chord_sig = chord.from_dict(chord_dict)</span>

<span class="sd">        Iterates over the given tasks in the dictionary and convert them to signatures.</span>
<span class="sd">        Chord header needs to be defined in d[&#39;kwargs&#39;][&#39;header&#39;] as a sequence</span>
<span class="sd">        of tasks.</span>
<span class="sd">        Chord body needs to be defined in d[&#39;kwargs&#39;][&#39;body&#39;] as a single task.</span>

<span class="sd">        The tasks themselves can be dictionaries or signatures (or both).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_unpack_args</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_unpack_args</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Python signatures are better at extracting keys from dicts</span>
        <span class="c1"># than manually popping things off.</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">),</span> <span class="n">kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s1">&#39;celery.chord&#39;</span><span class="p">,</span>
                 <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{</span><span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
                         <span class="p">{</span><span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="n">_maybe_group</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">app</span><span class="p">),</span>
                          <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">maybe_signature</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)},</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span>
                         <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subtask_type</span> <span class="o">=</span> <span class="s1">&#39;chord&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((),</span> <span class="p">{</span><span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="n">body</span><span class="p">}</span> <span class="k">if</span> <span class="n">body</span> <span class="k">else</span> <span class="p">{},</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">_chain</span><span class="p">))</span> <span class="ow">and</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Signature</span><span class="p">)):</span>
            <span class="c1"># chord | task -&gt;  attach to body</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">sig</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">body</span> <span class="o">|</span> <span class="n">other</span>
            <span class="k">return</span> <span class="n">sig</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># chord | group -&gt; chain with chord body.</span>
            <span class="c1"># unroll group with one member</span>
            <span class="n">other</span> <span class="o">=</span> <span class="n">maybe_unroll_group</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">sig</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">body</span> <span class="o">|</span> <span class="n">other</span>
            <span class="k">return</span> <span class="n">sig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__or__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">freeze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">root_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">group_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># pylint: disable=redefined-outer-name</span>
        <span class="c1">#   XXX chord is also a class in outer scope.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
        <span class="c1"># first freeze all tasks in the header</span>
        <span class="n">header_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span>
            <span class="n">parent_id</span><span class="o">=</span><span class="n">parent_id</span><span class="p">,</span> <span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">,</span> <span class="n">chord</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># secondly freeze all tasks in the body: those that should be called after the header</span>

        <span class="n">body_result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="n">body_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span>
                <span class="n">_id</span><span class="p">,</span> <span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">,</span> <span class="n">chord</span><span class="o">=</span><span class="n">chord</span><span class="p">,</span> <span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span>
                <span class="n">group_index</span><span class="o">=</span><span class="n">group_index</span><span class="p">)</span>
            <span class="c1"># we need to link the body result back to the group result,</span>
            <span class="c1"># but the body may actually be a chain,</span>
            <span class="c1"># so find the first result without a parent</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">body_result</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">node</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Recursive result parents&#39;</span><span class="p">)</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">header_result</span>
                    <span class="k">break</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>

        <span class="k">return</span> <span class="n">body_result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">append_stamps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">):</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">tasks</span>

        <span class="n">visitor_headers</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">visitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visitor_headers</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">on_chord_header_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stamp_headers</span><span class="p">(</span><span class="n">visitor_headers</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stamp_links</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">_regen</span><span class="p">):</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_partial</span><span class="p">(</span><span class="n">_stamp_regen_task</span><span class="p">,</span> <span class="n">visitor</span><span class="o">=</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="o">=</span><span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stamps</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">stamps</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">visitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visitor</span><span class="o">.</span><span class="n">on_chord_header_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">visitor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">visitor_headers</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">on_chord_body</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stamp_headers</span><span class="p">(</span><span class="n">visitor_headers</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span> <span class="n">append_stamps</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">producer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">publisher</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">router</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">result_cls</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">immutable</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_app</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
                 <span class="k">else</span> <span class="n">group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_id&#39;</span><span class="p">,</span> <span class="n">uuid</span><span class="p">())))</span>
        <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">task_always_eager</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">allow_join_result</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span>
                                  <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

        <span class="n">merged_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="n">option_task_id</span> <span class="o">=</span> <span class="n">merged_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;task_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task_id</span> <span class="o">=</span> <span class="n">option_task_id</span>

        <span class="c1"># chord([A, B, ...], C)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">merged_options</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">propagate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">body</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
                 <span class="k">else</span> <span class="n">group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">body</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tasks</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">propagate</span><span class="o">=</span><span class="n">propagate</span><span class="p">),),</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_descend</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sig_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count the number of tasks in the given signature recursively.</span>

<span class="sd">        Descend into the signature object and return the amount of tasks it contains.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Sometimes serialized signatures might make their way here</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sig_obj</span><span class="p">,</span> <span class="n">Signature</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sig_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">sig_obj</span> <span class="o">=</span> <span class="n">Signature</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">sig_obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sig_obj</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
            <span class="c1"># Each task in a group counts toward this chord</span>
            <span class="n">subtasks</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sig_obj</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="s2">&quot;tasks&quot;</span><span class="p">,</span> <span class="n">sig_obj</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_descend</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">subtasks</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sig_obj</span><span class="p">,</span> <span class="n">_chain</span><span class="p">):</span>
            <span class="c1"># The last non-empty element in a chain counts toward this chord</span>
            <span class="k">for</span> <span class="n">child_sig</span> <span class="ow">in</span> <span class="n">sig_obj</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">child_size</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_descend</span><span class="p">(</span><span class="n">child_sig</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">child_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">child_size</span>
            <span class="c1"># We have to just hope this chain is part of some encapsulating</span>
            <span class="c1"># signature which is valid and can fire the chord body</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sig_obj</span><span class="p">,</span> <span class="n">chord</span><span class="p">):</span>
            <span class="c1"># The child chord&#39;s body counts toward this chord</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_descend</span><span class="p">(</span><span class="n">sig_obj</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sig_obj</span><span class="p">,</span> <span class="n">Signature</span><span class="p">):</span>
            <span class="c1"># Each simple signature counts as 1 completion for this chord</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="c1"># Any other types are assumed to be iterables of simple signatures</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig_obj</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__length_hint__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of tasks in this chord&#39;s header (recursively).&quot;&quot;&quot;</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">,</span> <span class="s2">&quot;tasks&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_descend</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">partial_args</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">countdown</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eager</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">task_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the chord.</span>

<span class="sd">        Executing the chord means executing the header and sending the</span>
<span class="sd">        result to the body. In case of an empty header, the body is</span>
<span class="sd">        executed immediately.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            header (group): The header to execute.</span>
<span class="sd">            body (Signature): The body to execute.</span>
<span class="sd">            partial_args (tuple): Arguments to pass to the header.</span>
<span class="sd">            app (Celery): The Celery app instance.</span>
<span class="sd">            interval (float): The interval between retries.</span>
<span class="sd">            countdown (int): The countdown between retries.</span>
<span class="sd">            max_retries (int): The maximum number of retries.</span>
<span class="sd">            task_id (str): The task id to use for the body.</span>
<span class="sd">            kwargs (dict): Keyword arguments to pass to the header.</span>
<span class="sd">            options (dict): Options to pass to the header.</span>

<span class="sd">        Returns:</span>
<span class="sd">            AsyncResult: The result of the body (with the result of the header in the parent of the body).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">app</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_app</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;task_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">uuid</span><span class="p">()</span>
        <span class="n">root_id</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;root_id&#39;</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span> <span class="k">if</span> <span class="n">options</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
            <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;task_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">body</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="n">bodyres</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">)</span>

        <span class="c1"># Chains should not be passed to the header tasks. See #3771</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;chain&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Neither should chords, for deeply nested chords to work</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;chord&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;task_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">header_result_args</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">_freeze_group_tasks</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span> <span class="n">chord</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">root_id</span><span class="o">=</span><span class="n">root_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">apply_chord</span><span class="p">(</span>
                <span class="n">header_result_args</span><span class="p">,</span>
                <span class="n">body</span><span class="p">,</span>
                <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
                <span class="n">countdown</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span>
                <span class="n">max_retries</span><span class="o">=</span><span class="n">max_retries</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">header_result</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">partial_args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">task_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="c1"># The execution of a chord body is normally triggered by its header&#39;s</span>
        <span class="c1"># tasks completing. If the header is empty this will never happen, so</span>
        <span class="c1"># we execute the body manually here.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body</span><span class="o">.</span><span class="n">delay</span><span class="p">([])</span>
            <span class="n">header_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">GroupResult</span><span class="p">(</span><span class="o">*</span><span class="n">header_result_args</span><span class="p">)</span>

        <span class="n">bodyres</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">header_result</span>
        <span class="k">return</span> <span class="n">bodyres</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># need to make copy of body</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">signature</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maybe_signature</span><span class="p">(</span>
                <span class="n">signature</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">],</span> <span class="n">clone</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">signature</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Links a callback to the chord body only.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">callback</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">link_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Links an error callback to the chord body, and potentially the header as well.</span>

<span class="sd">        Note:</span>
<span class="sd">            The ``task_allow_error_cb_on_chord_header`` setting controls whether</span>
<span class="sd">            error callbacks are allowed on the header. If this setting is</span>
<span class="sd">            ``False`` (the current default), then the error callback will only be</span>
<span class="sd">            applied to the body.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errback</span> <span class="o">=</span> <span class="n">maybe_signature</span><span class="p">(</span><span class="n">errback</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">task_allow_error_cb_on_chord_header</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">maybe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">link_error</span><span class="p">(</span><span class="n">errback</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">immutable</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Once this warning is removed, the whole method needs to be refactored to:</span>
            <span class="c1"># 1. link the error callback to each task in the header</span>
            <span class="c1"># 2. link the error callback to the body</span>
            <span class="c1"># 3. return the error callback</span>
            <span class="c1"># In summary, up to 4 lines of code + updating the method docstring.</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;task_allow_error_cb_on_chord_header=False is pending deprecation in &quot;</span>
                <span class="s2">&quot;a future release of Celery.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Please test the new behavior by setting task_allow_error_cb_on_chord_header to True &quot;</span>
                <span class="s2">&quot;and report any concerns you might have in our issue tracker before we make a final decision &quot;</span>
                <span class="s2">&quot;regarding how errbacks should behave when used with chords.&quot;</span><span class="p">,</span>
                <span class="n">CPendingDeprecationWarning</span>
            <span class="p">)</span>

        <span class="c1"># Edge case for nested chords in the header</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">maybe_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">chord</span><span class="p">):</span>
                <span class="c1"># Let the nested chord do the error linking itself on its</span>
                <span class="c1"># header and body where needed, based on the current configuration</span>
                <span class="n">task</span><span class="o">.</span><span class="n">link_error</span><span class="p">(</span><span class="n">errback</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">link_error</span><span class="p">(</span><span class="n">errback</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">errback</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_immutable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">immutable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sets the immutable flag on the chord header only.</span>

<span class="sd">        Note:</span>
<span class="sd">            Does not affect the chord body.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            immutable (bool): The new mutability value for chord header.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_immutable</span><span class="p">(</span><span class="n">immutable</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="n">_chain</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">remove_repeating_from_task</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;task&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;%(</span><span class="si">{}</span><span class="s1"> | </span><span class="si">{!r}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reprcall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">),</span>
                        <span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">app</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="n">remove_repeating_from_task</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">reprcall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">))</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;chord without body: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="si">!r}</span><span class="s1">&gt;&#39;</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_app</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">tasks</span>  <span class="c1"># is a group</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span>
            <span class="k">if</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="n">app</span> <span class="o">=</span> <span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">_app</span>
            <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">app</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">_app</span>
        <span class="k">return</span> <span class="n">app</span> <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">current_app</span>

    <span class="n">tasks</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;kwargs.header&#39;</span><span class="p">,</span> <span class="s1">&#39;Tasks in chord header.&#39;</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">getitem_property</span><span class="p">(</span><span class="s1">&#39;kwargs.body&#39;</span><span class="p">,</span> <span class="s1">&#39;Body task of chord.&#39;</span><span class="p">)</span>


<span class="c1"># Add a back-compat alias for the previous `chord` class name which conflicts</span>
<span class="c1"># with keyword arguments elsewhere in this file</span>
<span class="n">chord</span> <span class="o">=</span> <span class="n">_chord</span>


<div class="viewcode-block" id="signature">
<a class="viewcode-back" href="../../reference/celery.html#celery.signature">[文档]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">signature</span><span class="p">(</span><span class="n">varies</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create new signature.</span>

<span class="sd">    - if the first argument is a signature already then it&#39;s cloned.</span>
<span class="sd">    - if the first argument is a dict, then a Signature version is returned.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Signature: The resulting signature.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varies</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">varies</span><span class="p">,</span> <span class="n">abstract</span><span class="o">.</span><span class="n">CallableSignature</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">varies</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Signature</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">varies</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Signature</span><span class="p">(</span><span class="n">varies</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<span class="n">subtask</span> <span class="o">=</span> <span class="n">signature</span>  <span class="c1"># XXX compat</span>


<span class="k">def</span><span class="w"> </span><span class="nf">maybe_signature</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clone</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure obj is a signature, or None.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        d (Optional[Union[abstract.CallableSignature, Mapping]]):</span>
<span class="sd">            Signature or dict-serialized signature.</span>
<span class="sd">        app (celery.Celery):</span>
<span class="sd">            App to bind signature to.</span>
<span class="sd">        clone (bool):</span>
<span class="sd">            If d&#39; is already a signature, the signature</span>
<span class="sd">           will be cloned when this flag is enabled.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[abstract.CallableSignature]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">abstract</span><span class="o">.</span><span class="n">CallableSignature</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">clone</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">_app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="n">maybe_subtask</span> <span class="o">=</span> <span class="n">maybe_signature</span>  <span class="c1"># XXX compat</span>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../../copyright.html">Copyright</a> &#169; 2009-2023, Ask Solem &amp; contributors
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=8156d91f"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/tabs.js?v=3ee01567"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=5eb1bb1e"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../../_static/translations.js?v=beaddf03"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    </body>
</html>