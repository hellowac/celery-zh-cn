<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="copyright" title="版权所有" href="../copyright.html" /><link rel="next" title="守护进程" href="daemonizing.html" /><link rel="prev" title="Canvas：设计工作流" href="canvas.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>Workers 指南 - Celery 5.5.1 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=3ee1c6c6" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/my.css?v=112ca36d" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Celery 5.5.1 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/celery_512_1.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Celery 5.5.1 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">版权</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../getting-started/index.html">快速开始</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 快速开始</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/introduction.html">Celery 简介</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../getting-started/backends-and-brokers/index.html">Backends 和 Brokers</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Backends 和 Brokers</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/rabbitmq.html">使用 RabbitMQ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/redis.html">使用 Redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/sqs.html">使用 Amazon SQS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/kafka.html">使用 Kafka</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/gcpubsub.html">使用 Google Pub/Sub</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/first-steps-with-celery.html">使用 Celery 的第一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/next-steps.html">下一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/resources.html">资源</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">用户指南</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 用户指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="application.html">应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="tasks.html">任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="calling.html">调用任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="canvas.html">Canvas：设计工作流</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Workers 指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="daemonizing.html">守护进程</a></li>
<li class="toctree-l2"><a class="reference internal" href="periodic-tasks.html">周期性任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="routing.html">路由任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">监控和管理指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimizing.html">优化</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">调试</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="concurrency/index.html">并发</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 并发</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="concurrency/eventlet.html">Eventlet 并发</a></li>
<li class="toctree-l3"><a class="reference internal" href="concurrency/gevent.html">gevent 并发</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="signals.html">信号</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">使用 Celery 进行测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="extending.html">扩展 和 Bootsteps</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">配置和默认值</a></li>
<li class="toctree-l2"><a class="reference internal" href="sphinx.html">使用 Sphinx 文档化任务</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../django/index.html">Django</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Django</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../django/first-steps-with-django.html">使用 Django 的第一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community.html">社区资源</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials/index.html">教程</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 教程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/task-cookbook.html">Task Cookbook</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">更改历史</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">API 参考</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of API 参考</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/cli.html">命令行接口</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">celery</span></code> --- Distributed processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.html">Proxies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.html#functions">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.task.html"><code class="docutils literal notranslate"><span class="pre">celery.app.task</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.amqp.html">AMQP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.amqp.html#queues">Queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.defaults.html"><code class="docutils literal notranslate"><span class="pre">celery.app.defaults</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.control.html"><code class="docutils literal notranslate"><span class="pre">celery.app.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.registry.html"><code class="docutils literal notranslate"><span class="pre">celery.app.registry</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.backends.html"><code class="docutils literal notranslate"><span class="pre">celery.app.backends</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.builtins.html"><code class="docutils literal notranslate"><span class="pre">celery.app.builtins</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.events.html"><code class="docutils literal notranslate"><span class="pre">celery.app.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.log.html"><code class="docutils literal notranslate"><span class="pre">celery.app.log</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.app.utils</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.autoretry.html"><code class="docutils literal notranslate"><span class="pre">celery.app.autoretry</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bootsteps.html"><code class="docutils literal notranslate"><span class="pre">celery.bootsteps</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.result.html"><code class="docutils literal notranslate"><span class="pre">celery.result</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.schedules.html"><code class="docutils literal notranslate"><span class="pre">celery.schedules</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.signals.html"><code class="docutils literal notranslate"><span class="pre">celery.signals</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.security.html"><code class="docutils literal notranslate"><span class="pre">celery.security</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.utils.debug.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.debug</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.exceptions.html"><code class="docutils literal notranslate"><span class="pre">celery.exceptions</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.app.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.app</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.default.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.default</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.base.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.base</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html">States</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#sets">Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#misc">Misc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.FAILURE"><code class="docutils literal notranslate"><span class="pre">FAILURE</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.PENDING"><code class="docutils literal notranslate"><span class="pre">PENDING</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.RECEIVED"><code class="docutils literal notranslate"><span class="pre">RECEIVED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.RETRY"><code class="docutils literal notranslate"><span class="pre">RETRY</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.REVOKED"><code class="docutils literal notranslate"><span class="pre">REVOKED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.STARTED"><code class="docutils literal notranslate"><span class="pre">STARTED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.SUCCESS"><code class="docutils literal notranslate"><span class="pre">SUCCESS</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.precedence"><code class="docutils literal notranslate"><span class="pre">precedence()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.state"><code class="docutils literal notranslate"><span class="pre">state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.abortable.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.abortable</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.django.task.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.django.task</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.migrate.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.migrate</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.pytest.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.pytest</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.sphinx.html">celery.contrib.sphinx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.app.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.app</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.manager.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.manager</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.mocks.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.mocks</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.rdb.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.rdb</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.html"><code class="docutils literal notranslate"><span class="pre">celery.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.receiver.html"><code class="docutils literal notranslate"><span class="pre">celery.events.receiver</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.dispatcher.html"><code class="docutils literal notranslate"><span class="pre">celery.events.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.event.html"><code class="docutils literal notranslate"><span class="pre">celery.events.event</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.state.html"><code class="docutils literal notranslate"><span class="pre">celery.events.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.multi.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.multi</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.request.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.request</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.state.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.strategy.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.strategy</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.agent.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.agent</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.connection.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.connection</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.consumer.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.consumer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.control.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.events.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.gossip.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.gossip</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.heart.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.heart</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.mingle.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.mingle</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.tasks.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.tasks</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.base.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.base</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.celery.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.celery</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.events.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.logtool.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.logtool</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.amqp.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.amqp</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.graph.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.graph</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.multi.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.multi</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.call.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.call</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.control.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.list.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.list</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.migrate.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.migrate</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.purge.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.purge</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.result.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.result</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.shell.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.shell</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.upgrade.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.upgrade</span></code></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../internals/index.html">内部</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of 内部</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../internals/guide.html">代码贡献指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/deprecation.html">Celery 弃用时间表</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/worker.html">内部的 worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/protocol.html">消息协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/app-overview.html">“大实例”重构</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../internals/reference/index.html">内部模块参考</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 内部模块参考</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.components.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.components</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.loops.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.loops</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.heartbeat.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.heartbeat</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.control.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.control</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.pidbox.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.pidbox</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.autoscale.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.autoscale</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.solo.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.solo</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.prefork.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.prefork</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.eventlet.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.eventlet</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.gevent.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.gevent</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.thread.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.thread</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.base.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.base</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.html"><code class="docutils literal notranslate"><span class="pre">celery.backends</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.base.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.base</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.asynchronous.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.asynchronous</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.azureblockblob.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.azureblockblob</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.rpc.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.rpc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cache.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cache</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.consul.html">celery.backends.consul</a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.couchdb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.couchdb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.mongodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.mongodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.elasticsearch.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.elasticsearch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.redis.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.redis</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cassandra.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cassandra</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.couchbase.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.couchbase</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.arangodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.arangodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.dynamodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.dynamodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.filesystem.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.filesystem</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cosmosdbsql.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cosmosdbsql</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.s3.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.s3</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.gcs.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.gcs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.trace.html"><code class="docutils literal notranslate"><span class="pre">celery.app.trace</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.annotations.html"><code class="docutils literal notranslate"><span class="pre">celery.app.annotations</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.routes.html"><code class="docutils literal notranslate"><span class="pre">celery.app.routes</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.certificate.html"><code class="docutils literal notranslate"><span class="pre">celery.security.certificate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.key.html"><code class="docutils literal notranslate"><span class="pre">celery.security.key</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.serialization.html"><code class="docutils literal notranslate"><span class="pre">celery.security.serialization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.security.utils</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.snapshot.html"><code class="docutils literal notranslate"><span class="pre">celery.events.snapshot</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.cursesmon.html"><code class="docutils literal notranslate"><span class="pre">celery.events.cursesmon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.dumper.html"><code class="docutils literal notranslate"><span class="pre">celery.events.dumper</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.models.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database.models</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.session.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database.session</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.utils</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.abstract.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.abstract</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.collections.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.collections</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.nodenames.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.nodenames</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.deprecated.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.deprecated</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.functional.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.functional</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.graph.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.graph</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.objects.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.objects</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.term.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.term</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.time.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.time</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.iso8601.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.iso8601</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.saferepr.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.saferepr</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.serialization.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.serialization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.sysinfo.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.sysinfo</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.threads.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.threads</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.timer2.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.timer2</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.imports.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.imports</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.log.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.text.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.text</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.dispatch.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.dispatch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.dispatch.signal.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.dispatch.signal</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.platforms.html"><code class="docutils literal notranslate"><span class="pre">celery.platforms</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery._state.html"><code class="docutils literal notranslate"><span class="pre">celery._state</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../history/index.html">历史</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of 历史</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.5.html">What's new in Celery 5.5 (Immunity)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.5.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.4.html">What's new in Celery 5.4 (Opalescent)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.4.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.3.html">What's new in Celery 5.3 (Emerald Rush)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.3.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.1.html">What's new in Celery 5.1 (Sun Harmonics)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.0.html">What's new in Celery 5.0 (singularity)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.0.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.4.html">What's new in Celery 4.4 (Cliffs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.4.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.3.html">What's new in Celery 4.3 (rhubarb)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.3.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.2.html">What's new in Celery 4.2 (windowlicker)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.2.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.1.html">What's new in Celery 4.1 (latentcall)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.0.html">What's new in Celery 4.0 (latentcall)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.0.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-3.1.html">What's new in Celery 3.1 (Cipater)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-3.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-3.0.html">What's new in Celery 3.0 (Chiastic Slide)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-3.0.html">Change history for Celery 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-2.5.html">What's new in Celery 2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.5.html">Change history for Celery 2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.4.html">Change history for Celery 2.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.3.html">Change history for Celery 2.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.2.html">Change history for Celery 2.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.1.html">Change history for Celery 2.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.0.html">Change history for Celery 2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-1.0.html">Change history for Celery 1.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">术语</a></li>
</ul>

</div>
<!-- <iframe src="https://ghbtns.com/github-btn.html?user=celery&repo=celery&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe> -->
<div id="donate">
  <h5>捐赠</h5>
  <p>请捐赠以支持这个社区项目</p>
  <a href="https://opencollective.com/celery/donate" target="_blank">
    <!-- <img src="https://opencollective.com/celery/donate/button@2x.png?color=blue" /> -->
    <img src="https://opencollective.com/celery/donate/button.png?color=blue" />
  </a>
</div></div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/userguide/workers.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="workers">
<span id="guide-workers"></span><h1>Workers 指南<a class="headerlink" href="#workers" title="Link to this heading">¶</a></h1>
<p>Workers Guide</p>
<section id="worker">
<span id="worker-starting"></span><h2>启动 worker<a class="headerlink" href="#worker" title="Link to this heading">¶</a></h2>
<p>Starting the worker</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">中文</label><div class="tab-content docutils container">
<div class="admonition-daemonizing admonition">
<p class="admonition-title">守护进程化（Daemonizing）</p>
<p>你可能希望使用守护进程工具将 worker 以后台进程的方式启动。
请参阅 <a class="reference internal" href="daemonizing.html#daemonizing"><span class="std std-ref">守护进程</span></a>，了解如何使用常见的服务管理器将 worker 启动为守护进程。</p>
</div>
<p>你也可以通过以下命令在前台启动 worker：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>-l<span class="w"> </span>INFO
</pre></div>
</div>
<p>要查看完整的命令行选项列表，请参阅 <a class="reference internal" href="../reference/celery.bin.worker.html#module-celery.bin.worker" title="celery.bin.worker"><code class="xref py py-mod docutils literal notranslate"><span class="pre">worker</span></code></a>，或直接运行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>worker<span class="w"> </span>--help
</pre></div>
</div>
<p>你可以在同一台机器上启动多个 worker，但请确保通过 <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-n"><code class="xref std std-option docutils literal notranslate"><span class="pre">--hostname</span></code></a> 参数为每个 worker 指定唯一的节点名：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>--loglevel<span class="o">=</span>INFO<span class="w"> </span>--concurrency<span class="o">=</span><span class="m">10</span><span class="w"> </span>-n<span class="w"> </span>worker1@%h
<span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>--loglevel<span class="o">=</span>INFO<span class="w"> </span>--concurrency<span class="o">=</span><span class="m">10</span><span class="w"> </span>-n<span class="w"> </span>worker2@%h
<span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>--loglevel<span class="o">=</span>INFO<span class="w"> </span>--concurrency<span class="o">=</span><span class="m">10</span><span class="w"> </span>-n<span class="w"> </span>worker3@%h
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">hostname</span></code> 参数支持以下变量展开：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">%h</span></code>：主机名，包含域名。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%n</span></code>：仅主机名。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%d</span></code>：仅域名。</p></li>
</ul>
<p>假设当前主机名为 <em>george.example.com</em>，这些变量将被展开为：</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>变量</p></td>
<td><p>模板</p></td>
<td><p>展开结果</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">worker1&#64;%h</span></code></p></td>
<td><p><em>worker1&#64;george.example.com</em></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">%n</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">worker1&#64;%n</span></code></p></td>
<td><p><em>worker1&#64;george</em></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%d</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">worker1&#64;%d</span></code></p></td>
<td><p><em>worker1&#64;example.com</em></p></td>
</tr>
</tbody>
</table>
</div>
<div class="admonition-pypi-supervisor admonition">
<p class="admonition-title">针对 <a class="extlink-pypi reference external" href="https://pypi.org/project/supervisor/">https://pypi.org/project/supervisor/</a> 用户的注意事项</p>
<p><code class="docutils literal notranslate"><span class="pre">%</span></code> 符号必须通过添加第二个 <code class="docutils literal notranslate"><span class="pre">%</span></code> 进行转义： <cite>%%h</cite>。</p>
</div>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">英文</label><div class="tab-content docutils container">
<div class="admonition-daemonizing admonition">
<p class="admonition-title">Daemonizing</p>
<p>You probably want to use a daemonization tool to start
the worker in the background. See <a class="reference internal" href="daemonizing.html#daemonizing"><span class="std std-ref">守护进程</span></a> for help
starting the worker as a daemon using popular service managers.</p>
</div>
<p>You can start the worker in the foreground by executing the command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>-l<span class="w"> </span>INFO
</pre></div>
</div>
<p>For a full list of available command-line options see
<a class="reference internal" href="../reference/celery.bin.worker.html#module-celery.bin.worker" title="celery.bin.worker"><code class="xref py py-mod docutils literal notranslate"><span class="pre">worker</span></code></a>, or simply do:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>worker<span class="w"> </span>--help
</pre></div>
</div>
<p>You can start multiple workers on the same machine, but
be sure to name each individual worker by specifying a
node name with the <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-n"><code class="xref std std-option docutils literal notranslate"><span class="pre">--hostname</span></code></a> argument:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>--loglevel<span class="o">=</span>INFO<span class="w"> </span>--concurrency<span class="o">=</span><span class="m">10</span><span class="w"> </span>-n<span class="w"> </span>worker1@%h
<span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>--loglevel<span class="o">=</span>INFO<span class="w"> </span>--concurrency<span class="o">=</span><span class="m">10</span><span class="w"> </span>-n<span class="w"> </span>worker2@%h
<span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>--loglevel<span class="o">=</span>INFO<span class="w"> </span>--concurrency<span class="o">=</span><span class="m">10</span><span class="w"> </span>-n<span class="w"> </span>worker3@%h
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">hostname</span></code> argument can expand the following variables:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">%h</span></code>:  Hostname, including domain name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%n</span></code>:  Hostname only.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%d</span></code>:  Domain name only.</p></li>
</ul>
<p>If the current hostname is <em>george.example.com</em>, these will expand to:</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Variable</p></td>
<td><p>Template</p></td>
<td><p>Result</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">worker1&#64;%h</span></code></p></td>
<td><p><em>worker1&#64;george.example.com</em></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">%n</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">worker1&#64;%n</span></code></p></td>
<td><p><em>worker1&#64;george</em></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">%d</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">worker1&#64;%d</span></code></p></td>
<td><p><em>worker1&#64;example.com</em></p></td>
</tr>
</tbody>
</table>
</div>
<div class="admonition-note-for-pypi-supervisor-users admonition">
<p class="admonition-title">Note for <a class="extlink-pypi reference external" href="https://pypi.org/project/supervisor/">https://pypi.org/project/supervisor/</a> users</p>
<p>The <code class="docutils literal notranslate"><span class="pre">%</span></code> sign must be escaped by adding a second one: <cite>%%h</cite>.</p>
</div>
</div>
</div>
</section>
<section id="worker-stopping">
<span id="id1"></span><h2>停止 worker<a class="headerlink" href="#worker-stopping" title="Link to this heading">¶</a></h2>
<p>Stopping the worker</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">中文</label><div class="tab-content docutils container">
<p>建议使用 <code class="xref std std-sig docutils literal notranslate"><span class="pre">TERM</span></code> 信号来关闭 worker。</p>
<p>当关闭被触发时，worker 会在实际退出前完成所有正在执行的任务。如果这些任务很重要，你应该等待它们完成后再执行进一步操作，例如发送 <code class="xref std std-sig docutils literal notranslate"><span class="pre">KILL</span></code> 信号这类激进的命令。</p>
<p>如果 worker 在合理时间内无法关闭（例如陷入死循环等），可以使用 <code class="xref std std-sig docutils literal notranslate"><span class="pre">KILL</span></code> 信号强制终止它；但请注意，此时正在执行的任务将会丢失（即除非这些任务设置了 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.acks_late" title="celery.app.task.Task.acks_late"><code class="xref py py-attr docutils literal notranslate"><span class="pre">acks_late</span></code></a> 选项）。</p>
<p>此外，由于进程无法拦截 <code class="xref std std-sig docutils literal notranslate"><span class="pre">KILL</span></code> 信号，worker 将无法回收其子进程；你需要手动执行清理。以下命令通常可以完成这项工作：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pkill<span class="w"> </span>-9<span class="w"> </span>-f<span class="w"> </span><span class="s1">&#39;celery worker&#39;</span>
</pre></div>
</div>
<p>如果你的系统中没有 <strong class="command">pkill</strong> 命令，也可以使用稍长一点的替代方式：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ps<span class="w"> </span>auxww<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;/celery worker/ {print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span><span class="nb">kill</span><span class="w"> </span>-9
</pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">在 5.2 版本发生变更: </span>在 Linux 系统上，Celery 现在支持在 worker 终止后向所有子进程发送 <code class="xref std std-sig docutils literal notranslate"><span class="pre">KILL</span></code> 信号。
这是通过 <code class="docutils literal notranslate"><span class="pre">prctl(2)</span></code> 的 <cite>PR_SET_PDEATHSIG</cite> 选项实现的。</p>
</div>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">英文</label><div class="tab-content docutils container">
<p>Shutdown should be accomplished using the <code class="xref std std-sig docutils literal notranslate"><span class="pre">TERM</span></code> signal.</p>
<p>When shutdown is initiated the worker will finish all currently executing
tasks before it actually terminates. If these tasks are important, you should
wait for it to finish before doing anything drastic, like sending the <code class="xref std std-sig docutils literal notranslate"><span class="pre">KILL</span></code>
signal.</p>
<p>If the worker won't shutdown after considerate time, for being
stuck in an infinite-loop or similar, you can use the <code class="xref std std-sig docutils literal notranslate"><span class="pre">KILL</span></code> signal to
force terminate the worker: but be aware that currently executing tasks will
be lost (i.e., unless the tasks have the <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.acks_late" title="celery.app.task.Task.acks_late"><code class="xref py py-attr docutils literal notranslate"><span class="pre">acks_late</span></code></a>
option set).</p>
<p>Also as processes can't override the <code class="xref std std-sig docutils literal notranslate"><span class="pre">KILL</span></code> signal, the worker will
not be able to reap its children; make sure to do so manually. This
command usually does the trick:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pkill<span class="w"> </span>-9<span class="w"> </span>-f<span class="w"> </span><span class="s1">&#39;celery worker&#39;</span>
</pre></div>
</div>
<p>If you don't have the <strong class="command">pkill</strong> command on your system, you can use the slightly
longer version:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ps<span class="w"> </span>auxww<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;/celery worker/ {print $2}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span><span class="nb">kill</span><span class="w"> </span>-9
</pre></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">在 5.2 版本发生变更: </span>On Linux systems, Celery now supports sending <code class="xref std std-sig docutils literal notranslate"><span class="pre">KILL</span></code> signal to all child processes
after worker termination. This is done via <cite>PR_SET_PDEATHSIG</cite> option of <code class="docutils literal notranslate"><span class="pre">prctl(2)</span></code>.</p>
</div>
</div>
</div>
<section id="worker-shutdown">
<span id="id2"></span><h3>关闭 worker<a class="headerlink" href="#worker-shutdown" title="Link to this heading">¶</a></h3>
<p>Worker Shutdown</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">中文</label><div class="tab-content docutils container">
<p>我们将使用 <em>Warm（温）、Soft（软）、Cold（冷）、Hard（硬）</em> 这几个术语来描述 worker 关闭的不同阶段。
当收到 <code class="xref std std-sig docutils literal notranslate"><span class="pre">TERM</span></code> 或 <code class="xref std std-sig docutils literal notranslate"><span class="pre">QUIT</span></code> 信号时，worker 会启动关闭流程。
在关闭流程中，<code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> （Ctrl-C）信号同样会被处理，并始终触发下一个关闭阶段。</p>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">英文</label><div class="tab-content docutils container">
<p>We will use the terms <em>Warm, Soft, Cold, Hard</em> to describe the different stages of worker shutdown.
The worker will initiate the shutdown process when it receives the <code class="xref std std-sig docutils literal notranslate"><span class="pre">TERM</span></code> or <code class="xref std std-sig docutils literal notranslate"><span class="pre">QUIT</span></code> signal.
The <code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> (Ctrl-C) signal is also handled during the shutdown process and always triggers the
next stage of the shutdown process.</p>
</div>
</div>
<section id="worker-warm-shutdown">
<span id="id3"></span><h4>热关闭<a class="headerlink" href="#worker-warm-shutdown" title="Link to this heading">¶</a></h4>
<p>Warm Shutdown</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">中文</label><div class="tab-content docutils container">
<p>当 worker 收到 <code class="xref std std-sig docutils literal notranslate"><span class="pre">TERM</span></code> 信号时，会启动一次温关闭（warm shutdown）。
worker 会在终止之前完成当前正在执行的所有任务。
第一次收到 <code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> （Ctrl-C）信号时，也会启动一次温关闭。</p>
<p>温关闭会停止调用 <a class="reference internal" href="../reference/celery.worker.worker.html#celery.worker.worker.WorkController.start" title="celery.worker.worker.WorkController.start"><code class="xref py py-func docutils literal notranslate"><span class="pre">WorkController.start()</span></code></a>，
并调用 <a class="reference internal" href="../reference/celery.worker.worker.html#celery.worker.worker.WorkController.stop" title="celery.worker.worker.WorkController.stop"><code class="xref py py-func docutils literal notranslate"><span class="pre">WorkController.stop()</span></code></a>。</p>
<ul class="simple">
<li><p>在温关闭阶段，收到的后续 <code class="xref std std-sig docutils literal notranslate"><span class="pre">TERM</span></code> 信号将被忽略。</p></li>
<li><p>下一次收到 <code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> 信号将触发关闭流程的下一个阶段。</p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">英文</label><div class="tab-content docutils container">
<p>When the worker receives the <code class="xref std std-sig docutils literal notranslate"><span class="pre">TERM</span></code> signal, it will initiate a warm shutdown. The worker will
finish all currently executing tasks before it actually terminates. The first time the worker receives
the <code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> (Ctrl-C) signal, it will initiate a warm shutdown as well.</p>
<p>The warm shutdown will stop the call to <a class="reference internal" href="../reference/celery.worker.worker.html#celery.worker.worker.WorkController.start" title="celery.worker.worker.WorkController.start"><code class="xref py py-func docutils literal notranslate"><span class="pre">WorkController.start()</span></code></a>
and will call <a class="reference internal" href="../reference/celery.worker.worker.html#celery.worker.worker.WorkController.stop" title="celery.worker.worker.WorkController.stop"><code class="xref py py-func docutils literal notranslate"><span class="pre">WorkController.stop()</span></code></a>.</p>
<ul class="simple">
<li><p>Additional <code class="xref std std-sig docutils literal notranslate"><span class="pre">TERM</span></code> signals will be ignored during the warm shutdown process.</p></li>
<li><p>The next <code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> signal will trigger the next stage of the shutdown process.</p></li>
</ul>
</div>
</div>
</section>
<section id="worker-remap-sigterm">
<span id="worker-cold-shutdown"></span><span id="id4"></span><h4>冷关闭<a class="headerlink" href="#worker-remap-sigterm" title="Link to this heading">¶</a></h4>
<p>Cold Shutdown</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">中文</label><div class="tab-content docutils container">
<p>冷关机（Cold shutdown）在 worker 收到 <code class="xref std std-sig docutils literal notranslate"><span class="pre">QUIT</span></code> 信号时触发。此时 worker 会立即停止所有正在执行的任务并终止进程。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果环境变量 <code class="docutils literal notranslate"><span class="pre">REMAP_SIGTERM</span></code> 被设置为 <code class="docutils literal notranslate"><span class="pre">SIGQUIT</span></code>，那么当 worker 收到 <code class="xref std std-sig docutils literal notranslate"><span class="pre">TERM</span></code> 信号时也将会触发冷关机，而非温关机。</p>
</div>
<p>冷关机会停止对 <a class="reference internal" href="../reference/celery.worker.worker.html#celery.worker.worker.WorkController.start" title="celery.worker.worker.WorkController.start"><code class="xref py py-func docutils literal notranslate"><span class="pre">WorkController.start()</span></code></a> 的调用，并改为调用 <a class="reference internal" href="../reference/celery.worker.worker.html#celery.worker.worker.WorkController.terminate" title="celery.worker.worker.WorkController.terminate"><code class="xref py py-func docutils literal notranslate"><span class="pre">WorkController.terminate()</span></code></a>。</p>
<p>如果温关机已经开始，切换到冷关机时将运行一个名为 <code class="docutils literal notranslate"><span class="pre">on_cold_shutdown</span></code> 的信号处理器，用于从主进程中取消所有正在执行的任务，并可能触发 <a class="reference internal" href="#worker-soft-shutdown"><span class="std std-ref">软关闭</span></a>。</p>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">英文</label><div class="tab-content docutils container">
<p>Cold shutdown is initiated when the worker receives the <code class="xref std std-sig docutils literal notranslate"><span class="pre">QUIT</span></code> signal. The worker will stop
all currently executing tasks and terminate immediately.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>If the environment variable <code class="docutils literal notranslate"><span class="pre">REMAP_SIGTERM</span></code> is set to <code class="docutils literal notranslate"><span class="pre">SIGQUIT</span></code>, the worker will also initiate
a cold shutdown when it receives the <code class="xref std std-sig docutils literal notranslate"><span class="pre">TERM</span></code> signal instead of a warm shutdown.</p>
</div>
<p>The cold shutdown will stop the call to <a class="reference internal" href="../reference/celery.worker.worker.html#celery.worker.worker.WorkController.start" title="celery.worker.worker.WorkController.start"><code class="xref py py-func docutils literal notranslate"><span class="pre">WorkController.start()</span></code></a>
and will call <a class="reference internal" href="../reference/celery.worker.worker.html#celery.worker.worker.WorkController.terminate" title="celery.worker.worker.WorkController.terminate"><code class="xref py py-func docutils literal notranslate"><span class="pre">WorkController.terminate()</span></code></a>.</p>
<p>If the warm shutdown already started, the transition to cold shutdown will run a signal handler <code class="docutils literal notranslate"><span class="pre">on_cold_shutdown</span></code>
to cancel all currently executing tasks from the MainProcess and potentially trigger the <a class="reference internal" href="#worker-soft-shutdown"><span class="std std-ref">软关闭</span></a>.</p>
</div>
</div>
</section>
<section id="worker-soft-shutdown">
<span id="id5"></span><h4>软关闭<a class="headerlink" href="#worker-soft-shutdown" title="Link to this heading">¶</a></h4>
<p>Soft Shutdown</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.5.</span></p>
</div>
<p>软关机（Soft shutdown）是一种有时间限制的温关机，发生在冷关机之前。worker 会允许所有当前正在执行的任务在 <a class="reference internal" href="configuration.html#std-setting-worker_soft_shutdown_timeout"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_soft_shutdown_timeout</span></code></a> 指定的秒数内完成，然后才终止进程。如果时间限制到达，worker 将启动冷关机并取消所有正在执行的任务。如果在软关机期间收到 <code class="xref std std-sig docutils literal notranslate"><span class="pre">QUIT</span></code> 信号，worker 会取消所有任务，但仍会等待设定的时间限制结束后再终止，从而以更优雅的方式完成冷关机。</p>
<p>为了兼容旧有行为，软关机默认是禁用的。要启用软关机，需将 <a class="reference internal" href="configuration.html#std-setting-worker_soft_shutdown_timeout"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_soft_shutdown_timeout</span></code></a> 设置为一个正的浮点数。当没有任务正在运行时，软关机会被跳过。若希望在空闲状态下也强制执行软关机，还需启用 <a class="reference internal" href="configuration.html#std-setting-worker_enable_soft_shutdown_on_idle"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_enable_soft_shutdown_on_idle</span></code></a> 设置。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>如果 worker 当前没有运行任务，但有 ETA 任务被保留，除非启用了 <a class="reference internal" href="configuration.html#std-setting-worker_enable_soft_shutdown_on_idle"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_enable_soft_shutdown_on_idle</span></code></a>，软关机不会被触发，这可能导致冷关机期间任务丢失。使用 ETA 任务时，建议启用空闲时软关机功能。可根据实际部署情况尝试不同的 <a class="reference internal" href="configuration.html#std-setting-worker_soft_shutdown_timeout"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_soft_shutdown_timeout</span></code></a> 配置值，以最大程度减少任务丢失风险。</p>
</div>
<p>例如，当设置 <code class="docutils literal notranslate"><span class="pre">worker_soft_shutdown_timeout=3</span></code> 时，worker 会允许最多 3 秒的时间让正在执行的任务完成。如果时间到了，则执行冷关机并取消所有任务。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[INFO/MainProcess] Task myapp.long_running_task[6f748357-b2c7-456a-95de-f05c00504042] received</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 1/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 2/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 3/2000s</span>
<span class="go">^C</span>
<span class="go">worker: Hitting Ctrl+C again will initiate cold shutdown, terminating all running tasks!</span>

<span class="go">worker: Warm shutdown (MainProcess)</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 4/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 5/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 6/2000s</span>
<span class="go">^C</span>
<span class="go">worker: Hitting Ctrl+C again will terminate all running tasks!</span>
<span class="go">[WARNING/MainProcess] Initiating Soft Shutdown, terminating in 3 seconds</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 7/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 8/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 9/2000s</span>
<span class="go">[WARNING/MainProcess] Restoring 1 unacknowledged message(s)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>下一次 <code class="xref std std-sig docutils literal notranslate"><span class="pre">QUIT</span></code> 信号将在软关机中取消仍在运行的任务，但 worker 仍会等待时间限制结束才终止。</p></li>
<li><p>第二次（或之后的） <code class="xref std std-sig docutils literal notranslate"><span class="pre">QUIT</span></code> 或 <code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> 信号将会触发下一阶段的关机流程。</p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.5.</span></p>
</div>
<p>Soft shutdown is a time limited warm shutdown, initiated just before the cold shutdown. The worker will
allow <a class="reference internal" href="configuration.html#std-setting-worker_soft_shutdown_timeout"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_soft_shutdown_timeout</span></code></a> seconds for all currently executing tasks to finish before
it terminates. If the time limit is reached, the worker will initiate a cold shutdown and cancel all currently
executing tasks. If the <code class="xref std std-sig docutils literal notranslate"><span class="pre">QUIT</span></code> signal is received during the soft shutdown, the worker will cancel all
currently executing tasks but still wait for the time limit to finish before terminating, giving a chance for
the worker to perform the cold shutdown a little more gracefully.</p>
<p>The soft shutdown is disabled by default to maintain backward compatibility with the <a class="reference internal" href="#worker-cold-shutdown"><span class="std std-ref">冷关闭</span></a>
behavior. To enable the soft shutdown, set <a class="reference internal" href="configuration.html#std-setting-worker_soft_shutdown_timeout"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_soft_shutdown_timeout</span></code></a> to a positive float value.
The soft shutdown will be skipped if there are no tasks running. To force the soft shutdown, <em>also</em> enable the
<a class="reference internal" href="configuration.html#std-setting-worker_enable_soft_shutdown_on_idle"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_enable_soft_shutdown_on_idle</span></code></a> setting.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>If the worker is not running any task but has ETA tasks reserved, the soft shutdown will not be initiated
unless the <a class="reference internal" href="configuration.html#std-setting-worker_enable_soft_shutdown_on_idle"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_enable_soft_shutdown_on_idle</span></code></a> setting is enabled, which may lead to task loss
during the cold shutdown. When using ETA tasks, it is recommended to enable the soft shutdown on idle.
Experiment which <a class="reference internal" href="configuration.html#std-setting-worker_soft_shutdown_timeout"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_soft_shutdown_timeout</span></code></a> value works best for your setup to reduce the risk
of task loss to a minimum.</p>
</div>
<p>For example, when setting <code class="docutils literal notranslate"><span class="pre">worker_soft_shutdown_timeout=3</span></code>, the worker will allow 3 seconds for all currently
executing tasks to finish before it terminates. If the time limit is reached, the worker will initiate a cold shutdown
and cancel all currently executing tasks.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[INFO/MainProcess] Task myapp.long_running_task[6f748357-b2c7-456a-95de-f05c00504042] received</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 1/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 2/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 3/2000s</span>
<span class="go">^C</span>
<span class="go">worker: Hitting Ctrl+C again will initiate cold shutdown, terminating all running tasks!</span>

<span class="go">worker: Warm shutdown (MainProcess)</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 4/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 5/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 6/2000s</span>
<span class="go">^C</span>
<span class="go">worker: Hitting Ctrl+C again will terminate all running tasks!</span>
<span class="go">[WARNING/MainProcess] Initiating Soft Shutdown, terminating in 3 seconds</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 7/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 8/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 9/2000s</span>
<span class="go">[WARNING/MainProcess] Restoring 1 unacknowledged message(s)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The next <code class="xref std std-sig docutils literal notranslate"><span class="pre">QUIT</span></code> signal will cancel the tasks that are still running in the soft shutdown, but the worker
will still wait for the time limit to finish before terminating.</p></li>
<li><p>The next (2nd) <code class="xref std std-sig docutils literal notranslate"><span class="pre">QUIT</span></code> or <code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> signal will trigger the next stage of the shutdown process.</p></li>
</ul>
</div>
</div>
</section>
<section id="worker-hard-shutdown">
<span id="id6"></span><h4>硬关闭<a class="headerlink" href="#worker-hard-shutdown" title="Link to this heading">¶</a></h4>
<p>Hard Shutdown</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.5.</span></p>
</div>
<p>硬关机（Hard shutdown）主要用于本地开发或调试场景，允许通过重复发送 <code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> （Ctrl-C）信号强制 worker 立即终止。worker 会立即停止所有正在执行的任务，并在主进程中抛出 <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.WorkerTerminate" title="celery.exceptions.WorkerTerminate"><code class="xref py py-exc docutils literal notranslate"><span class="pre">WorkerTerminate</span></code></a> 异常来退出。</p>
<p>例如，注意以下日志中的 <code class="docutils literal notranslate"><span class="pre">^C</span></code> 表示用户通过 <code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> 信号手动推进关机阶段：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[INFO/MainProcess] Task myapp.long_running_task[7235ac16-543d-4fd5-a9e1-2d2bb8ab630a] received</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 1/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 2/2000s</span>
<span class="go">^C</span>
<span class="go">worker: Hitting Ctrl+C again will initiate cold shutdown, terminating all running tasks!</span>

<span class="go">worker: Warm shutdown (MainProcess)</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 3/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 4/2000s</span>
<span class="go">^C</span>
<span class="go">worker: Hitting Ctrl+C again will terminate all running tasks!</span>
<span class="go">[WARNING/MainProcess] Initiating Soft Shutdown, terminating in 10 seconds</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 5/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 6/2000s</span>
<span class="go">^C</span>
<span class="go">Waiting gracefully for cold shutdown to complete...</span>

<span class="go">worker: Cold shutdown (MainProcess)</span>
<span class="go">^C[WARNING/MainProcess] Restoring 1 unacknowledged message(s)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>日志中 <code class="docutils literal notranslate"><span class="pre">Restoring</span> <span class="pre">1</span> <span class="pre">unacknowledged</span> <span class="pre">message(s)</span></code> 的信息可能具有误导性，因为在硬关机后并不能保证这些消息会被恢复。相较而言，<a class="reference internal" href="#worker-soft-shutdown"><span class="std std-ref">软关闭</span></a> 可以在温关机与冷关机之间提供一个时间窗口，从而显著提升关机过程的优雅性。</p>
</div>
</div>
<input class="tab-input" id="tab-set--6-input--2" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.5.</span></p>
</div>
<p>Hard shutdown is mostly for local or debug purposes, allowing to spam the <code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> (Ctrl-C) signal
to force the worker to terminate immediately. The worker will stop all currently executing tasks and
terminate immediately by raising a <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.WorkerTerminate" title="celery.exceptions.WorkerTerminate"><code class="xref py py-exc docutils literal notranslate"><span class="pre">WorkerTerminate</span></code></a> exception in the MainProcess.</p>
<p>For example, notice the <code class="docutils literal notranslate"><span class="pre">^C</span></code> in the logs below (using the <code class="xref std std-sig docutils literal notranslate"><span class="pre">INT</span></code> signal to move from stage to stage):</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">[INFO/MainProcess] Task myapp.long_running_task[7235ac16-543d-4fd5-a9e1-2d2bb8ab630a] received</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 1/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 2/2000s</span>
<span class="go">^C</span>
<span class="go">worker: Hitting Ctrl+C again will initiate cold shutdown, terminating all running tasks!</span>

<span class="go">worker: Warm shutdown (MainProcess)</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 3/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 4/2000s</span>
<span class="go">^C</span>
<span class="go">worker: Hitting Ctrl+C again will terminate all running tasks!</span>
<span class="go">[WARNING/MainProcess] Initiating Soft Shutdown, terminating in 10 seconds</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 5/2000s</span>
<span class="go">[WARNING/ForkPoolWorker-8] long_running_task is running, sleeping 6/2000s</span>
<span class="go">^C</span>
<span class="go">Waiting gracefully for cold shutdown to complete...</span>

<span class="go">worker: Cold shutdown (MainProcess)</span>
<span class="go">^C[WARNING/MainProcess] Restoring 1 unacknowledged message(s)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>The log <code class="docutils literal notranslate"><span class="pre">Restoring</span> <span class="pre">1</span> <span class="pre">unacknowledged</span> <span class="pre">message(s)</span></code> is misleading as it is not guaranteed that the message
will be restored after a hard shutdown. The <a class="reference internal" href="#worker-soft-shutdown"><span class="std std-ref">软关闭</span></a> allows adding a time window just between
the warm and the cold shutdown that improves the gracefulness of the shutdown process.</p>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="worker-restarting">
<span id="id7"></span><h2>重启 worker<a class="headerlink" href="#worker-restarting" title="Link to this heading">¶</a></h2>
<p>Restarting the worker</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--1">中文</label><div class="tab-content docutils container">
<p>若要重启 worker，应先发送 <cite>TERM</cite> 信号终止原有进程，再启动新实例。开发环境下建议使用 <cite>celery multi</cite> 管理 worker：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>multi<span class="w"> </span>start<span class="w"> </span><span class="m">1</span><span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>-l<span class="w"> </span>INFO<span class="w"> </span>-c4<span class="w"> </span>--pidfile<span class="o">=</span>/var/run/celery/%n.pid
<span class="gp">$ </span>celery<span class="w"> </span>multi<span class="w"> </span>restart<span class="w"> </span><span class="m">1</span><span class="w"> </span>--pidfile<span class="o">=</span>/var/run/celery/%n.pid
</pre></div>
</div>
<p>对于生产部署，建议使用初始化脚本或进程管理工具（见 <a class="reference internal" href="daemonizing.html#daemonizing"><span class="std std-ref">守护进程</span></a> ）。</p>
<p>除了停止再启动外，还可以使用 <code class="xref std std-sig docutils literal notranslate"><span class="pre">HUP</span></code> 信号直接重启 worker。需要注意的是，此方式由 worker 自行负责重启，可能不稳定，因此不建议在生产环境中使用：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">kill</span><span class="w"> </span>-HUP<span class="w"> </span><span class="nv">$pid</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>只有当 worker 在后台以守护进程（daemon）方式运行（即无控制终端）时， <code class="xref std std-sig docutils literal notranslate"><span class="pre">HUP</span></code> 重启才有效。</p>
<p>macOS 平台因系统限制，禁用了 <code class="xref std std-sig docutils literal notranslate"><span class="pre">HUP</span></code> 信号的处理。</p>
</div>
</div>
<input class="tab-input" id="tab-set--7-input--2" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--2">英文</label><div class="tab-content docutils container">
<p>To restart the worker you should send the <cite>TERM</cite> signal and start a new
instance. The easiest way to manage workers for development
is by using <cite>celery multi</cite>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>multi<span class="w"> </span>start<span class="w"> </span><span class="m">1</span><span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>-l<span class="w"> </span>INFO<span class="w"> </span>-c4<span class="w"> </span>--pidfile<span class="o">=</span>/var/run/celery/%n.pid
<span class="gp">$ </span>celery<span class="w"> </span>multi<span class="w"> </span>restart<span class="w"> </span><span class="m">1</span><span class="w"> </span>--pidfile<span class="o">=</span>/var/run/celery/%n.pid
</pre></div>
</div>
<p>For production deployments you should be using init-scripts or a process
supervision system (see <a class="reference internal" href="daemonizing.html#daemonizing"><span class="std std-ref">守护进程</span></a>).</p>
<p>Other than stopping, then starting the worker to restart, you can also
restart the worker using the <code class="xref std std-sig docutils literal notranslate"><span class="pre">HUP</span></code> signal. Note that the worker
will be responsible for restarting itself so this is prone to problems and
isn't recommended in production:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">kill</span><span class="w"> </span>-HUP<span class="w"> </span><span class="nv">$pid</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Restarting by <code class="xref std std-sig docutils literal notranslate"><span class="pre">HUP</span></code> only works if the worker is running
in the background as a daemon (it doesn't have a controlling
terminal).</p>
<p><code class="xref std std-sig docutils literal notranslate"><span class="pre">HUP</span></code> is disabled on macOS because of a limitation on
that platform.</p>
</div>
</div>
</div>
</section>
<section id="broker">
<h2>与broker服务器连接丢失时自动重新连接<a class="headerlink" href="#broker" title="Link to this heading">¶</a></h2>
<p>Automatic re-connection on connection loss to broker</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.3.</span></p>
</div>
<p>除非将 <a class="reference internal" href="configuration.html#std-setting-broker_connection_retry_on_startup"><code class="xref std std-setting docutils literal notranslate"><span class="pre">broker_connection_retry_on_startup</span></code></a> 设置为 False，
Celery 会在首次连接中断后自动尝试重新连接到 broker。
而 <a class="reference internal" href="configuration.html#std-setting-broker_connection_retry"><code class="xref std std-setting docutils literal notranslate"><span class="pre">broker_connection_retry</span></code></a> 控制后续连接中断时是否自动重试重新连接。</p>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.1.</span></p>
</div>
<p>如果将 <a class="reference internal" href="configuration.html#std-setting-worker_cancel_long_running_tasks_on_connection_loss"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_cancel_long_running_tasks_on_connection_loss</span></code></a> 设置为 True，
Celery 也会取消所有当前正在运行的长时间运行任务。</p>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.3.</span></p>
</div>
<p>由于消息中间件无法追踪连接丢失前已取出的任务数量，
Celery 会将预取计数（prefetch count）减少为当前正在运行的任务数量乘以
<a class="reference internal" href="configuration.html#std-setting-worker_prefetch_multiplier"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_prefetch_multiplier</span></code></a> 的结果。
该预取计数将在每次完成一个连接丢失前启动的任务后，逐步恢复至允许的最大值。</p>
<p>此特性默认启用，可通过将 <a class="reference internal" href="configuration.html#std-setting-worker_enable_prefetch_count_reduction"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_enable_prefetch_count_reduction</span></code></a> 设置为 False 来禁用。</p>
</div>
<input class="tab-input" id="tab-set--8-input--2" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.3.</span></p>
</div>
<p>Unless <a class="reference internal" href="configuration.html#std-setting-broker_connection_retry_on_startup"><code class="xref std std-setting docutils literal notranslate"><span class="pre">broker_connection_retry_on_startup</span></code></a> is set to False,
Celery will automatically retry reconnecting to the broker after the first
connection loss. <a class="reference internal" href="configuration.html#std-setting-broker_connection_retry"><code class="xref std std-setting docutils literal notranslate"><span class="pre">broker_connection_retry</span></code></a> controls whether to automatically
retry reconnecting to the broker for subsequent reconnects.</p>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.1.</span></p>
</div>
<p>If <a class="reference internal" href="configuration.html#std-setting-worker_cancel_long_running_tasks_on_connection_loss"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_cancel_long_running_tasks_on_connection_loss</span></code></a> is set to True,
Celery will also cancel any long running task that is currently running.</p>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.3.</span></p>
</div>
<p>Since the message broker does not track how many tasks were already fetched before
the connection was lost, Celery will reduce the prefetch count by the number of
tasks that are currently running multiplied by <a class="reference internal" href="configuration.html#std-setting-worker_prefetch_multiplier"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_prefetch_multiplier</span></code></a>.
The prefetch count will be gradually restored to the maximum allowed after
each time a task that was running before the connection was lost is complete.</p>
<p>This feature is enabled by default, but can be disabled by setting False
to <a class="reference internal" href="configuration.html#std-setting-worker_enable_prefetch_count_reduction"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_enable_prefetch_count_reduction</span></code></a>.</p>
</div>
</div>
</section>
<section id="worker-process-signals">
<span id="id8"></span><h2>进程信号<a class="headerlink" href="#worker-process-signals" title="Link to this heading">¶</a></h2>
<p>Process Signals</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--1">中文</label><div class="tab-content docutils container">
<p>Worker 的主进程会覆盖以下信号处理行为：</p>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--2">英文</label><div class="tab-content docutils container">
<p>The worker's main process overrides the following signals:</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p><code class="xref std std-sig docutils literal notranslate"><span class="pre">TERM</span></code></p></td>
<td><p>Warm shutdown, wait for tasks to complete.</p></td>
</tr>
<tr class="row-even"><td><p><code class="xref std std-sig docutils literal notranslate"><span class="pre">QUIT</span></code></p></td>
<td><p>Cold shutdown, terminate ASAP</p></td>
</tr>
<tr class="row-odd"><td><p><code class="xref std std-sig docutils literal notranslate"><span class="pre">USR1</span></code></p></td>
<td><p>Dump traceback for all active threads.</p></td>
</tr>
<tr class="row-even"><td><p><code class="xref std std-sig docutils literal notranslate"><span class="pre">USR2</span></code></p></td>
<td><p>Remote debug, see <a class="reference internal" href="../reference/celery.contrib.rdb.html#module-celery.contrib.rdb" title="celery.contrib.rdb"><code class="xref py py-mod docutils literal notranslate"><span class="pre">celery.contrib.rdb</span></code></a>.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="worker-files">
<span id="id9"></span><h2>文件路径中的变量<a class="headerlink" href="#worker-files" title="Link to this heading">¶</a></h2>
<p>Variables in file paths</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-f"><code class="xref std std-option docutils literal notranslate"><span class="pre">--logfile</span></code></a>、<a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-pidfile"><code class="xref std std-option docutils literal notranslate"><span class="pre">--pidfile</span></code></a> 和
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-S"><code class="xref std std-option docutils literal notranslate"><span class="pre">--statedb</span></code></a> 等参数的文件路径可以包含变量占位符，
Worker 会在运行时对其进行展开：</p>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--2">英文</label><div class="tab-content docutils container">
<p>The file path arguments for <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-f"><code class="xref std std-option docutils literal notranslate"><span class="pre">--logfile</span></code></a>,
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-pidfile"><code class="xref std std-option docutils literal notranslate"><span class="pre">--pidfile</span></code></a>, and
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-S"><code class="xref std std-option docutils literal notranslate"><span class="pre">--statedb</span></code></a> can contain variables that the
worker will expand:</p>
</div>
</div>
<section id="id10">
<h3>节点名称替换<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h3>
<p>Node name replacements</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--11-input--1" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--1">中文</label><div class="tab-content docutils container">
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">%p</span></code>：完整节点名（node name）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%h</span></code>：主机名（包含域名）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%n</span></code>：主机名（不包含域名）。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%d</span></code>：域名部分。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%i</span></code>：Prefork 池中子进程索引，主进程为 0。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%I</span></code>：带分隔符的子进程索引。</p></li>
</ul>
<p>例如，当前主机名为 <code class="docutils literal notranslate"><span class="pre">george&#64;foo.example.com</span></code> 时，将展开为：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--logfile=%p.log</span></code> -&gt; <code class="file docutils literal notranslate"><span class="pre">george&#64;foo.example.com.log</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--logfile=%h.log</span></code> -&gt; <code class="file docutils literal notranslate"><span class="pre">foo.example.com.log</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--logfile=%n.log</span></code> -&gt; <code class="file docutils literal notranslate"><span class="pre">george.log</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--logfile=%d.log</span></code> -&gt; <code class="file docutils literal notranslate"><span class="pre">example.com.log</span></code></p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--11-input--2" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--2">英文</label><div class="tab-content docutils container">
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">%p</span></code>:  Full node name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%h</span></code>:  Hostname, including domain name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%n</span></code>:  Hostname only.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%d</span></code>:  Domain name only.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%i</span></code>:  Prefork pool process index or 0 if MainProcess.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">%I</span></code>:  Prefork pool process index with separator.</p></li>
</ul>
<p>For example, if the current hostname is <code class="docutils literal notranslate"><span class="pre">george&#64;foo.example.com</span></code> then
these will expand to:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--logfile=%p.log</span></code> -&gt; <code class="file docutils literal notranslate"><span class="pre">george&#64;foo.example.com.log</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--logfile=%h.log</span></code> -&gt; <code class="file docutils literal notranslate"><span class="pre">foo.example.com.log</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--logfile=%n.log</span></code> -&gt; <code class="file docutils literal notranslate"><span class="pre">george.log</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--logfile=%d.log</span></code> -&gt; <code class="file docutils literal notranslate"><span class="pre">example.com.log</span></code></p></li>
</ul>
</div>
</div>
</section>
<section id="prefork">
<span id="worker-files-process-index"></span><h3>Prefork 池进程索引<a class="headerlink" href="#prefork" title="Link to this heading">¶</a></h3>
<p>Prefork pool process index</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--12-input--1" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--1">中文</label><div class="tab-content docutils container">
<p>Prefork 子进程索引相关的占位符，会根据具体要打开该文件的进程展开为不同的文件名。</p>
<p>这可用于为每个子进程指定独立的日志文件。</p>
<p>需要注意的是：即使进程退出，或启用了 autoscale、<code class="docutils literal notranslate"><span class="pre">maxtasksperchild</span></code>、执行时间限制等机制，
索引号也会保持在进程数限制内。换言之，该数字表示的是“进程索引”而非进程数量或进程 ID。</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">%i</span></code> - 池中子进程索引，主进程为 0。</p>
<p>例如：使用 <code class="docutils literal notranslate"><span class="pre">-n</span> <span class="pre">worker1&#64;example.com</span> <span class="pre">-c2</span> <span class="pre">-f</span> <span class="pre">%n-%i.log</span></code> 时，会生成三个日志文件：</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1-0.log</span></code> （主进程）</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1-1.log</span></code> （子进程 1）</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1-2.log</span></code> （子进程 2）</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">%I</span></code> - 带分隔符的池中子进程索引。</p>
<p>例如：使用 <code class="docutils literal notranslate"><span class="pre">-n</span> <span class="pre">worker1&#64;example.com</span> <span class="pre">-c2</span> <span class="pre">-f</span> <span class="pre">%n%I.log</span></code> 时，会生成三个日志文件：</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1.log</span></code> （主进程）</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1-1.log</span></code> （子进程 1）</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1-2.log</span></code> （子进程 2）</p></li>
</ul>
</li>
</ul>
</div>
<input class="tab-input" id="tab-set--12-input--2" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--2">英文</label><div class="tab-content docutils container">
<p>The prefork pool process index specifiers will expand into a different
filename depending on the process that'll eventually need to open the file.</p>
<p>This can be used to specify one log file per child process.</p>
<p>Note that the numbers will stay within the process limit even if processes
exit or if autoscale/<code class="docutils literal notranslate"><span class="pre">maxtasksperchild</span></code>/time limits are used.  That is, the number
is the <em>process index</em> not the process count or pid.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">%i</span></code> - Pool process index or 0 if MainProcess.</p>
<p>Where <code class="docutils literal notranslate"><span class="pre">-n</span> <span class="pre">worker1&#64;example.com</span> <span class="pre">-c2</span> <span class="pre">-f</span> <span class="pre">%n-%i.log</span></code> will result in
three log files:</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1-0.log</span></code> (main process)</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1-1.log</span></code> (pool process 1)</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1-2.log</span></code> (pool process 2)</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">%I</span></code> - Pool process index with separator.</p>
<p>Where <code class="docutils literal notranslate"><span class="pre">-n</span> <span class="pre">worker1&#64;example.com</span> <span class="pre">-c2</span> <span class="pre">-f</span> <span class="pre">%n%I.log</span></code> will result in
three log files:</p>
<ul class="simple">
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1.log</span></code> (main process)</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1-1.log</span></code> (pool process 1)</p></li>
<li><p><code class="file docutils literal notranslate"><span class="pre">worker1-2.log</span></code> (pool process 2)</p></li>
</ul>
</li>
</ul>
</div>
</div>
</section>
</section>
<section id="worker-concurrency">
<span id="id11"></span><h2>并发<a class="headerlink" href="#worker-concurrency" title="Link to this heading">¶</a></h2>
<p>Concurrency</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--13-input--1" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--1">中文</label><div class="tab-content docutils container">
<p>默认情况下，Celery 使用多进程（multiprocessing）机制来并发执行任务，
但你也可以使用 <a class="reference internal" href="concurrency/gevent.html#concurrency-eventlet"><span class="std std-ref">Eventlet</span></a>。
工作进程/线程的数量可以通过 <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-c"><code class="xref std std-option docutils literal notranslate"><span class="pre">--concurrency</span></code></a> 参数进行设置，
默认值为机器上可用的 CPU 数量。</p>
<div class="admonition-multiprocessing-prefork admonition">
<p class="admonition-title">进程数量（multiprocessing/prefork 池）</p>
<p>通常来说，进程数量越多性能越好，但当数量达到某个临界点后，
增加进程数反而会导致性能下降。
有一些证据表明，运行多个 Worker 实例有时比只运行一个 Worker 更高效。
例如，运行 3 个 Worker，每个都有 10 个池进程。
你需要自行尝试以找到最适合你场景的配置，
因为这会受到应用类型、工作负载、任务运行时间以及其他因素的影响。</p>
</div>
</div>
<input class="tab-input" id="tab-set--13-input--2" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--2">英文</label><div class="tab-content docutils container">
<p>By default multiprocessing is used to perform concurrent execution of tasks,
but you can also use <a class="reference internal" href="concurrency/gevent.html#concurrency-eventlet"><span class="std std-ref">Eventlet</span></a>. The number
of worker processes/threads can be changed using the
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-c"><code class="xref std std-option docutils literal notranslate"><span class="pre">--concurrency</span></code></a> argument and defaults
to the number of CPUs available on the machine.</p>
<div class="admonition-number-of-processes-multiprocessing-prefork-pool admonition">
<p class="admonition-title">Number of processes (multiprocessing/prefork pool)</p>
<p>More pool processes are usually better, but there's a cut-off point where
adding more pool processes affects performance in negative ways.
There's even some evidence to support that having multiple worker
instances running, may perform better than having a single worker.
For example 3 workers with 10 pool processes each. You need to experiment
to find the numbers that works best for you, as this varies based on
application, work load, task run times and other factors.</p>
</div>
</div>
</div>
</section>
<section id="worker-remote-control">
<span id="id12"></span><h2>远程控制<a class="headerlink" href="#worker-remote-control" title="Link to this heading">¶</a></h2>
<p>Remote control</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--14-input--1" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.0.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">pool 支持<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>prefork, eventlet, gevent, thread</em>, 阻塞型: <em>solo</em> （参见注释）</p>
</dd>
<dt class="field-even">broker 支持<span class="colon">:</span></dt>
<dd class="field-even"><p><em>amqp, redis</em></p>
</dd>
</dl>
<p>Worker 支持通过高优先级的广播消息队列进行远程控制。
这些命令可以发送给所有 Worker，也可以只发送给指定的 Worker 列表。</p>
<p>命令也可以请求回应。客户端可等待并收集这些回应。
由于系统中没有中央服务可用来判断当前集群中有多少个 Worker，
因此也无法准确预估将收到多少回应。
为此，客户端提供了一个可配置的超时时间，即等待回应到达的时间上限（以秒为单位），
默认值为 1 秒。
如果在截止时间内 Worker 没有回应，这并不一定意味着该 Worker 没有响应，
或者更糟糕的是已经挂掉，
可能仅仅是因为网络延迟，或该 Worker 在处理命令时比较慢，因此应根据情况调整超时时间。</p>
<p>除了超时时间，客户端还可以设置最多等待多少个回应。
如果指定了目标 Worker，这一限制将默认为目标主机数。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">solo</span></code> 类型的池也支持远程控制命令，
但如果某个任务正在执行，任何待处理的控制命令都会被阻塞。
因此当 Worker 比较繁忙时， <code class="docutils literal notranslate"><span class="pre">solo</span></code> 的远程控制用途会受到限制。
此时应在客户端中提高等待回应的超时时间。</p>
</div>
</div>
<input class="tab-input" id="tab-set--14-input--2" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.0.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">pool support<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>prefork, eventlet, gevent, thread</em>, blocking:<em>solo</em> (see note)</p>
</dd>
<dt class="field-even">broker support<span class="colon">:</span></dt>
<dd class="field-even"><p><em>amqp, redis</em></p>
</dd>
</dl>
<p>Workers have the ability to be remote controlled using a high-priority
broadcast message queue. The commands can be directed to all, or a specific
list of workers.</p>
<p>Commands can also have replies. The client can then wait for and collect
those replies. Since there's no central authority to know how many
workers are available in the cluster, there's also no way to estimate
how many workers may send a reply, so the client has a configurable
timeout — the deadline in seconds for replies to arrive in. This timeout
defaults to one second. If the worker doesn't reply within the deadline
it doesn't necessarily mean the worker didn't reply, or worse is dead, but
may simply be caused by network latency or the worker being slow at processing
commands, so adjust the timeout accordingly.</p>
<p>In addition to timeouts, the client can specify the maximum number
of replies to wait for. If a destination is specified, this limit is set
to the number of destination hosts.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The <code class="docutils literal notranslate"><span class="pre">solo</span></code> pool supports remote control commands,
but any task executing will block any waiting control command,
so it is of limited use if the worker is very busy. In that
case you must increase the timeout waiting for replies in the client.</p>
</div>
</div>
</div>
<section id="broadcast">
<span id="worker-broadcast-fun"></span><h3><a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.broadcast" title="celery.app.control.Control.broadcast"><code class="xref py py-meth docutils literal notranslate"><span class="pre">broadcast()</span></code></a> 函数<a class="headerlink" href="#broadcast" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.broadcast" title="celery.app.control.Control.broadcast"><code class="xref py py-meth docutils literal notranslate"><span class="pre">broadcast()</span></code></a> function</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--15-input--1" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--1">中文</label><div class="tab-content docutils container">
<p>以下是客户端用于向 Worker 发送指令的函数。
某些远程控制命令也提供了更高级的接口，
这些接口在内部会调用 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.broadcast" title="celery.app.control.Control.broadcast"><code class="xref py py-meth docutils literal notranslate"><span class="pre">broadcast()</span></code></a>，例如
<a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.rate_limit" title="celery.app.control.Control.rate_limit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">rate_limit()</span></code></a> 和 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.ping" title="celery.app.control.Control.ping"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ping()</span></code></a>。</p>
<p>以下为发送 <a class="reference internal" href="#std-control-rate_limit"><code class="xref std std-control docutils literal notranslate"><span class="pre">rate_limit</span></code></a> 命令和参数的示例：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="s1">&#39;rate_limit&#39;</span><span class="p">,</span>
<span class="gp">... </span>                         <span class="n">arguments</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;task_name&#39;</span><span class="p">:</span> <span class="s1">&#39;myapp.mytask&#39;</span><span class="p">,</span>
<span class="gp">... </span>                                    <span class="s1">&#39;rate_limit&#39;</span><span class="p">:</span> <span class="s1">&#39;200/m&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>此操作将异步发送命令，并不会等待回应。
若希望获取回应，可使用 <cite>reply</cite> 参数：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="s1">&#39;rate_limit&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s1">&#39;task_name&#39;</span><span class="p">:</span> <span class="s1">&#39;myapp.mytask&#39;</span><span class="p">,</span> <span class="s1">&#39;rate_limit&#39;</span><span class="p">:</span> <span class="s1">&#39;200/m&#39;</span><span class="p">},</span> <span class="n">reply</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">[{&#39;worker1.example.com&#39;: &#39;New rate limit set successfully&#39;},</span>
<span class="go">{&#39;worker2.example.com&#39;: &#39;New rate limit set successfully&#39;},</span>
<span class="go">{&#39;worker3.example.com&#39;: &#39;New rate limit set successfully&#39;}]</span>
</pre></div>
</div>
<p>通过 <cite>destination</cite> 参数可以指定命令接收的 Worker 列表：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="s1">&#39;rate_limit&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s1">&#39;task_name&#39;</span><span class="p">:</span> <span class="s1">&#39;myapp.mytask&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s1">&#39;rate_limit&#39;</span><span class="p">:</span> <span class="s1">&#39;200/m&#39;</span><span class="p">},</span> <span class="n">reply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>                            <span class="n">destination</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;worker1@example.com&#39;</span><span class="p">])</span>
<span class="go">[{&#39;worker1.example.com&#39;: &#39;New rate limit set successfully&#39;}]</span>
</pre></div>
</div>
<p>当然，使用高级接口来设置速率限制更为方便，
但也存在一些只能通过 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.broadcast" title="celery.app.control.Control.broadcast"><code class="xref py py-meth docutils literal notranslate"><span class="pre">broadcast()</span></code></a> 发送的命令。</p>
</div>
<input class="tab-input" id="tab-set--15-input--2" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--2">英文</label><div class="tab-content docutils container">
<p>This is the client function used to send commands to the workers.
Some remote control commands also have higher-level interfaces using
<a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.broadcast" title="celery.app.control.Control.broadcast"><code class="xref py py-meth docutils literal notranslate"><span class="pre">broadcast()</span></code></a> in the background, like
<a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.rate_limit" title="celery.app.control.Control.rate_limit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">rate_limit()</span></code></a>, and <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.ping" title="celery.app.control.Control.ping"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ping()</span></code></a>.</p>
<p>Sending the <a class="reference internal" href="#std-control-rate_limit"><code class="xref std std-control docutils literal notranslate"><span class="pre">rate_limit</span></code></a> command and keyword arguments:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="s1">&#39;rate_limit&#39;</span><span class="p">,</span>
<span class="gp">... </span>                         <span class="n">arguments</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;task_name&#39;</span><span class="p">:</span> <span class="s1">&#39;myapp.mytask&#39;</span><span class="p">,</span>
<span class="gp">... </span>                                    <span class="s1">&#39;rate_limit&#39;</span><span class="p">:</span> <span class="s1">&#39;200/m&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>This will send the command asynchronously, without waiting for a reply.
To request a reply you have to use the <cite>reply</cite> argument:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="s1">&#39;rate_limit&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s1">&#39;task_name&#39;</span><span class="p">:</span> <span class="s1">&#39;myapp.mytask&#39;</span><span class="p">,</span> <span class="s1">&#39;rate_limit&#39;</span><span class="p">:</span> <span class="s1">&#39;200/m&#39;</span><span class="p">},</span> <span class="n">reply</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">[{&#39;worker1.example.com&#39;: &#39;New rate limit set successfully&#39;},</span>
<span class="go">{&#39;worker2.example.com&#39;: &#39;New rate limit set successfully&#39;},</span>
<span class="go">{&#39;worker3.example.com&#39;: &#39;New rate limit set successfully&#39;}]</span>
</pre></div>
</div>
<p>Using the <cite>destination</cite> argument you can specify a list of workers
to receive the command:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="s1">&#39;rate_limit&#39;</span><span class="p">,</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s1">&#39;task_name&#39;</span><span class="p">:</span> <span class="s1">&#39;myapp.mytask&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="s1">&#39;rate_limit&#39;</span><span class="p">:</span> <span class="s1">&#39;200/m&#39;</span><span class="p">},</span> <span class="n">reply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>                            <span class="n">destination</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;worker1@example.com&#39;</span><span class="p">])</span>
<span class="go">[{&#39;worker1.example.com&#39;: &#39;New rate limit set successfully&#39;}]</span>
</pre></div>
</div>
<p>Of course, using the higher-level interface to set rate limits is much
more convenient, but there are commands that can only be requested
using <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.broadcast" title="celery.app.control.Control.broadcast"><code class="xref py py-meth docutils literal notranslate"><span class="pre">broadcast()</span></code></a>.</p>
</div>
</div>
</section>
</section>
<section id="id13">
<h2>命令<a class="headerlink" href="#id13" title="Link to this heading">¶</a></h2>
<p>Commands</p>
<section id="revoke">
<span id="std-control-revoke"></span><h3><code class="docutils literal notranslate"><span class="pre">revoke</span></code>: 撤销任务<a class="headerlink" href="#revoke" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">revoke</span></code>: Revoking tasks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--16-input--1" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--1">中文</label><div class="tab-content docutils container">
<dl class="field-list simple">
<dt class="field-odd">pool 支持<span class="colon">:</span></dt>
<dd class="field-odd"><p>全部， <cite>terminate</cite> 选项仅在 prefork、eventlet 和 gevent 中受支持</p>
</dd>
<dt class="field-even">broker 支持<span class="colon">:</span></dt>
<dd class="field-even"><p><em>amqp, redis</em></p>
</dd>
<dt class="field-odd">command<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong class="program">celery -A proj control revoke &lt;task_id&gt;</strong></p>
</dd>
</dl>
<p>所有 Worker 节点都会保留被撤销任务（revoked task）的任务 ID 信息，
这些信息可能存储在内存中，也可能持久化在磁盘上（参见 <a class="reference internal" href="#worker-persistent-revokes"><span class="std std-ref">持久性撤销</span></a>）。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>可通过环境变量 <code class="docutils literal notranslate"><span class="pre">CELERY_WORKER_REVOKES_MAX</span></code> 设置内存中最多保留的被撤销任务数量，
默认值为 50000。当超过此上限后，这些撤销信息将保留 10800 秒（即 3 小时）后过期。
该过期时间可通过 <code class="docutils literal notranslate"><span class="pre">CELERY_WORKER_REVOKE_EXPIRES</span></code> 环境变量进行修改。</p>
<p>成功任务的内存限制也可通过 <code class="docutils literal notranslate"><span class="pre">CELERY_WORKER_SUCCESSFUL_MAX</span></code> 和
<code class="docutils literal notranslate"><span class="pre">CELERY_WORKER_SUCCESSFUL_EXPIRES</span></code> 两个环境变量设置，默认值分别为 1000 和 10800。</p>
</div>
<p>当 Worker 收到撤销请求时，它将跳过该任务的执行，
但不会中止一个已经在执行中的任务，除非设置了 <cite>terminate</cite> 选项。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><cite>terminate</cite> 选项是管理员处理卡住任务的最后手段。
它并不是终止任务本身，而是终止执行该任务的进程。
而且该进程在收到信号时可能已经开始处理其他任务，
因此 <strong>绝不能通过编程方式调用此选项</strong> 。</p>
</div>
<p>如果启用了 <cite>terminate</cite>，Worker 将终止处理该任务的子进程。
默认发送的信号为 <cite>TERM</cite>，你可以通过 <cite>signal</cite> 参数自定义信号类型。
信号名称应为 Python 标准库 <a class="reference external" href="https://docs.python.org/dev/library/signal.html#module-signal" title="（在 Python v3.15）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">signal</span></code></a> 模块中定义的信号的大写名称。</p>
<p>撤销任务的同时也会对其进行标记撤销（revoked）。</p>
<p><strong>示例</strong></p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">revoke</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">AsyncResult</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">revoke</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;d9078da5-9915-40a0-bfa1-392c7bde42ed&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;d9078da5-9915-40a0-bfa1-392c7bde42ed&#39;</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;d9078da5-9915-40a0-bfa1-392c7bde42ed&#39;</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="s1">&#39;SIGKILL&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--16-input--2" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--2">英文</label><div class="tab-content docutils container">
<dl class="field-list simple">
<dt class="field-odd">pool support<span class="colon">:</span></dt>
<dd class="field-odd"><p>all, terminate only supported by prefork, eventlet and gevent</p>
</dd>
<dt class="field-even">broker support<span class="colon">:</span></dt>
<dd class="field-even"><p><em>amqp, redis</em></p>
</dd>
<dt class="field-odd">command<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong class="program">celery -A proj control revoke &lt;task_id&gt;</strong></p>
</dd>
</dl>
<p>All worker nodes keeps a memory of revoked task ids, either in-memory or
persistent on disk (see <a class="reference internal" href="#worker-persistent-revokes"><span class="std std-ref">持久性撤销</span></a>).</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The maximum number of revoked tasks to keep in memory can be
specified using the <code class="docutils literal notranslate"><span class="pre">CELERY_WORKER_REVOKES_MAX</span></code> environment
variable, which defaults to 50000. When the limit has been exceeded,
the revokes will be active for 10800 seconds (3 hours) before being
expired. This value can be changed using the
<code class="docutils literal notranslate"><span class="pre">CELERY_WORKER_REVOKE_EXPIRES</span></code> environment variable.</p>
<p>Memory limits can also be set for successful tasks through the
<code class="docutils literal notranslate"><span class="pre">CELERY_WORKER_SUCCESSFUL_MAX</span></code> and
<code class="docutils literal notranslate"><span class="pre">CELERY_WORKER_SUCCESSFUL_EXPIRES</span></code> environment variables, and
default to 1000 and 10800 respectively.</p>
</div>
<p>When a worker receives a revoke request it will skip executing
the task, but it won't terminate an already executing task unless
the <cite>terminate</cite> option is set.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The terminate option is a last resort for administrators when
a task is stuck. It's not for terminating the task,
it's for terminating the process that's executing the task, and that
process may have already started processing another task at the point
when the signal is sent, so for this reason you must never call this
programmatically.</p>
</div>
<p>If <cite>terminate</cite> is set the worker child process processing the task
will be terminated. The default signal sent is <cite>TERM</cite>, but you can
specify this using the <cite>signal</cite> argument. Signal can be the uppercase name
of any signal defined in the <a class="reference external" href="https://docs.python.org/dev/library/signal.html#module-signal" title="（在 Python v3.15）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">signal</span></code></a> module in the Python Standard
Library.</p>
<p>Terminating a task also revokes it.</p>
<p><strong>Example</strong></p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">revoke</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">AsyncResult</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">revoke</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;d9078da5-9915-40a0-bfa1-392c7bde42ed&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;d9078da5-9915-40a0-bfa1-392c7bde42ed&#39;</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke</span><span class="p">(</span><span class="s1">&#39;d9078da5-9915-40a0-bfa1-392c7bde42ed&#39;</span><span class="p">,</span>
<span class="gp">... </span>                   <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="s1">&#39;SIGKILL&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id14">
<h3>撤销多个任务<a class="headerlink" href="#id14" title="Link to this heading">¶</a></h3>
<p>Revoking multiple tasks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--17-input--1" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.1.</span></p>
</div>
<p><cite>revoke</cite> 方法也支持传入一个任务 ID 列表参数，从而一次性撤销多个任务。</p>
<p><strong>示例</strong></p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke</span><span class="p">([</span>
<span class="gp">... </span>   <span class="s1">&#39;7993b0aa-1f0b-4780-9af0-c47c0858b3f2&#39;</span><span class="p">,</span>
<span class="gp">... </span>   <span class="s1">&#39;f565793e-b041-4b2b-9ca4-dca22762a55d&#39;</span><span class="p">,</span>
<span class="gp">... </span>   <span class="s1">&#39;d9d35e03-2997-42d0-a13e-64a66b88a618&#39;</span><span class="p">,</span>
<span class="go">])</span>
</pre></div>
</div>
<p>自 3.1 版本起， <code class="docutils literal notranslate"><span class="pre">GroupResult.revoke</span></code> 方法也利用了此机制。</p>
</div>
<input class="tab-input" id="tab-set--17-input--2" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.1.</span></p>
</div>
<p>The revoke method also accepts a list argument, where it will revoke
several tasks at once.</p>
<p><strong>Example</strong></p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke</span><span class="p">([</span>
<span class="gp">... </span>   <span class="s1">&#39;7993b0aa-1f0b-4780-9af0-c47c0858b3f2&#39;</span><span class="p">,</span>
<span class="gp">... </span>   <span class="s1">&#39;f565793e-b041-4b2b-9ca4-dca22762a55d&#39;</span><span class="p">,</span>
<span class="gp">... </span>   <span class="s1">&#39;d9d35e03-2997-42d0-a13e-64a66b88a618&#39;</span><span class="p">,</span>
<span class="go">])</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GroupResult.revoke</span></code> method takes advantage of this since
version 3.1.</p>
</div>
</div>
</section>
<section id="worker-persistent-revokes">
<span id="id15"></span><h3>持久性撤销<a class="headerlink" href="#worker-persistent-revokes" title="Link to this heading">¶</a></h3>
<p>Persistent revokes</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--18-input--1" name="tab-set--18" type="radio"><label class="tab-label" for="tab-set--18-input--1">中文</label><div class="tab-content docutils container">
<p>任务撤销通过向所有 Worker 广播一条消息来实现，
Worker 接收到消息后会将被撤销的任务添加到内存中的撤销列表中。
当新的 Worker 启动时，它会与集群中其他 Worker 同步撤销任务列表。</p>
<p>撤销任务列表保存在内存中，因此如果所有 Worker 都重启，该列表也会丢失。
如果你希望在 Worker 重启后仍然保留撤销记录，可以通过 <strong class="program">celery worker</strong>
命令的 <cite>--statedb</cite> 参数将其保存到文件中：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>-l<span class="w"> </span>INFO<span class="w"> </span>--statedb<span class="o">=</span>/var/run/celery/worker.state
</pre></div>
</div>
<p>如果你使用 <strong class="program">celery multi</strong>，则应为每个 Worker 实例创建独立的文件，
可以使用 <cite>%n</cite> 占位符来引用当前节点的名称：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">celery multi start 2 -l INFO --statedb=/var/run/celery/%n.state</span>
</pre></div>
</div>
<p>参见 <a class="reference internal" href="#worker-files"><span class="std std-ref">文件路径中的变量</span></a></p>
<p>注意，任务撤销功能依赖于远程控制命令的正常工作。
目前远程控制命令仅支持 RabbitMQ（amqp）和 Redis。</p>
</div>
<input class="tab-input" id="tab-set--18-input--2" name="tab-set--18" type="radio"><label class="tab-label" for="tab-set--18-input--2">英文</label><div class="tab-content docutils container">
<p>Revoking tasks works by sending a broadcast message to all the workers,
the workers then keep a list of revoked tasks in memory. When a worker starts
up it will synchronize revoked tasks with other workers in the cluster.</p>
<p>The list of revoked tasks is in-memory so if all workers restart the list
of revoked ids will also vanish. If you want to preserve this list between
restarts you need to specify a file for these to be stored in by using the <cite>--statedb</cite>
argument to <strong class="program">celery worker</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>-l<span class="w"> </span>INFO<span class="w"> </span>--statedb<span class="o">=</span>/var/run/celery/worker.state
</pre></div>
</div>
<p>or if you use <strong class="program">celery multi</strong> you want to create one file per
worker instance so use the <cite>%n</cite> format to expand the current node
name:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">celery multi start 2 -l INFO --statedb=/var/run/celery/%n.state</span>
</pre></div>
</div>
<p>See also <a class="reference internal" href="#worker-files"><span class="std std-ref">文件路径中的变量</span></a></p>
<p>Note that remote control commands must be working for revokes to work.
Remote control commands are only supported by the RabbitMQ (amqp) and Redis
at this point.</p>
</div>
</div>
</section>
<section id="revoke-by-stamped-headers">
<span id="std-control-revoke_by_stamped_headers"></span><h3><code class="docutils literal notranslate"><span class="pre">revoke_by_stamped_headers</span></code>: 通过标记的标头撤销任务<a class="headerlink" href="#revoke-by-stamped-headers" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">revoke_by_stamped_headers</span></code>: Revoking tasks by their stamped headers</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--19-input--1" name="tab-set--19" type="radio"><label class="tab-label" for="tab-set--19-input--1">中文</label><div class="tab-content docutils container">
<dl class="field-list simple">
<dt class="field-odd">pool 支持<span class="colon">:</span></dt>
<dd class="field-odd"><p>全部， <cite>terminate</cite> 选项仅在 prefork 和 eventlet 中受支持</p>
</dd>
<dt class="field-even">broker 支持<span class="colon">:</span></dt>
<dd class="field-even"><p><em>amqp, redis</em></p>
</dd>
<dt class="field-odd">command<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong class="program">celery -A proj control revoke_by_stamped_headers &lt;header=value&gt;</strong></p>
</dd>
</dl>
<p>该命令与 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.revoke" title="celery.app.control.Control.revoke"><code class="xref py py-meth docutils literal notranslate"><span class="pre">revoke()</span></code></a> 类似，但不是指定任务 ID，
而是通过指定一组键值对形式的 stamped header，
所有匹配这些键值对的 stamped header 的任务都将被撤销。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>撤销的 stamped header 映射在 Worker 重启后不会持久保留，
所以如果你重启了 Worker，这些映射将会丢失，需要重新设置。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>如果你的 Worker 并发度很高，并启用了 terminate 选项，
此命令可能性能较差，因为它需要遍历所有运行中的任务来查找具有指定 stamped header 的任务。</p>
</div>
<p><strong>示例</strong></p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke_by_stamped_headers</span><span class="p">({</span><span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">})</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke_by_stamped_headers</span><span class="p">({</span><span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">},</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke_by_stamped_headers</span><span class="p">({</span><span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">},</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="s1">&#39;SIGKILL&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--19-input--2" name="tab-set--19" type="radio"><label class="tab-label" for="tab-set--19-input--2">英文</label><div class="tab-content docutils container">
<dl class="field-list simple">
<dt class="field-odd">pool support<span class="colon">:</span></dt>
<dd class="field-odd"><p>all, terminate only supported by prefork and eventlet</p>
</dd>
<dt class="field-even">broker support<span class="colon">:</span></dt>
<dd class="field-even"><p><em>amqp, redis</em></p>
</dd>
<dt class="field-odd">command<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong class="program">celery -A proj control revoke_by_stamped_headers &lt;header=value&gt;</strong></p>
</dd>
</dl>
<p>This command is similar to <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.revoke" title="celery.app.control.Control.revoke"><code class="xref py py-meth docutils literal notranslate"><span class="pre">revoke()</span></code></a>, but instead of
specifying the task id(s), you specify the stamped header(s) as key-value pair(s),
and each task that has a stamped header matching the key-value pair(s) will be revoked.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>The revoked headers mapping is not persistent across restarts, so if you
restart the workers, the revoked headers will be lost and need to be
mapped again.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>This command may perform poorly if your worker pool concurrency is high
and terminate is enabled, since it will have to iterate over all the running
tasks to find the ones with the specified stamped header.</p>
</div>
<p><strong>Example</strong></p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke_by_stamped_headers</span><span class="p">({</span><span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">})</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke_by_stamped_headers</span><span class="p">({</span><span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">},</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke_by_stamped_headers</span><span class="p">({</span><span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">},</span> <span class="n">terminate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="s1">&#39;SIGKILL&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id16">
<h3>通过标记的标头撤销多个任务<a class="headerlink" href="#id16" title="Link to this heading">¶</a></h3>
<p>Revoking multiple tasks by stamped headers</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--20-input--1" name="tab-set--20" type="radio"><label class="tab-label" for="tab-set--20-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.3.</span></p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">revoke_by_stamped_headers</span></code> 方法也支持传入一个列表参数，
可同时根据多个 header 或多个值进行任务撤销。</p>
<p><strong>示例</strong></p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke_by_stamped_headers</span><span class="p">({</span>
<span class="gp">... </span>   <span class="s1">&#39;header_A&#39;</span><span class="p">:</span> <span class="s1">&#39;value_1&#39;</span><span class="p">,</span>
<span class="gp">... </span>   <span class="s1">&#39;header_B&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;value_2&#39;</span><span class="p">,</span> <span class="s1">&#39;value_3&#39;</span><span class="p">],</span>
<span class="go">})</span>
</pre></div>
</div>
<p>上述示例将撤销所有带有 stamped header <code class="docutils literal notranslate"><span class="pre">header_A</span></code> 且值为 <code class="docutils literal notranslate"><span class="pre">value_1</span></code> 的任务，
以及所有带有 stamped header <code class="docutils literal notranslate"><span class="pre">header_B</span></code> 且值为 <code class="docutils literal notranslate"><span class="pre">value_2</span></code> 或 <code class="docutils literal notranslate"><span class="pre">value_3</span></code> 的任务。</p>
<p><strong>命令行示例</strong></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>revoke_by_stamped_headers<span class="w"> </span><span class="nv">stamped_header_key_A</span><span class="o">=</span>stamped_header_value_1<span class="w"> </span><span class="nv">stamped_header_key_B</span><span class="o">=</span>stamped_header_value_2

<span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>revoke_by_stamped_headers<span class="w"> </span><span class="nv">stamped_header_key_A</span><span class="o">=</span>stamped_header_value_1<span class="w"> </span><span class="nv">stamped_header_key_B</span><span class="o">=</span>stamped_header_value_2<span class="w"> </span>--terminate

<span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>revoke_by_stamped_headers<span class="w"> </span><span class="nv">stamped_header_key_A</span><span class="o">=</span>stamped_header_value_1<span class="w"> </span><span class="nv">stamped_header_key_B</span><span class="o">=</span>stamped_header_value_2<span class="w"> </span>--terminate<span class="w"> </span>--signal<span class="o">=</span>SIGKILL
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--20-input--2" name="tab-set--20" type="radio"><label class="tab-label" for="tab-set--20-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.3.</span></p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">revoke_by_stamped_headers</span></code> method also accepts a list argument, where it will revoke
by several headers or several values.</p>
<p><strong>Example</strong></p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt; app.control.revoke_by_stamped_headers({</span>
<span class="go">...    &#39;header_A&#39;: &#39;value_1&#39;,</span>
<span class="go">...    &#39;header_B&#39;: [&#39;value_2&#39;, &#39;value_3&#39;],</span>
<span class="go">})</span>
</pre></div>
</div>
<p>This will revoke all of the tasks that have a stamped header <code class="docutils literal notranslate"><span class="pre">header_A</span></code> with value <code class="docutils literal notranslate"><span class="pre">value_1</span></code>,
and all of the tasks that have a stamped header <code class="docutils literal notranslate"><span class="pre">header_B</span></code> with values <code class="docutils literal notranslate"><span class="pre">value_2</span></code> or <code class="docutils literal notranslate"><span class="pre">value_3</span></code>.</p>
<p><strong>CLI Example</strong></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>revoke_by_stamped_headers<span class="w"> </span><span class="nv">stamped_header_key_A</span><span class="o">=</span>stamped_header_value_1<span class="w"> </span><span class="nv">stamped_header_key_B</span><span class="o">=</span>stamped_header_value_2

<span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>revoke_by_stamped_headers<span class="w"> </span><span class="nv">stamped_header_key_A</span><span class="o">=</span>stamped_header_value_1<span class="w"> </span><span class="nv">stamped_header_key_B</span><span class="o">=</span>stamped_header_value_2<span class="w"> </span>--terminate

<span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>revoke_by_stamped_headers<span class="w"> </span><span class="nv">stamped_header_key_A</span><span class="o">=</span>stamped_header_value_1<span class="w"> </span><span class="nv">stamped_header_key_B</span><span class="o">=</span>stamped_header_value_2<span class="w"> </span>--terminate<span class="w"> </span>--signal<span class="o">=</span>SIGKILL
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="worker-time-limits">
<span id="id17"></span><h2>时间限制<a class="headerlink" href="#worker-time-limits" title="Link to this heading">¶</a></h2>
<p>Time Limits</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--21-input--1" name="tab-set--21" type="radio"><label class="tab-label" for="tab-set--21-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.0.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">pool 支持<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>prefork/gevent（见下文说明）</em></p>
</dd>
</dl>
<div class="admonition-soft-hard admonition">
<p class="admonition-title">Soft，还是 hard？</p>
<p>时间限制由两个值控制：<cite>soft</cite> 和 <cite>hard</cite>。
soft 时间限制允许任务捕获异常进行清理；
而 hard 限制无法被捕获，直接强制终止任务。</p>
</div>
<p>单个任务有可能会无限期运行，如果有许多任务都在等待某个永远不会发生的事件，
那么就会导致 Worker 被阻塞，无法处理新的任务。
防止此类情况的最佳做法是启用任务的时间限制。</p>
<p>时间限制（<cite>--time-limit</cite>）用于设置任务允许的最长期限（单位：秒），
超过该时间后执行任务的进程将被终止并由新进程取代。
你也可以启用 soft 时间限制（<cite>--soft-time-limit</cite>），
它会抛出一个异常，任务可以在此异常中进行清理，然后再被硬性终止：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">myapp</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">SoftTimeLimitExceeded</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mytask</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">do_work</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">SoftTimeLimitExceeded</span><span class="p">:</span>
        <span class="n">clean_up_in_a_hurry</span><span class="p">()</span>
</pre></div>
</div>
<p>你也可以使用 <a class="reference internal" href="configuration.html#std-setting-task_time_limit"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_time_limit</span></code></a> /
<a class="reference internal" href="configuration.html#std-setting-task_soft_time_limit"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_soft_time_limit</span></code></a> 设置来配置时间限制。
此外，也可以在客户端使用 <code class="docutils literal notranslate"><span class="pre">AsyncResult.get()</span></code> 函数的 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 参数设置超时。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>时间限制目前不适用于不支持 <code class="xref std std-sig docutils literal notranslate"><span class="pre">SIGUSR1</span></code> 信号的平台。</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>gevent 池不支持 soft 时间限制；
另外，如果任务处于阻塞状态，它也不会强制执行 hard 时间限制。</p>
</div>
</div>
<input class="tab-input" id="tab-set--21-input--2" name="tab-set--21" type="radio"><label class="tab-label" for="tab-set--21-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.0.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">pool support<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>prefork/gevent (see note below)</em></p>
</dd>
</dl>
<div class="admonition-soft-or-hard admonition">
<p class="admonition-title">Soft, or hard?</p>
<p>The time limit is set in two values, <cite>soft</cite> and <cite>hard</cite>.
The soft time limit allows the task to catch an exception
to clean up before it is killed: the hard timeout isn't catch-able
and force terminates the task.</p>
</div>
<p>A single task can potentially run forever, if you have lots of tasks
waiting for some event that'll never happen you'll block the worker
from processing new tasks indefinitely. The best way to defend against
this scenario happening is enabling time limits.</p>
<p>The time limit (<cite>--time-limit</cite>) is the maximum number of seconds a task
may run before the process executing it is terminated and replaced by a
new process. You can also enable a soft time limit (<cite>--soft-time-limit</cite>),
this raises an exception the task can catch to clean up before the hard
time limit kills it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">myapp</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">SoftTimeLimitExceeded</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mytask</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">do_work</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">SoftTimeLimitExceeded</span><span class="p">:</span>
        <span class="n">clean_up_in_a_hurry</span><span class="p">()</span>
</pre></div>
</div>
<p>Time limits can also be set using the <a class="reference internal" href="configuration.html#std-setting-task_time_limit"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_time_limit</span></code></a> /
<a class="reference internal" href="configuration.html#std-setting-task_soft_time_limit"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_soft_time_limit</span></code></a> settings. You can also specify time
limits for client side operation using <code class="docutils literal notranslate"><span class="pre">timeout</span></code> argument of
<code class="docutils literal notranslate"><span class="pre">AsyncResult.get()</span></code> function.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Time limits don't currently work on platforms that don't support
the <code class="xref std std-sig docutils literal notranslate"><span class="pre">SIGUSR1</span></code> signal.</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The gevent pool does not implement soft time limits. Additionally,
it will not enforce the hard time limit if the task is blocking.</p>
</div>
</div>
</div>
<section id="id18">
<h3>在运行时更改时间限制<a class="headerlink" href="#id18" title="Link to this heading">¶</a></h3>
<p>Changing time limits at run-time</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--22-input--1" name="tab-set--22" type="radio"><label class="tab-label" for="tab-set--22-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.3.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">broker 支持<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>amqp, redis</em></p>
</dd>
</dl>
<p>有一个远程控制命令允许你动态修改任务的 soft 和 hard 时间限制 —— 名为 <code class="docutils literal notranslate"><span class="pre">time_limit</span></code>。</p>
<p>例如，将任务 <code class="docutils literal notranslate"><span class="pre">tasks.crawl_the_web</span></code> 的 soft 时间限制设置为 1 分钟，
hard 时间限制设置为 2 分钟：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">time_limit</span><span class="p">(</span><span class="s1">&#39;tasks.crawl_the_web&#39;</span><span class="p">,</span>
<span class="gp">... </span>                       <span class="n">soft</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">hard</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">reply</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">[{&#39;worker1.example.com&#39;: {&#39;ok&#39;: &#39;time limits set successfully&#39;}}]</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--22-input--2" name="tab-set--22" type="radio"><label class="tab-label" for="tab-set--22-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.3.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">broker support<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>amqp, redis</em></p>
</dd>
</dl>
<p>There's a remote control command that enables you to change both soft
and hard time limits for a task — named <code class="docutils literal notranslate"><span class="pre">time_limit</span></code>.</p>
<p>Example changing the time limit for the <code class="docutils literal notranslate"><span class="pre">tasks.crawl_the_web</span></code> task
to have a soft time limit of one minute, and a hard time limit of
two minutes:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">time_limit</span><span class="p">(</span><span class="s1">&#39;tasks.crawl_the_web&#39;</span><span class="p">,</span>
<span class="go">                        soft=60, hard=120, reply=True)</span>
<span class="go">[{&#39;worker1.example.com&#39;: {&#39;ok&#39;: &#39;time limits set successfully&#39;}}]</span>
</pre></div>
</div>
<p>Only tasks that starts executing after the time limit change will be affected.</p>
</div>
</div>
</section>
</section>
<section id="worker-rate-limits">
<span id="id19"></span><h2>速率限制<a class="headerlink" href="#worker-rate-limits" title="Link to this heading">¶</a></h2>
<p>Rate Limits</p>
<section id="std-control-rate_limit">
<span id="id20"></span><h3>在运行时更改速率限制<a class="headerlink" href="#std-control-rate_limit" title="Link to this heading">¶</a></h3>
<p>Changing rate-limits at run-time</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--23-input--1" name="tab-set--23" type="radio"><label class="tab-label" for="tab-set--23-input--1">中文</label><div class="tab-content docutils container">
<p>只有在该时间限制变更之后开始执行的任务才会受到影响。</p>
<p>另一个示例是修改任务 <cite>myapp.mytask</cite> 的速率限制，使其最多每分钟执行 200 次：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">(</span><span class="s1">&#39;myapp.mytask&#39;</span><span class="p">,</span> <span class="s1">&#39;200/m&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>上述示例未指定目标 Worker，因此该更改会影响集群中的所有 Worker 实例。
如果你只希望更改某些特定的 Worker，可以添加 <code class="docutils literal notranslate"><span class="pre">destination</span></code> 参数：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">(</span><span class="s1">&#39;myapp.mytask&#39;</span><span class="p">,</span> <span class="s1">&#39;200/m&#39;</span><span class="p">,</span>
<span class="gp">... </span>           <span class="n">destination</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;celery@worker1.example.com&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>如果 Worker 启用了 <a class="reference internal" href="configuration.html#std-setting-worker_disable_rate_limits"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_disable_rate_limits</span></code></a> 设置，
则此命令将不会生效。</p>
</div>
</div>
<input class="tab-input" id="tab-set--23-input--2" name="tab-set--23" type="radio"><label class="tab-label" for="tab-set--23-input--2">英文</label><div class="tab-content docutils container">
<p>Example changing the rate limit for the <cite>myapp.mytask</cite> task to execute
at most 200 tasks of that type every minute:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">(</span><span class="s1">&#39;myapp.mytask&#39;</span><span class="p">,</span> <span class="s1">&#39;200/m&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The above doesn't specify a destination, so the change request will affect
all worker instances in the cluster. If you only want to affect a specific
list of workers you can include the <code class="docutils literal notranslate"><span class="pre">destination</span></code> argument:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">rate_limit</span><span class="p">(</span><span class="s1">&#39;myapp.mytask&#39;</span><span class="p">,</span> <span class="s1">&#39;200/m&#39;</span><span class="p">,</span>
<span class="gp">... </span>           <span class="n">destination</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;celery@worker1.example.com&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>This won't affect workers with the
<a class="reference internal" href="configuration.html#std-setting-worker_disable_rate_limits"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_disable_rate_limits</span></code></a> setting enabled.</p>
</div>
</div>
</div>
</section>
</section>
<section id="worker-max-tasks-per-child">
<span id="id21"></span><h2>每个子进程的最大任务数设置<a class="headerlink" href="#worker-max-tasks-per-child" title="Link to this heading">¶</a></h2>
<p>Max tasks per child setting</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--24-input--1" name="tab-set--24" type="radio"><label class="tab-label" for="tab-set--24-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.0.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">pool 支持<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>prefork</em></p>
</dd>
</dl>
<p>通过此选项，你可以配置单个 Worker 进程在被替换前最多可执行的任务数。</p>
<p>这在某些情况下非常有用，例如你使用了某些闭源的 C 扩展，
并且它们存在你无法控制的内存泄漏问题。</p>
<p>该选项可以通过 Worker 命令行参数
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-max-tasks-per-child"><code class="xref std std-option docutils literal notranslate"><span class="pre">--max-tasks-per-child</span></code></a> 设置，
也可以通过配置项 <a class="reference internal" href="configuration.html#std-setting-worker_max_tasks_per_child"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_max_tasks_per_child</span></code></a> 设置。</p>
</div>
<input class="tab-input" id="tab-set--24-input--2" name="tab-set--24" type="radio"><label class="tab-label" for="tab-set--24-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.0.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">pool support<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>prefork</em></p>
</dd>
</dl>
<p>With this option you can configure the maximum number of tasks
a worker can execute before it's replaced by a new process.</p>
<p>This is useful if you have memory leaks you have no control over
for example from closed source C extensions.</p>
<p>The option can be set using the workers
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-max-tasks-per-child"><code class="xref std std-option docutils literal notranslate"><span class="pre">--max-tasks-per-child</span></code></a> argument
or using the <a class="reference internal" href="configuration.html#std-setting-worker_max_tasks_per_child"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_max_tasks_per_child</span></code></a> setting.</p>
</div>
</div>
</section>
<section id="worker-max-memory-per-child">
<span id="id22"></span><h2>每个子进程的最大内存设置<a class="headerlink" href="#worker-max-memory-per-child" title="Link to this heading">¶</a></h2>
<p>Max memory per child setting</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--25-input--1" name="tab-set--25" type="radio"><label class="tab-label" for="tab-set--25-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.0.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">pool 支持<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>prefork</em></p>
</dd>
</dl>
<p>通过此选项，你可以设置 Worker 在驻留内存（resident memory）使用达到指定上限后被新进程替换。</p>
<p>这在你无法控制内存泄漏的情况下非常有用，例如使用了闭源的 C 扩展。</p>
<p>该选项可以通过 Worker 命令行参数
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-max-memory-per-child"><code class="xref std std-option docutils literal notranslate"><span class="pre">--max-memory-per-child</span></code></a> 设置，
也可以通过配置项 <a class="reference internal" href="configuration.html#std-setting-worker_max_memory_per_child"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_max_memory_per_child</span></code></a> 设置。</p>
</div>
<input class="tab-input" id="tab-set--25-input--2" name="tab-set--25" type="radio"><label class="tab-label" for="tab-set--25-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.0.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">pool support<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>prefork</em></p>
</dd>
</dl>
<p>With this option you can configure the maximum amount of resident
memory a worker can execute before it's replaced by a new process.</p>
<p>This is useful if you have memory leaks you have no control over
for example from closed source C extensions.</p>
<p>The option can be set using the workers
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-max-memory-per-child"><code class="xref std std-option docutils literal notranslate"><span class="pre">--max-memory-per-child</span></code></a> argument
or using the <a class="reference internal" href="configuration.html#std-setting-worker_max_memory_per_child"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_max_memory_per_child</span></code></a> setting.</p>
</div>
</div>
</section>
<section id="worker-autoscaling">
<span id="id23"></span><h2>自动扩缩<a class="headerlink" href="#worker-autoscaling" title="Link to this heading">¶</a></h2>
<p>Autoscaling</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--26-input--1" name="tab-set--26" type="radio"><label class="tab-label" for="tab-set--26-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.2.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">pool 支持<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>prefork</em>, <em>gevent</em></p>
</dd>
</dl>
<p><em>autoscaler</em> （自动伸缩器）组件用于根据负载动态调整 Worker 池的大小：</p>
<ul class="simple">
<li><p>当有任务要处理时，autoscaler 会增加更多的池进程；</p></li>
<li><p>当负载降低时，它会开始减少池进程的数量。</p></li>
</ul>
<p>可以使用 <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-autoscale"><code class="xref std std-option docutils literal notranslate"><span class="pre">--autoscale</span></code></a> 选项启用 autoscaler，
该选项需要两个数字：最大和最小池进程数：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>--autoscale=AUTOSCALE
    通过指定 max_concurrency,min_concurrency 来启用自动伸缩。例如：
    --autoscale=10,3 （始终保持至少 3 个进程，如有需要可扩展至最多 10 个）
</pre></div>
</div>
<p>你还可以通过继承 <a class="reference internal" href="../internals/reference/celery.worker.autoscale.html#celery.worker.autoscale.Autoscaler" title="celery.worker.autoscale.Autoscaler"><code class="xref py py-class docutils literal notranslate"><span class="pre">Autoscaler</span></code></a> 来自定义 autoscaler 行为。
可以使用的指标包括系统负载平均值、可用内存大小等。
你可以通过配置项 <a class="reference internal" href="configuration.html#std-setting-worker_autoscaler"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_autoscaler</span></code></a> 指定自定义 autoscaler。</p>
</div>
<input class="tab-input" id="tab-set--26-input--2" name="tab-set--26" type="radio"><label class="tab-label" for="tab-set--26-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.2.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">pool support<span class="colon">:</span></dt>
<dd class="field-odd"><p><em>prefork</em>, <em>gevent</em></p>
</dd>
</dl>
<p>The <em>autoscaler</em> component is used to dynamically resize the pool
based on load:</p>
<ul class="simple">
<li><p>The autoscaler adds more pool processes when there is work to do,</p></li>
<li><p>and starts removing processes when the workload is low.</p></li>
</ul>
<p>It's enabled by the <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-autoscale"><code class="xref std std-option docutils literal notranslate"><span class="pre">--autoscale</span></code></a> option,
which needs two numbers: the maximum and minimum number of pool processes:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>--autoscale=AUTOSCALE
    Enable autoscaling by providing
    max_concurrency,min_concurrency.  Example:
    --autoscale=10,3 (always keep 3 processes, but grow to
    10 if necessary).
</pre></div>
</div>
<p>You can also define your own rules for the autoscaler by subclassing
<a class="reference internal" href="../internals/reference/celery.worker.autoscale.html#celery.worker.autoscale.Autoscaler" title="celery.worker.autoscale.Autoscaler"><code class="xref py py-class docutils literal notranslate"><span class="pre">Autoscaler</span></code></a>.
Some ideas for metrics include load average or the amount of memory available.
You can specify a custom autoscaler with the <a class="reference internal" href="configuration.html#std-setting-worker_autoscaler"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_autoscaler</span></code></a> setting.</p>
</div>
</div>
</section>
<section id="worker-queues">
<span id="id24"></span><h2>队列<a class="headerlink" href="#worker-queues" title="Link to this heading">¶</a></h2>
<p>Queues</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--27-input--1" name="tab-set--27" type="radio"><label class="tab-label" for="tab-set--27-input--1">中文</label><div class="tab-content docutils container">
<p>一个 Worker 实例可以消费任意数量的队列。
默认情况下，它会消费 <a class="reference internal" href="configuration.html#std-setting-task_queues"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_queues</span></code></a> 设置中定义的所有队列（如果未定义则默认使用名为 <code class="docutils literal notranslate"><span class="pre">celery</span></code> 的队列）。</p>
<p>你可以在启动时使用 <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-Q"><code class="xref std std-option docutils literal notranslate"><span class="pre">-Q</span></code></a> 选项传入用逗号分隔的队列列表，指定要消费的队列：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>-l<span class="w"> </span>INFO<span class="w"> </span>-Q<span class="w"> </span>foo,bar,baz
</pre></div>
</div>
<p>如果队列名称在 <a class="reference internal" href="configuration.html#std-setting-task_queues"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_queues</span></code></a> 中有定义，将使用该定义的配置；
如果未定义，Celery 将根据 <a class="reference internal" href="configuration.html#std-setting-task_create_missing_queues"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_create_missing_queues</span></code></a> 设置自动为你创建新队列。</p>
<p>你也可以在运行时通过远程控制命令 <a class="reference internal" href="#std-control-add_consumer"><code class="xref std std-control docutils literal notranslate"><span class="pre">add_consumer</span></code></a> 和 <a class="reference internal" href="#std-control-cancel_consumer"><code class="xref std std-control docutils literal notranslate"><span class="pre">cancel_consumer</span></code></a>
来动态添加或移除消费的队列。</p>
</div>
<input class="tab-input" id="tab-set--27-input--2" name="tab-set--27" type="radio"><label class="tab-label" for="tab-set--27-input--2">英文</label><div class="tab-content docutils container">
<p>A worker instance can consume from any number of queues.
By default it will consume from all queues defined in the
<a class="reference internal" href="configuration.html#std-setting-task_queues"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_queues</span></code></a> setting (that if not specified falls back to the
default queue named <code class="docutils literal notranslate"><span class="pre">celery</span></code>).</p>
<p>You can specify what queues to consume from at start-up, by giving a comma
separated list of queues to the <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-Q"><code class="xref std std-option docutils literal notranslate"><span class="pre">-Q</span></code></a> option:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>worker<span class="w"> </span>-l<span class="w"> </span>INFO<span class="w"> </span>-Q<span class="w"> </span>foo,bar,baz
</pre></div>
</div>
<p>If the queue name is defined in <a class="reference internal" href="configuration.html#std-setting-task_queues"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_queues</span></code></a> it will use that
configuration, but if it's not defined in the list of queues Celery will
automatically generate a new queue for you (depending on the
<a class="reference internal" href="configuration.html#std-setting-task_create_missing_queues"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_create_missing_queues</span></code></a> option).</p>
<p>You can also tell the worker to start and stop consuming from a queue at
run-time using the remote control commands <a class="reference internal" href="#std-control-add_consumer"><code class="xref std std-control docutils literal notranslate"><span class="pre">add_consumer</span></code></a> and
<a class="reference internal" href="#std-control-cancel_consumer"><code class="xref std std-control docutils literal notranslate"><span class="pre">cancel_consumer</span></code></a>.</p>
</div>
</div>
<section id="std-control-add_consumer">
<span id="id25"></span><h3>队列：添加消费者<a class="headerlink" href="#std-control-add_consumer" title="Link to this heading">¶</a></h3>
<p>Queues: Adding consumers</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--28-input--1" name="tab-set--28" type="radio"><label class="tab-label" for="tab-set--28-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="#std-control-add_consumer"><code class="xref std std-control docutils literal notranslate"><span class="pre">add_consumer</span></code></a> 控制命令会通知一个或多个 Worker 开始消费某个队列。该操作是幂等的。</p>
<p>要让集群中所有 Worker 开始消费名为 <code class="docutils literal notranslate"><span class="pre">foo</span></code> 的队列，可以使用 <strong class="program">celery control</strong> 命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>add_consumer<span class="w"> </span>foo
<span class="go">-&gt; worker1.local: OK</span>
<span class="go">    started consuming from u&#39;foo&#39;</span>
</pre></div>
</div>
<p>如果只希望某个特定 Worker 执行此操作，可以使用
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-control-d"><code class="xref std std-option docutils literal notranslate"><span class="pre">--destination</span></code></a> 参数：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>add_consumer<span class="w"> </span>foo<span class="w"> </span>-d<span class="w"> </span>celery@worker1.local
</pre></div>
</div>
<p>同样的操作也可以通过 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.add_consumer" title="celery.app.control.Control.add_consumer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.control.add_consumer()</span></code></a> 方法动态完成：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">add_consumer</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">reply</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">[{u&#39;worker1.local&#39;: {u&#39;ok&#39;: u&quot;already consuming from u&#39;foo&#39;&quot;}}]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">add_consumer</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">reply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>                         <span class="n">destination</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;worker1@example.com&#39;</span><span class="p">])</span>
<span class="go">[{u&#39;worker1.local&#39;: {u&#39;ok&#39;: u&quot;already consuming from u&#39;foo&#39;&quot;}}]</span>
</pre></div>
</div>
<p>以上示例展示的是基于自动队列配置的用法，
如果你需要更细粒度的控制，也可以自定义 exchange、routing_key 甚至其他选项：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">add_consumer</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;ex&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;topic&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;media.*&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">options</span><span class="o">=</span><span class="p">{</span>
<span class="gp">... </span>        <span class="s1">&#39;queue_durable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s1">&#39;exchange_durable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">},</span>
<span class="gp">... </span>    <span class="n">reply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">destination</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;w1@example.com&#39;</span><span class="p">,</span> <span class="s1">&#39;w2@example.com&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--28-input--2" name="tab-set--28" type="radio"><label class="tab-label" for="tab-set--28-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="#std-control-add_consumer"><code class="xref std std-control docutils literal notranslate"><span class="pre">add_consumer</span></code></a> control command will tell one or more workers
to start consuming from a queue. This operation is idempotent.</p>
<p>To tell all workers in the cluster to start consuming from a queue
named &quot;<code class="docutils literal notranslate"><span class="pre">foo</span></code>&quot; you can use the <strong class="program">celery control</strong> program:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>add_consumer<span class="w"> </span>foo
<span class="go">-&gt; worker1.local: OK</span>
<span class="go">    started consuming from u&#39;foo&#39;</span>
</pre></div>
</div>
<p>If you want to specify a specific worker you can use the
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-control-d"><code class="xref std std-option docutils literal notranslate"><span class="pre">--destination</span></code></a> argument:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>add_consumer<span class="w"> </span>foo<span class="w"> </span>-d<span class="w"> </span>celery@worker1.local
</pre></div>
</div>
<p>The same can be accomplished dynamically using the <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.add_consumer" title="celery.app.control.Control.add_consumer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.control.add_consumer()</span></code></a> method:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">add_consumer</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">reply</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">[{u&#39;worker1.local&#39;: {u&#39;ok&#39;: u&quot;already consuming from u&#39;foo&#39;&quot;}}]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">add_consumer</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">reply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>                         <span class="n">destination</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;worker1@example.com&#39;</span><span class="p">])</span>
<span class="go">[{u&#39;worker1.local&#39;: {u&#39;ok&#39;: u&quot;already consuming from u&#39;foo&#39;&quot;}}]</span>
</pre></div>
</div>
<p>By now we've only shown examples using automatic queues,
If you need more control you can also specify the exchange, routing_key and
even other options:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">add_consumer</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">exchange</span><span class="o">=</span><span class="s1">&#39;ex&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">exchange_type</span><span class="o">=</span><span class="s1">&#39;topic&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;media.*&#39;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">options</span><span class="o">=</span><span class="p">{</span>
<span class="gp">... </span>        <span class="s1">&#39;queue_durable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>        <span class="s1">&#39;exchange_durable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">},</span>
<span class="gp">... </span>    <span class="n">reply</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">destination</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;w1@example.com&#39;</span><span class="p">,</span> <span class="s1">&#39;w2@example.com&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="std-control-cancel_consumer">
<span id="id26"></span><h3>队列：取消消费者<a class="headerlink" href="#std-control-cancel_consumer" title="Link to this heading">¶</a></h3>
<p>Queues: Canceling consumers</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--29-input--1" name="tab-set--29" type="radio"><label class="tab-label" for="tab-set--29-input--1">中文</label><div class="tab-content docutils container">
<p>你可以使用 <a class="reference internal" href="#std-control-cancel_consumer"><code class="xref std std-control docutils literal notranslate"><span class="pre">cancel_consumer</span></code></a> 控制命令，通过队列名称取消一个消费者（consumer）。</p>
<p>如果你想强制集群中所有 Worker 停止消费某个队列，可以使用 <strong class="program">celery control</strong> 命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>cancel_consumer<span class="w"> </span>foo
</pre></div>
</div>
<p>你还可以使用 <a class="reference internal" href="../reference/cli.html#cmdoption-celery-control-d"><code class="xref std std-option docutils literal notranslate"><span class="pre">--destination</span></code></a> 参数，
指定一个或多个 Worker 来执行该命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>cancel_consumer<span class="w"> </span>foo<span class="w"> </span>-d<span class="w"> </span>celery@worker1.local
</pre></div>
</div>
<p>你也可以通过编程方式调用 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.cancel_consumer" title="celery.app.control.Control.cancel_consumer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.control.cancel_consumer()</span></code></a> 方法取消队列消费：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt; app.control.cancel_consumer(&#39;foo&#39;, reply=True)</span>
<span class="go">[{u&#39;worker1.local&#39;: {u&#39;ok&#39;: u&quot;no longer consuming from u&#39;foo&#39;&quot;}}]</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--29-input--2" name="tab-set--29" type="radio"><label class="tab-label" for="tab-set--29-input--2">英文</label><div class="tab-content docutils container">
<p>You can cancel a consumer by queue name using the <a class="reference internal" href="#std-control-cancel_consumer"><code class="xref std std-control docutils literal notranslate"><span class="pre">cancel_consumer</span></code></a>
control command.</p>
<p>To force all workers in the cluster to cancel consuming from a queue
you can use the <strong class="program">celery control</strong> program:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>cancel_consumer<span class="w"> </span>foo
</pre></div>
</div>
<p>The <a class="reference internal" href="../reference/cli.html#cmdoption-celery-control-d"><code class="xref std std-option docutils literal notranslate"><span class="pre">--destination</span></code></a> argument can be
used to specify a worker, or a list of workers, to act on the command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>cancel_consumer<span class="w"> </span>foo<span class="w"> </span>-d<span class="w"> </span>celery@worker1.local
</pre></div>
</div>
<p>You can also cancel consumers programmatically using the
<a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.cancel_consumer" title="celery.app.control.Control.cancel_consumer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.control.cancel_consumer()</span></code></a> method:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">&gt;&gt;&gt; app.control.cancel_consumer(&#39;foo&#39;, reply=True)</span>
<span class="go">[{u&#39;worker1.local&#39;: {u&#39;ok&#39;: u&quot;no longer consuming from u&#39;foo&#39;&quot;}}]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="std-control-active_queues">
<span id="id27"></span><h3>队列：活动队列列表<a class="headerlink" href="#std-control-active_queues" title="Link to this heading">¶</a></h3>
<p>Queues: List of active queues</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--30-input--1" name="tab-set--30" type="radio"><label class="tab-label" for="tab-set--30-input--1">中文</label><div class="tab-content docutils container">
<p>你可以使用 <a class="reference internal" href="#std-control-active_queues"><code class="xref std std-control docutils literal notranslate"><span class="pre">active_queues</span></code></a> 控制命令获取某个 Worker 当前正在消费的队列列表：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>inspect<span class="w"> </span>active_queues
<span class="go">[...]</span>
</pre></div>
</div>
<p>与其他远程控制命令一样，你也可以使用
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-inspect-d"><code class="xref std std-option docutils literal notranslate"><span class="pre">--destination</span></code></a> 参数来指定哪些 Worker 应当响应该请求：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>inspect<span class="w"> </span>active_queues<span class="w"> </span>-d<span class="w"> </span>celery@worker1.local
<span class="go">[...]</span>
</pre></div>
</div>
<p>你还可以通过编程方式调用
<a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.active_queues" title="celery.app.control.Inspect.active_queues"><code class="xref py py-meth docutils literal notranslate"><span class="pre">active_queues()</span></code></a> 方法实现相同的功能：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">inspect</span><span class="p">()</span><span class="o">.</span><span class="n">active_queues</span><span class="p">()</span>
<span class="go">[...]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">inspect</span><span class="p">([</span><span class="s1">&#39;worker1.local&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">active_queues</span><span class="p">()</span>
<span class="go">[...]</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--30-input--2" name="tab-set--30" type="radio"><label class="tab-label" for="tab-set--30-input--2">英文</label><div class="tab-content docutils container">
<p>You can get a list of queues that a worker consumes from by using
the <a class="reference internal" href="#std-control-active_queues"><code class="xref std std-control docutils literal notranslate"><span class="pre">active_queues</span></code></a> control command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>inspect<span class="w"> </span>active_queues
<span class="go">[...]</span>
</pre></div>
</div>
<p>Like all other remote control commands this also supports the
<a class="reference internal" href="../reference/cli.html#cmdoption-celery-inspect-d"><code class="xref std std-option docutils literal notranslate"><span class="pre">--destination</span></code></a> argument used
to specify the workers that should reply to the request:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>inspect<span class="w"> </span>active_queues<span class="w"> </span>-d<span class="w"> </span>celery@worker1.local
<span class="go">[...]</span>
</pre></div>
</div>
<p>This can also be done programmatically by using the
<a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.active_queues" title="celery.app.control.Inspect.active_queues"><code class="xref py py-meth docutils literal notranslate"><span class="pre">active_queues()</span></code></a> method:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">inspect</span><span class="p">()</span><span class="o">.</span><span class="n">active_queues</span><span class="p">()</span>
<span class="go">[...]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">inspect</span><span class="p">([</span><span class="s1">&#39;worker1.local&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">active_queues</span><span class="p">()</span>
<span class="go">[...]</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="worker-inspect">
<span id="id28"></span><h2>审查 worker<a class="headerlink" href="#worker-inspect" title="Link to this heading">¶</a></h2>
<p>Inspecting workers</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--31-input--1" name="tab-set--31" type="radio"><label class="tab-label" for="tab-set--31-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.inspect" title="celery.app.control.Control.inspect"><code class="xref py py-class docutils literal notranslate"><span class="pre">app.control.inspect</span></code></a> 类可用于检查正在运行的 Worker 状态。
它的底层使用的是远程控制命令。</p>
<p>你也可以使用 <code class="docutils literal notranslate"><span class="pre">celery</span></code> 命令来检查 Worker 状态，
其支持的命令与 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control" title="celery.app.control.Control"><code class="xref py py-class docutils literal notranslate"><span class="pre">app.control</span></code></a> 接口相同。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># 检查所有节点。</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">inspect</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># 指定多个节点进行检查。</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">inspect</span><span class="p">([</span><span class="s1">&#39;worker1.example.com&#39;</span><span class="p">,</span>
<span class="go">                            &#39;worker2.example.com&#39;])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># 指定单个节点进行检查。</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="s1">&#39;worker1.example.com&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--31-input--2" name="tab-set--31" type="radio"><label class="tab-label" for="tab-set--31-input--2">英文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.inspect" title="celery.app.control.Control.inspect"><code class="xref py py-class docutils literal notranslate"><span class="pre">app.control.inspect</span></code></a> lets you inspect running workers. It
uses remote control commands under the hood.</p>
<p>You can also use the <code class="docutils literal notranslate"><span class="pre">celery</span></code> command to inspect workers,
and it supports the same commands as the <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control" title="celery.app.control.Control"><code class="xref py py-class docutils literal notranslate"><span class="pre">app.control</span></code></a> interface.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Inspect all nodes.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">inspect</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Specify multiple nodes to inspect.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">inspect</span><span class="p">([</span><span class="s1">&#39;worker1.example.com&#39;</span><span class="p">,</span>
<span class="go">                            &#39;worker2.example.com&#39;])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Specify a single node to inspect.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="s1">&#39;worker1.example.com&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="worker-inspect-registered-tasks">
<span id="id29"></span><h3>已注册队列的转储<a class="headerlink" href="#worker-inspect-registered-tasks" title="Link to this heading">¶</a></h3>
<p>Dump of registered tasks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--32-input--1" name="tab-set--32" type="radio"><label class="tab-label" for="tab-set--32-input--1">中文</label><div class="tab-content docutils container">
<p>你可以使用 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.registered" title="celery.app.control.Inspect.registered"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registered()</span></code></a> 方法获取 Worker 中已注册任务的列表：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i</span><span class="o">.</span><span class="n">registered</span><span class="p">()</span>
<span class="go">[{&#39;worker1.example.com&#39;: [&#39;tasks.add&#39;,</span>
<span class="go">                        &#39;tasks.sleeptask&#39;]}]</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--32-input--2" name="tab-set--32" type="radio"><label class="tab-label" for="tab-set--32-input--2">英文</label><div class="tab-content docutils container">
<p>You can get a list of tasks registered in the worker using the
<a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.registered" title="celery.app.control.Inspect.registered"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registered()</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i</span><span class="o">.</span><span class="n">registered</span><span class="p">()</span>
<span class="go">[{&#39;worker1.example.com&#39;: [&#39;tasks.add&#39;,</span>
<span class="go">                        &#39;tasks.sleeptask&#39;]}]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="worker-inspect-active-tasks">
<span id="id30"></span><h3>当前正在执行的任务的转储<a class="headerlink" href="#worker-inspect-active-tasks" title="Link to this heading">¶</a></h3>
<p>Dump of currently executing tasks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--33-input--1" name="tab-set--33" type="radio"><label class="tab-label" for="tab-set--33-input--1">中文</label><div class="tab-content docutils container">
<p>你可以使用 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.active" title="celery.app.control.Inspect.active"><code class="xref py py-meth docutils literal notranslate"><span class="pre">active()</span></code></a> 方法获取当前正在执行的任务列表：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i</span><span class="o">.</span><span class="n">active</span><span class="p">()</span>
<span class="go">[{&#39;worker1.example.com&#39;:</span>
<span class="go">    [{&#39;name&#39;: &#39;tasks.sleeptask&#39;,</span>
<span class="go">    &#39;id&#39;: &#39;32666e9b-809c-41fa-8e93-5ae0c80afbbf&#39;,</span>
<span class="go">    &#39;args&#39;: &#39;(8,)&#39;,</span>
<span class="go">    &#39;kwargs&#39;: &#39;{}&#39;}]}]</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--33-input--2" name="tab-set--33" type="radio"><label class="tab-label" for="tab-set--33-input--2">英文</label><div class="tab-content docutils container">
<p>You can get a list of active tasks using
<a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.active" title="celery.app.control.Inspect.active"><code class="xref py py-meth docutils literal notranslate"><span class="pre">active()</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i</span><span class="o">.</span><span class="n">active</span><span class="p">()</span>
<span class="go">[{&#39;worker1.example.com&#39;:</span>
<span class="go">    [{&#39;name&#39;: &#39;tasks.sleeptask&#39;,</span>
<span class="go">    &#39;id&#39;: &#39;32666e9b-809c-41fa-8e93-5ae0c80afbbf&#39;,</span>
<span class="go">    &#39;args&#39;: &#39;(8,)&#39;,</span>
<span class="go">    &#39;kwargs&#39;: &#39;{}&#39;}]}]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="eta">
<span id="worker-inspect-eta-schedule"></span><h3>转储计划 (ETA) 任务<a class="headerlink" href="#eta" title="Link to this heading">¶</a></h3>
<p>Dump of scheduled (ETA) tasks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--34-input--1" name="tab-set--34" type="radio"><label class="tab-label" for="tab-set--34-input--1">中文</label><div class="tab-content docutils container">
<p>你可以使用 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.scheduled" title="celery.app.control.Inspect.scheduled"><code class="xref py py-meth docutils literal notranslate"><span class="pre">scheduled()</span></code></a> 方法获取等待调度的任务列表：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i</span><span class="o">.</span><span class="n">scheduled</span><span class="p">()</span>
<span class="go">[{&#39;worker1.example.com&#39;:</span>
<span class="go">    [{&#39;eta&#39;: &#39;2010-06-07 09:07:52&#39;, &#39;priority&#39;: 0,</span>
<span class="go">    &#39;request&#39;: {</span>
<span class="go">        &#39;name&#39;: &#39;tasks.sleeptask&#39;,</span>
<span class="go">        &#39;id&#39;: &#39;1a7980ea-8b19-413e-91d2-0b74f3844c4d&#39;,</span>
<span class="go">        &#39;args&#39;: &#39;[1]&#39;,</span>
<span class="go">        &#39;kwargs&#39;: &#39;{}&#39;}},</span>
<span class="go">    {&#39;eta&#39;: &#39;2010-06-07 09:07:53&#39;, &#39;priority&#39;: 0,</span>
<span class="go">    &#39;request&#39;: {</span>
<span class="go">        &#39;name&#39;: &#39;tasks.sleeptask&#39;,</span>
<span class="go">        &#39;id&#39;: &#39;49661b9a-aa22-4120-94b7-9ee8031d219d&#39;,</span>
<span class="go">        &#39;args&#39;: &#39;[2]&#39;,</span>
<span class="go">        &#39;kwargs&#39;: &#39;{}&#39;}}]}]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>这些任务是带有 ETA/countdown 参数的任务，而不是周期性任务。</p>
</div>
</div>
<input class="tab-input" id="tab-set--34-input--2" name="tab-set--34" type="radio"><label class="tab-label" for="tab-set--34-input--2">英文</label><div class="tab-content docutils container">
<p>You can get a list of tasks waiting to be scheduled by using
<a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.scheduled" title="celery.app.control.Inspect.scheduled"><code class="xref py py-meth docutils literal notranslate"><span class="pre">scheduled()</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i</span><span class="o">.</span><span class="n">scheduled</span><span class="p">()</span>
<span class="go">[{&#39;worker1.example.com&#39;:</span>
<span class="go">    [{&#39;eta&#39;: &#39;2010-06-07 09:07:52&#39;, &#39;priority&#39;: 0,</span>
<span class="go">    &#39;request&#39;: {</span>
<span class="go">        &#39;name&#39;: &#39;tasks.sleeptask&#39;,</span>
<span class="go">        &#39;id&#39;: &#39;1a7980ea-8b19-413e-91d2-0b74f3844c4d&#39;,</span>
<span class="go">        &#39;args&#39;: &#39;[1]&#39;,</span>
<span class="go">        &#39;kwargs&#39;: &#39;{}&#39;}},</span>
<span class="go">    {&#39;eta&#39;: &#39;2010-06-07 09:07:53&#39;, &#39;priority&#39;: 0,</span>
<span class="go">    &#39;request&#39;: {</span>
<span class="go">        &#39;name&#39;: &#39;tasks.sleeptask&#39;,</span>
<span class="go">        &#39;id&#39;: &#39;49661b9a-aa22-4120-94b7-9ee8031d219d&#39;,</span>
<span class="go">        &#39;args&#39;: &#39;[2]&#39;,</span>
<span class="go">        &#39;kwargs&#39;: &#39;{}&#39;}}]}]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>These are tasks with an ETA/countdown argument, not periodic tasks.</p>
</div>
</div>
</div>
</section>
<section id="worker-inspect-reserved">
<span id="id31"></span><h3>转储预留任务<a class="headerlink" href="#worker-inspect-reserved" title="Link to this heading">¶</a></h3>
<p>Dump of reserved tasks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--35-input--1" name="tab-set--35" type="radio"><label class="tab-label" for="tab-set--35-input--1">中文</label><div class="tab-content docutils container">
<p>保留任务（reserved tasks）是指已被接收但尚未执行的任务。</p>
<p>你可以使用 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.reserved" title="celery.app.control.Inspect.reserved"><code class="xref py py-meth docutils literal notranslate"><span class="pre">reserved()</span></code></a> 方法获取这些任务的列表：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i</span><span class="o">.</span><span class="n">reserved</span><span class="p">()</span>
<span class="go">[{&#39;worker1.example.com&#39;:</span>
<span class="go">    [{&#39;name&#39;: &#39;tasks.sleeptask&#39;,</span>
<span class="go">    &#39;id&#39;: &#39;32666e9b-809c-41fa-8e93-5ae0c80afbbf&#39;,</span>
<span class="go">    &#39;args&#39;: &#39;(8,)&#39;,</span>
<span class="go">    &#39;kwargs&#39;: &#39;{}&#39;}]}]</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--35-input--2" name="tab-set--35" type="radio"><label class="tab-label" for="tab-set--35-input--2">英文</label><div class="tab-content docutils container">
<p>Reserved tasks are tasks that have been received, but are still waiting to be
executed.</p>
<p>You can get a list of these using
<a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.reserved" title="celery.app.control.Inspect.reserved"><code class="xref py py-meth docutils literal notranslate"><span class="pre">reserved()</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">i</span><span class="o">.</span><span class="n">reserved</span><span class="p">()</span>
<span class="go">[{&#39;worker1.example.com&#39;:</span>
<span class="go">    [{&#39;name&#39;: &#39;tasks.sleeptask&#39;,</span>
<span class="go">    &#39;id&#39;: &#39;32666e9b-809c-41fa-8e93-5ae0c80afbbf&#39;,</span>
<span class="go">    &#39;args&#39;: &#39;(8,)&#39;,</span>
<span class="go">    &#39;kwargs&#39;: &#39;{}&#39;}]}]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="worker-statistics">
<span id="id32"></span><h3>统计信息<a class="headerlink" href="#worker-statistics" title="Link to this heading">¶</a></h3>
<p>Statistics</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--36-input--1" name="tab-set--36" type="radio"><label class="tab-label" for="tab-set--36-input--1">中文</label><div class="tab-content docutils container">
<p>远程控制命令 <code class="docutils literal notranslate"><span class="pre">inspect</span> <span class="pre">stats</span></code> （或方法 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.stats" title="celery.app.control.Inspect.stats"><code class="xref py py-meth docutils literal notranslate"><span class="pre">stats()</span></code></a>）可返回大量关于 Worker 的统计信息（有用的或无用的）：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>inspect<span class="w"> </span>stats
</pre></div>
</div>
<p>关于该命令的输出详情，请参阅 <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.stats" title="celery.app.control.Inspect.stats"><code class="xref py py-meth docutils literal notranslate"><span class="pre">stats()</span></code></a> 的参考文档。</p>
</div>
<input class="tab-input" id="tab-set--36-input--2" name="tab-set--36" type="radio"><label class="tab-label" for="tab-set--36-input--2">英文</label><div class="tab-content docutils container">
<p>The remote control command <code class="docutils literal notranslate"><span class="pre">inspect</span> <span class="pre">stats</span></code> (or
<a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.stats" title="celery.app.control.Inspect.stats"><code class="xref py py-meth docutils literal notranslate"><span class="pre">stats()</span></code></a>) will give you a long list of useful (or not
so useful) statistics about the worker:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>inspect<span class="w"> </span>stats
</pre></div>
</div>
<p>For the output details, consult the reference documentation of <a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Inspect.stats" title="celery.app.control.Inspect.stats"><code class="xref py py-meth docutils literal notranslate"><span class="pre">stats()</span></code></a>.</p>
</div>
</div>
</section>
</section>
<section id="id33">
<h2>附加命令<a class="headerlink" href="#id33" title="Link to this heading">¶</a></h2>
<p>Additional Commands</p>
<section id="std-control-shutdown">
<span id="id34"></span><h3>远程关闭<a class="headerlink" href="#std-control-shutdown" title="Link to this heading">¶</a></h3>
<p>Remote shutdown</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--37-input--1" name="tab-set--37" type="radio"><label class="tab-label" for="tab-set--37-input--1">中文</label><div class="tab-content docutils container">
<p>以下命令可优雅地远程关闭 Worker：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="s1">&#39;shutdown&#39;</span><span class="p">)</span> <span class="c1"># 关闭所有 Worker</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="s1">&#39;shutdown&#39;</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="s1">&#39;worker1@example.com&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--37-input--2" name="tab-set--37" type="radio"><label class="tab-label" for="tab-set--37-input--2">英文</label><div class="tab-content docutils container">
<p>This command will gracefully shut down the worker remotely:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="s1">&#39;shutdown&#39;</span><span class="p">)</span> <span class="c1"># shutdown all workers</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="s1">&#39;shutdown&#39;</span><span class="p">,</span> <span class="n">destination</span><span class="o">=</span><span class="s1">&#39;worker1@example.com&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="ping">
<span id="std-control-ping"></span><h3>Ping<a class="headerlink" href="#ping" title="Link to this heading">¶</a></h3>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--38-input--1" name="tab-set--38" type="radio"><label class="tab-label" for="tab-set--38-input--1">中文</label><div class="tab-content docutils container">
<p>以下命令用于请求所有存活的 Worker 返回 ping 响应。
Worker 会回复字符串 'pong'，仅此而已。
该方法默认超时时间为 1 秒，你也可以自定义超时：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="go">[{&#39;worker1.example.com&#39;: &#39;pong&#39;},</span>
<span class="go">{&#39;worker2.example.com&#39;: &#39;pong&#39;},</span>
<span class="go">{&#39;worker3.example.com&#39;: &#39;pong&#39;}]</span>
</pre></div>
</div>
<p><a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.ping" title="celery.app.control.Control.ping"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ping()</span></code></a> 也支持 <cite>destination</cite> 参数，
因此你可以指定要发送 ping 的 Worker：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ping</span><span class="p">([</span><span class="s1">&#39;worker2.example.com&#39;</span><span class="p">,</span> <span class="s1">&#39;worker3.example.com&#39;</span><span class="p">])</span>
<span class="go">[{&#39;worker2.example.com&#39;: &#39;pong&#39;},</span>
<span class="go">{&#39;worker3.example.com&#39;: &#39;pong&#39;}]</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--38-input--2" name="tab-set--38" type="radio"><label class="tab-label" for="tab-set--38-input--2">英文</label><div class="tab-content docutils container">
<p>This command requests a ping from alive workers.
The workers reply with the string 'pong', and that's just about it.
It will use the default one second timeout for replies unless you specify
a custom timeout:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">ping</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="go">[{&#39;worker1.example.com&#39;: &#39;pong&#39;},</span>
<span class="go">{&#39;worker2.example.com&#39;: &#39;pong&#39;},</span>
<span class="go">{&#39;worker3.example.com&#39;: &#39;pong&#39;}]</span>
</pre></div>
</div>
<p><a class="reference internal" href="../reference/celery.app.control.html#celery.app.control.Control.ping" title="celery.app.control.Control.ping"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ping()</span></code></a> also supports the <cite>destination</cite> argument,
so you can specify the workers to ping:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ping</span><span class="p">([</span><span class="s1">&#39;worker2.example.com&#39;</span><span class="p">,</span> <span class="s1">&#39;worker3.example.com&#39;</span><span class="p">])</span>
<span class="go">[{&#39;worker2.example.com&#39;: &#39;pong&#39;},</span>
<span class="go">{&#39;worker3.example.com&#39;: &#39;pong&#39;}]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="std-control-disable_events">
<span id="std-control-enable_events"></span><span id="worker-enable-events"></span><span id="id35"></span><h3>启用/禁用事件<a class="headerlink" href="#std-control-disable_events" title="Link to this heading">¶</a></h3>
<p>Enable/disable events</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--39-input--1" name="tab-set--39" type="radio"><label class="tab-label" for="tab-set--39-input--1">中文</label><div class="tab-content docutils container">
<p>你可以使用 <cite>enable_events</cite> 和 <cite>disable_events</cite> 命令来启用/禁用事件。这对于使用 <strong class="program">celery events</strong>/<strong class="program">celerymon</strong> 临时监控 Worker 非常有用。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">enable_events</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">disable_events</span><span class="p">()</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--39-input--2" name="tab-set--39" type="radio"><label class="tab-label" for="tab-set--39-input--2">英文</label><div class="tab-content docutils container">
<p>You can enable/disable events by using the <cite>enable_events</cite>,
<cite>disable_events</cite> commands. This is useful to temporarily monitor
a worker using <strong class="program">celery events</strong>/<strong class="program">celerymon</strong>.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">enable_events</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">disable_events</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="worker-custom-control-commands">
<span id="id36"></span><h2>编写您自己的远程控制命令<a class="headerlink" href="#worker-custom-control-commands" title="Link to this heading">¶</a></h2>
<p>Writing your own remote control commands</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--40-input--1" name="tab-set--40" type="radio"><label class="tab-label" for="tab-set--40-input--1">中文</label><div class="tab-content docutils container">
<p>远程控制命令有两种类型：</p>
<ul>
<li><p>Inspect 命令</p>
<p>不会有副作用，通常只是返回 Worker 中找到的一些值，比如当前已注册任务的列表、正在执行的任务列表等。</p>
</li>
<li><p>Control 命令</p>
<p>会有副作用，比如添加一个新的队列供消费。</p>
</li>
</ul>
<p>远程控制命令会在控制面板中注册，并且接受一个参数：当前的
<code class="xref py py-class docutils literal notranslate"><span class="pre">celery.worker.control.ControlDispatch</span></code> 实例。
从这里你可以访问活动的
<a class="reference internal" href="../reference/celery.worker.consumer.html#celery.worker.consumer.Consumer" title="celery.worker.consumer.Consumer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Consumer</span></code></a>，如果需要的话。</p>
<p>下面是一个控制命令的例子，用于增加任务的预取计数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.worker.control</span><span class="w"> </span><span class="kn">import</span> <span class="n">control_command</span>

<span class="nd">@control_command</span><span class="p">(</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)],</span>
    <span class="n">signature</span><span class="o">=</span><span class="s1">&#39;[N=1]&#39;</span><span class="p">,</span>  <span class="c1"># &lt;- 用于命令行帮助。</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">increase_prefetch_count</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">increment_eventually</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;ok&#39;</span><span class="p">:</span> <span class="s1">&#39;prefetch count incremented&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>确保将此代码添加到一个被 Worker 导入的模块中：
这个模块可以与定义 Celery 应用程序的模块相同，或者你可以
将该模块添加到 <a class="reference internal" href="configuration.html#std-setting-imports"><code class="xref std std-setting docutils literal notranslate"><span class="pre">imports</span></code></a> 设置中。</p>
<p>重新启动 Worker，以便注册控制命令，现在你可以使用 <strong class="program">celery control</strong> 工具调用你的命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>increase_prefetch_count<span class="w"> </span><span class="m">3</span>
</pre></div>
</div>
<p>你还可以将动作添加到 <strong class="program">celery inspect</strong> 程序中，
例如一个读取当前预取计数的命令：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.worker.control</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspect_command</span>

<span class="nd">@inspect_command</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">current_prefetch_count</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;prefetch_count&#39;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
</pre></div>
</div>
<p>重新启动 Worker 后，你现在可以使用 <strong class="program">celery inspect</strong> 程序查询此值：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>inspect<span class="w"> </span>current_prefetch_count
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--40-input--2" name="tab-set--40" type="radio"><label class="tab-label" for="tab-set--40-input--2">英文</label><div class="tab-content docutils container">
<p>There are two types of remote control commands:</p>
<ul>
<li><p>Inspect command</p>
<p>Does not have side effects, will usually just return some value
found in the worker, like the list of currently registered tasks,
the list of active tasks, etc.</p>
</li>
<li><p>Control command</p>
<p>Performs side effects, like adding a new queue to consume from.</p>
</li>
</ul>
<p>Remote control commands are registered in the control panel and
they take a single argument: the current
<code class="xref py py-class docutils literal notranslate"><span class="pre">celery.worker.control.ControlDispatch</span></code> instance.
From there you have access to the active
<a class="reference internal" href="../reference/celery.worker.consumer.html#celery.worker.consumer.Consumer" title="celery.worker.consumer.Consumer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Consumer</span></code></a> if needed.</p>
<p>Here's an example control command that increments the task prefetch count:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.worker.control</span><span class="w"> </span><span class="kn">import</span> <span class="n">control_command</span>

<span class="nd">@control_command</span><span class="p">(</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)],</span>
    <span class="n">signature</span><span class="o">=</span><span class="s1">&#39;[N=1]&#39;</span><span class="p">,</span>  <span class="c1"># &lt;- used for help on the command-line.</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">increase_prefetch_count</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">state</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">increment_eventually</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;ok&#39;</span><span class="p">:</span> <span class="s1">&#39;prefetch count incremented&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>Make sure you add this code to a module that is imported by the worker:
this could be the same module as where your Celery app is defined, or you
can add the module to the <a class="reference internal" href="configuration.html#std-setting-imports"><code class="xref std std-setting docutils literal notranslate"><span class="pre">imports</span></code></a> setting.</p>
<p>Restart the worker so that the control command is registered, and now you
can call your command using the <strong class="program">celery control</strong> utility:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>control<span class="w"> </span>increase_prefetch_count<span class="w"> </span><span class="m">3</span>
</pre></div>
</div>
<p>You can also add actions to the <strong class="program">celery inspect</strong> program,
for example one that reads the current prefetch count:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.worker.control</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspect_command</span>

<span class="nd">@inspect_command</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">current_prefetch_count</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;prefetch_count&#39;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>
</pre></div>
</div>
<p>After restarting the worker you can now query this value using the
<strong class="program">celery inspect</strong> program:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>celery<span class="w"> </span>-A<span class="w"> </span>proj<span class="w"> </span>inspect<span class="w"> </span>current_prefetch_count
</pre></div>
</div>
</div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="daemonizing.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">守护进程</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="canvas.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Canvas：设计工作流</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../copyright.html">Copyright</a> &#169; 2009-2023, Ask Solem &amp; contributors
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Workers 指南</a><ul>
<li><a class="reference internal" href="#worker">启动 worker</a></li>
<li><a class="reference internal" href="#worker-stopping">停止 worker</a><ul>
<li><a class="reference internal" href="#worker-shutdown">关闭 worker</a><ul>
<li><a class="reference internal" href="#worker-warm-shutdown">热关闭</a></li>
<li><a class="reference internal" href="#worker-remap-sigterm">冷关闭</a></li>
<li><a class="reference internal" href="#worker-soft-shutdown">软关闭</a></li>
<li><a class="reference internal" href="#worker-hard-shutdown">硬关闭</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#worker-restarting">重启 worker</a></li>
<li><a class="reference internal" href="#broker">与broker服务器连接丢失时自动重新连接</a></li>
<li><a class="reference internal" href="#worker-process-signals">进程信号</a></li>
<li><a class="reference internal" href="#worker-files">文件路径中的变量</a><ul>
<li><a class="reference internal" href="#id10">节点名称替换</a></li>
<li><a class="reference internal" href="#prefork">Prefork 池进程索引</a></li>
</ul>
</li>
<li><a class="reference internal" href="#worker-concurrency">并发</a></li>
<li><a class="reference internal" href="#worker-remote-control">远程控制</a><ul>
<li><a class="reference internal" href="#broadcast"><code class="xref py py-meth docutils literal notranslate"><span class="pre">broadcast()</span></code> 函数</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id13">命令</a><ul>
<li><a class="reference internal" href="#revoke"><code class="docutils literal notranslate"><span class="pre">revoke</span></code>: 撤销任务</a></li>
<li><a class="reference internal" href="#id14">撤销多个任务</a></li>
<li><a class="reference internal" href="#worker-persistent-revokes">持久性撤销</a></li>
<li><a class="reference internal" href="#revoke-by-stamped-headers"><code class="docutils literal notranslate"><span class="pre">revoke_by_stamped_headers</span></code>: 通过标记的标头撤销任务</a></li>
<li><a class="reference internal" href="#id16">通过标记的标头撤销多个任务</a></li>
</ul>
</li>
<li><a class="reference internal" href="#worker-time-limits">时间限制</a><ul>
<li><a class="reference internal" href="#id18">在运行时更改时间限制</a></li>
</ul>
</li>
<li><a class="reference internal" href="#worker-rate-limits">速率限制</a><ul>
<li><a class="reference internal" href="#std-control-rate_limit">在运行时更改速率限制</a></li>
</ul>
</li>
<li><a class="reference internal" href="#worker-max-tasks-per-child">每个子进程的最大任务数设置</a></li>
<li><a class="reference internal" href="#worker-max-memory-per-child">每个子进程的最大内存设置</a></li>
<li><a class="reference internal" href="#worker-autoscaling">自动扩缩</a></li>
<li><a class="reference internal" href="#worker-queues">队列</a><ul>
<li><a class="reference internal" href="#std-control-add_consumer">队列：添加消费者</a></li>
<li><a class="reference internal" href="#std-control-cancel_consumer">队列：取消消费者</a></li>
<li><a class="reference internal" href="#std-control-active_queues">队列：活动队列列表</a></li>
</ul>
</li>
<li><a class="reference internal" href="#worker-inspect">审查 worker</a><ul>
<li><a class="reference internal" href="#worker-inspect-registered-tasks">已注册队列的转储</a></li>
<li><a class="reference internal" href="#worker-inspect-active-tasks">当前正在执行的任务的转储</a></li>
<li><a class="reference internal" href="#eta">转储计划 (ETA) 任务</a></li>
<li><a class="reference internal" href="#worker-inspect-reserved">转储预留任务</a></li>
<li><a class="reference internal" href="#worker-statistics">统计信息</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id33">附加命令</a><ul>
<li><a class="reference internal" href="#std-control-shutdown">远程关闭</a></li>
<li><a class="reference internal" href="#ping">Ping</a></li>
<li><a class="reference internal" href="#std-control-disable_events">启用/禁用事件</a></li>
</ul>
</li>
<li><a class="reference internal" href="#worker-custom-control-commands">编写您自己的远程控制命令</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=8156d91f"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3ee01567"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=5eb1bb1e"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    </body>
</html>