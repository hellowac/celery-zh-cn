<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="copyright" title="版权所有" href="../copyright.html" /><link rel="next" title="配置和默认值" href="configuration.html" /><link rel="prev" title="使用 Celery 进行测试" href="testing.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>扩展 和 Bootsteps - Celery 5.5.1 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=3ee1c6c6" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/my.css?v=112ca36d" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Celery 5.5.1 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/celery_512_1.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Celery 5.5.1 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">版权</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../getting-started/index.html">快速开始</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 快速开始</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/introduction.html">Celery 简介</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../getting-started/backends-and-brokers/index.html">Backends 和 Brokers</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Backends 和 Brokers</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/rabbitmq.html">使用 RabbitMQ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/redis.html">使用 Redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/sqs.html">使用 Amazon SQS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/kafka.html">使用 Kafka</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/gcpubsub.html">使用 Google Pub/Sub</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/first-steps-with-celery.html">使用 Celery 的第一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/next-steps.html">下一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/resources.html">资源</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">用户指南</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 用户指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="application.html">应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="tasks.html">任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="calling.html">调用任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="canvas.html">Canvas：设计工作流</a></li>
<li class="toctree-l2"><a class="reference internal" href="workers.html">Workers 指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="daemonizing.html">守护进程</a></li>
<li class="toctree-l2"><a class="reference internal" href="periodic-tasks.html">周期性任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="routing.html">路由任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">监控和管理指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimizing.html">优化</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">调试</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="concurrency/index.html">并发</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 并发</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="concurrency/eventlet.html">Eventlet 并发</a></li>
<li class="toctree-l3"><a class="reference internal" href="concurrency/gevent.html">gevent 并发</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="signals.html">信号</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">使用 Celery 进行测试</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">扩展 和 Bootsteps</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">配置和默认值</a></li>
<li class="toctree-l2"><a class="reference internal" href="sphinx.html">使用 Sphinx 文档化任务</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../django/index.html">Django</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Django</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../django/first-steps-with-django.html">使用 Django 的第一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community.html">社区资源</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials/index.html">教程</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 教程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/task-cookbook.html">Task Cookbook</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">更改历史</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">API 参考</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of API 参考</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/cli.html">命令行接口</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">celery</span></code> --- Distributed processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.html">Proxies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.html#functions">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.task.html"><code class="docutils literal notranslate"><span class="pre">celery.app.task</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.amqp.html">AMQP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.amqp.html#queues">Queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.defaults.html"><code class="docutils literal notranslate"><span class="pre">celery.app.defaults</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.control.html"><code class="docutils literal notranslate"><span class="pre">celery.app.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.registry.html"><code class="docutils literal notranslate"><span class="pre">celery.app.registry</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.backends.html"><code class="docutils literal notranslate"><span class="pre">celery.app.backends</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.builtins.html"><code class="docutils literal notranslate"><span class="pre">celery.app.builtins</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.events.html"><code class="docutils literal notranslate"><span class="pre">celery.app.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.log.html"><code class="docutils literal notranslate"><span class="pre">celery.app.log</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.app.utils</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.autoretry.html"><code class="docutils literal notranslate"><span class="pre">celery.app.autoretry</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bootsteps.html"><code class="docutils literal notranslate"><span class="pre">celery.bootsteps</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.result.html"><code class="docutils literal notranslate"><span class="pre">celery.result</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.schedules.html"><code class="docutils literal notranslate"><span class="pre">celery.schedules</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.signals.html"><code class="docutils literal notranslate"><span class="pre">celery.signals</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.security.html"><code class="docutils literal notranslate"><span class="pre">celery.security</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.utils.debug.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.debug</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.exceptions.html"><code class="docutils literal notranslate"><span class="pre">celery.exceptions</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.app.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.app</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.default.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.default</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.base.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.base</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html">States</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#sets">Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#misc">Misc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.FAILURE"><code class="docutils literal notranslate"><span class="pre">FAILURE</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.PENDING"><code class="docutils literal notranslate"><span class="pre">PENDING</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.RECEIVED"><code class="docutils literal notranslate"><span class="pre">RECEIVED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.RETRY"><code class="docutils literal notranslate"><span class="pre">RETRY</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.REVOKED"><code class="docutils literal notranslate"><span class="pre">REVOKED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.STARTED"><code class="docutils literal notranslate"><span class="pre">STARTED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.SUCCESS"><code class="docutils literal notranslate"><span class="pre">SUCCESS</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.precedence"><code class="docutils literal notranslate"><span class="pre">precedence()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.state"><code class="docutils literal notranslate"><span class="pre">state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.abortable.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.abortable</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.django.task.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.django.task</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.migrate.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.migrate</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.pytest.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.pytest</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.sphinx.html">celery.contrib.sphinx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.app.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.app</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.manager.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.manager</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.mocks.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.mocks</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.rdb.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.rdb</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.html"><code class="docutils literal notranslate"><span class="pre">celery.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.receiver.html"><code class="docutils literal notranslate"><span class="pre">celery.events.receiver</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.dispatcher.html"><code class="docutils literal notranslate"><span class="pre">celery.events.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.event.html"><code class="docutils literal notranslate"><span class="pre">celery.events.event</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.state.html"><code class="docutils literal notranslate"><span class="pre">celery.events.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.multi.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.multi</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.request.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.request</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.state.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.strategy.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.strategy</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.agent.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.agent</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.connection.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.connection</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.consumer.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.consumer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.control.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.events.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.gossip.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.gossip</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.heart.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.heart</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.mingle.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.mingle</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.tasks.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.tasks</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.base.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.base</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.celery.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.celery</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.events.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.logtool.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.logtool</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.amqp.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.amqp</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.graph.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.graph</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.multi.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.multi</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.call.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.call</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.control.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.list.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.list</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.migrate.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.migrate</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.purge.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.purge</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.result.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.result</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.shell.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.shell</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.upgrade.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.upgrade</span></code></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../internals/index.html">内部</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of 内部</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../internals/guide.html">代码贡献指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/deprecation.html">Celery 弃用时间表</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/worker.html">内部的 worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/protocol.html">消息协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/app-overview.html">“大实例”重构</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../internals/reference/index.html">内部模块参考</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 内部模块参考</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.components.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.components</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.loops.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.loops</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.heartbeat.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.heartbeat</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.control.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.control</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.pidbox.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.pidbox</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.autoscale.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.autoscale</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.solo.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.solo</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.prefork.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.prefork</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.eventlet.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.eventlet</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.gevent.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.gevent</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.thread.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.thread</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.base.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.base</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.html"><code class="docutils literal notranslate"><span class="pre">celery.backends</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.base.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.base</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.asynchronous.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.asynchronous</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.azureblockblob.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.azureblockblob</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.rpc.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.rpc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cache.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cache</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.consul.html">celery.backends.consul</a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.couchdb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.couchdb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.mongodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.mongodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.elasticsearch.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.elasticsearch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.redis.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.redis</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cassandra.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cassandra</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.couchbase.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.couchbase</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.arangodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.arangodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.dynamodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.dynamodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.filesystem.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.filesystem</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cosmosdbsql.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cosmosdbsql</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.s3.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.s3</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.gcs.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.gcs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.trace.html"><code class="docutils literal notranslate"><span class="pre">celery.app.trace</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.annotations.html"><code class="docutils literal notranslate"><span class="pre">celery.app.annotations</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.routes.html"><code class="docutils literal notranslate"><span class="pre">celery.app.routes</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.certificate.html"><code class="docutils literal notranslate"><span class="pre">celery.security.certificate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.key.html"><code class="docutils literal notranslate"><span class="pre">celery.security.key</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.serialization.html"><code class="docutils literal notranslate"><span class="pre">celery.security.serialization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.security.utils</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.snapshot.html"><code class="docutils literal notranslate"><span class="pre">celery.events.snapshot</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.cursesmon.html"><code class="docutils literal notranslate"><span class="pre">celery.events.cursesmon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.dumper.html"><code class="docutils literal notranslate"><span class="pre">celery.events.dumper</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.models.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database.models</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.session.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database.session</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.utils</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.abstract.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.abstract</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.collections.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.collections</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.nodenames.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.nodenames</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.deprecated.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.deprecated</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.functional.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.functional</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.graph.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.graph</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.objects.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.objects</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.term.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.term</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.time.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.time</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.iso8601.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.iso8601</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.saferepr.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.saferepr</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.serialization.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.serialization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.sysinfo.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.sysinfo</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.threads.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.threads</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.timer2.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.timer2</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.imports.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.imports</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.log.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.text.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.text</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.dispatch.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.dispatch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.dispatch.signal.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.dispatch.signal</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.platforms.html"><code class="docutils literal notranslate"><span class="pre">celery.platforms</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery._state.html"><code class="docutils literal notranslate"><span class="pre">celery._state</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../history/index.html">历史</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of 历史</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.5.html">What's new in Celery 5.5 (Immunity)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.5.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.4.html">What's new in Celery 5.4 (Opalescent)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.4.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.3.html">What's new in Celery 5.3 (Emerald Rush)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.3.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.1.html">What's new in Celery 5.1 (Sun Harmonics)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.0.html">What's new in Celery 5.0 (singularity)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.0.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.4.html">What's new in Celery 4.4 (Cliffs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.4.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.3.html">What's new in Celery 4.3 (rhubarb)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.3.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.2.html">What's new in Celery 4.2 (windowlicker)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.2.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.1.html">What's new in Celery 4.1 (latentcall)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.0.html">What's new in Celery 4.0 (latentcall)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.0.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-3.1.html">What's new in Celery 3.1 (Cipater)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-3.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-3.0.html">What's new in Celery 3.0 (Chiastic Slide)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-3.0.html">Change history for Celery 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-2.5.html">What's new in Celery 2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.5.html">Change history for Celery 2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.4.html">Change history for Celery 2.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.3.html">Change history for Celery 2.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.2.html">Change history for Celery 2.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.1.html">Change history for Celery 2.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.0.html">Change history for Celery 2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-1.0.html">Change history for Celery 1.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">术语</a></li>
</ul>

</div>
<!-- <iframe src="https://ghbtns.com/github-btn.html?user=celery&repo=celery&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe> -->
<div id="donate">
  <h5>捐赠</h5>
  <p>请捐赠以支持这个社区项目</p>
  <a href="https://opencollective.com/celery/donate" target="_blank">
    <!-- <img src="https://opencollective.com/celery/donate/button@2x.png?color=blue" /> -->
    <img src="https://opencollective.com/celery/donate/button.png?color=blue" />
  </a>
</div></div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/userguide/extending.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="bootsteps">
<span id="guide-extending"></span><h1>扩展 和 Bootsteps<a class="headerlink" href="#bootsteps" title="Link to this heading">¶</a></h1>
<p>Extensions and Bootsteps</p>
<section id="extending-custom-consumers">
<span id="id1"></span><h2>自定义消息消费者<a class="headerlink" href="#extending-custom-consumers" title="Link to this heading">¶</a></h2>
<p>Custom Message Consumers</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">中文</label><div class="tab-content docutils container">
<p>你可能希望嵌入自定义的 Kombu 消费者（Consumer）来手动处理消息。</p>
<p>为此，Celery 提供了一个特殊的 <code class="xref py py-class docutils literal notranslate"><span class="pre">ConsumerStep</span></code> bootstep 类，
你只需定义 <code class="docutils literal notranslate"><span class="pre">get_consumers</span></code> 方法。该方法必须返回一个 <a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.html#kombu.Consumer" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">kombu.Consumer</span></code></a> 对象的列表，
这些消费者将在连接建立时启动：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootsteps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">kombu</span><span class="w"> </span><span class="kn">import</span> <span class="n">Consumer</span><span class="p">,</span> <span class="n">Exchange</span><span class="p">,</span> <span class="n">Queue</span>

<span class="n">my_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span> <span class="n">Exchange</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">),</span> <span class="s1">&#39;routing_key&#39;</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyConsumerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">ConsumerStep</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_consumers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Consumer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span>
                        <span class="n">queues</span><span class="o">=</span><span class="p">[</span><span class="n">my_queue</span><span class="p">],</span>
                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_message</span><span class="p">],</span>
                        <span class="n">accept</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">])]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;收到消息: </span><span class="si">{0!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
        <span class="n">message</span><span class="o">.</span><span class="n">ack</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;consumer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyConsumerStep</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_me_a_message</span><span class="p">(</span><span class="n">who</span><span class="p">,</span> <span class="n">producer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">producer_or_acquire</span><span class="p">(</span><span class="n">producer</span><span class="p">)</span> <span class="k">as</span> <span class="n">producer</span><span class="p">:</span>
        <span class="n">producer</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="n">who</span><span class="p">},</span>
            <span class="n">serializer</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span>
            <span class="n">exchange</span><span class="o">=</span><span class="n">my_queue</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span>
            <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;routing_key&#39;</span><span class="p">,</span>
            <span class="n">declare</span><span class="o">=</span><span class="p">[</span><span class="n">my_queue</span><span class="p">],</span>
            <span class="n">retry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">send_me_a_message</span><span class="p">(</span><span class="s1">&#39;world!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Kombu Consumer 支持两种不同的消息回调分发机制。
第一种是 <code class="docutils literal notranslate"><span class="pre">callbacks</span></code> 参数，它接受一个形如 <code class="docutils literal notranslate"><span class="pre">(body,</span> <span class="pre">message)</span></code> 的回调函数列表；
第二种是 <code class="docutils literal notranslate"><span class="pre">on_message</span></code> 参数，它接受一个形如 <code class="docutils literal notranslate"><span class="pre">(message,)</span></code> 的单个回调函数。
后者不会自动对消息进行解码与反序列化。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_consumers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Consumer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">queues</span><span class="o">=</span><span class="p">[</span><span class="n">my_queue</span><span class="p">],</span>
                    <span class="n">on_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_message</span><span class="p">)]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;收到消息: </span><span class="si">{0!r}</span><span class="s1"> </span><span class="si">{props!r}</span><span class="s1"> rawlen=</span><span class="si">{s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">payload</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">),</span>
    <span class="p">))</span>
    <span class="n">message</span><span class="o">.</span><span class="n">ack</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">英文</label><div class="tab-content docutils container">
<p>You may want to embed custom Kombu consumers to manually process your messages.</p>
<p>For that purpose a special <code class="xref py py-class docutils literal notranslate"><span class="pre">ConsumerStep</span></code> bootstep class
exists, where you only need to define the <code class="docutils literal notranslate"><span class="pre">get_consumers</span></code> method, that must
return a list of <a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.html#kombu.Consumer" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">kombu.Consumer</span></code></a> objects to start
whenever the connection is established:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootsteps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">kombu</span><span class="w"> </span><span class="kn">import</span> <span class="n">Consumer</span><span class="p">,</span> <span class="n">Exchange</span><span class="p">,</span> <span class="n">Queue</span>

<span class="n">my_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">,</span> <span class="n">Exchange</span><span class="p">(</span><span class="s1">&#39;custom&#39;</span><span class="p">),</span> <span class="s1">&#39;routing_key&#39;</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyConsumerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">ConsumerStep</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_consumers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Consumer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span>
                        <span class="n">queues</span><span class="o">=</span><span class="p">[</span><span class="n">my_queue</span><span class="p">],</span>
                        <span class="n">callbacks</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_message</span><span class="p">],</span>
                        <span class="n">accept</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;json&#39;</span><span class="p">])]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Received message: </span><span class="si">{0!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
        <span class="n">message</span><span class="o">.</span><span class="n">ack</span><span class="p">()</span>
<span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;consumer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyConsumerStep</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">send_me_a_message</span><span class="p">(</span><span class="n">who</span><span class="p">,</span> <span class="n">producer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">producer_or_acquire</span><span class="p">(</span><span class="n">producer</span><span class="p">)</span> <span class="k">as</span> <span class="n">producer</span><span class="p">:</span>
        <span class="n">producer</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="n">who</span><span class="p">},</span>
            <span class="n">serializer</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span>
            <span class="n">exchange</span><span class="o">=</span><span class="n">my_queue</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span>
            <span class="n">routing_key</span><span class="o">=</span><span class="s1">&#39;routing_key&#39;</span><span class="p">,</span>
            <span class="n">declare</span><span class="o">=</span><span class="p">[</span><span class="n">my_queue</span><span class="p">],</span>
            <span class="n">retry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">send_me_a_message</span><span class="p">(</span><span class="s1">&#39;world!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Kombu Consumers can take use of two different message callback dispatching
mechanisms. The first one is the <code class="docutils literal notranslate"><span class="pre">callbacks</span></code> argument that accepts
a list of callbacks with a <code class="docutils literal notranslate"><span class="pre">(body,</span> <span class="pre">message)</span></code> signature,
the second one is the <code class="docutils literal notranslate"><span class="pre">on_message</span></code> argument that takes a single
callback with a <code class="docutils literal notranslate"><span class="pre">(message,)</span></code> signature. The latter won't
automatically decode and deserialize the payload.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_consumers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Consumer</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">queues</span><span class="o">=</span><span class="p">[</span><span class="n">my_queue</span><span class="p">],</span>
                    <span class="n">on_message</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_message</span><span class="p">)]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;Received message: </span><span class="si">{0!r}</span><span class="s1"> </span><span class="si">{props!r}</span><span class="s1"> rawlen=</span><span class="si">{s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">payload</span><span class="p">,</span> <span class="n">props</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">),</span>
    <span class="p">))</span>
    <span class="n">message</span><span class="o">.</span><span class="n">ack</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="extending-blueprints">
<span id="id2"></span><h2>蓝图<a class="headerlink" href="#extending-blueprints" title="Link to this heading">¶</a></h2>
<p>Blueprints</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">中文</label><div class="tab-content docutils container">
<p>Bootsteps 是一种为 worker 添加自定义功能的机制。
一个 bootstep 是一个自定义类，它定义了一组钩子方法，用于在 worker 启动过程的不同阶段执行自定义操作。
每个 bootstep 都属于某个 blueprint，worker 当前定义了两个 blueprint：<strong>Worker</strong> 和 <strong>Consumer</strong></p>
<p><strong>图 A：</strong> Worker 和 Consumer blueprint 中的 Bootsteps。
从下往上，Worker blueprint 中的第一个步骤是 Timer，
最后一个步骤是启动 Consumer blueprint，
该 blueprint 将建立与 broker 的连接并开始消费消息。</p>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">英文</label><div class="tab-content docutils container">
<p>Bootsteps is a technique to add functionality to the workers.
A bootstep is a custom class that defines hooks to do custom actions
at different stages in the worker. Every bootstep belongs to a blueprint,
and the worker currently defines two blueprints: <strong>Worker</strong>, and <strong>Consumer</strong></p>
<dl class="simple">
<dt><strong>Figure A:</strong> Bootsteps in the Worker and Consumer blueprints. Starting</dt><dd><p>from the bottom up the first step in the worker blueprint
is the Timer, and the last step is to start the Consumer blueprint,
that then establishes the broker connection and starts
consuming messages.</p>
</dd>
</dl>
</div>
</div>
<figure class="align-default">
<img alt="../_images/worker_graph_full.png" src="../_images/worker_graph_full.png" />
</figure>
<hr class="docutils" />
</section>
<section id="worker">
<span id="extending-worker-blueprint"></span><h2>Worker<a class="headerlink" href="#worker" title="Link to this heading">¶</a></h2>
<p>Worker</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">中文</label><div class="tab-content docutils container">
<p>Worker 是第一个启动的 blueprint，它会启动主要组件，如事件循环（event loop）、
处理进程池（processing pool）、以及用于处理 ETA 任务和其他定时事件的 Timer。</p>
<p>当 worker 完全启动后，会继续启动 Consumer blueprint，
它负责设置任务的执行方式、连接 broker，并启动消息消费者。</p>
<p><a class="reference internal" href="../reference/celery.worker.html#celery.worker.WorkController" title="celery.worker.WorkController"><code class="xref py py-class docutils literal notranslate"><span class="pre">WorkController</span></code></a> 是 worker 的核心实现类，
它包含多个方法和属性，可供自定义 bootstep 使用。</p>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">英文</label><div class="tab-content docutils container">
<p>The Worker is the first blueprint to start, and with it starts major components like
the event loop, processing pool, and the timer used for ETA tasks and other
timed events.</p>
<p>When the worker is fully started it continues with the Consumer blueprint,
that sets up how tasks are executed, connects to the broker and starts
the message consumers.</p>
<p>The <a class="reference internal" href="../reference/celery.worker.html#celery.worker.WorkController" title="celery.worker.WorkController"><code class="xref py py-class docutils literal notranslate"><span class="pre">WorkController</span></code></a> is the core worker implementation,
and contains several methods and attributes that you can use in your bootstep.</p>
</div>
</div>
<section id="extending-worker-blueprint-attributes">
<span id="id3"></span><h3>属性<a class="headerlink" href="#extending-worker-blueprint-attributes" title="Link to this heading">¶</a></h3>
<p>Attributes</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">中文</label><div class="tab-content docutils container">
<dl class="py attribute" id="extending-worker-app">
<dt class="sig sig-object py" id="app">
<span class="sig-name descname"><span class="pre">app</span></span><a class="headerlink" href="#app" title="Link to this definition">¶</a></dt>
<dd><p>当前的 app 实例。</p>
</dd></dl>

<dl class="py attribute" id="extending-worker-hostname">
<dt class="sig sig-object py" id="hostname">
<span class="sig-name descname"><span class="pre">hostname</span></span><a class="headerlink" href="#hostname" title="Link to this definition">¶</a></dt>
<dd><p>Worker 的节点名称（例如：<cite>worker1&#64;example.com</cite>）</p>
</dd></dl>

<dl class="py attribute" id="id4">
<dt class="sig sig-object py" id="blueprint">
<span class="sig-name descname"><span class="pre">blueprint</span></span><a class="headerlink" href="#blueprint" title="Link to this definition">¶</a></dt>
<dd><p>这是该 worker 的 <a class="reference internal" href="../reference/celery.bootsteps.html#celery.bootsteps.Blueprint" title="celery.bootsteps.Blueprint"><code class="xref py py-class docutils literal notranslate"><span class="pre">Blueprint</span></code></a> 对象。</p>
</dd></dl>

<dl class="py attribute" id="extending-worker-hub">
<dt class="sig sig-object py" id="hub">
<span class="sig-name descname"><span class="pre">hub</span></span><a class="headerlink" href="#hub" title="Link to this definition">¶</a></dt>
<dd><p>事件循环对象（<a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.asynchronous.html#kombu.asynchronous.Hub" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Hub</span></code></a>）。你可以使用它在事件循环中注册回调。</p>
<p>仅在支持异步 I/O 的传输方式中可用（如 amqp、redis），
此时应设置 <cite>worker.use_eventloop</cite> 属性。</p>
<p>要在自定义的 worker bootstep 中使用该属性，你的 bootstep 必须依赖 Hub bootstep：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Hub&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute" id="extending-worker-pool">
<dt class="sig sig-object py" id="pool">
<span class="sig-name descname"><span class="pre">pool</span></span><a class="headerlink" href="#pool" title="Link to this definition">¶</a></dt>
<dd><p>当前使用的进程 / eventlet / gevent / 线程池。
参见 <a class="reference internal" href="../internals/reference/celery.concurrency.base.html#celery.concurrency.base.BasePool" title="celery.concurrency.base.BasePool"><code class="xref py py-class docutils literal notranslate"><span class="pre">celery.concurrency.base.BasePool</span></code></a>。</p>
<p>要在自定义的 worker bootstep 中使用该属性，你的 bootstep 必须依赖 Pool bootstep：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Pool&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute" id="extending-worker-timer">
<dt class="sig sig-object py" id="timer">
<span class="sig-name descname"><span class="pre">timer</span></span><a class="headerlink" href="#timer" title="Link to this definition">¶</a></dt>
<dd><p>用于调度函数的 <a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.asynchronous.timer.html#kombu.asynchronous.timer.Timer" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Timer</span></code></a> 实例。</p>
<p>要在自定义的 worker bootstep 中使用该属性，你的 bootstep 必须依赖 Timer bootstep：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Timer&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute" id="extending-worker-statedb">
<dt class="sig sig-object py" id="statedb">
<span class="sig-name descname"><span class="pre">statedb</span></span><a class="headerlink" href="#statedb" title="Link to this definition">¶</a></dt>
<dd><p>用于在 worker 重启之间持久化状态的 <a class="reference internal" href="../reference/celery.worker.state.html#celery.worker.state.Persistent" title="celery.worker.state.Persistent"><code class="xref py py-class docutils literal notranslate"><span class="pre">Database</span></code></a> 实例。</p>
<p>仅在启用了 <code class="docutils literal notranslate"><span class="pre">statedb</span></code> 参数时才会定义该属性。</p>
<p>要在自定义的 worker bootstep 中使用该属性，你的 bootstep 必须依赖 <code class="docutils literal notranslate"><span class="pre">Statedb</span></code> bootstep：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Statedb&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute" id="extending-worker-autoscaler">
<dt class="sig sig-object py" id="autoscaler">
<span class="sig-name descname"><span class="pre">autoscaler</span></span><a class="headerlink" href="#autoscaler" title="Link to this definition">¶</a></dt>
<dd><p>用于根据需要自动增加或减少进程数的
<code class="xref py py-class docutils literal notranslate"><span class="pre">Autoscaler</span></code> 实例。</p>
<p>仅在启用了 <code class="docutils literal notranslate"><span class="pre">autoscale</span></code> 参数时才会定义该属性。</p>
<p>要在自定义的 worker bootstep 中使用该属性，你的 bootstep 必须依赖 <cite>Autoscaler</cite> bootstep：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;celery.worker.autoscaler:Autoscaler&#39;</span><span class="p">,)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute" id="extending-worker-autoreloader">
<dt class="sig sig-object py" id="autoreloader">
<span class="sig-name descname"><span class="pre">autoreloader</span></span><a class="headerlink" href="#autoreloader" title="Link to this definition">¶</a></dt>
<dd><p>用于在文件系统发生变更时自动重新加载用户代码的
<code class="xref py py-class docutils literal notranslate"><span class="pre">Autoreloader</span></code> 实例。</p>
<p>仅在启用了 <code class="docutils literal notranslate"><span class="pre">autoreload</span></code> 参数时才会定义该属性。
要在自定义的 worker bootstep 中使用该属性，你的 bootstep 必须依赖 <cite>Autoreloader</cite> bootstep：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;celery.worker.autoreloader:Autoreloader&#39;</span><span class="p">,)</span>
</pre></div>
</div>
</dd></dl>

</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">英文</label><div class="tab-content docutils container">
<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">app</span></span></dt>
<dd><p>The current app instance.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">hostname</span></span></dt>
<dd><p>The workers node name (e.g., <cite>worker1&#64;example.com</cite>)</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">blueprint</span></span></dt>
<dd><p>This is the worker <a class="reference internal" href="../reference/celery.bootsteps.html#celery.bootsteps.Blueprint" title="celery.bootsteps.Blueprint"><code class="xref py py-class docutils literal notranslate"><span class="pre">Blueprint</span></code></a>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">hub</span></span></dt>
<dd><p>Event loop object (<a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.asynchronous.html#kombu.asynchronous.Hub" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Hub</span></code></a>). You can use
this to register callbacks in the event loop.</p>
<p>This is only supported by async I/O enabled transports (amqp, redis),
in which case the <cite>worker.use_eventloop</cite> attribute should be set.</p>
<p>Your worker bootstep must require the Hub bootstep to use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Hub&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">pool</span></span></dt>
<dd><p>The current process/eventlet/gevent/thread pool.
See <a class="reference internal" href="../internals/reference/celery.concurrency.base.html#celery.concurrency.base.BasePool" title="celery.concurrency.base.BasePool"><code class="xref py py-class docutils literal notranslate"><span class="pre">celery.concurrency.base.BasePool</span></code></a>.</p>
<p>Your worker bootstep must require the Pool bootstep to use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Pool&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">timer</span></span></dt>
<dd><p><a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.asynchronous.timer.html#kombu.asynchronous.timer.Timer" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Timer</span></code></a> used to schedule functions.</p>
<p>Your worker bootstep must require the Timer bootstep to use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Timer&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">statedb</span></span></dt>
<dd><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Database</span> <span class="pre">&lt;celery.worker.state.Persistent&gt;`</span></code> to persist state between
worker restarts.</p>
<p>This is only defined if the <code class="docutils literal notranslate"><span class="pre">statedb</span></code> argument is enabled.</p>
<p>Your worker bootstep must require the <code class="docutils literal notranslate"><span class="pre">Statedb</span></code> bootstep to use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Statedb&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">autoscaler</span></span></dt>
<dd><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Autoscaler</span></code> used to automatically grow
and shrink the number of processes in the pool.</p>
<p>This is only defined if the <code class="docutils literal notranslate"><span class="pre">autoscale</span></code> argument is enabled.</p>
<p>Your worker bootstep must require the <cite>Autoscaler</cite> bootstep to use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;celery.worker.autoscaler:Autoscaler&#39;</span><span class="p">,)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">autoreloader</span></span></dt>
<dd><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Autoreloader</span></code> used to automatically
reload use code when the file-system changes.</p>
<p>This is only defined if the <code class="docutils literal notranslate"><span class="pre">autoreload</span></code> argument is enabled.
Your worker bootstep must require the <cite>Autoreloader</cite> bootstep to use this;</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;celery.worker.autoreloader:Autoreloader&#39;</span><span class="p">,)</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
</section>
<section id="id5">
<h3>Worker 启动步骤示例<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<p>Example worker bootstep</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">中文</label><div class="tab-content docutils container">
<p>一个示例的 Worker bootstep 如下所示：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootsteps</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ExampleWorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Pool&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;在构造 WorkController 实例时调用&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;传递给 WorkController 的参数: </span><span class="si">{0!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># 此方法可用于将操作方法委托给实现了 ``start`` 和 ``stop`` 的其他对象。</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;在 worker 启动时调用。&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;在 worker 关闭时调用。&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;在 worker 终止时调用。&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>每个方法都会将当前的 <code class="docutils literal notranslate"><span class="pre">WorkController</span></code> 实例作为第一个参数传入。</p>
<p>另一个示例使用 timer 以定期唤醒方式运行：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootsteps</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DeadlockDetection</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Timer&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">deadlock_timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">deadlock_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># 每 30 秒运行一次。</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">call_repeatedly</span><span class="p">(</span>
            <span class="mf">30.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect</span><span class="p">,</span> <span class="p">(</span><span class="n">worker</span><span class="p">,),</span> <span class="n">priority</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tref</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tref</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># 更新活跃请求</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">worker</span><span class="o">.</span><span class="n">active_requests</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">time_start</span> <span class="ow">and</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">req</span><span class="o">.</span><span class="n">time_start</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">英文</label><div class="tab-content docutils container">
<p>An example Worker bootstep could be:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootsteps</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ExampleWorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Pool&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Called when the WorkController instance is constructed&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Arguments to WorkController: </span><span class="si">{0!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># this method can be used to delegate the action methods</span>
        <span class="c1"># to another object that implements ``start`` and ``stop``.</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Called when the worker is started.&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Called when the worker shuts down.&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Called when the worker terminates&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Every method is passed the current <code class="docutils literal notranslate"><span class="pre">WorkController</span></code> instance as the first
argument.</p>
<p>Another example could use the timer to wake up at regular intervals:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootsteps</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DeadlockDetection</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Timer&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">deadlock_timeout</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">deadlock_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># run every 30 seconds.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">call_repeatedly</span><span class="p">(</span>
            <span class="mf">30.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect</span><span class="p">,</span> <span class="p">(</span><span class="n">worker</span><span class="p">,),</span> <span class="n">priority</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tref</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tref</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tref</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">detect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># update active requests</span>
        <span class="k">for</span> <span class="n">req</span> <span class="ow">in</span> <span class="n">worker</span><span class="o">.</span><span class="n">active_requests</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">time_start</span> <span class="ow">and</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">req</span><span class="o">.</span><span class="n">time_start</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id6">
<h3>自定义任务处理日志<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h3>
<p>Customizing Task Handling Logs</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--1">中文</label><div class="tab-content docutils container">
<p>Celery worker 会在任务生命周期的不同事件点向 Python 的日志子系统发出消息。
你可以通过覆盖定义于 <code class="file docutils literal notranslate"><span class="pre">celery/app/trace.py</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">LOG_&lt;TYPE&gt;</span></code> 格式字符串
来自定义这些日志消息。</p>
<p>例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">celery.app.trace</span>

<span class="n">celery</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">LOG_SUCCESS</span> <span class="o">=</span> <span class="s2">&quot;This is a custom message&quot;</span>
</pre></div>
</div>
<p>所有格式字符串都使用任务名称和任务 ID 进行 <code class="docutils literal notranslate"><span class="pre">%</span></code> 格式化，
其中一些还包含附加字段，如任务返回值或导致任务失败的异常对象。
你可以像下面这样在自定义格式字符串中使用这些字段：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">celery.app.trace</span>

<span class="n">celery</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">LOG_REJECTED</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(name)r</span><span class="s2"> 是个被诅咒的任务，我拒绝执行：</span><span class="si">%(exc)s</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--2">英文</label><div class="tab-content docutils container">
<p>The Celery worker emits messages to the Python logging subsystem for various
events throughout the lifecycle of a task.
These messages can be customized by overriding the <code class="docutils literal notranslate"><span class="pre">LOG_&lt;TYPE&gt;</span></code> format
strings which are defined in <code class="file docutils literal notranslate"><span class="pre">celery/app/trace.py</span></code>.
For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">celery.app.trace</span>

<span class="n">celery</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">LOG_SUCCESS</span> <span class="o">=</span> <span class="s2">&quot;This is a custom message&quot;</span>
</pre></div>
</div>
<p>The various format strings are all provided with the task name and ID for
<code class="docutils literal notranslate"><span class="pre">%</span></code> formatting, and some of them receive extra fields like the return value
or the exception which caused a task to fail.
These fields can be used in custom format strings like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">celery.app.trace</span>

<span class="n">celery</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">LOG_REJECTED</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(name)r</span><span class="s2"> is cursed and I won&#39;t run it: </span><span class="si">%(exc)s</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="extending-consumer-blueprint">
<span id="id7"></span><h2>消费者<a class="headerlink" href="#extending-consumer-blueprint" title="Link to this heading">¶</a></h2>
<p>Consumer</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--1">中文</label><div class="tab-content docutils container">
<p>Consumer blueprint（消费者蓝图）用于与 broker 建立连接，并在连接断开时自动重启。
消费者 bootstep 包括 worker 的心跳机制、远程控制命令接收器，以及任务消费者（最为关键）。</p>
<p>在创建消费者 bootstep 时，必须确保你的 blueprint 支持重启。
消费者 bootstep 还定义了一个额外的 <cite>shutdown</cite> 方法，该方法会在 worker 关闭时调用。</p>
</div>
<input class="tab-input" id="tab-set--6-input--2" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--2">英文</label><div class="tab-content docutils container">
<p>The Consumer blueprint establishes a connection to the broker, and
is restarted every time this connection is lost. Consumer bootsteps
include the worker heartbeat, the remote control command consumer, and
importantly, the task consumer.</p>
<p>When you create consumer bootsteps you must take into account that it must
be possible to restart your blueprint. An additional 'shutdown' method is
defined for consumer bootsteps, this method is called when the worker is
shutdown.</p>
</div>
</div>
<section id="extending-consumer-attributes">
<span id="id8"></span><h3>属性<a class="headerlink" href="#extending-consumer-attributes" title="Link to this heading">¶</a></h3>
<p>Attributes</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--1">中文</label><div class="tab-content docutils container">
<dl class="py attribute" id="extending-consumer-app">
<dt class="sig sig-object py" id="id0">
<span class="sig-name descname"><span class="pre">app</span></span><a class="headerlink" href="#id0" title="Link to this definition">¶</a></dt>
<dd><p>当前的 app 实例。</p>
</dd></dl>

<dl class="py attribute" id="extending-consumer-controller">
<dt class="sig sig-object py" id="controller">
<span class="sig-name descname"><span class="pre">controller</span></span><a class="headerlink" href="#controller" title="Link to this definition">¶</a></dt>
<dd><p>创建该 consumer 的父级 <a class="reference internal" href="../reference/celery.worker.html#celery.worker.WorkController" title="celery.worker.WorkController"><code class="xref py py-class docutils literal notranslate"><span class="pre">WorkController</span></code></a> 对象。</p>
</dd></dl>

<dl class="py attribute" id="extending-consumer-hostname">
<dt class="sig sig-object py" id="id9">
<span class="sig-name descname"><span class="pre">hostname</span></span><a class="headerlink" href="#id9" title="Link to this definition">¶</a></dt>
<dd><p>worker 节点的名称（例如：<cite>worker1&#64;example.com</cite>）</p>
</dd></dl>

<dl class="py attribute" id="id10">
<dt class="sig sig-object py" id="id11">
<span class="sig-name descname"><span class="pre">blueprint</span></span><a class="headerlink" href="#id11" title="Link to this definition">¶</a></dt>
<dd><p>这是 worker 的 <a class="reference internal" href="../reference/celery.bootsteps.html#celery.bootsteps.Blueprint" title="celery.bootsteps.Blueprint"><code class="xref py py-class docutils literal notranslate"><span class="pre">Blueprint</span></code></a> 实例。</p>
</dd></dl>

<dl class="py attribute" id="extending-consumer-hub">
<dt class="sig sig-object py" id="id12">
<span class="sig-name descname"><span class="pre">hub</span></span><a class="headerlink" href="#id12" title="Link to this definition">¶</a></dt>
<dd><p>事件循环对象（<a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.asynchronous.html#kombu.asynchronous.Hub" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Hub</span></code></a>）。你可以使用它在事件循环中注册回调函数。</p>
<p>仅支持启用了异步 I/O 的 transport（如 amqp、redis），此时应设置 <cite>worker.use_eventloop</cite> 属性。</p>
<p>若要使用此属性，你的 worker bootstep 必须依赖 Hub bootstep：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Hub&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute" id="extending-consumer-connection">
<dt class="sig sig-object py" id="connection">
<span class="sig-name descname"><span class="pre">connection</span></span><a class="headerlink" href="#connection" title="Link to this definition">¶</a></dt>
<dd><p>当前的 broker 连接（<a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.html#kombu.Connection" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">kombu.Connection</span></code></a>）。</p>
<p>若要使用此属性，consumer bootstep 必须依赖 'Connection' bootstep：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.connection:Connection&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute" id="extending-consumer-event-dispatcher">
<dt class="sig sig-object py" id="event_dispatcher">
<span class="sig-name descname"><span class="pre">event_dispatcher</span></span><a class="headerlink" href="#event_dispatcher" title="Link to this definition">¶</a></dt>
<dd><p>一个 <code class="xref py py-class docutils literal notranslate"><span class="pre">app.events.Dispatcher</span></code> 对象，可用于发送事件。</p>
<p>若要使用此属性，consumer bootstep 必须依赖 <cite>Events</cite> bootstep。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.events:Events&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute" id="extending-consumer-gossip">
<dt class="sig sig-object py" id="gossip">
<span class="sig-name descname"><span class="pre">gossip</span></span><a class="headerlink" href="#gossip" title="Link to this definition">¶</a></dt>
<dd><p>用于 worker 间广播通信的对象
（<a class="reference internal" href="../reference/celery.worker.consumer.gossip.html#celery.worker.consumer.gossip.Gossip" title="celery.worker.consumer.gossip.Gossip"><code class="xref py py-class docutils literal notranslate"><span class="pre">Gossip</span></code></a>）。</p>
<p>若要使用此属性，consumer bootstep 必须依赖 <cite>Gossip</cite> bootstep。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RatelimitStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;基于集群中 worker 数量对任务进行速率限制。&quot;&quot;&quot;</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.gossip:Gossip&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">node_join</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_cluster_size_change</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">node_leave</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_cluster_size_change</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">node_lost</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_node_lost</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="s1">&#39;proj.tasks.add&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="s1">&#39;proj.tasks.mul&#39;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_size</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_cluster_size_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="n">cluster_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">alive_workers</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">cluster_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_size</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">rate_limit</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">cluster_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">reset_rate_limits</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_size</span> <span class="o">=</span> <span class="n">cluster_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_node_lost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># 可能由于心跳响应过晚，因此需要尽快再次检查该 worker 是否恢复</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">call_after</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_cluster_size_change</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>回调事件</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;set&gt;</span> <span class="pre">gossip.on.node_join</span></code></p>
<blockquote>
<div><p>当有新节点加入集群时触发，提供一个
<a class="reference internal" href="../reference/celery.events.state.html#celery.events.state.Worker" title="celery.events.state.Worker"><code class="xref py py-class docutils literal notranslate"><span class="pre">Worker</span></code></a> 实例。</p>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;set&gt;</span> <span class="pre">gossip.on.node_leave</span></code></p>
<blockquote>
<div><p>当有节点离开集群（关闭）时触发，提供一个
<a class="reference internal" href="../reference/celery.events.state.html#celery.events.state.Worker" title="celery.events.state.Worker"><code class="xref py py-class docutils literal notranslate"><span class="pre">Worker</span></code></a> 实例。</p>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;set&gt;</span> <span class="pre">gossip.on.node_lost</span></code></p>
<blockquote>
<div><p>当集群中的某个 worker 未能按时发送或处理心跳时触发，提供一个
<a class="reference internal" href="../reference/celery.events.state.html#celery.events.state.Worker" title="celery.events.state.Worker"><code class="xref py py-class docutils literal notranslate"><span class="pre">Worker</span></code></a> 实例。</p>
<p>这并不一定意味着 worker 真正离线，因此如果默认心跳超时不足以确认，
可使用额外的超时机制。</p>
</div></blockquote>
</li>
</ul>
</dd></dl>

<dl class="py attribute" id="extending-consumer-pool">
<dt class="sig sig-object py" id="id13">
<span class="sig-name descname"><span class="pre">pool</span></span><a class="headerlink" href="#id13" title="Link to this definition">¶</a></dt>
<dd><p>当前使用的进程 / eventlet / gevent / 线程池。
参考 <a class="reference internal" href="../internals/reference/celery.concurrency.base.html#celery.concurrency.base.BasePool" title="celery.concurrency.base.BasePool"><code class="xref py py-class docutils literal notranslate"><span class="pre">celery.concurrency.base.BasePool</span></code></a>。</p>
</dd></dl>

<dl class="py attribute" id="extending-consumer-timer">
<dt class="sig sig-object py" id="id14">
<span class="sig-name descname"><span class="pre">timer</span></span><a class="headerlink" href="#id14" title="Link to this definition">¶</a></dt>
<dd><p>用于调度函数的 <a class="reference internal" href="../internals/reference/celery.utils.timer2.html#celery.utils.timer2.Schedule" title="celery.utils.timer2.Schedule"><code class="xref py py-class docutils literal notranslate"><span class="pre">Timer</span></code></a>。</p>
</dd></dl>

<dl class="py attribute" id="extending-consumer-heart">
<dt class="sig sig-object py" id="heart">
<span class="sig-name descname"><span class="pre">heart</span></span><a class="headerlink" href="#heart" title="Link to this definition">¶</a></dt>
<dd><p>负责发送 worker 事件心跳的对象
（<a class="reference internal" href="../internals/reference/celery.worker.heartbeat.html#celery.worker.heartbeat.Heart" title="celery.worker.heartbeat.Heart"><code class="xref py py-class docutils literal notranslate"><span class="pre">Heart</span></code></a>）。</p>
<p>若要使用此属性，consumer bootstep 必须依赖 <cite>Heart</cite> bootstep：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.heart:Heart&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute" id="extending-consumer-task-consumer">
<dt class="sig sig-object py" id="task_consumer">
<span class="sig-name descname"><span class="pre">task_consumer</span></span><a class="headerlink" href="#task_consumer" title="Link to this definition">¶</a></dt>
<dd><p>用于消费任务消息的 <a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.html#kombu.Consumer" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">kombu.Consumer</span></code></a> 对象。</p>
<p>若要使用此属性，consumer bootstep 必须依赖 <cite>Tasks</cite> bootstep：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.tasks:Tasks&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute" id="extending-consumer-strategies">
<dt class="sig sig-object py" id="strategies">
<span class="sig-name descname"><span class="pre">strategies</span></span><a class="headerlink" href="#strategies" title="Link to this definition">¶</a></dt>
<dd><p>每个已注册的任务类型在此映射中都有一个条目，
映射值用于执行该类型任务的接收消息（即任务执行策略）。
此映射由 <cite>Tasks</cite> bootstep 在 consumer 启动时生成：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">strategies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">start_strategy</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">consumer</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">__trace__</span> <span class="o">=</span> <span class="n">celery</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">build_tracer</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">hostname</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>若要使用此属性，consumer bootstep 必须依赖 <cite>Tasks</cite> bootstep：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.tasks:Tasks&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute" id="extending-consumer-task-buckets">
<dt class="sig sig-object py" id="task_buckets">
<span class="sig-name descname"><span class="pre">task_buckets</span></span><a class="headerlink" href="#task_buckets" title="Link to this definition">¶</a></dt>
<dd><p>一个 <a class="reference external" href="https://docs.python.org/dev/library/collections.html#collections.defaultdict" title="（在 Python v3.15）"><code class="xref py py-class docutils literal notranslate"><span class="pre">defaultdict</span></code></a>，用于按任务类型查找其速率限制器。
此 dict 中的值可以是 None（表示无限制），也可以是实现了
<code class="docutils literal notranslate"><span class="pre">consume(tokens)</span></code> 和 <code class="docutils literal notranslate"><span class="pre">expected_time(tokens)</span></code> 方法的
<a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.utils.limits.html#kombu.utils.limits.TokenBucket" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">TokenBucket</span></code></a> 实例。</p>
<p><cite>TokenBucket</cite> 实现了 <a class="reference external" href="https://en.wikipedia.org/wiki/Token_bucket">令牌桶算法</a>，但只要符合上述接口和方法定义，
也可以使用其他算法。</p>
</dd></dl>

<dl class="py attribute" id="extending-consumer-qos">
<dt class="sig sig-object py" id="qos">
<span class="sig-name descname"><span class="pre">qos</span></span><a class="headerlink" href="#qos" title="Link to this definition">¶</a></dt>
<dd><p><code class="xref py py-class docutils literal notranslate"><span class="pre">QoS</span></code> 对象，用于修改当前任务通道的 <cite>prefetch_count</cite> 值：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 在下一个周期增加</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">increment_eventually</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># 在下一个周期减少</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">decrement_eventually</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
<input class="tab-input" id="tab-set--7-input--2" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--2">英文</label><div class="tab-content docutils container">
<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">app</span></span></dt>
<dd><p>The current app instance.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">controller</span></span></dt>
<dd><p>The parent <a class="reference internal" href="../reference/celery.worker.html#celery.worker.WorkController" title="celery.worker.WorkController"><code class="xref py py-class docutils literal notranslate"><span class="pre">WorkController</span></code></a> object that created this consumer.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">hostname</span></span></dt>
<dd><p>The workers node name (e.g., <cite>worker1&#64;example.com</cite>)</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">blueprint</span></span></dt>
<dd><p>This is the worker <a class="reference internal" href="../reference/celery.bootsteps.html#celery.bootsteps.Blueprint" title="celery.bootsteps.Blueprint"><code class="xref py py-class docutils literal notranslate"><span class="pre">Blueprint</span></code></a>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">hub</span></span></dt>
<dd><p>Event loop object (<a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.asynchronous.html#kombu.asynchronous.Hub" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Hub</span></code></a>). You can use
this to register callbacks in the event loop.</p>
<p>This is only supported by async I/O enabled transports (amqp, redis),
in which case the <cite>worker.use_eventloop</cite> attribute should be set.</p>
<p>Your worker bootstep must require the Hub bootstep to use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WorkerStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.components:Hub&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">connection</span></span></dt>
<dd><p>The current broker connection (<a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.html#kombu.Connection" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">kombu.Connection</span></code></a>).</p>
<p>A consumer bootstep must require the 'Connection' bootstep
to use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.connection:Connection&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">event_dispatcher</span></span></dt>
<dd><p>A <code class="xref py py-class docutils literal notranslate"><span class="pre">app.events.Dispatcher</span></code> object that can be used to send events.</p>
<p>A consumer bootstep must require the <cite>Events</cite> bootstep to use this.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.events:Events&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">gossip</span></span></dt>
<dd><p>Worker to worker broadcast communication
(<a class="reference internal" href="../reference/celery.worker.consumer.gossip.html#celery.worker.consumer.gossip.Gossip" title="celery.worker.consumer.gossip.Gossip"><code class="xref py py-class docutils literal notranslate"><span class="pre">Gossip</span></code></a>).</p>
<p>A consumer bootstep must require the <cite>Gossip</cite> bootstep to use this.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RatelimitStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rate limit tasks based on the number of workers in the</span>
<span class="sd">    cluster.&quot;&quot;&quot;</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.gossip:Gossip&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">node_join</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_cluster_size_change</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">node_leave</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_cluster_size_change</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">node_lost</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_node_lost</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="s1">&#39;proj.tasks.add&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="s1">&#39;proj.tasks.mul&#39;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_size</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_cluster_size_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="n">cluster_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gossip</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">alive_workers</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">cluster_size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_size</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">rate_limit</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">cluster_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">reset_rate_limits</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_size</span> <span class="o">=</span> <span class="n">cluster_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_node_lost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">):</span>
        <span class="c1"># may have processed heartbeat too late, so wake up soon</span>
        <span class="c1"># in order to see if the worker recovered.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">timer</span><span class="o">.</span><span class="n">call_after</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_cluster_size_change</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Callbacks</strong></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;set&gt;</span> <span class="pre">gossip.on.node_join</span></code></p>
<blockquote>
<div><p>Called whenever a new node joins the cluster, providing a
<a class="reference internal" href="../reference/celery.events.state.html#celery.events.state.Worker" title="celery.events.state.Worker"><code class="xref py py-class docutils literal notranslate"><span class="pre">Worker</span></code></a> instance.</p>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;set&gt;</span> <span class="pre">gossip.on.node_leave</span></code></p>
<blockquote>
<div><p>Called whenever a new node leaves the cluster (shuts down),
providing a <a class="reference internal" href="../reference/celery.events.state.html#celery.events.state.Worker" title="celery.events.state.Worker"><code class="xref py py-class docutils literal notranslate"><span class="pre">Worker</span></code></a> instance.</p>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;set&gt;</span> <span class="pre">gossip.on.node_lost</span></code></p>
<blockquote>
<div><p>Called whenever heartbeat was missed for a worker instance in the
cluster (heartbeat not received or processed in time),
providing a <a class="reference internal" href="../reference/celery.events.state.html#celery.events.state.Worker" title="celery.events.state.Worker"><code class="xref py py-class docutils literal notranslate"><span class="pre">Worker</span></code></a> instance.</p>
<p>This doesn't necessarily mean the worker is actually offline, so use a time
out mechanism if the default heartbeat timeout isn't sufficient.</p>
</div></blockquote>
</li>
</ul>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">pool</span></span></dt>
<dd><p>The current process/eventlet/gevent/thread pool.
See <a class="reference internal" href="../internals/reference/celery.concurrency.base.html#celery.concurrency.base.BasePool" title="celery.concurrency.base.BasePool"><code class="xref py py-class docutils literal notranslate"><span class="pre">celery.concurrency.base.BasePool</span></code></a>.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">timer</span></span></dt>
<dd><p><code class="xref py py-class docutils literal notranslate"><span class="pre">Timer</span> <span class="pre">&lt;celery.utils.timer2.Schedule</span></code> used to schedule functions.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">heart</span></span></dt>
<dd><p>Responsible for sending worker event heartbeats
(<a class="reference internal" href="../internals/reference/celery.worker.heartbeat.html#celery.worker.heartbeat.Heart" title="celery.worker.heartbeat.Heart"><code class="xref py py-class docutils literal notranslate"><span class="pre">Heart</span></code></a>).</p>
<p>Your consumer bootstep must require the <cite>Heart</cite> bootstep to use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.heart:Heart&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">task_consumer</span></span></dt>
<dd><p>The <a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.html#kombu.Consumer" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">kombu.Consumer</span></code></a> object used to consume task messages.</p>
<p>Your consumer bootstep must require the <cite>Tasks</cite> bootstep to use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.tasks:Tasks&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">strategies</span></span></dt>
<dd><p>Every registered task type has an entry in this mapping,
where the value is used to execute an incoming message of this task type
(the task execution strategy). This mapping is generated by the Tasks
bootstep when the consumer starts:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">strategies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">start_strategy</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">consumer</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">__trace__</span> <span class="o">=</span> <span class="n">celery</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">build_tracer</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">hostname</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Your consumer bootstep must require the <cite>Tasks</cite> bootstep to use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Step</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">StartStopStep</span><span class="p">):</span>
    <span class="n">requires</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;celery.worker.consumer.tasks:Tasks&#39;</span><span class="p">}</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">task_buckets</span></span></dt>
<dd><p>A <a class="reference external" href="https://docs.python.org/dev/library/collections.html#collections.defaultdict" title="（在 Python v3.15）"><code class="xref py py-class docutils literal notranslate"><span class="pre">defaultdict</span></code></a> used to look-up the rate limit for
a task by type.
Entries in this dict may be None (for no limit) or a
<a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.utils.limits.html#kombu.utils.limits.TokenBucket" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">TokenBucket</span></code></a> instance implementing
<code class="docutils literal notranslate"><span class="pre">consume(tokens)</span></code> and <code class="docutils literal notranslate"><span class="pre">expected_time(tokens)</span></code>.</p>
<p>TokenBucket implements the <a class="reference external" href="https://en.wikipedia.org/wiki/Token_bucket">token bucket algorithm</a>, but any algorithm
may be used as long as it conforms to the same interface and defines the
two methods above.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">qos</span></span></dt>
<dd><p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">QoS</span></code> object can be used to change the
task channels current prefetch_count value:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># increment at next cycle</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">increment_eventually</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># decrement at next cycle</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">decrement_eventually</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">qos</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>
</section>
<section id="id16">
<h3>方法<a class="headerlink" href="#id16" title="Link to this heading">¶</a></h3>
<p>Methods</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--1">中文</label><div class="tab-content docutils container">
<dl class="py method">
<dt class="sig sig-object py" id="consumer.reset_rate_limits">
<span class="sig-prename descclassname"><span class="pre">consumer.</span></span><span class="sig-name descname"><span class="pre">reset_rate_limits</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#consumer.reset_rate_limits" title="Link to this definition">¶</a></dt>
<dd><p>更新所有已注册任务类型的 <code class="docutils literal notranslate"><span class="pre">task_buckets</span></code> 映射。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="consumer.bucket_for_task">
<span class="sig-prename descclassname"><span class="pre">consumer.</span></span><span class="sig-name descname"><span class="pre">bucket_for_task</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">type</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">Bucket</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">TokenBucket</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#consumer.bucket_for_task" title="Link to this definition">¶</a></dt>
<dd><p>使用任务的 <code class="docutils literal notranslate"><span class="pre">task.rate_limit</span></code> 属性为任务创建速率限制桶。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">consumer.add_task_queue(name,</span> <span class="pre">exchange=None,</span> <span class="pre">exchange_type=None,</span></span></dt>
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">routing_key=None,</span> <span class="pre">**options):</span></span></dt>
<dd><p>添加新的队列以进行消费。此操作将在连接重启后继续生效。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="consumer.cancel_task_queue">
<span class="sig-prename descclassname"><span class="pre">consumer.</span></span><span class="sig-name descname"><span class="pre">cancel_task_queue</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#consumer.cancel_task_queue" title="Link to this definition">¶</a></dt>
<dd><p>停止消费指定名称的队列。此操作将在连接重启后继续生效。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="apply_eta_task">
<span class="sig-name descname"><span class="pre">apply_eta_task</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">request</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#apply_eta_task" title="Link to this definition">¶</a></dt>
<dd><p>根据 <code class="docutils literal notranslate"><span class="pre">request.eta</span></code> 属性调度 ETA 任务以执行。
（<a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request" title="celery.worker.request.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">Request</span></code></a>）</p>
</dd></dl>

</div>
<input class="tab-input" id="tab-set--8-input--2" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--2">英文</label><div class="tab-content docutils container">
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">consumer.</span></span><span class="sig-name descname"><span class="pre">reset_rate_limits</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span></dt>
<dd><p>Updates the <code class="docutils literal notranslate"><span class="pre">task_buckets</span></code> mapping for all registered task types.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">consumer.</span></span><span class="sig-name descname"><span class="pre">bucket_for_task</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">type</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">Bucket</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">TokenBucket</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Creates rate limit bucket for a task using its <code class="docutils literal notranslate"><span class="pre">task.rate_limit</span></code>
attribute.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">consumer.add_task_queue(name,</span> <span class="pre">exchange=None,</span> <span class="pre">exchange_type=None,</span></span></dt>
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">routing_key=None,</span> <span class="pre">**options):</span></span></dt>
<dd><p>Adds new queue to consume from. This will persist on connection restart.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">consumer.</span></span><span class="sig-name descname"><span class="pre">cancel_task_queue</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">name</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Stop consuming from queue by name. This will persist on connection
restart.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">apply_eta_task</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">request</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Schedule ETA task to execute based on the <code class="docutils literal notranslate"><span class="pre">request.eta</span></code> attribute.
(<a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request" title="celery.worker.request.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">Request</span></code></a>)</p>
</dd></dl>

</div>
</div>
</section>
</section>
<section id="extending-bootsteps">
<span id="id17"></span><h2>安装启动步骤<a class="headerlink" href="#extending-bootsteps" title="Link to this heading">¶</a></h2>
<p>Installing Bootsteps</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--1">中文</label><div class="tab-content docutils container">
<p><code class="docutils literal notranslate"><span class="pre">app.steps['worker']</span></code> 和 <code class="docutils literal notranslate"><span class="pre">app.steps['consumer']</span></code> 可被修改以添加新的启动步骤（bootstep）：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;worker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyWorkerStep</span><span class="p">)</span>  <span class="c1"># &lt; 添加类，不实例化</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;consumer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyConsumerStep</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;consumer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">StepA</span><span class="p">,</span> <span class="n">StepB</span><span class="p">])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;consumer&#39;</span><span class="p">]</span>
<span class="go">{step:proj.StepB{()}, step:proj.MyConsumerStep{()}, step:proj.StepA{()}}</span>
</pre></div>
</div>
<p>步骤的顺序在此处并不重要，因为最终的执行顺序是由生成的依赖图（<code class="docutils literal notranslate"><span class="pre">Step.requires</span></code>）决定的。</p>
<p>以下是一个示例步骤，用来演示如何安装 bootstep 以及它们的工作原理。这个步骤会打印一些无用的调试信息。
它既可以作为 worker 的 bootstep，也可以作为 consumer 的 bootstep 添加：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootsteps</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InfoStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">Step</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># 我们可以在这里以任意方式初始化 Worker/Consumer 对象，</span>
        <span class="c1"># 例如设置默认属性等。</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0!r}</span><span class="s1"> is in init&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="c1"># 此步骤将在所有其他 Worker/Consumer 的 bootstep 启动时一同启动。</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0!r}</span><span class="s1"> is starting&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="c1"># Consumer 每次重启（例如连接丢失）以及关闭时都会调用 stop。</span>
        <span class="c1"># Worker 仅在关闭时调用 stop。</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0!r}</span><span class="s1"> is stopping&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="c1"># shutdown 会在 Consumer 关闭时调用，而不会被 Worker 调用。</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0!r}</span><span class="s1"> is shutting down&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;worker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">InfoStep</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;consumer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">InfoStep</span><span class="p">)</span>
</pre></div>
</div>
<p>使用该步骤启动 worker 时，会产生以下日志输出：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;Worker: w@example.com (initializing)&gt; is in init
&lt;Consumer: w@example.com (initializing)&gt; is in init
[2013-05-29 16:18:20,544: WARNING/MainProcess]
    &lt;Worker: w@example.com (running)&gt; is starting
[2013-05-29 16:18:21,577: WARNING/MainProcess]
    &lt;Consumer: w@example.com (running)&gt; is starting
&lt;Consumer: w@example.com (closing)&gt; is stopping
&lt;Worker: w@example.com (closing)&gt; is stopping
&lt;Consumer: w@example.com (terminating)&gt; is shutting down
</pre></div>
</div>
<p>这些 <code class="docutils literal notranslate"><span class="pre">print</span></code> 语句会在 worker 初始化后被重定向到日志系统，因此 &quot;is starting&quot; 的日志是带有时间戳的。
你可能会注意到在 shutdown 时不再输出这些信息，这是因为 <code class="docutils literal notranslate"><span class="pre">stop</span></code> 和 <code class="docutils literal notranslate"><span class="pre">shutdown</span></code> 方法是在 <em>信号处理器</em> 中调用的，
而在信号处理器中使用日志系统是不安全的。</p>
<p>使用 Python 的日志模块记录信息并不是 <a class="reference internal" href="../glossary.html#term-reentrant"><span class="xref std std-term">可重入</span></a> 的：
也就是说你不能在函数执行中断后再次调用它。因此你所编写的 <code class="docutils literal notranslate"><span class="pre">stop</span></code> 和 <code class="docutils literal notranslate"><span class="pre">shutdown</span></code> 方法也必须是 <a class="reference internal" href="../glossary.html#term-reentrant"><span class="xref std std-term">可重入</span></a> 的。</p>
<p>以 <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-l"><code class="xref std std-option docutils literal notranslate"><span class="pre">--loglevel=debug</span></code></a> 启动 worker 会显示更多有关启动过程的信息：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[2013-05-29 16:18:20,509: DEBUG/MainProcess] | Worker: Preparing bootsteps.
[2013-05-29 16:18:20,511: DEBUG/MainProcess] | Worker: Building graph...
&lt;celery.apps.worker.Worker object at 0x101ad8410&gt; is in init
[2013-05-29 16:18:20,511: DEBUG/MainProcess] | Worker: New boot order:
    {Hub, Pool, Timer, StateDB, Autoscaler, InfoStep, Beat, Consumer}
[2013-05-29 16:18:20,514: DEBUG/MainProcess] | Consumer: Preparing bootsteps.
[2013-05-29 16:18:20,514: DEBUG/MainProcess] | Consumer: Building graph...
&lt;celery.worker.consumer.Consumer object at 0x101c2d8d0&gt; is in init
[2013-05-29 16:18:20,515: DEBUG/MainProcess] | Consumer: New boot order:
    {Connection, Mingle, Events, Gossip, InfoStep, Agent,
    Heart, Control, Tasks, event loop}
[2013-05-29 16:18:20,522: DEBUG/MainProcess] | Worker: Starting Hub
[2013-05-29 16:18:20,522: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:20,522: DEBUG/MainProcess] | Worker: Starting Pool
[2013-05-29 16:18:20,542: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:20,543: DEBUG/MainProcess] | Worker: Starting InfoStep
[2013-05-29 16:18:20,544: WARNING/MainProcess]
    &lt;celery.apps.worker.Worker object at 0x101ad8410&gt; is starting
[2013-05-29 16:18:20,544: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:20,544: DEBUG/MainProcess] | Worker: Starting Consumer
[2013-05-29 16:18:20,544: DEBUG/MainProcess] | Consumer: Starting Connection
[2013-05-29 16:18:20,559: INFO/MainProcess] Connected to amqp://guest@127.0.0.1:5672//
[2013-05-29 16:18:20,560: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:20,560: DEBUG/MainProcess] | Consumer: Starting Mingle
[2013-05-29 16:18:20,560: INFO/MainProcess] mingle: searching for neighbors
[2013-05-29 16:18:21,570: INFO/MainProcess] mingle: no one here
[2013-05-29 16:18:21,570: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,571: DEBUG/MainProcess] | Consumer: Starting Events
[2013-05-29 16:18:21,572: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,572: DEBUG/MainProcess] | Consumer: Starting Gossip
[2013-05-29 16:18:21,577: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,577: DEBUG/MainProcess] | Consumer: Starting InfoStep
[2013-05-29 16:18:21,577: WARNING/MainProcess]
    &lt;celery.worker.consumer.Consumer object at 0x101c2d8d0&gt; is starting
[2013-05-29 16:18:21,578: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,578: DEBUG/MainProcess] | Consumer: Starting Heart
[2013-05-29 16:18:21,579: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,579: DEBUG/MainProcess] | Consumer: Starting Control
[2013-05-29 16:18:21,583: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,583: DEBUG/MainProcess] | Consumer: Starting Tasks
[2013-05-29 16:18:21,606: DEBUG/MainProcess] basic.qos: prefetch_count-&gt;80
[2013-05-29 16:18:21,606: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,606: DEBUG/MainProcess] | Consumer: Starting event loop
[2013-05-29 16:18:21,608: WARNING/MainProcess] celery@example.com ready.
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--2">英文</label><div class="tab-content docutils container">
<p><code class="docutils literal notranslate"><span class="pre">app.steps['worker']</span></code> and <code class="docutils literal notranslate"><span class="pre">app.steps['consumer']</span></code> can be modified
to add new bootsteps:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;worker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyWorkerStep</span><span class="p">)</span>  <span class="c1"># &lt; add class, don&#39;t instantiate</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;consumer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyConsumerStep</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;consumer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">StepA</span><span class="p">,</span> <span class="n">StepB</span><span class="p">])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;consumer&#39;</span><span class="p">]</span>
<span class="go">{step:proj.StepB{()}, step:proj.MyConsumerStep{()}, step:proj.StepA{()}</span>
</pre></div>
</div>
<p>The order of steps isn't important here as the order is decided by the
resulting dependency graph (<code class="docutils literal notranslate"><span class="pre">Step.requires</span></code>).</p>
<p>To illustrate how you can install bootsteps and how they work, this is an example step that
prints some useless debugging information.
It can be added both as a worker and consumer bootstep:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootsteps</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InfoStep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">Step</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># here we can prepare the Worker/Consumer object</span>
        <span class="c1"># in any way we want, set attribute defaults, and so on.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0!r}</span><span class="s1"> is in init&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="c1"># our step is started together with all other Worker/Consumer</span>
        <span class="c1"># bootsteps.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0!r}</span><span class="s1"> is starting&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="c1"># the Consumer calls stop every time the consumer is</span>
        <span class="c1"># restarted (i.e., connection is lost) and also at shutdown.</span>
        <span class="c1"># The Worker will call stop at shutdown only.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0!r}</span><span class="s1"> is stopping&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="c1"># shutdown is called by the Consumer at shutdown, it&#39;s not</span>
        <span class="c1"># called by Worker.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0!r}</span><span class="s1"> is shutting down&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://&#39;</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;worker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">InfoStep</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;consumer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">InfoStep</span><span class="p">)</span>
</pre></div>
</div>
<p>Starting the worker with this step installed will give us the following
logs:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;Worker: w@example.com (initializing)&gt; is in init
&lt;Consumer: w@example.com (initializing)&gt; is in init
[2013-05-29 16:18:20,544: WARNING/MainProcess]
    &lt;Worker: w@example.com (running)&gt; is starting
[2013-05-29 16:18:21,577: WARNING/MainProcess]
    &lt;Consumer: w@example.com (running)&gt; is starting
&lt;Consumer: w@example.com (closing)&gt; is stopping
&lt;Worker: w@example.com (closing)&gt; is stopping
&lt;Consumer: w@example.com (terminating)&gt; is shutting down
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">print</span></code> statements will be redirected to the logging subsystem after
the worker has been initialized, so the &quot;is starting&quot; lines are time-stamped.
You may notice that this does no longer happen at shutdown, this is because
the <code class="docutils literal notranslate"><span class="pre">stop</span></code> and <code class="docutils literal notranslate"><span class="pre">shutdown</span></code> methods are called inside a <em>signal handler</em>,
and it's not safe to use logging inside such a handler.
Logging with the Python logging module isn't <a class="reference internal" href="../glossary.html#term-reentrant"><span class="xref std std-term">reentrant</span></a>:
meaning you cannot interrupt the function then
call it again later. It's important that the <code class="docutils literal notranslate"><span class="pre">stop</span></code> and <code class="docutils literal notranslate"><span class="pre">shutdown</span></code> methods
you write is also <a class="reference internal" href="../glossary.html#term-reentrant"><span class="xref std std-term">reentrant</span></a>.</p>
<p>Starting the worker with <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-l"><code class="xref std std-option docutils literal notranslate"><span class="pre">--loglevel=debug</span></code></a>
will show us more information about the boot process:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[2013-05-29 16:18:20,509: DEBUG/MainProcess] | Worker: Preparing bootsteps.
[2013-05-29 16:18:20,511: DEBUG/MainProcess] | Worker: Building graph...
&lt;celery.apps.worker.Worker object at 0x101ad8410&gt; is in init
[2013-05-29 16:18:20,511: DEBUG/MainProcess] | Worker: New boot order:
    {Hub, Pool, Timer, StateDB, Autoscaler, InfoStep, Beat, Consumer}
[2013-05-29 16:18:20,514: DEBUG/MainProcess] | Consumer: Preparing bootsteps.
[2013-05-29 16:18:20,514: DEBUG/MainProcess] | Consumer: Building graph...
&lt;celery.worker.consumer.Consumer object at 0x101c2d8d0&gt; is in init
[2013-05-29 16:18:20,515: DEBUG/MainProcess] | Consumer: New boot order:
    {Connection, Mingle, Events, Gossip, InfoStep, Agent,
    Heart, Control, Tasks, event loop}
[2013-05-29 16:18:20,522: DEBUG/MainProcess] | Worker: Starting Hub
[2013-05-29 16:18:20,522: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:20,522: DEBUG/MainProcess] | Worker: Starting Pool
[2013-05-29 16:18:20,542: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:20,543: DEBUG/MainProcess] | Worker: Starting InfoStep
[2013-05-29 16:18:20,544: WARNING/MainProcess]
    &lt;celery.apps.worker.Worker object at 0x101ad8410&gt; is starting
[2013-05-29 16:18:20,544: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:20,544: DEBUG/MainProcess] | Worker: Starting Consumer
[2013-05-29 16:18:20,544: DEBUG/MainProcess] | Consumer: Starting Connection
[2013-05-29 16:18:20,559: INFO/MainProcess] Connected to amqp://guest@127.0.0.1:5672//
[2013-05-29 16:18:20,560: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:20,560: DEBUG/MainProcess] | Consumer: Starting Mingle
[2013-05-29 16:18:20,560: INFO/MainProcess] mingle: searching for neighbors
[2013-05-29 16:18:21,570: INFO/MainProcess] mingle: no one here
[2013-05-29 16:18:21,570: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,571: DEBUG/MainProcess] | Consumer: Starting Events
[2013-05-29 16:18:21,572: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,572: DEBUG/MainProcess] | Consumer: Starting Gossip
[2013-05-29 16:18:21,577: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,577: DEBUG/MainProcess] | Consumer: Starting InfoStep
[2013-05-29 16:18:21,577: WARNING/MainProcess]
    &lt;celery.worker.consumer.Consumer object at 0x101c2d8d0&gt; is starting
[2013-05-29 16:18:21,578: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,578: DEBUG/MainProcess] | Consumer: Starting Heart
[2013-05-29 16:18:21,579: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,579: DEBUG/MainProcess] | Consumer: Starting Control
[2013-05-29 16:18:21,583: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,583: DEBUG/MainProcess] | Consumer: Starting Tasks
[2013-05-29 16:18:21,606: DEBUG/MainProcess] basic.qos: prefetch_count-&gt;80
[2013-05-29 16:18:21,606: DEBUG/MainProcess] ^-- substep ok
[2013-05-29 16:18:21,606: DEBUG/MainProcess] | Consumer: Starting event loop
[2013-05-29 16:18:21,608: WARNING/MainProcess] celery@example.com ready.
</pre></div>
</div>
</div>
</div>
</section>
<section id="extending-programs">
<span id="id18"></span><h2>命令行程序<a class="headerlink" href="#extending-programs" title="Link to this heading">¶</a></h2>
<p>Command-line programs</p>
<section id="extending-commandoptions">
<span id="id19"></span><h3>添加新的命令行选项<a class="headerlink" href="#extending-commandoptions" title="Link to this heading">¶</a></h3>
<p>Adding new command-line options</p>
<section id="extending-command-options">
<span id="id20"></span><h4>特定于命令的选项<a class="headerlink" href="#extending-command-options" title="Link to this heading">¶</a></h4>
<p>Command-specific options</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--1">中文</label><div class="tab-content docutils container">
<p>你可以通过修改应用实例的 <a class="reference internal" href="../reference/celery.html#celery.Celery.user_options" title="celery.Celery.user_options"><code class="xref py py-attr docutils literal notranslate"><span class="pre">user_options</span></code></a> 属性，为 <code class="docutils literal notranslate"><span class="pre">worker</span></code>、 <code class="docutils literal notranslate"><span class="pre">beat</span></code> 和 <code class="docutils literal notranslate"><span class="pre">events</span></code> 命令添加额外的命令行选项。</p>
<p>Celery 命令使用 <a class="reference external" href="https://click.palletsprojects.com/en/stable/api/#module-click" title="（在 Click v8.1.x）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">click</span></code></a> 模块解析命令行参数，因此要添加自定义参数，你需要将 <a class="reference external" href="https://click.palletsprojects.com/en/stable/api/#click.Option" title="（在 Click v8.1.x）"><code class="xref py py-class docutils literal notranslate"><span class="pre">click.Option</span></code></a> 实例添加到相应的选项集合中。</p>
<p>以下是为 <strong class="program">celery worker</strong> 命令添加自定义选项的示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">click</span><span class="w"> </span><span class="kn">import</span> <span class="n">Option</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://&#39;</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">user_options</span><span class="p">[</span><span class="s1">&#39;worker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Option</span><span class="p">((</span><span class="s1">&#39;--enable-my-option&#39;</span><span class="p">,),</span>
                                    <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;启用自定义选项。&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>所有 bootstep 现在都会以关键字参数的形式在 <code class="docutils literal notranslate"><span class="pre">Bootstep.__init__</span></code> 中接收到该参数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootsteps</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBootstep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">Step</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">enable_my_option</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enable_my_option</span><span class="p">:</span>
            <span class="n">party</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;worker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyBootstep</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--2">英文</label><div class="tab-content docutils container">
<p>You can add additional command-line options to the <code class="docutils literal notranslate"><span class="pre">worker</span></code>, <code class="docutils literal notranslate"><span class="pre">beat</span></code>, and
<code class="docutils literal notranslate"><span class="pre">events</span></code> commands by modifying the <a class="reference internal" href="../reference/celery.html#celery.Celery.user_options" title="celery.Celery.user_options"><code class="xref py py-attr docutils literal notranslate"><span class="pre">user_options</span></code></a> attribute of the
application instance.</p>
<p>Celery commands uses the <a class="reference external" href="https://click.palletsprojects.com/en/stable/api/#module-click" title="（在 Click v8.1.x）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">click</span></code></a> module to parse command-line
arguments, and so to add custom arguments you need to add <a class="reference external" href="https://click.palletsprojects.com/en/stable/api/#click.Option" title="（在 Click v8.1.x）"><code class="xref py py-class docutils literal notranslate"><span class="pre">click.Option</span></code></a> instances
to the relevant set.</p>
<p>Example adding a custom option to the <strong class="program">celery worker</strong> command:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">click</span><span class="w"> </span><span class="kn">import</span> <span class="n">Option</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://&#39;</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">user_options</span><span class="p">[</span><span class="s1">&#39;worker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Option</span><span class="p">((</span><span class="s1">&#39;--enable-my-option&#39;</span><span class="p">,),</span>
                                    <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable custom option.&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>All bootsteps will now receive this argument as a keyword argument to
<code class="docutils literal notranslate"><span class="pre">Bootstep.__init__</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">bootsteps</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyBootstep</span><span class="p">(</span><span class="n">bootsteps</span><span class="o">.</span><span class="n">Step</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">enable_my_option</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enable_my_option</span><span class="p">:</span>
            <span class="n">party</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;worker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MyBootstep</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="extending-preload-options">
<span id="id21"></span><h4>预加载选项<a class="headerlink" href="#extending-preload-options" title="Link to this heading">¶</a></h4>
<p>Preload options</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--11-input--1" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--1">中文</label><div class="tab-content docutils container">
<p><strong class="program">celery</strong> 总控命令支持“预加载选项”（preload options）的概念。这些是会传递给所有子命令的特殊选项。</p>
<p>你可以添加新的预加载选项，例如用于指定配置模板：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">click</span><span class="w"> </span><span class="kn">import</span> <span class="n">Option</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">user_options</span><span class="p">[</span><span class="s1">&#39;preload&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Option</span><span class="p">((</span><span class="s1">&#39;-Z&#39;</span><span class="p">,</span> <span class="s1">&#39;--template&#39;</span><span class="p">),</span>
                                    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;要使用的配置模板。&#39;</span><span class="p">))</span>

<span class="nd">@signals</span><span class="o">.</span><span class="n">user_preload_options</span><span class="o">.</span><span class="n">connect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_preload_parsed</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">use_template</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--11-input--2" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--2">英文</label><div class="tab-content docutils container">
<p>The <strong class="program">celery</strong> umbrella command supports the concept of 'preload
options'.  These are special options passed to all sub-commands.</p>
<p>You can add new preload options, for example to specify a configuration
template:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">click</span><span class="w"> </span><span class="kn">import</span> <span class="n">Option</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">()</span>

<span class="n">app</span><span class="o">.</span><span class="n">user_options</span><span class="p">[</span><span class="s1">&#39;preload&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Option</span><span class="p">((</span><span class="s1">&#39;-Z&#39;</span><span class="p">,</span> <span class="s1">&#39;--template&#39;</span><span class="p">),</span>
                                    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Configuration template to use.&#39;</span><span class="p">))</span>

<span class="nd">@signals</span><span class="o">.</span><span class="n">user_preload_options</span><span class="o">.</span><span class="n">connect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_preload_parsed</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">use_template</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;template&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="celery">
<span id="extending-subcommands"></span><h3>添加新的 <strong class="program">celery</strong> 子命令<a class="headerlink" href="#celery" title="Link to this heading">¶</a></h3>
<p>Adding new <strong class="program">celery</strong> sub-commands</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--12-input--1" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--1">中文</label><div class="tab-content docutils container">
<p>可以通过使用 <a class="reference external" href="http://reinout.vanrees.org/weblog/2010/01/06/zest-releaser-entry-points.html">setuptools entry-points</a> 向 <strong class="program">celery</strong> 总控命令添加新的子命令。</p>
<p>Entry-point 是一种特殊的元数据，可添加到你的软件包的 <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> 脚本中，安装后可以使用 <a class="reference external" href="https://docs.python.org/dev/library/importlib.html#module-importlib" title="（在 Python v3.15）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">importlib</span></code></a> 模块从系统中读取。</p>
<p>Celery 会识别 <code class="docutils literal notranslate"><span class="pre">celery.commands</span></code> entry-points 来安装额外的子命令，其中 entry-point 的值必须是一个有效的 click 命令。</p>
<p>这正是 <a class="extlink-pypi reference external" href="https://pypi.org/project/Flower/">https://pypi.org/project/Flower/</a> 监控扩展通过在 <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code> 中添加 entry-point 的方式，实现添加 <strong class="program">celery flower</strong> 命令的方式：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;flower&#39;</span><span class="p">,</span>
    <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;celery.commands&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;flower = flower.command:flower&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>命令定义由等号分隔为两部分，第一部分是子命令的名称（此处为 flower），第二部分是实现该命令的函数的完全限定符号路径：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>flower.command:flower
</pre></div>
</div>
<p>模块路径与属性名称之间应使用冒号分隔，如上所示。</p>
<p>在 <code class="file docutils literal notranslate"><span class="pre">flower/command.py</span></code> 模块中，命令函数可以定义如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">click</span>

<span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8888</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Web服务器端口&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">flower</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;运行自定义命令&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--12-input--2" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--2">英文</label><div class="tab-content docutils container">
<p>New commands can be added to the <strong class="program">celery</strong> umbrella command by using
<a class="reference external" href="http://reinout.vanrees.org/weblog/2010/01/06/zest-releaser-entry-points.html">setuptools entry-points</a>.</p>
<p>Entry-points is special meta-data that can be added to your packages <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> program,
and then after installation, read from the system using the <a class="reference external" href="https://docs.python.org/dev/library/importlib.html#module-importlib" title="（在 Python v3.15）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">importlib</span></code></a> module.</p>
<p>Celery recognizes <code class="docutils literal notranslate"><span class="pre">celery.commands</span></code> entry-points to install additional
sub-commands, where the value of the entry-point must point to a valid click
command.</p>
<p>This is how the <a class="extlink-pypi reference external" href="https://pypi.org/project/Flower/">https://pypi.org/project/Flower/</a> monitoring extension may add the <strong class="program">celery flower</strong> command,
by adding an entry-point in <code class="file docutils literal notranslate"><span class="pre">setup.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">setup</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;flower&#39;</span><span class="p">,</span>
    <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;celery.commands&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">&#39;flower = flower.command:flower&#39;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The command definition is in two parts separated by the equal sign, where the
first part is the name of the sub-command (flower), then the second part is
the fully qualified symbol path to the function that implements the command:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>flower.command:flower
</pre></div>
</div>
<p>The module path and the name of the attribute should be separated by colon
as above.</p>
<p>In the module <code class="file docutils literal notranslate"><span class="pre">flower/command.py</span></code>, the command function may be defined
as the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">click</span>

<span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">8888</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Webserver port&#39;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">is_flag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">flower</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">debug</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running our command&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="worker-api">
<h2>Worker API<a class="headerlink" href="#worker-api" title="Link to this heading">¶</a></h2>
<p>Worker API</p>
<section id="hub-worker">
<h3><a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.asynchronous.html#kombu.asynchronous.Hub" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Hub</span></code></a> - Worker 异步事件循环<a class="headerlink" href="#hub-worker" title="Link to this heading">¶</a></h3>
<p><a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.asynchronous.html#kombu.asynchronous.Hub" title="（在 Kombu v5.5）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Hub</span></code></a> - The workers async event loop</p>
<dl class="field-list simple">
<dt class="field-odd">supported transports<span class="colon">:</span></dt>
<dd class="field-odd"><p>amqp, redis</p>
</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--13-input--1" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--1">中文</label><div class="tab-content docutils container">
<p>当使用 amqp 或 redis broker 传输方式时，worker 会使用异步 I/O。最终的目标是让所有传输方式都基于事件循环（event-loop）实现，但这还需要一段时间，因此其他传输方式仍然采用基于线程的解决方案。</p>
<dl class="py method">
<dt class="sig sig-object py" id="hub.add">
<span class="sig-prename descclassname"><span class="pre">hub.</span></span><span class="sig-name descname"><span class="pre">add</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fd</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flags</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#hub.add" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="hub.add_reader">
<span class="sig-prename descclassname"><span class="pre">hub.</span></span><span class="sig-name descname"><span class="pre">add_reader</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fd</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#hub.add_reader" title="Link to this definition">¶</a></dt>
<dd><p>添加在 <code class="docutils literal notranslate"><span class="pre">fd</span></code> 可读时调用的回调函数。</p>
<p>该回调函数会持续注册，直到显式地使用 <a class="reference internal" href="#hub.remove" title="hub.remove"><code class="xref py py-meth docutils literal notranslate"><span class="pre">hub.remove(fd)</span></code></a> 移除，
或者由于文件描述符不再有效而被自动丢弃。</p>
<p>注意：任意给定的文件描述符在任意时刻只能注册一个回调函数，因此若第二次调用 <code class="docutils literal notranslate"><span class="pre">add</span></code>，
会移除此前为该文件描述符注册的任何回调。</p>
<p>文件描述符可以是支持 <code class="docutils literal notranslate"><span class="pre">fileno</span></code> 方法的任何类似文件对象，或是文件描述符的整数编号（int）。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="hub.add_writer">
<span class="sig-prename descclassname"><span class="pre">hub.</span></span><span class="sig-name descname"><span class="pre">add_writer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fd</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#hub.add_writer" title="Link to this definition">¶</a></dt>
<dd><p>添加在 <code class="docutils literal notranslate"><span class="pre">fd</span></code> 可写时调用的回调函数。
参考上文 <a class="reference internal" href="#hub.add_reader" title="hub.add_reader"><code class="xref py py-meth docutils literal notranslate"><span class="pre">hub.add_reader()</span></code></a> 的说明。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="hub.remove">
<span class="sig-prename descclassname"><span class="pre">hub.</span></span><span class="sig-name descname"><span class="pre">remove</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fd</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#hub.remove" title="Link to this definition">¶</a></dt>
<dd><p>从事件循环中移除文件描述符 <code class="docutils literal notranslate"><span class="pre">fd</span></code> 的所有回调函数。</p>
</dd></dl>

</div>
<input class="tab-input" id="tab-set--13-input--2" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--2">英文</label><div class="tab-content docutils container">
<p>The worker uses asynchronous I/O when the amqp or redis broker transports are
used. The eventual goal is for all transports to use the event-loop, but that
will take some time so other transports still use a threading-based solution.</p>
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">hub.</span></span><span class="sig-name descname"><span class="pre">add</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fd</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">flags</span></span></em><span class="sig-paren">)</span></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">hub.</span></span><span class="sig-name descname"><span class="pre">add_reader</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fd</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Add callback to be called when <code class="docutils literal notranslate"><span class="pre">fd</span></code> is readable.</p>
<p>The callback will stay registered until explicitly removed using
<a class="reference internal" href="#hub.remove" title="hub.remove"><code class="xref py py-meth docutils literal notranslate"><span class="pre">hub.remove(fd)</span></code></a>, or the file descriptor is
automatically discarded because it's no longer valid.</p>
<p>Note that only one callback can be registered for any given
file descriptor at a time, so calling <code class="docutils literal notranslate"><span class="pre">add</span></code> a second time will remove
any callback that was previously registered for that file descriptor.</p>
<p>A file descriptor is any file-like object that supports the <code class="docutils literal notranslate"><span class="pre">fileno</span></code>
method, or it can be the file descriptor number (int).</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">hub.</span></span><span class="sig-name descname"><span class="pre">add_writer</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fd</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">callback</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Add callback to be called when <code class="docutils literal notranslate"><span class="pre">fd</span></code> is writable.
See also notes for <a class="reference internal" href="#hub.add_reader" title="hub.add_reader"><code class="xref py py-meth docutils literal notranslate"><span class="pre">hub.add_reader()</span></code></a> above.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">hub.</span></span><span class="sig-name descname"><span class="pre">remove</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">fd</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Remove all callbacks for file descriptor <code class="docutils literal notranslate"><span class="pre">fd</span></code> from the loop.</p>
</dd></dl>

</div>
</div>
</section>
<section id="id22">
<h3>计时器 - 事件调度<a class="headerlink" href="#id22" title="Link to this heading">¶</a></h3>
<p>Timer - Scheduling events</p>
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">timer.call_after(secs,</span> <span class="pre">callback,</span> <span class="pre">args=(),</span> <span class="pre">kwargs=(),</span></span></dt>
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">priority=0)</span></span></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">timer.call_repeatedly(secs,</span> <span class="pre">callback,</span> <span class="pre">args=(),</span> <span class="pre">kwargs=(),</span></span></dt>
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">priority=0)</span></span></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">timer.call_at(eta,</span> <span class="pre">callback,</span> <span class="pre">args=(),</span> <span class="pre">kwargs=(),</span></span></dt>
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">priority=0)</span></span></dt>
<dd></dd></dl>

</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="configuration.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">配置和默认值</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="testing.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">使用 Celery 进行测试</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../copyright.html">Copyright</a> &#169; 2009-2023, Ask Solem &amp; contributors
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">扩展 和 Bootsteps</a><ul>
<li><a class="reference internal" href="#extending-custom-consumers">自定义消息消费者</a></li>
<li><a class="reference internal" href="#extending-blueprints">蓝图</a></li>
<li><a class="reference internal" href="#worker">Worker</a><ul>
<li><a class="reference internal" href="#extending-worker-blueprint-attributes">属性</a><ul>
<li><a class="reference internal" href="#app"><code class="docutils literal notranslate"><span class="pre">app</span></code></a></li>
<li><a class="reference internal" href="#hostname"><code class="docutils literal notranslate"><span class="pre">hostname</span></code></a></li>
<li><a class="reference internal" href="#blueprint"><code class="docutils literal notranslate"><span class="pre">blueprint</span></code></a></li>
<li><a class="reference internal" href="#hub"><code class="docutils literal notranslate"><span class="pre">hub</span></code></a></li>
<li><a class="reference internal" href="#pool"><code class="docutils literal notranslate"><span class="pre">pool</span></code></a></li>
<li><a class="reference internal" href="#timer"><code class="docutils literal notranslate"><span class="pre">timer</span></code></a></li>
<li><a class="reference internal" href="#statedb"><code class="docutils literal notranslate"><span class="pre">statedb</span></code></a></li>
<li><a class="reference internal" href="#autoscaler"><code class="docutils literal notranslate"><span class="pre">autoscaler</span></code></a></li>
<li><a class="reference internal" href="#autoreloader"><code class="docutils literal notranslate"><span class="pre">autoreloader</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">Worker 启动步骤示例</a></li>
<li><a class="reference internal" href="#id6">自定义任务处理日志</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extending-consumer-blueprint">消费者</a><ul>
<li><a class="reference internal" href="#extending-consumer-attributes">属性</a><ul>
<li><a class="reference internal" href="#id0"><code class="docutils literal notranslate"><span class="pre">app</span></code></a></li>
<li><a class="reference internal" href="#controller"><code class="docutils literal notranslate"><span class="pre">controller</span></code></a></li>
<li><a class="reference internal" href="#id9"><code class="docutils literal notranslate"><span class="pre">hostname</span></code></a></li>
<li><a class="reference internal" href="#id11"><code class="docutils literal notranslate"><span class="pre">blueprint</span></code></a></li>
<li><a class="reference internal" href="#id12"><code class="docutils literal notranslate"><span class="pre">hub</span></code></a></li>
<li><a class="reference internal" href="#connection"><code class="docutils literal notranslate"><span class="pre">connection</span></code></a></li>
<li><a class="reference internal" href="#event_dispatcher"><code class="docutils literal notranslate"><span class="pre">event_dispatcher</span></code></a></li>
<li><a class="reference internal" href="#gossip"><code class="docutils literal notranslate"><span class="pre">gossip</span></code></a></li>
<li><a class="reference internal" href="#id13"><code class="docutils literal notranslate"><span class="pre">pool</span></code></a></li>
<li><a class="reference internal" href="#id14"><code class="docutils literal notranslate"><span class="pre">timer</span></code></a></li>
<li><a class="reference internal" href="#heart"><code class="docutils literal notranslate"><span class="pre">heart</span></code></a></li>
<li><a class="reference internal" href="#task_consumer"><code class="docutils literal notranslate"><span class="pre">task_consumer</span></code></a></li>
<li><a class="reference internal" href="#strategies"><code class="docutils literal notranslate"><span class="pre">strategies</span></code></a></li>
<li><a class="reference internal" href="#task_buckets"><code class="docutils literal notranslate"><span class="pre">task_buckets</span></code></a></li>
<li><a class="reference internal" href="#qos"><code class="docutils literal notranslate"><span class="pre">qos</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id16">方法</a><ul>
<li><a class="reference internal" href="#consumer.reset_rate_limits"><code class="docutils literal notranslate"><span class="pre">consumer.reset_rate_limits()</span></code></a></li>
<li><a class="reference internal" href="#consumer.bucket_for_task"><code class="docutils literal notranslate"><span class="pre">consumer.bucket_for_task()</span></code></a></li>
<li><a class="reference internal" href="#consumer.cancel_task_queue"><code class="docutils literal notranslate"><span class="pre">consumer.cancel_task_queue()</span></code></a></li>
<li><a class="reference internal" href="#apply_eta_task"><code class="docutils literal notranslate"><span class="pre">apply_eta_task()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#extending-bootsteps">安装启动步骤</a></li>
<li><a class="reference internal" href="#extending-programs">命令行程序</a><ul>
<li><a class="reference internal" href="#extending-commandoptions">添加新的命令行选项</a><ul>
<li><a class="reference internal" href="#extending-command-options">特定于命令的选项</a></li>
<li><a class="reference internal" href="#extending-preload-options">预加载选项</a></li>
</ul>
</li>
<li><a class="reference internal" href="#celery">添加新的 <strong class="program">celery</strong> 子命令</a></li>
</ul>
</li>
<li><a class="reference internal" href="#worker-api">Worker API</a><ul>
<li><a class="reference internal" href="#hub-worker"><code class="xref py py-class docutils literal notranslate"><span class="pre">Hub</span></code> - Worker 异步事件循环</a><ul>
<li><a class="reference internal" href="#hub.add"><code class="docutils literal notranslate"><span class="pre">hub.add()</span></code></a></li>
<li><a class="reference internal" href="#hub.add_reader"><code class="docutils literal notranslate"><span class="pre">hub.add_reader()</span></code></a></li>
<li><a class="reference internal" href="#hub.add_writer"><code class="docutils literal notranslate"><span class="pre">hub.add_writer()</span></code></a></li>
<li><a class="reference internal" href="#hub.remove"><code class="docutils literal notranslate"><span class="pre">hub.remove()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#id22">计时器 - 事件调度</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=8156d91f"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3ee01567"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=5eb1bb1e"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    </body>
</html>