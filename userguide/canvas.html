<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="copyright" title="版权所有" href="../copyright.html" /><link rel="next" title="Workers 指南" href="workers.html" /><link rel="prev" title="调用任务/Tasks" href="calling.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>Canvas：设计工作流 - Celery 5.5.1 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=3ee1c6c6" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/my.css?v=112ca36d" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Celery 5.5.1 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/celery_512_1.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Celery 5.5.1 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">版权</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../getting-started/index.html">快速开始</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 快速开始</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/introduction.html">Celery 简介</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../getting-started/backends-and-brokers/index.html">Backends 和 Brokers</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Backends 和 Brokers</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/rabbitmq.html">使用 RabbitMQ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/redis.html">使用 Redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/sqs.html">使用 Amazon SQS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/kafka.html">使用 Kafka</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/gcpubsub.html">使用 Google Pub/Sub</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/first-steps-with-celery.html">使用 Celery 的第一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/next-steps.html">下一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/resources.html">资源</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">用户指南</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 用户指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="application.html">应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="tasks.html">任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="calling.html">调用任务/Tasks</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Canvas：设计工作流</a></li>
<li class="toctree-l2"><a class="reference internal" href="workers.html">Workers 指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="daemonizing.html">守护进程</a></li>
<li class="toctree-l2"><a class="reference internal" href="periodic-tasks.html">周期性任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="routing.html">路由任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">监控和管理指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimizing.html">优化</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">调试</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="concurrency/index.html">并发</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 并发</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="concurrency/eventlet.html">Eventlet 并发</a></li>
<li class="toctree-l3"><a class="reference internal" href="concurrency/gevent.html">gevent 并发</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="signals.html">信号</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">使用 Celery 进行测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="extending.html">扩展 和 Bootsteps</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">配置和默认值</a></li>
<li class="toctree-l2"><a class="reference internal" href="sphinx.html">使用 Sphinx 文档化任务</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../django/index.html">Django</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Django</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../django/first-steps-with-django.html">使用 Django 的第一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community.html">社区资源</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials/index.html">教程</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 教程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/task-cookbook.html">Task Cookbook</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">更改历史</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">API 参考</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of API 参考</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/cli.html">命令行接口</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">celery</span></code> --- Distributed processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.html">Proxies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.html#functions">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.task.html"><code class="docutils literal notranslate"><span class="pre">celery.app.task</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.amqp.html">AMQP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.amqp.html#queues">Queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.defaults.html"><code class="docutils literal notranslate"><span class="pre">celery.app.defaults</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.control.html"><code class="docutils literal notranslate"><span class="pre">celery.app.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.registry.html"><code class="docutils literal notranslate"><span class="pre">celery.app.registry</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.backends.html"><code class="docutils literal notranslate"><span class="pre">celery.app.backends</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.builtins.html"><code class="docutils literal notranslate"><span class="pre">celery.app.builtins</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.events.html"><code class="docutils literal notranslate"><span class="pre">celery.app.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.log.html"><code class="docutils literal notranslate"><span class="pre">celery.app.log</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.app.utils</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.autoretry.html"><code class="docutils literal notranslate"><span class="pre">celery.app.autoretry</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bootsteps.html"><code class="docutils literal notranslate"><span class="pre">celery.bootsteps</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.result.html"><code class="docutils literal notranslate"><span class="pre">celery.result</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.schedules.html"><code class="docutils literal notranslate"><span class="pre">celery.schedules</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.signals.html"><code class="docutils literal notranslate"><span class="pre">celery.signals</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.security.html"><code class="docutils literal notranslate"><span class="pre">celery.security</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.utils.debug.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.debug</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.exceptions.html"><code class="docutils literal notranslate"><span class="pre">celery.exceptions</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.app.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.app</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.default.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.default</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.base.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.base</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html">States</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#sets">Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#misc">Misc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.FAILURE"><code class="docutils literal notranslate"><span class="pre">FAILURE</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.PENDING"><code class="docutils literal notranslate"><span class="pre">PENDING</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.RECEIVED"><code class="docutils literal notranslate"><span class="pre">RECEIVED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.RETRY"><code class="docutils literal notranslate"><span class="pre">RETRY</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.REVOKED"><code class="docutils literal notranslate"><span class="pre">REVOKED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.STARTED"><code class="docutils literal notranslate"><span class="pre">STARTED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.SUCCESS"><code class="docutils literal notranslate"><span class="pre">SUCCESS</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.precedence"><code class="docutils literal notranslate"><span class="pre">precedence()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.state"><code class="docutils literal notranslate"><span class="pre">state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.abortable.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.abortable</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.django.task.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.django.task</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.migrate.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.migrate</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.pytest.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.pytest</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.sphinx.html">celery.contrib.sphinx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.app.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.app</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.manager.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.manager</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.mocks.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.mocks</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.rdb.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.rdb</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.html"><code class="docutils literal notranslate"><span class="pre">celery.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.receiver.html"><code class="docutils literal notranslate"><span class="pre">celery.events.receiver</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.dispatcher.html"><code class="docutils literal notranslate"><span class="pre">celery.events.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.event.html"><code class="docutils literal notranslate"><span class="pre">celery.events.event</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.state.html"><code class="docutils literal notranslate"><span class="pre">celery.events.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.multi.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.multi</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.request.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.request</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.state.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.strategy.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.strategy</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.agent.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.agent</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.connection.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.connection</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.consumer.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.consumer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.control.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.events.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.gossip.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.gossip</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.heart.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.heart</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.mingle.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.mingle</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.tasks.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.tasks</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.base.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.base</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.celery.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.celery</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.events.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.logtool.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.logtool</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.amqp.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.amqp</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.graph.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.graph</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.multi.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.multi</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.call.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.call</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.control.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.list.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.list</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.migrate.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.migrate</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.purge.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.purge</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.result.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.result</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.shell.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.shell</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.upgrade.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.upgrade</span></code></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../internals/index.html">内部</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of 内部</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../internals/guide.html">代码贡献指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/deprecation.html">Celery 弃用时间表</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/worker.html">内部的 worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/protocol.html">消息协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/app-overview.html">“大实例”重构</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../internals/reference/index.html">内部模块参考</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 内部模块参考</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.components.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.components</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.loops.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.loops</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.heartbeat.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.heartbeat</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.control.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.control</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.pidbox.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.pidbox</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.autoscale.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.autoscale</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.solo.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.solo</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.prefork.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.prefork</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.eventlet.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.eventlet</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.gevent.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.gevent</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.thread.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.thread</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.base.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.base</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.html"><code class="docutils literal notranslate"><span class="pre">celery.backends</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.base.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.base</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.asynchronous.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.asynchronous</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.azureblockblob.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.azureblockblob</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.rpc.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.rpc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cache.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cache</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.consul.html">celery.backends.consul</a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.couchdb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.couchdb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.mongodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.mongodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.elasticsearch.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.elasticsearch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.redis.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.redis</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cassandra.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cassandra</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.couchbase.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.couchbase</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.arangodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.arangodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.dynamodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.dynamodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.filesystem.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.filesystem</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cosmosdbsql.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cosmosdbsql</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.s3.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.s3</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.gcs.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.gcs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.trace.html"><code class="docutils literal notranslate"><span class="pre">celery.app.trace</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.annotations.html"><code class="docutils literal notranslate"><span class="pre">celery.app.annotations</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.routes.html"><code class="docutils literal notranslate"><span class="pre">celery.app.routes</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.certificate.html"><code class="docutils literal notranslate"><span class="pre">celery.security.certificate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.key.html"><code class="docutils literal notranslate"><span class="pre">celery.security.key</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.serialization.html"><code class="docutils literal notranslate"><span class="pre">celery.security.serialization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.security.utils</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.snapshot.html"><code class="docutils literal notranslate"><span class="pre">celery.events.snapshot</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.cursesmon.html"><code class="docutils literal notranslate"><span class="pre">celery.events.cursesmon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.dumper.html"><code class="docutils literal notranslate"><span class="pre">celery.events.dumper</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.models.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database.models</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.session.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database.session</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.utils</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.abstract.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.abstract</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.collections.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.collections</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.nodenames.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.nodenames</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.deprecated.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.deprecated</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.functional.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.functional</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.graph.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.graph</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.objects.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.objects</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.term.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.term</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.time.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.time</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.iso8601.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.iso8601</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.saferepr.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.saferepr</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.serialization.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.serialization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.sysinfo.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.sysinfo</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.threads.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.threads</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.timer2.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.timer2</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.imports.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.imports</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.log.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.text.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.text</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.dispatch.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.dispatch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.dispatch.signal.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.dispatch.signal</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.platforms.html"><code class="docutils literal notranslate"><span class="pre">celery.platforms</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery._state.html"><code class="docutils literal notranslate"><span class="pre">celery._state</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../history/index.html">历史</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of 历史</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.5.html">What's new in Celery 5.5 (Immunity)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.5.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.4.html">What's new in Celery 5.4 (Opalescent)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.4.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.3.html">What's new in Celery 5.3 (Emerald Rush)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.3.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.1.html">What's new in Celery 5.1 (Sun Harmonics)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.0.html">What's new in Celery 5.0 (singularity)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.0.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.4.html">What's new in Celery 4.4 (Cliffs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.4.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.3.html">What's new in Celery 4.3 (rhubarb)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.3.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.2.html">What's new in Celery 4.2 (windowlicker)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.2.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.1.html">What's new in Celery 4.1 (latentcall)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.0.html">What's new in Celery 4.0 (latentcall)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.0.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-3.1.html">What's new in Celery 3.1 (Cipater)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-3.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-3.0.html">What's new in Celery 3.0 (Chiastic Slide)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-3.0.html">Change history for Celery 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-2.5.html">What's new in Celery 2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.5.html">Change history for Celery 2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.4.html">Change history for Celery 2.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.3.html">Change history for Celery 2.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.2.html">Change history for Celery 2.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.1.html">Change history for Celery 2.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.0.html">Change history for Celery 2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-1.0.html">Change history for Celery 1.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">术语</a></li>
</ul>

</div>
<!-- <iframe src="https://ghbtns.com/github-btn.html?user=celery&repo=celery&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe> -->
<div id="donate">
  <h5>捐赠</h5>
  <p>请捐赠以支持这个社区项目</p>
  <a href="https://opencollective.com/celery/donate" target="_blank">
    <!-- <img src="https://opencollective.com/celery/donate/button@2x.png?color=blue" /> -->
    <img src="https://opencollective.com/celery/donate/button.png?color=blue" />
  </a>
</div></div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/userguide/canvas.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="canvas">
<span id="guide-canvas"></span><h1>Canvas：设计工作流<a class="headerlink" href="#canvas" title="Link to this heading">¶</a></h1>
<p>Canvas: Designing Work-flows</p>
<section id="canvas-signatures">
<span id="canvas-subtasks"></span><span id="id1"></span><h2>签名<a class="headerlink" href="#canvas-signatures" title="Link to this heading">¶</a></h2>
<p>Signatures</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.0.</span></p>
</div>
<p>你已经在 <a class="reference internal" href="calling.html#guide-calling"><span class="std std-ref">calling</span></a> 指南中学习了如何使用任务的 <code class="docutils literal notranslate"><span class="pre">delay</span></code> 方法来调用任务，这通常已足够，但有时你可能希望将任务调用的签名传递给另一个进程，或者作为参数传递给另一个函数。</p>
<p><a class="reference internal" href="../reference/celery.html#celery.signature" title="celery.signature"><code class="xref py py-func docutils literal notranslate"><span class="pre">signature()</span></code></a> 会将一次任务调用的参数、关键字参数及执行选项封装起来，以便它可以被传递给其他函数，甚至被序列化并通过网络发送。</p>
<ul>
<li><p>你可以使用任务名称为 <code class="docutils literal notranslate"><span class="pre">add</span></code> 任务创建一个签名，如下所示：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">signature</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">signature</span><span class="p">(</span><span class="s1">&#39;tasks.add&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="go">tasks.add(2, 2)</span>
</pre></div>
</div>
<p>此任务的签名为 arity 为 2（两个参数）：<code class="docutils literal notranslate"><span class="pre">(2,</span> <span class="pre">2)</span></code>，
并设置执行选项 <cite>countdown</cite> 为 10。</p>
</li>
<li><p>或者你可以使用任务的 <code class="docutils literal notranslate"><span class="pre">signature</span></code> 方法来创建签名：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="go">tasks.add(2, 2)</span>
</pre></div>
</div>
</li>
<li><p>也可以使用星号参数的快捷方式：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">tasks.add(2, 2)</span>
</pre></div>
</div>
</li>
<li><p>同样也支持关键字参数：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">tasks.add(2, 2, debug=True)</span>
</pre></div>
</div>
</li>
<li><p>你可以从任意签名实例中检查不同的字段：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">args</span>
<span class="go">(2, 2)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">kwargs</span>
<span class="go">{&#39;debug&#39;: True}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;countdown&#39;: 10}</span>
</pre></div>
</div>
</li>
<li><p>它支持 <code class="docutils literal notranslate"><span class="pre">delay</span></code>、<code class="docutils literal notranslate"><span class="pre">apply_async</span></code> 等“调用 API”，包括可直接调用（即 <code class="docutils literal notranslate"><span class="pre">__call__</span></code>）。</p>
<p>调用该签名将在当前进程中直接执行任务：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)()</span>
<span class="go">4</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">delay</span></code> 是我们喜爱的快捷方式，相当于使用星号参数调用 <code class="docutils literal notranslate"><span class="pre">apply_async</span></code>：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">4</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">apply_async</span></code> 接受的参数与 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.apply_async" title="celery.app.task.Task.apply_async"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.apply_async()</span></code></a> 方法相同：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>你不能通过 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.s" title="celery.app.task.Task.s"><code class="xref py py-meth docutils literal notranslate"><span class="pre">s()</span></code></a> 方法定义选项，但可以通过链式调用 <code class="docutils literal notranslate"><span class="pre">set</span></code> 方法来设置：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">proj.tasks.add(2, 2)</span>
</pre></div>
</div>
</li>
</ul>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.0.</span></p>
</div>
<p>You just learned how to call a task using the tasks <code class="docutils literal notranslate"><span class="pre">delay</span></code> method
in the <a class="reference internal" href="calling.html#guide-calling"><span class="std std-ref">calling</span></a> guide, and this is often all you need,
but sometimes you may want to pass the signature of a task invocation to
another process or as an argument to another function.</p>
<p>A <a class="reference internal" href="../reference/celery.html#celery.signature" title="celery.signature"><code class="xref py py-func docutils literal notranslate"><span class="pre">signature()</span></code></a> wraps the arguments, keyword arguments, and execution options
of a single task invocation in a way such that it can be passed to functions
or even serialized and sent across the wire.</p>
<ul>
<li><p>You can create a signature for the <code class="docutils literal notranslate"><span class="pre">add</span></code> task using its name like this:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">signature</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">signature</span><span class="p">(</span><span class="s1">&#39;tasks.add&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="go">tasks.add(2, 2)</span>
</pre></div>
</div>
<p>This task has a signature of arity 2 (two arguments): <code class="docutils literal notranslate"><span class="pre">(2,</span> <span class="pre">2)</span></code>,
and sets the countdown execution option to 10.</p>
</li>
<li><p>or you can create one using the task's <code class="docutils literal notranslate"><span class="pre">signature</span></code> method:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="go">tasks.add(2, 2)</span>
</pre></div>
</div>
</li>
<li><p>There's also a shortcut using star arguments:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">tasks.add(2, 2)</span>
</pre></div>
</div>
</li>
<li><p>Keyword arguments are also supported:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">tasks.add(2, 2, debug=True)</span>
</pre></div>
</div>
</li>
<li><p>From any signature instance you can inspect the different fields:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">args</span>
<span class="go">(2, 2)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">kwargs</span>
<span class="go">{&#39;debug&#39;: True}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;countdown&#39;: 10}</span>
</pre></div>
</div>
</li>
<li><p>It supports the &quot;Calling API&quot; of <code class="docutils literal notranslate"><span class="pre">delay</span></code>,
<code class="docutils literal notranslate"><span class="pre">apply_async</span></code>, etc., including being called directly (<code class="docutils literal notranslate"><span class="pre">__call__</span></code>).</p>
<p>Calling the signature will execute the task inline in the current process:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)()</span>
<span class="go">4</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">delay</span></code> is our beloved shortcut to <code class="docutils literal notranslate"><span class="pre">apply_async</span></code> taking star-arguments:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">4</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">apply_async</span></code> takes the same arguments as the
<a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.apply_async" title="celery.app.task.Task.apply_async"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.apply_async()</span></code></a> method:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>You can't define options with <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.s" title="celery.app.task.Task.s"><code class="xref py py-meth docutils literal notranslate"><span class="pre">s()</span></code></a>, but a chaining
<code class="docutils literal notranslate"><span class="pre">set</span></code> call takes care of that:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">proj.tasks.add(2, 2)</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<section id="id2">
<h3>部分代码<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p>Partials</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">中文</label><div class="tab-content docutils container">
<p>使用签名，你可以在 worker 中执行任务：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>或者也可以在当前进程中直接调用：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)()</span>
<span class="go">4</span>
</pre></div>
</div>
<p>向 <code class="docutils literal notranslate"><span class="pre">apply_async</span></code>/<code class="docutils literal notranslate"><span class="pre">delay</span></code> 提供额外的 args、kwargs 或 options，会创建部分签名（partial）：</p>
<ul>
<li><p>所添加的位置参数会被追加到签名中的已有参数前面：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">partial</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>          <span class="c1"># 不完整的签名</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">partial</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>            <span class="c1"># 4 + 2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">partial</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">4</span><span class="p">,))</span>  <span class="c1"># 同上</span>
</pre></div>
</div>
</li>
<li><p>所添加的关键字参数会与签名中的关键字参数合并，
新添加的关键字参数将覆盖已有参数：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                    <span class="c1"># -&gt; add(2, 2, debug=True)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>  <span class="c1"># 同上</span>
</pre></div>
</div>
</li>
<li><p>所添加的选项会与签名中的选项合并，
新添加的选项将覆盖已有选项：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># countdown 现在为 1</span>
</pre></div>
</div>
</li>
</ul>
<p>你还可以克隆签名以创建派生签名：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">proj.tasks.add(2)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="go">proj.tasks.add(4, 2, debug=True)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">英文</label><div class="tab-content docutils container">
<p>With a signature, you can execute the task in a worker:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Or you can call it directly in the current process:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)()</span>
<span class="go">4</span>
</pre></div>
</div>
<p>Specifying additional args, kwargs, or options to <code class="docutils literal notranslate"><span class="pre">apply_async</span></code>/<code class="docutils literal notranslate"><span class="pre">delay</span></code>
creates partials:</p>
<ul>
<li><p>Any arguments added will be prepended to the args in the signature:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">partial</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>          <span class="c1"># incomplete signature</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">partial</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>            <span class="c1"># 4 + 2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">partial</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">4</span><span class="p">,))</span>  <span class="c1"># same</span>
</pre></div>
</div>
</li>
<li><p>Any keyword arguments added will be merged with the kwargs in the signature,
with the new keyword arguments taking precedence:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                    <span class="c1"># -&gt; add(2, 2, debug=True)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>  <span class="c1"># same</span>
</pre></div>
</div>
</li>
<li><p>Any options added will be merged with the options in the signature,
with the new options taking precedence:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># countdown is now 1</span>
</pre></div>
</div>
</li>
</ul>
<p>You can also clone signatures to create derivatives:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">proj.tasks.add(2)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="go">proj.tasks.add(4, 2, debug=True)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h3>不变性<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<p>Immutability</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
<p>部分签名（Partials）主要用于回调函数。任何通过 <code class="docutils literal notranslate"><span class="pre">link</span></code> 关联的任务或 chord 的回调函数，都会接收到父任务的返回结果。
但有时你可能希望指定一个**不接受附加参数**的回调函数，此时可以将签名设置为不可变（immutable）：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">link</span><span class="o">=</span><span class="n">reset_buffers</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">immutable</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p>你也可以使用 <code class="docutils literal notranslate"><span class="pre">.si()</span></code> 这个快捷方式来创建不可变签名：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">link</span><span class="o">=</span><span class="n">reset_buffers</span><span class="o">.</span><span class="n">si</span><span class="p">())</span>
</pre></div>
</div>
<p>当一个签名是不可变的时，只能设置其执行选项，
因此无法通过传递额外的参数或关键字参数来调用该签名。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在本教程中，我有时会对签名使用前缀操作符 <cite>~</cite>。
在生产环境中你可能不应使用这个操作符，但在 Python 交互式 shell 中做实验时它非常方便：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="o">~</span><span class="n">sig</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># 等价于</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sig</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
<p>Partials are meant to be used with callbacks, any tasks linked, or chord
callbacks will be applied with the result of the parent task.
Sometimes you want to specify a callback that doesn't take
additional arguments, and in that case you can set the signature
to be immutable:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">link</span><span class="o">=</span><span class="n">reset_buffers</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">immutable</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.si()</span></code> shortcut can also be used to create immutable signatures:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">link</span><span class="o">=</span><span class="n">reset_buffers</span><span class="o">.</span><span class="n">si</span><span class="p">())</span>
</pre></div>
</div>
<p>Only the execution options can be set when a signature is immutable,
so it's not possible to call the signature with partial args/kwargs.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>In this tutorial I sometimes use the prefix operator <cite>~</cite> to signatures.
You probably shouldn't use it in your production code, but it's a handy shortcut
when experimenting in the Python shell:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="o">~</span><span class="n">sig</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># is the same as</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sig</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</section>
<section id="canvas-callbacks">
<span id="id4"></span><h3>回调函数<a class="headerlink" href="#canvas-callbacks" title="Link to this heading">¶</a></h3>
<p>Callbacks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
<p>你可以使用 <code class="docutils literal notranslate"><span class="pre">apply_async</span></code> 的 <code class="docutils literal notranslate"><span class="pre">link</span></code> 参数，为任何任务添加回调函数：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="go">add.apply_async((2, 2), link=other_task.s())</span>
</pre></div>
</div>
<p>该回调任务仅在前一个任务成功完成时才会被执行，
且其参数将是前一个任务的返回值。</p>
<p>如前所述，<strong>任何添加到签名上的参数都会被追加在签名原本定义的参数之前！</strong></p>
<p>如果你有以下签名：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sig</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>那么 <cite>sig.delay(result)</cite> 实际相当于：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>...</p>
<p>现在让我们通过部分参数，给 <code class="docutils literal notranslate"><span class="pre">add</span></code> 任务设置一个回调函数：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">link</span><span class="o">=</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
<p>如预期，这首先会启动一个任务来计算 <span class="math">2 + 2</span>，然后启动另一个任务来计算 <span class="math">8 + 4</span>。</p>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
<p>Callbacks can be added to any task using the <code class="docutils literal notranslate"><span class="pre">link</span></code> argument
to <code class="docutils literal notranslate"><span class="pre">apply_async</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="go">add.apply_async((2, 2), link=other_task.s())</span>
</pre></div>
</div>
<p>The callback will only be applied if the task exited successfully,
and it will be applied with the return value of the parent task as argument.</p>
<p>As I mentioned earlier, any arguments you add to a signature,
will be prepended to the arguments specified by the signature itself!</p>
<p>If you have the signature:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sig</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>then <cite>sig.delay(result)</cite> becomes:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>...</p>
<p>Now let's call our <code class="docutils literal notranslate"><span class="pre">add</span></code> task with a callback using partial
arguments:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">link</span><span class="o">=</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
<p>As expected this will first launch one task calculating <span class="math">2 + 2</span>, then
another task calculating <span class="math">8 + 4</span>.</p>
</div>
</div>
</section>
</section>
<section id="id5">
<h2>原语<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<p>The Primitives</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
<p>这些原语本身也是签名对象，因此可以通过任意方式组合使用，来构建复杂的工作流。</p>
<p>以下是一些示例：</p>
<ul>
<li><p>简单的 chain</p>
<p>这是一个简单的 chain，第一个任务执行后会将其返回值作为参数传递给下一个任务，以此类推。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># 2 + 2 + 4 + 8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">16</span>
</pre></div>
</div>
<p>也可以使用管道语法来写：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">16</span>
</pre></div>
</div>
</li>
<li><p>不可变签名（Immutable signatures）</p>
<p>签名可以是部分签名，因此可以向其中添加额外参数，但有时你可能并不希望这样，
比如你不希望链中前一个任务的结果作为下一个任务的参数。</p>
<p>此时可以将签名标记为不可变（immutable），使其参数不可更改：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">immutable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>你也可以使用 <code class="docutils literal notranslate"><span class="pre">.si()</span></code> 快捷方式，这是推荐的创建不可变签名的方式：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>现在你可以创建一个互不依赖的任务链：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">16</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">8</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">4</span>
</pre></div>
</div>
</li>
<li><p>简单的 group</p>
<p>你可以很容易地创建一个任务组以并行执行：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span>
</pre></div>
</div>
</li>
<li><p>简单的 chord</p>
<p>chord 原语允许我们在 group 的所有任务完成后执行一个回调函数。
对于一些无法完全并行化的算法，这种机制非常有用：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chord</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">chord</span><span class="p">((</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="n">tsum</span><span class="o">.</span><span class="n">s</span><span class="p">())()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">90</span>
</pre></div>
</div>
<p>上面的示例会启动 10 个并行任务，当所有任务完成后，
它们的返回值会被组合成一个列表传递给 <code class="docutils literal notranslate"><span class="pre">tsum</span></code> 任务。</p>
<p>chord 的 body 也可以设置为不可变，这样 group 的返回值就不会传递给回调函数：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">chord</span><span class="p">((</span><span class="n">import_contact</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">),</span>
<span class="gp">... </span>      <span class="n">notify_complete</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">import_id</span><span class="p">))</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
</pre></div>
</div>
<p>注意上面使用了 <code class="docutils literal notranslate"><span class="pre">.si</span></code>，这会创建一个不可变签名，意味着无论是新的参数还是前一个任务的返回值都会被忽略。</p>
</li>
<li><p>混合组合，解锁脑洞</p>
<p>chain 本身也可以是部分签名：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>

<span class="go"># (16 + 4) * 8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">c1</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">160</span>
</pre></div>
</div>
<p>这意味着 chain 也可以组合在一起：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="go"># ((4 + 16) * 2 + 4) * 8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">c2</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">352</span>
</pre></div>
</div>
<p>将 group 与另一个任务组合时，会自动转换为 chord：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c3</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">|</span> <span class="n">tsum</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">c3</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">90</span>
</pre></div>
</div>
<p>group 和 chord 也支持部分参数，在链中，前一个任务的返回值会被转发给 group 中的所有任务：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">new_user_workflow</span> <span class="o">=</span> <span class="p">(</span><span class="n">create_user</span><span class="o">.</span><span class="n">s</span><span class="p">()</span> <span class="o">|</span> <span class="n">group</span><span class="p">(</span>
<span class="gp">... </span>                     <span class="n">import_contacts</span><span class="o">.</span><span class="n">s</span><span class="p">(),</span>
<span class="gp">... </span>                     <span class="n">send_welcome_email</span><span class="o">.</span><span class="n">s</span><span class="p">()))</span>
<span class="gp">... </span><span class="n">new_user_workflow</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;artv&#39;</span><span class="p">,</span>
<span class="gp">... </span>                        <span class="n">first</span><span class="o">=</span><span class="s1">&#39;Art&#39;</span><span class="p">,</span>
<span class="gp">... </span>                        <span class="n">last</span><span class="o">=</span><span class="s1">&#39;Vandelay&#39;</span><span class="p">,</span>
<span class="gp">... </span>                        <span class="n">email</span><span class="o">=</span><span class="s1">&#39;art@vandelay.com&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>如果你不希望将参数转发到 group 中的任务，可以将 group 中的签名设为不可变：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">8</span>
</pre></div>
</div>
</li>
</ul>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
<p>The primitives are also signature objects themselves, so that they can be combined
in any number of ways to compose complex work-flows.</p>
<p>Here're some examples:</p>
<ul>
<li><p>Simple chain</p>
<p>Here's a simple chain, the first task executes passing its return value
to the next task in the chain, and so on.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># 2 + 2 + 4 + 8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">16</span>
</pre></div>
</div>
<p>This can also be written using pipes:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))()</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">16</span>
</pre></div>
</div>
</li>
<li><p>Immutable signatures</p>
<p>Signatures can be partial so arguments can be
added to the existing arguments, but you may not always want that,
for example if you don't want the result of the previous task in a chain.</p>
<p>In that case you can mark the signature as immutable, so that the arguments
cannot be changed:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">signature</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">immutable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>There's also a <code class="docutils literal notranslate"><span class="pre">.si()</span></code> shortcut for this, and this is the preferred way of
creating signatures:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Now you can create a chain of independent tasks instead:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">16</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">8</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">4</span>
</pre></div>
</div>
</li>
<li><p>Simple group</p>
<p>You can easily create a group of tasks to execute in parallel:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span>
</pre></div>
</div>
</li>
<li><p>Simple chord</p>
<p>The chord primitive enables us to add a callback to be called when
all of the tasks in a group have finished executing.  This is often
required for algorithms that aren't <em>embarrassingly parallel</em>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chord</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">chord</span><span class="p">((</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="n">tsum</span><span class="o">.</span><span class="n">s</span><span class="p">())()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">90</span>
</pre></div>
</div>
<p>The above example creates 10 tasks that all start in parallel,
and when all of them are complete the return values are combined
into a list and sent to the <code class="docutils literal notranslate"><span class="pre">tsum</span></code> task.</p>
<p>The body of a chord can also be immutable, so that the return value
of the group isn't passed on to the callback:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">chord</span><span class="p">((</span><span class="n">import_contact</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">),</span>
<span class="gp">... </span>      <span class="n">notify_complete</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">import_id</span><span class="p">))</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
</pre></div>
</div>
<p>Note the use of <code class="docutils literal notranslate"><span class="pre">.si</span></code> above; this creates an immutable signature,
meaning any new arguments passed (including to return value of the
previous task) will be ignored.</p>
</li>
<li><p>Blow your mind by combining</p>
<p>Chains can be partial too:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>

<span class="go"># (16 + 4) * 8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">c1</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">160</span>
</pre></div>
</div>
<p>this means that you can combine chains:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="go"># ((4 + 16) * 2 + 4) * 8</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">c2</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">352</span>
</pre></div>
</div>
<p>Chaining a group together with another task will automatically
upgrade it to be a chord:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c3</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">|</span> <span class="n">tsum</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">c3</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">90</span>
</pre></div>
</div>
<p>Groups and chords accepts partial arguments too, so in a chain
the return value of the previous task is forwarded to all tasks in the group:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">new_user_workflow</span> <span class="o">=</span> <span class="p">(</span><span class="n">create_user</span><span class="o">.</span><span class="n">s</span><span class="p">()</span> <span class="o">|</span> <span class="n">group</span><span class="p">(</span>
<span class="gp">... </span>                     <span class="n">import_contacts</span><span class="o">.</span><span class="n">s</span><span class="p">(),</span>
<span class="gp">... </span>                     <span class="n">send_welcome_email</span><span class="o">.</span><span class="n">s</span><span class="p">()))</span>
<span class="gp">... </span><span class="n">new_user_workflow</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s1">&#39;artv&#39;</span><span class="p">,</span>
<span class="gp">... </span>                        <span class="n">first</span><span class="o">=</span><span class="s1">&#39;Art&#39;</span><span class="p">,</span>
<span class="gp">... </span>                        <span class="n">last</span><span class="o">=</span><span class="s1">&#39;Vandelay&#39;</span><span class="p">,</span>
<span class="gp">... </span>                        <span class="n">email</span><span class="o">=</span><span class="s1">&#39;art@vandelay.com&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you don't want to forward arguments to the group then
you can make the signatures in the group immutable:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">8</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<section id="canvas-chain">
<span id="id6"></span><h3>链<a class="headerlink" href="#canvas-chain" title="Link to this heading">¶</a></h3>
<p>Chains</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
<p>任务可以彼此链接：当一个任务成功返回时，会调用所链接的任务：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">link</span><span class="o">=</span><span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">4</span>
</pre></div>
</div>
<p>所链接的任务将以其父任务的结果作为第一个参数来调用。在上述示例中，结果为 4，因此会执行 <code class="docutils literal notranslate"><span class="pre">mul(4,</span> <span class="pre">16)</span></code>。</p>
<p>结果对象会追踪原始任务所调用的所有子任务，可以通过结果实例访问这些子任务：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">children</span>
<span class="go">[&lt;AsyncResult: 8c350acf-519d-4553-8a53-4ad3a5c5aeb4&gt;]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">64</span>
</pre></div>
</div>
<p>结果实例还提供了 <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult.collect" title="celery.result.AsyncResult.collect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">collect()</span></code></a> 方法，它会将结果视为一张图，使你可以迭代地访问所有结果：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>
<span class="go">[(&lt;AsyncResult: 7b720856-dc5f-4415-9134-5c89def5664e&gt;, 4),</span>
<span class="go"> (&lt;AsyncResult: 8c350acf-519d-4553-8a53-4ad3a5c5aeb4&gt;, 64)]</span>
</pre></div>
</div>
<p>默认情况下，如果图未完全构建（即有任务尚未完成），<a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult.collect" title="celery.result.AsyncResult.collect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">collect()</span></code></a> 会抛出 <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.IncompleteStream" title="celery.exceptions.IncompleteStream"><code class="xref py py-exc docutils literal notranslate"><span class="pre">IncompleteStream</span></code></a> 异常，
但你也可以选择获取图的中间状态：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">intermediate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="go">....</span>
</pre></div>
</div>
<p>你可以将任意数量的任务链接起来，签名（signature）也同样支持链接：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">log_result</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
</pre></div>
</div>
<p>你也可以通过 <cite>on_error</cite> 方法添加 <em>错误回调</em>：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">log_error</span><span class="o">.</span><span class="n">s</span><span class="p">())</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</pre></div>
</div>
<p>当应用该签名时，实际执行的 <code class="docutils literal notranslate"><span class="pre">.apply_async</span></code> 调用如下所示：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">link_error</span><span class="o">=</span><span class="n">log_error</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
</pre></div>
</div>
<p>Worker 并不会以任务形式调用 errback，而是直接调用 errback 函数，
这样可以将原始请求对象、异常对象和 traceback 对象传递给它。</p>
<p>以下是一个 errback 的示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">proj.celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/var/errors&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--</span><span class="se">\n\n</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">traceback</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
<p>为了简化任务的链接操作，Celery 提供了一个特殊的签名类 <a class="reference internal" href="../reference/celery.html#celery.chain" title="celery.chain"><code class="xref py py-class docutils literal notranslate"><span class="pre">chain</span></code></a>，可以用来将多个任务链式连接：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">proj.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">mul</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># (4 + 4) * 8 * 10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="go">proj.tasks.add(4, 4) | proj.tasks.mul(8) | proj.tasks.mul(10)</span>
</pre></div>
</div>
<p>调用该 chain 会在当前进程中依次调用每个任务，并返回链中最后一个任务的结果：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">10</span><span class="p">))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">640</span>
</pre></div>
</div>
<p>它还会设置 <code class="docutils literal notranslate"><span class="pre">parent</span></code> 属性，这样你就可以向上遍历任务链以获取中间结果：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">64</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">8</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
<span class="go">&lt;AsyncResult: eeaad925-6778-4ad1-88c8-b2a63d017933&gt;</span>
</pre></div>
</div>
<p>你也可以使用 <code class="docutils literal notranslate"><span class="pre">|</span></code> （管道）操作符来创建任务链：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
<p>Tasks can be linked together: the linked task is called when the task
returns successfully:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">link</span><span class="o">=</span><span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">4</span>
</pre></div>
</div>
<p>The linked task will be applied with the result of its parent
task as the first argument. In the above case where the result was 4,
this will result in <code class="docutils literal notranslate"><span class="pre">mul(4,</span> <span class="pre">16)</span></code>.</p>
<p>The results will keep track of any subtasks called by the original task,
and this can be accessed from the result instance:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">children</span>
<span class="go">[&lt;AsyncResult: 8c350acf-519d-4553-8a53-4ad3a5c5aeb4&gt;]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">64</span>
</pre></div>
</div>
<p>The result instance also has a <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult.collect" title="celery.result.AsyncResult.collect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">collect()</span></code></a> method
that treats the result as a graph, enabling you to iterate over
the results:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>
<span class="go">[(&lt;AsyncResult: 7b720856-dc5f-4415-9134-5c89def5664e&gt;, 4),</span>
<span class="go"> (&lt;AsyncResult: 8c350acf-519d-4553-8a53-4ad3a5c5aeb4&gt;, 64)]</span>
</pre></div>
</div>
<p>By default <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult.collect" title="celery.result.AsyncResult.collect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">collect()</span></code></a> will raise an
<a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.IncompleteStream" title="celery.exceptions.IncompleteStream"><code class="xref py py-exc docutils literal notranslate"><span class="pre">IncompleteStream</span></code></a> exception if the graph isn't fully
formed (one of the tasks hasn't completed yet),
but you can get an intermediate representation of the graph
too:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">intermediate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="go">....</span>
</pre></div>
</div>
<p>You can link together as many tasks as you like,
and signatures can be linked too:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">log_result</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
</pre></div>
</div>
<p>You can also add <em>error callbacks</em> using the <cite>on_error</cite> method:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">log_error</span><span class="o">.</span><span class="n">s</span><span class="p">())</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</pre></div>
</div>
<p>This will result in the following <code class="docutils literal notranslate"><span class="pre">.apply_async</span></code> call when the signature
is applied:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">link_error</span><span class="o">=</span><span class="n">log_error</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
</pre></div>
</div>
<p>The worker won't actually call the errback as a task, but will
instead call the errback function directly so that the raw request, exception
and traceback objects can be passed to it.</p>
<p>Here's an example errback:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">proj.celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/var/errors&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--</span><span class="se">\n\n</span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">traceback</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
<p>To make it even easier to link tasks together there's
a special signature called <a class="reference internal" href="../reference/celery.html#celery.chain" title="celery.chain"><code class="xref py py-class docutils literal notranslate"><span class="pre">chain</span></code></a> that lets
you chain tasks together:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">proj.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">mul</span>

<span class="gp">&gt;&gt;&gt; </span><span class="c1"># (4 + 4) * 8 * 10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="go">proj.tasks.add(4, 4) | proj.tasks.mul(8) | proj.tasks.mul(10)</span>
</pre></div>
</div>
<p>Calling the chain will call the tasks in the current process
and return the result of the last task in the chain:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">10</span><span class="p">))()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">640</span>
</pre></div>
</div>
<p>It also sets <code class="docutils literal notranslate"><span class="pre">parent</span></code> attributes so that you can
work your way up the chain to get intermediate results:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">64</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">8</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
<span class="go">&lt;AsyncResult: eeaad925-6778-4ad1-88c8-b2a63d017933&gt;</span>
</pre></div>
</div>
<p>Chains can also be made using the <code class="docutils literal notranslate"><span class="pre">|</span></code> (pipe) operator:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="id">
<h4>任务 ID<a class="headerlink" href="#id" title="Link to this heading">¶</a></h4>
<p>Task ID</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.4.</span></p>
</div>
<p>链将继承链中最后一个任务的任务 ID。</p>
</div>
<input class="tab-input" id="tab-set--6-input--2" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.4.</span></p>
</div>
<p>A chain will inherit the task id of the last task in the chain.</p>
</div>
</div>
</section>
<section id="id7">
<h4>图表<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h4>
<p>Graphs</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--1">中文</label><div class="tab-content docutils container">
<p>此外，你还可以将结果图作为 <a class="reference internal" href="../internals/reference/celery.utils.graph.html#celery.utils.graph.DependencyGraph" title="celery.utils.graph.DependencyGraph"><code class="xref py py-class docutils literal notranslate"><span class="pre">DependencyGraph</span></code></a> 来操作：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">10</span><span class="p">))()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">graph</span>
<span class="go">285fa253-fcf8-42ef-8b95-0078897e83e6(1)</span>
<span class="go">    463afec2-5ed4-4036-b22d-ba067ec64f52(0)</span>
<span class="go">872c3995-6fa0-46ca-98c2-5a19155afcf0(2)</span>
<span class="go">    285fa253-fcf8-42ef-8b95-0078897e83e6(1)</span>
<span class="go">        463afec2-5ed4-4036-b22d-ba067ec64f52(0)</span>
</pre></div>
</div>
<p>你甚至可以将这些图转换为 <em>dot</em> 格式：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;graph.dot&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">to_dot</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
<p>并生成图像：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dot<span class="w"> </span>-Tpng<span class="w"> </span>graph.dot<span class="w"> </span>-o<span class="w"> </span>graph.png
</pre></div>
</div>
<img alt="../_images/result_graph.png" src="../_images/result_graph.png" />
</div>
<input class="tab-input" id="tab-set--7-input--2" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--2">英文</label><div class="tab-content docutils container">
<p>In addition you can work with the result graph as a
<a class="reference internal" href="../internals/reference/celery.utils.graph.html#celery.utils.graph.DependencyGraph" title="celery.utils.graph.DependencyGraph"><code class="xref py py-class docutils literal notranslate"><span class="pre">DependencyGraph</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">mul</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">10</span><span class="p">))()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">graph</span>
<span class="go">285fa253-fcf8-42ef-8b95-0078897e83e6(1)</span>
<span class="go">    463afec2-5ed4-4036-b22d-ba067ec64f52(0)</span>
<span class="go">872c3995-6fa0-46ca-98c2-5a19155afcf0(2)</span>
<span class="go">    285fa253-fcf8-42ef-8b95-0078897e83e6(1)</span>
<span class="go">        463afec2-5ed4-4036-b22d-ba067ec64f52(0)</span>
</pre></div>
</div>
<p>You can even convert these graphs to <em>dot</em> format:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;graph.dot&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">res</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">to_dot</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
</pre></div>
</div>
<p>and create images:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>dot<span class="w"> </span>-Tpng<span class="w"> </span>graph.dot<span class="w"> </span>-o<span class="w"> </span>graph.png
</pre></div>
</div>
<img alt="../_images/result_graph.png" src="../_images/result_graph.png" />
</div>
</div>
</section>
</section>
<section id="canvas-group">
<span id="id8"></span><h3>组<a class="headerlink" href="#canvas-group" title="Link to this heading">¶</a></h3>
<p>Groups</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>与 chords 类似，group 中使用的任务也 <em>不能</em> 忽略它们的结果。
参阅 &quot;<a class="reference internal" href="#chord-important-notes"><span class="std std-ref">重要说明</span></a>&quot; 以获取更多信息。</p>
</div>
<p>Group 可用于并行执行多个任务。</p>
<p><a class="reference internal" href="../reference/celery.html#celery.group" title="celery.group"><code class="xref py py-class docutils literal notranslate"><span class="pre">group</span></code></a> 函数接收一个签名列表作为参数：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">proj.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="go">(proj.tasks.add(2, 2), proj.tasks.add(4, 4))</span>
</pre></div>
</div>
<p>如果你 <strong>调用</strong> 该 group，任务将会在当前进程中一个接一个地执行，并返回一个 <a class="reference internal" href="../reference/celery.result.html#celery.result.GroupResult" title="celery.result.GroupResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">GroupResult</span></code></a>
实例，用于跟踪结果状态，或查看有多少任务已经完成等等：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">g</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">[4, 8]</span>
</pre></div>
</div>
<p>Group 也支持迭代器作为输入：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))()</span>
</pre></div>
</div>
<p>Group 是一个签名对象，因此可以与其他签名组合使用。</p>
</div>
<input class="tab-input" id="tab-set--8-input--2" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Similarly to chords, tasks used in a group must <em>not</em> ignore their results.
See &quot;<a class="reference internal" href="#chord-important-notes"><span class="std std-ref">重要说明</span></a>&quot; for more information.</p>
</div>
<p>A group can be used to execute several tasks in parallel.</p>
<p>The <a class="reference internal" href="../reference/celery.html#celery.group" title="celery.group"><code class="xref py py-class docutils literal notranslate"><span class="pre">group</span></code></a> function takes a list of signatures:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">proj.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="go">(proj.tasks.add(2, 2), proj.tasks.add(4, 4))</span>
</pre></div>
</div>
<p>If you <strong>call</strong> the group, the tasks will be applied
one after another in the current process, and a <a class="reference internal" href="../reference/celery.result.html#celery.result.GroupResult" title="celery.result.GroupResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">GroupResult</span></code></a>
instance is returned that can be used to keep track of the results,
or tell how many tasks are ready and so on:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">g</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">[4, 8]</span>
</pre></div>
</div>
<p>Group also supports iterators:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))()</span>
</pre></div>
</div>
<p>A group is a signature object, so it can be used in combination
with other signatures.</p>
</div>
</div>
<section id="group-callbacks">
<span id="id9"></span><h4>组回调函数和错误处理<a class="headerlink" href="#group-callbacks" title="Link to this heading">¶</a></h4>
<p>Group Callbacks and Error Handling</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--1">中文</label><div class="tab-content docutils container">
<p>Group 也可以绑定回调（callback）和错误回调（errback）签名，但其行为可能略显意外，
因为 group 并不是真正的任务对象，而只是将链接的任务传递给其封装的各个签名。
这意味着 group 的返回值不会被收集起来传递给链接的回调签名。
此外，链接的任务也 <em>不保证</em> 只有在所有 group 任务都完成后才会被激活。</p>
<p>例如，以下使用简单 <cite>add(a, b)</cite> 任务的片段是错误的，因为所链接的 <cite>add.s()</cite> 签名并不会收到最终的 group 结果作为参数：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">g</span><span class="p">()</span>
<span class="go">[4, 8]</span>
</pre></div>
</div>
<p>注意，前两个任务的最终结果被返回了，但回调签名在后台运行时会抛出异常，
因为它没有收到预期的两个参数。</p>
<p>Group 的 errback 也会被传递给封装的各个签名，
这意味着如果 group 中有多个任务失败，那么仅链接一次的 errback 可能会被调用多次。
例如，以下片段中使用了一个会抛出异常的 <cite>fail()</cite> 任务，可以预期 <cite>log_error()</cite> 签名会针对 group 中每一个失败的任务被调用一次：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">fail</span><span class="o">.</span><span class="n">s</span><span class="p">(),</span> <span class="n">fail</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">link_error</span><span class="p">(</span><span class="n">log_error</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">g</span><span class="p">()</span>
</pre></div>
</div>
<p>因此，通常建议将 errback 设计为幂等或可计数的任务，能容忍被多次调用。</p>
<p>对于这类使用场景，更推荐使用 <a class="reference internal" href="../reference/celery.html#celery.chord" title="celery.chord"><code class="xref py py-class docutils literal notranslate"><span class="pre">chord</span></code></a> 类，
该类在某些后端实现中提供了更合适的支持。</p>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--2">英文</label><div class="tab-content docutils container">
<p>Groups can have callback and errback signatures linked to them as well, however
the behaviour can be somewhat surprising due to the fact that groups are not
real tasks and simply pass linked tasks down to their encapsulated signatures.
This means that the return values of a group are not collected to be passed to
a linked callback signature.
Additionally, linking the task will <em>not</em> guarantee that it will activate only
when all group tasks have finished.
As an example, the following snippet using a simple <cite>add(a, b)</cite> task is faulty
since the linked <cite>add.s()</cite> signature will not receive the finalised group
result as one might expect.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">g</span><span class="p">()</span>
<span class="go">[4, 8]</span>
</pre></div>
</div>
<p>Note that the finalised results of the first two tasks are returned, but the
callback signature will have run in the background and raised an exception
since it did not receive the two arguments it expects.</p>
<p>Group errbacks are passed down to encapsulated signatures as well which opens
the possibility for an errback linked only once to be called more than once if
multiple tasks in a group were to fail.
As an example, the following snippet using a <cite>fail()</cite> task which raises an
exception can be expected to invoke the <cite>log_error()</cite> signature once for each
failing task which gets run in the group.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">fail</span><span class="o">.</span><span class="n">s</span><span class="p">(),</span> <span class="n">fail</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">link_error</span><span class="p">(</span><span class="n">log_error</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">g</span><span class="p">()</span>
</pre></div>
</div>
<p>With this in mind, it's generally advisable to create idempotent or counting
tasks which are tolerant to being called repeatedly for use as errbacks.</p>
<p>These use cases are better addressed by the <a class="reference internal" href="../reference/celery.html#celery.chord" title="celery.chord"><code class="xref py py-class docutils literal notranslate"><span class="pre">chord</span></code></a> class which
is supported on certain backend implementations.</p>
</div>
</div>
</section>
<section id="group-results">
<span id="id10"></span><h4>组结果<a class="headerlink" href="#group-results" title="Link to this heading">¶</a></h4>
<p>Group Results</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--1">中文</label><div class="tab-content docutils container">
<p>group 任务也会返回一个特殊的结果对象，
这个结果对象的行为与普通的任务结果相似，
只是它作用于整个 group：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">job</span> <span class="o">=</span> <span class="n">group</span><span class="p">([</span>
<span class="gp">... </span>            <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="gp">... </span>            <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="gp">... </span>            <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
<span class="gp">... </span>            <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
<span class="gp">... </span>            <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
<span class="gp">... </span><span class="p">])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">ready</span><span class="p">()</span>  <span class="c1"># 所有子任务都完成了吗？</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">successful</span><span class="p">()</span> <span class="c1"># 所有子任务都成功了吗？</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">[4, 8, 16, 32, 64]</span>
</pre></div>
</div>
<p><a class="reference internal" href="../reference/celery.result.html#celery.result.GroupResult" title="celery.result.GroupResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">GroupResult</span></code></a> 接收一个由 <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult" title="celery.result.AsyncResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncResult</span></code></a> 实例组成的列表，并将它们作为一个整体任务进行操作。</p>
<p>它支持以下操作：</p>
<ul>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">successful()</span></code></p>
<p>如果所有子任务都成功完成（例如没有抛出异常），返回 <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>。</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">failed()</span></code></p>
<p>如果有任意一个子任务失败，返回 <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>。</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">waiting()</span></code></p>
<p>如果仍有任意子任务尚未就绪，返回 <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>。</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">ready()</span></code></p>
<p>如果所有子任务都已就绪，返回 <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>。</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">completed_count()</span></code></p>
<p>返回已完成的子任务数量。注意，在此上下文中“完成”是指“成功”。换句话说，该方法的返回值是 <cite>successful</cite> 任务的数量。</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">revoke()</span></code></p>
<p>撤销所有子任务。</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">join()</span></code></p>
<p>收集所有子任务的结果，并按调用顺序返回（作为列表）。</p>
</li>
</ul>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--2">英文</label><div class="tab-content docutils container">
<p>The group task returns a special result too,
this result works just like normal task results, except
that it works on the group as a whole:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">job</span> <span class="o">=</span> <span class="n">group</span><span class="p">([</span>
<span class="gp">... </span>            <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<span class="gp">... </span>            <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
<span class="gp">... </span>            <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
<span class="gp">... </span>            <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
<span class="gp">... </span>            <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span>
<span class="gp">... </span><span class="p">])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">ready</span><span class="p">()</span>  <span class="c1"># have all subtasks completed?</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">successful</span><span class="p">()</span> <span class="c1"># were all subtasks successful?</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">[4, 8, 16, 32, 64]</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../reference/celery.result.html#celery.result.GroupResult" title="celery.result.GroupResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">GroupResult</span></code></a> takes a list of
<a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult" title="celery.result.AsyncResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncResult</span></code></a> instances and operates on them as
if it was a single task.</p>
<p>It supports the following operations:</p>
<ul>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">successful()</span></code></p>
<p>Return <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code> if all of the subtasks finished
successfully (e.g., didn't raise an exception).</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">failed()</span></code></p>
<p>Return <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code> if any of the subtasks failed.</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">waiting()</span></code></p>
<p>Return <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code> if any of the subtasks
isn't ready yet.</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">ready()</span></code></p>
<p>Return <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code> if all of the subtasks
are ready.</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">completed_count()</span></code></p>
<p>Return the number of completed subtasks. Note that <cite>complete</cite> means <cite>successful</cite> in
this context. In other words, the return value of this method is the number of
<code class="docutils literal notranslate"><span class="pre">successful</span></code> tasks.</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">revoke()</span></code></p>
<p>Revoke all of the subtasks.</p>
</li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">join()</span></code></p>
<p>Gather the results of all subtasks
and return them in the same order as they were called (as a list).</p>
</li>
</ul>
</div>
</div>
</section>
<section id="group-unrolling">
<span id="id11"></span><h4>组展开<a class="headerlink" href="#group-unrolling" title="Link to this heading">¶</a></h4>
<p>Group Unrolling</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--11-input--1" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--1">中文</label><div class="tab-content docutils container">
<p>当 group 中仅包含一个签名时，在链式调用中它将会被“展开”为单个签名。
这意味着如下 group 会根据其中元素的数量，
向后续 chain 传递一个结果或结果列表：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="go">add(2, 2) | add(1) | add(1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="go">add(2, 2) | %add((add(1), add(2)), 1)</span>
</pre></div>
</div>
<p>这意味着，如果你打算在大型 canvas 中使用该任务，
应确保 <cite>add</cite> 任务能够同时接受列表或单个元素作为输入。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>在 Celery 4.x 中，以下 group 不会在链中被“展开”，而是由于 bug 的原因，canvas 会被升级为 chord：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">chain</span><span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="go">%add([add(1, 1)], 2)</span>
</pre></div>
</div>
<p>而在 Celery 5.x 中此 bug 已被修复，group 会被正确地展开为单个签名：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">chain</span><span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="go">add(1, 1) | add(2)</span>
</pre></div>
</div>
</div>
</div>
<input class="tab-input" id="tab-set--11-input--2" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--2">英文</label><div class="tab-content docutils container">
<p>A group with a single signature will be unrolled to a single signature when chained.
This means that the following group may pass either a list of results or a single result to the chain
depending on the number of items in the group.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="go">add(2, 2) | add(1) | add(1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">chain</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="go">add(2, 2) | %add((add(1), add(2)), 1)</span>
</pre></div>
</div>
<p>This means that you should be careful and make sure the <code class="docutils literal notranslate"><span class="pre">add</span></code> task can accept either a list or a single item as input
if you plan to use it as part of a larger canvas.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>In Celery 4.x the following group below would not unroll into a chain due to a bug but instead the canvas would be
upgraded into a chord.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">chain</span><span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="go">%add([add(1, 1)], 2)</span>
</pre></div>
</div>
<p>In Celery 5.x this bug was fixed and the group is correctly unrolled into a single signature.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">group</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">chain</span><span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="go">add(1, 1) | add(2)</span>
</pre></div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="canvas-chord">
<span id="id12"></span><h3>合集<a class="headerlink" href="#canvas-chord" title="Link to this heading">¶</a></h3>
<p>Chords</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--12-input--1" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.3.</span></p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>chord 中的任务 <em>不得</em> 忽略其结果。
如果 chord 中的任意任务（无论是 header 还是 body）禁用了结果后端，
请阅读 &quot;<a class="reference internal" href="#chord-important-notes"><span class="std std-ref">重要说明</span></a>&quot;。
当前 chord 不支持 RPC 结果后端。</p>
</div>
<p>chord 是一种特殊的任务，仅当 group 中的所有任务都执行完毕后才会执行。</p>
<p>我们来计算如下表达式的和：
<span class="math">1 + 1 + 2 + 2 + 3 + 3 ... n + n</span>，直到 100：</p>
<p>首先你需要两个任务，<code class="xref py py-func docutils literal notranslate"><span class="pre">add()</span></code> 和 <code class="xref py py-func docutils literal notranslate"><span class="pre">tsum`（:func:`sum()</span></code> 是内建函数）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">tsum</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
</pre></div>
</div>
<p>接下来你可以使用 chord 来并行计算每一对相加操作，
然后对它们的结果求和：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chord</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">tsum</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">chord</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<span class="gp">... </span>      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))(</span><span class="n">tsum</span><span class="o">.</span><span class="n">s</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">9900</span>
</pre></div>
</div>
<p>当然这只是一个人为构造的示例，
消息传递和同步的开销使得它远比原生 Python 实现要慢：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">sum</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
<p>同步步骤代价较高，因此应尽可能避免使用 chord。
尽管如此，chord 依然是一个强大的原语，
在许多并行算法中， <em>同步</em> 是不可避免的。</p>
<p>我们将 chord 表达式分解如下：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">callback</span> <span class="o">=</span> <span class="n">tsum</span><span class="o">.</span><span class="n">s</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">chord</span><span class="p">(</span><span class="n">header</span><span class="p">)(</span><span class="n">callback</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">9900</span>
</pre></div>
</div>
<p>请记住，callback 只会在 header 中所有任务都返回后才会执行。
header 中的每一步都是一个任务，可能会并行执行在不同节点上。
然后 callback 会以这些任务的返回值为输入被调用。
<code class="xref py py-meth docutils literal notranslate"><span class="pre">chord()</span></code> 返回的任务 ID 实际上是 callback 的 ID，
因此你可以等待其完成并获取最终结果（但请牢记要 <a class="reference internal" href="tasks.html#task-synchronous-subtasks"><span class="std std-ref">避免任务之间同步等待</span></a>）。</p>
</div>
<input class="tab-input" id="tab-set--12-input--2" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 2.3.</span></p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Tasks used within a chord must <em>not</em> ignore their results. If the result
backend is disabled for <em>any</em> task (header or body) in your chord you
should read &quot;<a class="reference internal" href="#chord-important-notes"><span class="std std-ref">重要说明</span></a>&quot;. Chords are not currently
supported with the RPC result backend.</p>
</div>
<p>A chord is a task that only executes after all of the tasks in a group have
finished executing.</p>
<p>Let's calculate the sum of the expression
<span class="math">1 + 1 + 2 + 2 + 3 + 3 ... n + n</span> up to a hundred digits.</p>
<p>First you need two tasks, <code class="xref py py-func docutils literal notranslate"><span class="pre">add()</span></code> and <code class="xref py py-func docutils literal notranslate"><span class="pre">tsum()</span></code> (<a class="reference external" href="https://docs.python.org/dev/library/functions.html#sum" title="（在 Python v3.15）"><code class="xref py py-func docutils literal notranslate"><span class="pre">sum()</span></code></a> is
already a standard function):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">tsum</span><span class="p">(</span><span class="n">numbers</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span>
</pre></div>
</div>
<p>Now you can use a chord to calculate each addition step in parallel, and then
get the sum of the resulting numbers:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">chord</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span><span class="p">,</span> <span class="n">tsum</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">chord</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
<span class="gp">... </span>      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))(</span><span class="n">tsum</span><span class="o">.</span><span class="n">s</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">9900</span>
</pre></div>
</div>
<p>This is obviously a very contrived example, the overhead of messaging and
synchronization makes this a lot slower than its Python counterpart:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">sum</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
</pre></div>
</div>
<p>The synchronization step is costly, so you should avoid using chords as much
as possible. Still, the chord is a powerful primitive to have in your toolbox
as synchronization is a required step for many parallel algorithms.</p>
<p>Let's break the chord expression down:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">callback</span> <span class="o">=</span> <span class="n">tsum</span><span class="o">.</span><span class="n">s</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">chord</span><span class="p">(</span><span class="n">header</span><span class="p">)(</span><span class="n">callback</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">9900</span>
</pre></div>
</div>
<p>Remember, the callback can only be executed after all of the tasks in the
header have returned. Each step in the header is executed as a task, in
parallel, possibly on different nodes. The callback is then applied with
the return value of each task in the header. The task id returned by
<code class="xref py py-meth docutils literal notranslate"><span class="pre">chord()</span></code> is the id of the callback, so you can wait for it to complete
and get the final return value (but remember to <a class="reference internal" href="tasks.html#task-synchronous-subtasks"><span class="std std-ref">never have a task wait
for other tasks</span></a>)</p>
</div>
</div>
<section id="chord-errors">
<span id="id13"></span><h4>错误处理<a class="headerlink" href="#chord-errors" title="Link to this heading">¶</a></h4>
<p>Error handling</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--13-input--1" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--1">中文</label><div class="tab-content docutils container">
<p>那么如果其中一个任务抛出异常会发生什么？</p>
<p>chord 的回调结果将会进入失败状态，并且错误会被设置为
<a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.ChordError" title="celery.exceptions.ChordError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ChordError</span></code></a> 异常：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">chord</span><span class="p">([</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">raising_task</span><span class="o">.</span><span class="n">s</span><span class="p">(),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-pytb notranslate"><div class="highlight"><pre><span></span><span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">&quot;*/celery/result.py&quot;</span>, line <span class="m">120</span>, in <span class="n">get</span>
<span class="w">    </span><span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
  File <span class="nb">&quot;*/celery/backends/amqp.py&quot;</span>, line <span class="m">150</span>, in <span class="n">wait_for</span>
<span class="w">    </span><span class="k">raise</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
<span class="gr">celery.exceptions.ChordError</span>: <span class="n">Dependency 97de6f3f-ea67-4517-a21c-d867c61fcb47</span>
<span class="x">    raised ValueError(&#39;something something&#39;,)</span>
</pre></div>
</div>
<p>虽然回溯信息可能会因所使用的结果后端不同而有所不同，
但你可以看到错误描述中包含了失败任务的 ID，以及原始异常的字符串表示。
你还可以在 <code class="docutils literal notranslate"><span class="pre">result.traceback</span></code> 中找到原始的回溯信息。</p>
<p>注意，其他任务仍然会继续执行，所以即使中间的任务失败了，
第三个任务（ <code class="docutils literal notranslate"><span class="pre">add.s(8,</span> <span class="pre">8)</span></code> ）依然会被执行。
同时，<a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.ChordError" title="celery.exceptions.ChordError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ChordError</span></code></a> 只会显示第一个（按时间先后）失败的任务：
它不会遵循 header 分组中的顺序。</p>
<p>为了在 chord 失败时执行某些操作，你可以为 chord 回调附加一个 errback：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_chord_error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task </span><span class="si">{0!r}</span><span class="s1"> raised error: </span><span class="si">{1!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">|</span>
<span class="gp">... </span>     <span class="n">tsum</span><span class="o">.</span><span class="n">s</span><span class="p">()</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">on_chord_error</span><span class="o">.</span><span class="n">s</span><span class="p">()))</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</pre></div>
</div>
<p>chord 允许将回调和错误回调（errback）签名关联起来，这解决了将签名链接到 group 的一些问题。
这样可以将提供的签名连接到 chord 的 body 上，确保 body 完成时仅调用一次回调，
或者当 header 或 body 中的任何任务失败时，仅调用一次 errback。</p>
<p>你可以通过设置 <span class="xref std std-ref">task_allow_error_cb_on_chord_header</span> 标志，
来控制是否允许对 chord header 的错误进行处理。
启用此标志后，chord header 中失败的任务将触发对 body 的 errback（默认行为），
<em>并且</em> header 中失败的任务也会触发 errback。</p>
</div>
<input class="tab-input" id="tab-set--13-input--2" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--2">英文</label><div class="tab-content docutils container">
<p>So what happens if one of the tasks raises an exception?</p>
<p>The chord callback result will transition to the failure state, and the error is set
to the <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.ChordError" title="celery.exceptions.ChordError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ChordError</span></code></a> exception:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">chord</span><span class="p">([</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">raising_task</span><span class="o">.</span><span class="n">s</span><span class="p">(),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-pytb notranslate"><div class="highlight"><pre><span></span><span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
  File <span class="nb">&quot;*/celery/result.py&quot;</span>, line <span class="m">120</span>, in <span class="n">get</span>
<span class="w">    </span><span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">)</span>
  File <span class="nb">&quot;*/celery/backends/amqp.py&quot;</span>, line <span class="m">150</span>, in <span class="n">wait_for</span>
<span class="w">    </span><span class="k">raise</span> <span class="n">meta</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span>
<span class="gr">celery.exceptions.ChordError</span>: <span class="n">Dependency 97de6f3f-ea67-4517-a21c-d867c61fcb47</span>
<span class="x">    raised ValueError(&#39;something something&#39;,)</span>
</pre></div>
</div>
<p>While the traceback may be different depending on the result backend used,
you can see that the error description includes the id of the task that failed
and a string representation of the original exception. You can also
find the original traceback in <code class="docutils literal notranslate"><span class="pre">result.traceback</span></code>.</p>
<p>Note that the rest of the tasks will still execute, so the third task
(<code class="docutils literal notranslate"><span class="pre">add.s(8,</span> <span class="pre">8)</span></code>) is still executed even though the middle task failed.
Also the <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.ChordError" title="celery.exceptions.ChordError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ChordError</span></code></a> only shows the task that failed
first (in time): it doesn't respect the ordering of the header group.</p>
<p>To perform an action when a chord fails you can therefore attach
an errback to the chord callback:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_chord_error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task </span><span class="si">{0!r}</span><span class="s1"> raised error: </span><span class="si">{1!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">group</span><span class="p">(</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">|</span>
<span class="gp">... </span>     <span class="n">tsum</span><span class="o">.</span><span class="n">s</span><span class="p">()</span><span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">on_chord_error</span><span class="o">.</span><span class="n">s</span><span class="p">()))</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</pre></div>
</div>
<p>Chords may have callback and errback signatures linked to them, which addresses
some of the issues with linking signatures to groups.
Doing so will link the provided signature to the chord's body which can be
expected to gracefully invoke callbacks just once upon completion of the body,
or errbacks just once if any task in the chord header or body fails.</p>
<p>This behavior can be manipulated to allow error handling of the chord header using the <span class="xref std std-ref">task_allow_error_cb_on_chord_header</span> flag.
Enabling this flag will cause the chord header to invoke the errback for the body (default behavior) <em>and</em> any task in the chord's header that fails.</p>
</div>
</div>
</section>
<section id="chord-important-notes">
<span id="id14"></span><h4>重要说明<a class="headerlink" href="#chord-important-notes" title="Link to this heading">¶</a></h4>
<p>Important Notes</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--14-input--1" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--1">中文</label><div class="tab-content docutils container">
<p>在 chord 中使用的任务 <em>不能</em> 忽略其结果。实际使用中，
你必须启用 <code class="xref py py-const docutils literal notranslate"><span class="pre">result_backend</span></code> 才能使用 chord。
此外，如果你的配置中设置了 <code class="xref py py-const docutils literal notranslate"><span class="pre">task_ignore_result</span></code> 为 <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>，
请确保参与 chord 的每个任务都设置了 <code class="xref py py-const docutils literal notranslate"><span class="pre">ignore_result=False</span></code>。
这对于任务子类和装饰器任务都适用。</p>
<p>任务子类示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">ignore_result</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>装饰器任务示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">another_task</span><span class="p">(</span><span class="n">project</span><span class="p">):</span>
    <span class="n">do_something</span><span class="p">()</span>
</pre></div>
</div>
<p>默认情况下，同步步骤的实现方式是启动一个周期性任务，
每秒轮询一次 group 是否完成，并在准备就绪时调用签名。</p>
<p>示例实现：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">maybe_signature</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unlock_chord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">maybe_signature</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">join</span><span class="p">())</span>
    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="n">max_retries</span><span class="p">)</span>
</pre></div>
</div>
<p>除了 Redis、Memcached 和 DynamoDB 以外的所有结果后端都使用该方式：
它们在 header 中每个任务完成后递增计数器，并在计数器超过任务总数时应用回调。</p>
<p>Redis、Memcached 和 DynamoDB 的方式则更加高效，但在其他后端中不易实现
（欢迎提出建议！）。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在 Redis 2.2 之前的版本中，chord 无法正常工作；
你需要至少升级到 redis-server 2.2 才能使用它们。</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果你在使用 Redis 结果后端时还重写了
<code class="xref py py-meth docutils literal notranslate"><span class="pre">Task.after_return()</span></code> 方法，请确保调用了父类的实现，
否则 chord 回调将不会被触发。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">after_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">do_something</span><span class="p">()</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">after_return</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<input class="tab-input" id="tab-set--14-input--2" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--2">英文</label><div class="tab-content docutils container">
<p>Tasks used within a chord must <em>not</em> ignore their results. In practice this
means that you must enable a <code class="xref py py-const docutils literal notranslate"><span class="pre">result_backend</span></code> in order to use
chords. Additionally, if <code class="xref py py-const docutils literal notranslate"><span class="pre">task_ignore_result</span></code> is set to <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>
in your configuration, be sure that the individual tasks to be used within
the chord are defined with <code class="xref py py-const docutils literal notranslate"><span class="pre">ignore_result=False</span></code>. This applies to both
Task subclasses and decorated tasks.</p>
<p>Example Task subclass:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">ignore_result</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>Example decorated task:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">another_task</span><span class="p">(</span><span class="n">project</span><span class="p">):</span>
    <span class="n">do_something</span><span class="p">()</span>
</pre></div>
</div>
<p>By default the synchronization step is implemented by having a recurring task
poll the completion of the group every second, calling the signature when
ready.</p>
<p>Example implementation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">maybe_signature</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">unlock_chord</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">maybe_signature</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">join</span><span class="p">())</span>
    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="n">max_retries</span><span class="p">)</span>
</pre></div>
</div>
<p>This is used by all result backends except Redis, Memcached and DynamoDB: they
increment a counter after each task in the header, then applies the callback
when the counter exceeds the number of tasks in the set.</p>
<p>The Redis, Memcached and DynamoDB approach is a much better solution, but not easily
implemented in other backends (suggestions welcome!).</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Chords don't properly work with Redis before version 2.2; you'll need to
upgrade to at least redis-server 2.2 to use them.</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>If you're using chords with the Redis result backend and also overriding
the <code class="xref py py-meth docutils literal notranslate"><span class="pre">Task.after_return()</span></code> method, you need to make sure to call the
super method or else the chord callback won't be applied.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">after_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">do_something</span><span class="p">()</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">after_return</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="map-starmap">
<span id="canvas-map"></span><h3>map 和 starmap<a class="headerlink" href="#map-starmap" title="Link to this heading">¶</a></h3>
<p>Map &amp; Starmap</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--15-input--1" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--1">中文</label><div class="tab-content docutils container">
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">map</span></code> 和 <code class="xref py py-class docutils literal notranslate"><span class="pre">starmap</span></code> 是内置任务，
它们会对序列中的每个元素调用指定的调用任务。</p>
<p>它们与 <a class="reference internal" href="../reference/celery.html#celery.group" title="celery.group"><code class="xref py py-class docutils literal notranslate"><span class="pre">group</span></code></a> 不同之处在于：</p>
<ul class="simple">
<li><p>只发送一条任务消息。</p></li>
<li><p>操作是顺序执行的。</p></li>
</ul>
<p>例如使用 <code class="docutils literal notranslate"><span class="pre">map</span></code>：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">proj.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>

<span class="gp">&gt;&gt;&gt; </span><span class="o">~</span><span class="n">tsum</span><span class="o">.</span><span class="n">map</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))])</span>
<span class="go">[45, 4950]</span>
</pre></div>
</div>
<p>这等价于一个任务这样做：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">temp</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">tsum</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="n">tsum</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))]</span>
</pre></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">starmap</span></code>：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="o">~</span><span class="n">add</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
<span class="go">[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span>
</pre></div>
</div>
<p>这等价于一个任务这样写：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">temp</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">map</span></code> 和 <code class="docutils literal notranslate"><span class="pre">starmap</span></code> 都是签名对象，因此它们可以像其他签名一样使用，
并与 group 等组合使用，例如可以在 10 秒后调用 starmap：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--15-input--2" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--2">英文</label><div class="tab-content docutils container">
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">map</span></code> and <code class="xref py py-class docutils literal notranslate"><span class="pre">starmap</span></code> are built-in tasks
that call the provided calling task for every element in a sequence.</p>
<p>They differ from <a class="reference internal" href="../reference/celery.html#celery.group" title="celery.group"><code class="xref py py-class docutils literal notranslate"><span class="pre">group</span></code></a> in that:</p>
<ul class="simple">
<li><p>only one task message is sent.</p></li>
<li><p>the operation is sequential.</p></li>
</ul>
<p>For example using <code class="docutils literal notranslate"><span class="pre">map</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">proj.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>

<span class="gp">&gt;&gt;&gt; </span><span class="o">~</span><span class="n">tsum</span><span class="o">.</span><span class="n">map</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))])</span>
<span class="go">[45, 4950]</span>
</pre></div>
</div>
<p>is the same as having a task doing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">temp</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">tsum</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)),</span> <span class="n">tsum</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">))]</span>
</pre></div>
</div>
<p>and using <code class="docutils literal notranslate"><span class="pre">starmap</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="o">~</span><span class="n">add</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span>
<span class="go">[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</span>
</pre></div>
</div>
<p>is the same as having a task doing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">temp</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
</pre></div>
</div>
<p>Both <code class="docutils literal notranslate"><span class="pre">map</span></code> and <code class="docutils literal notranslate"><span class="pre">starmap</span></code> are signature objects, so they can be used as
other signatures and combined in groups etc., for example
to call the starmap after 10 seconds:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="canvas-chunks">
<span id="id15"></span><h3>数据块<a class="headerlink" href="#canvas-chunks" title="Link to this heading">¶</a></h3>
<p>Chunks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--16-input--1" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--1">中文</label><div class="tab-content docutils container">
<p>chunking 允许你将一个可迭代的工作集分割成多块，因此如果你有一百万个对象，
可以将它们分成 10 个任务，每个任务处理十万个对象。</p>
<p>有些人可能担心将任务切块会降低并行度，但这在实际中很少发生，
尤其是在繁忙的集群中，因为它减少了消息传递的开销，
所以通常可以显著提升性能。</p>
<p>要创建 chunk 签名，可以使用 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.chunks" title="celery.app.task.Task.chunks"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.chunks()</span></code></a> 方法：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>与 <a class="reference internal" href="../reference/celery.html#celery.group" title="celery.group"><code class="xref py py-class docutils literal notranslate"><span class="pre">group</span></code></a> 一样，chunk 的消息发送操作是在当前进程中完成的：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">proj.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span> <span class="mi">10</span><span class="p">)()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">[[0, 2, 4, 6, 8, 10, 12, 14, 16, 18],</span>
<span class="go"> [20, 22, 24, 26, 28, 30, 32, 34, 36, 38],</span>
<span class="go"> [40, 42, 44, 46, 48, 50, 52, 54, 56, 58],</span>
<span class="go"> [60, 62, 64, 66, 68, 70, 72, 74, 76, 78],</span>
<span class="go"> [80, 82, 84, 86, 88, 90, 92, 94, 96, 98],</span>
<span class="go"> [100, 102, 104, 106, 108, 110, 112, 114, 116, 118],</span>
<span class="go"> [120, 122, 124, 126, 128, 130, 132, 134, 136, 138],</span>
<span class="go"> [140, 142, 144, 146, 148, 150, 152, 154, 156, 158],</span>
<span class="go"> [160, 162, 164, 166, 168, 170, 172, 174, 176, 178],</span>
<span class="go"> [180, 182, 184, 186, 188, 190, 192, 194, 196, 198]]</span>
</pre></div>
</div>
<p>而调用 <code class="docutils literal notranslate"><span class="pre">.apply_async</span></code> 则会创建一个独立任务，
从而在 worker 中应用这些单独的任务：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
</pre></div>
</div>
<p>你也可以将 chunks 转换为一个 group：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">group</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
</pre></div>
</div>
<p>然后使用 group 的 skew 方法为每个任务设置递增的 countdown：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">group</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">10</span><span class="p">)()</span>
</pre></div>
</div>
<p>这意味着第一个任务将在 1 秒后执行，第二个任务在 2 秒后，依此类推。</p>
</div>
<input class="tab-input" id="tab-set--16-input--2" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--2">英文</label><div class="tab-content docutils container">
<p>Chunking lets you divide an iterable of work into pieces, so that if
you have one million objects, you can create 10 tasks with a hundred
thousand objects each.</p>
<p>Some may worry that chunking your tasks results in a degradation
of parallelism, but this is rarely true for a busy cluster
and in practice since you're avoiding the overhead  of messaging
it may considerably increase performance.</p>
<p>To create a chunks' signature you can use <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.chunks" title="celery.app.task.Task.chunks"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.chunks()</span></code></a>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>As with <a class="reference internal" href="../reference/celery.html#celery.group" title="celery.group"><code class="xref py py-class docutils literal notranslate"><span class="pre">group</span></code></a> the act of sending the messages for
the chunks will happen in the current process when called:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">proj.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span> <span class="mi">10</span><span class="p">)()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="go">[[0, 2, 4, 6, 8, 10, 12, 14, 16, 18],</span>
<span class="go"> [20, 22, 24, 26, 28, 30, 32, 34, 36, 38],</span>
<span class="go"> [40, 42, 44, 46, 48, 50, 52, 54, 56, 58],</span>
<span class="go"> [60, 62, 64, 66, 68, 70, 72, 74, 76, 78],</span>
<span class="go"> [80, 82, 84, 86, 88, 90, 92, 94, 96, 98],</span>
<span class="go"> [100, 102, 104, 106, 108, 110, 112, 114, 116, 118],</span>
<span class="go"> [120, 122, 124, 126, 128, 130, 132, 134, 136, 138],</span>
<span class="go"> [140, 142, 144, 146, 148, 150, 152, 154, 156, 158],</span>
<span class="go"> [160, 162, 164, 166, 168, 170, 172, 174, 176, 178],</span>
<span class="go"> [180, 182, 184, 186, 188, 190, 192, 194, 196, 198]]</span>
</pre></div>
</div>
<p>while calling <code class="docutils literal notranslate"><span class="pre">.apply_async</span></code> will create a dedicated
task so that the individual tasks are applied in a worker
instead:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also convert chunks to a group:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">group</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">chunks</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)),</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
</pre></div>
</div>
<p>and with the group skew the countdown of each task by increments
of one:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">group</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="mi">10</span><span class="p">)()</span>
</pre></div>
</div>
<p>This means that the first task will have a countdown of one second, the second
task a countdown of two seconds, and so on.</p>
</div>
</div>
</section>
</section>
<section id="canvas-stamping">
<span id="id16"></span><h2>标记<a class="headerlink" href="#canvas-stamping" title="Link to this heading">¶</a></h2>
<p>Stamping</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--17-input--1" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.3.</span></p>
</div>
<p>Stamping API 的目标是提供为签名及其组成部分打标签的能力，
以便于调试信息的标注。
例如，在 canvas 是一个复杂结构时，可能需要为结构中的部分或全部元素打标签。
复杂性在展开嵌套 group 或替换 chain 元素时进一步增加。
在此类情况下，可能需要知道某个元素属于哪个 group 或它处于哪个嵌套层级。
这就需要一个遍历 canvas 元素并以特定元数据标注它们的机制。
Stamping API 允许基于 Visitor 模式实现这一功能。</p>
<p>例如：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sig1</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sig1_res</span> <span class="o">=</span> <span class="n">sig1</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">sig1</span><span class="p">,</span> <span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">stamp</span><span class="o">=</span><span class="s1">&#39;your_custom_stamp&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUT</span><span class="p">)</span>
<span class="go">[4, 6]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sig1_res</span><span class="o">.</span><span class="n">_get_task_meta</span><span class="p">()[</span><span class="s1">&#39;stamp&#39;</span><span class="p">]</span>
<span class="go">[&#39;your_custom_stamp&#39;]</span>
</pre></div>
</div>
<p>这将初始化一个 group <code class="docutils literal notranslate"><span class="pre">g</span></code>，并为其组件打上 <code class="docutils literal notranslate"><span class="pre">your_custom_stamp</span></code> 标签。</p>
<p>要使该功能生效，你需要将配置项 <a class="reference internal" href="configuration.html#std-setting-result_extended"><code class="xref std std-setting docutils literal notranslate"><span class="pre">result_extended</span></code></a> 设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code>，
或使用配置指令 <code class="docutils literal notranslate"><span class="pre">result_extended</span> <span class="pre">=</span> <span class="pre">True</span></code>。</p>
</div>
<input class="tab-input" id="tab-set--17-input--2" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.3.</span></p>
</div>
<p>The goal of the Stamping API is to give an ability to label
the signature and its components for debugging information purposes.
For example, when the canvas is a complex structure, it may be necessary to
label some or all elements of the formed structure. The complexity
increases even more when nested groups are rolled-out or chain
elements are replaced. In such cases, it may be necessary to
understand which group an element is a part of or on what nested
level it is. This requires a mechanism that traverses the canvas
elements and marks them with specific metadata. The stamping API
allows doing that based on the Visitor pattern.</p>
<p>For example,</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sig1</span> <span class="o">=</span> <span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sig1_res</span> <span class="o">=</span> <span class="n">sig1</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span> <span class="o">=</span> <span class="n">group</span><span class="p">(</span><span class="n">sig1</span><span class="p">,</span> <span class="n">add</span><span class="o">.</span><span class="n">si</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">g</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">stamp</span><span class="o">=</span><span class="s1">&#39;your_custom_stamp&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">apply_async</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUT</span><span class="p">)</span>
<span class="go">[4, 6]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sig1_res</span><span class="o">.</span><span class="n">_get_task_meta</span><span class="p">()[</span><span class="s1">&#39;stamp&#39;</span><span class="p">]</span>
<span class="go">[&#39;your_custom_stamp&#39;]</span>
</pre></div>
</div>
<p>will initialize a group <code class="docutils literal notranslate"><span class="pre">g</span></code> and mark its components with stamp <code class="docutils literal notranslate"><span class="pre">your_custom_stamp</span></code>.</p>
<p>For this feature to be useful, you need to set the <a class="reference internal" href="configuration.html#std-setting-result_extended"><code class="xref std std-setting docutils literal notranslate"><span class="pre">result_extended</span></code></a>
configuration option to <code class="docutils literal notranslate"><span class="pre">True</span></code> or directive <code class="docutils literal notranslate"><span class="pre">result_extended</span> <span class="pre">=</span> <span class="pre">True</span></code>.</p>
</div>
</div>
<section id="id17">
<h3>Canvas 标记<a class="headerlink" href="#id17" title="Link to this heading">¶</a></h3>
<p>Canvas stamping</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--18-input--1" name="tab-set--18" type="radio"><label class="tab-label" for="tab-set--18-input--1">中文</label><div class="tab-content docutils container">
<p>你还可以通过自定义 stamping 逻辑来标记 canvas，
方法是继承 visitor 类 <code class="docutils literal notranslate"><span class="pre">StampingVisitor</span></code> 以实现自定义 stamping visitor。</p>
</div>
<input class="tab-input" id="tab-set--18-input--2" name="tab-set--18" type="radio"><label class="tab-label" for="tab-set--18-input--2">英文</label><div class="tab-content docutils container">
<p>We can also stamp the canvas with custom stamping logic, using the visitor class <code class="docutils literal notranslate"><span class="pre">StampingVisitor</span></code>
as the base class for the custom stamping visitor.</p>
</div>
</div>
</section>
<section id="id18">
<h3>自定义标记<a class="headerlink" href="#id18" title="Link to this heading">¶</a></h3>
<p>Custom stamping</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--19-input--1" name="tab-set--19" type="radio"><label class="tab-label" for="tab-set--19-input--1">中文</label><div class="tab-content docutils container">
<p>如果需要更复杂的标记（stamping）逻辑，可以基于访问者模式（Visitor pattern）实现自定义标记行为。
实现此类自定义逻辑的类必须继承自 <code class="docutils literal notranslate"><span class="pre">StampingVisitor</span></code> 并实现相应的方法。</p>
<p>例如，下面这个名为 <code class="docutils literal notranslate"><span class="pre">InGroupVisitor</span></code> 的示例将会给某个 group 中的任务打上 <code class="docutils literal notranslate"><span class="pre">in_group</span></code> 的标签：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InGroupVisitor</span><span class="p">(</span><span class="n">StampingVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_group</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_group_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_group</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;in_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_group</span><span class="p">],</span> <span class="s2">&quot;stamped_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;in_group&quot;</span><span class="p">]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_group_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_group</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_chain_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;in_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_group</span><span class="p">],</span> <span class="s2">&quot;stamped_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;in_group&quot;</span><span class="p">]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;in_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_group</span><span class="p">],</span> <span class="s2">&quot;stamped_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;in_group&quot;</span><span class="p">]}</span>
</pre></div>
</div>
<p>下面是另一个自定义的标记访问器示例，它会给所有任务加上一个自定义的 <code class="docutils literal notranslate"><span class="pre">monitoring_id</span></code>。
这个 <code class="docutils literal notranslate"><span class="pre">monitoring_id</span></code> 可以代表外部监控系统中的 UUID 值，可用于通过包含此 ID 来追踪任务执行情况。
该 ID 可以是随机生成的 UUID，或是监控系统中的唯一 span ID 等标识符。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MonitoringIdStampingVisitor</span><span class="p">(</span><span class="n">StampingVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;monitoring_id&#39;</span><span class="p">:</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>在 <code class="docutils literal notranslate"><span class="pre">on_signature</span></code> （或任何其他访问器方法）中返回的 <code class="docutils literal notranslate"><span class="pre">stamped_headers</span></code> 键用于指定
应该打到任务上的 header。如果未指定此键，访问器会假设返回的字典中的所有键都是要标记的 header。</p>
<p>这意味着，下面的代码块行为等同于前面的示例。</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MonitoringIdStampingVisitor</span><span class="p">(</span><span class="n">StampingVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;monitoring_id&#39;</span><span class="p">:</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span> <span class="s1">&#39;stamped_headers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;monitoring_id&#39;</span><span class="p">]}</span>
</pre></div>
</div>
<p>接下来，我们看看如何使用 <code class="docutils literal notranslate"><span class="pre">MonitoringIdStampingVisitor</span></code> 示例访问器对不同的画布结构（canvas）进行打标：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sig_example</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">)</span>
<span class="n">sig_example</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="o">=</span><span class="n">MonitoringIdStampingVisitor</span><span class="p">())</span>

<span class="n">group_example</span> <span class="o">=</span> <span class="n">group</span><span class="p">([</span><span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">)])</span>
<span class="n">group_example</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="o">=</span><span class="n">MonitoringIdStampingVisitor</span><span class="p">())</span>

<span class="n">chord_example</span> <span class="o">=</span> <span class="n">chord</span><span class="p">([</span><span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">)],</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t3&#39;</span><span class="p">))</span>
<span class="n">chord_example</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="o">=</span><span class="n">MonitoringIdStampingVisitor</span><span class="p">())</span>

<span class="n">chain_example</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t3&#39;</span><span class="p">)),</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t4&#39;</span><span class="p">))</span>
<span class="n">chain_example</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="o">=</span><span class="n">MonitoringIdStampingVisitor</span><span class="p">())</span>
</pre></div>
</div>
<p>最后需要说明的是，上述示例中的每个任务会获得不同的 monitoring id。</p>
</div>
<input class="tab-input" id="tab-set--19-input--2" name="tab-set--19" type="radio"><label class="tab-label" for="tab-set--19-input--2">英文</label><div class="tab-content docutils container">
<p>If more complex stamping logic is required, it is possible
to implement custom stamping behavior based on the Visitor
pattern. The class that implements this custom logic must
inherit <code class="docutils literal notranslate"><span class="pre">StampingVisitor</span></code> and implement appropriate methods.</p>
<p>For example, the following example <code class="docutils literal notranslate"><span class="pre">InGroupVisitor</span></code> will label
tasks that are in side of some group by label <code class="docutils literal notranslate"><span class="pre">in_group</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InGroupVisitor</span><span class="p">(</span><span class="n">StampingVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_group</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_group_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_group</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;in_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_group</span><span class="p">],</span> <span class="s2">&quot;stamped_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;in_group&quot;</span><span class="p">]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_group_end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_group</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_chain_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;in_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_group</span><span class="p">],</span> <span class="s2">&quot;stamped_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;in_group&quot;</span><span class="p">]}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;in_group&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_group</span><span class="p">],</span> <span class="s2">&quot;stamped_headers&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;in_group&quot;</span><span class="p">]}</span>
</pre></div>
</div>
<p>The following example shows another custom stamping visitor, which labels all
tasks with a custom <code class="docutils literal notranslate"><span class="pre">monitoring_id</span></code> which can represent a UUID value of an external monitoring system,
that can be used to track the task execution by including the id with such a visitor implementation.
This <code class="docutils literal notranslate"><span class="pre">monitoring_id</span></code> can be a randomly generated UUID, or a unique identifier of the span id used by
the external monitoring system, etc.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MonitoringIdStampingVisitor</span><span class="p">(</span><span class="n">StampingVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;monitoring_id&#39;</span><span class="p">:</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The <code class="docutils literal notranslate"><span class="pre">stamped_headers</span></code> key returned in <code class="docutils literal notranslate"><span class="pre">on_signature</span></code> (or any other visitor method) is used to
specify the headers that will be stamped on the task. If this key is not specified, the stamping
visitor will assume all keys in the returned dictionary are the stamped headers from the visitor.</p>
<p>This means the following code block will result in the same behavior as the previous example.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MonitoringIdStampingVisitor</span><span class="p">(</span><span class="n">StampingVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;monitoring_id&#39;</span><span class="p">:</span> <span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span> <span class="s1">&#39;stamped_headers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;monitoring_id&#39;</span><span class="p">]}</span>
</pre></div>
</div>
<p>Next, let's see how to use the <code class="docutils literal notranslate"><span class="pre">MonitoringIdStampingVisitor</span></code> example stamping visitor.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sig_example</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">)</span>
<span class="n">sig_example</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="o">=</span><span class="n">MonitoringIdStampingVisitor</span><span class="p">())</span>

<span class="n">group_example</span> <span class="o">=</span> <span class="n">group</span><span class="p">([</span><span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">)])</span>
<span class="n">group_example</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="o">=</span><span class="n">MonitoringIdStampingVisitor</span><span class="p">())</span>

<span class="n">chord_example</span> <span class="o">=</span> <span class="n">chord</span><span class="p">([</span><span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">)],</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t3&#39;</span><span class="p">))</span>
<span class="n">chord_example</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="o">=</span><span class="n">MonitoringIdStampingVisitor</span><span class="p">())</span>

<span class="n">chain_example</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t1&#39;</span><span class="p">),</span> <span class="n">group</span><span class="p">(</span><span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t2&#39;</span><span class="p">),</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t3&#39;</span><span class="p">)),</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;t4&#39;</span><span class="p">))</span>
<span class="n">chain_example</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="o">=</span><span class="n">MonitoringIdStampingVisitor</span><span class="p">())</span>
</pre></div>
</div>
<p>Lastly, it's important to mention that each monitoring id stamp in the example above would be different from each other between tasks.</p>
</div>
</div>
</section>
<section id="id19">
<h3>回调函数标记<a class="headerlink" href="#id19" title="Link to this heading">¶</a></h3>
<p>Callbacks stamping</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--20-input--1" name="tab-set--20" type="radio"><label class="tab-label" for="tab-set--20-input--1">中文</label><div class="tab-content docutils container">
<p>标记 API 也支持对回调（callback）进行隐式标记。
这意味着当某个回调添加到任务上时，访问器也会应用到该回调上。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>回调必须在标记之前链接到签名（signature）上。</p>
</div>
<p>例如，下面是一个自定义标记访问器的定义：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CustomStampingVisitor</span><span class="p">(</span><span class="n">StampingVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;on_callback&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_errback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errback</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;on_errback&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</pre></div>
</div>
<p>这个自定义访问器将会对签名、回调和错误回调打上 <code class="docutils literal notranslate"><span class="pre">{'header':</span> <span class="pre">'value'}</span></code>，
并分别为回调和错误回调添加 <code class="docutils literal notranslate"><span class="pre">{'on_callback':</span> <span class="pre">True}</span></code> 与 <code class="docutils literal notranslate"><span class="pre">{'on_errback':</span> <span class="pre">True}</span></code>：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">chord</span><span class="p">([</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">xsum</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
<span class="n">callback</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;sig_link&#39;</span><span class="p">)</span>
<span class="n">errback</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;sig_link_error&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">link_error</span><span class="p">(</span><span class="n">errback</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="o">=</span><span class="n">CustomStampingVisitor</span><span class="p">())</span>
</pre></div>
</div>
<p>该示例的最终结果为：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;stamped_headers&#39;: [&#39;header&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;stamped_headers&#39;: [&#39;header&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;stamped_headers&#39;: [&#39;header&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;stamped_headers&#39;: [&#39;header&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;on_callback&#39;: True, &#39;stamped_headers&#39;: [&#39;header&#39;, &#39;on_callback&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;link_error&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;on_errback&#39;: True, &#39;stamped_headers&#39;: [&#39;header&#39;, &#39;on_errback&#39;]}</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--20-input--2" name="tab-set--20" type="radio"><label class="tab-label" for="tab-set--20-input--2">英文</label><div class="tab-content docutils container">
<p>The stamping API also supports stamping callbacks implicitly.
This means that when a callback is added to a task, the stamping
visitor will be applied to the callback as well.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>The callback must be linked to the signature before stamping.</p>
</div>
<p>For example, let's examine the following custom stamping visitor.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CustomStampingVisitor</span><span class="p">(</span><span class="n">StampingVisitor</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">**</span><span class="n">headers</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="s1">&#39;value&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;on_callback&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_errback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">errback</span><span class="p">,</span> <span class="o">**</span><span class="n">header</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;on_errback&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
</pre></div>
</div>
<p>This custom stamping visitor will stamp the signature, callbacks, and errbacks with <code class="docutils literal notranslate"><span class="pre">{'header':</span> <span class="pre">'value'}</span></code>
and stamp the callbacks and errbacks with <code class="docutils literal notranslate"><span class="pre">{'on_callback':</span> <span class="pre">True}</span></code> and <code class="docutils literal notranslate"><span class="pre">{'on_errback':</span> <span class="pre">True}</span></code> respectively as shown below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">chord</span><span class="p">([</span><span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">add</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="n">xsum</span><span class="o">.</span><span class="n">s</span><span class="p">())</span>
<span class="n">callback</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;sig_link&#39;</span><span class="p">)</span>
<span class="n">errback</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="s1">&#39;sig_link_error&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">link_error</span><span class="p">(</span><span class="n">errback</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">stamp</span><span class="p">(</span><span class="n">visitor</span><span class="o">=</span><span class="n">CustomStampingVisitor</span><span class="p">())</span>
</pre></div>
</div>
<p>This example will result in the following stamps:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;stamped_headers&#39;: [&#39;header&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;stamped_headers&#39;: [&#39;header&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;stamped_headers&#39;: [&#39;header&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;stamped_headers&#39;: [&#39;header&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;link&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;on_callback&#39;: True, &#39;stamped_headers&#39;: [&#39;header&#39;, &#39;on_callback&#39;]}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;link_error&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">options</span>
<span class="go">{&#39;header&#39;: &#39;value&#39;, &#39;on_errback&#39;: True, &#39;stamped_headers&#39;: [&#39;header&#39;, &#39;on_errback&#39;]}</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="workers.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Workers 指南</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="calling.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">调用任务/Tasks</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../copyright.html">Copyright</a> &#169; 2009-2023, Ask Solem &amp; contributors
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Canvas：设计工作流</a><ul>
<li><a class="reference internal" href="#canvas-signatures">签名</a><ul>
<li><a class="reference internal" href="#id2">部分代码</a></li>
<li><a class="reference internal" href="#id3">不变性</a></li>
<li><a class="reference internal" href="#canvas-callbacks">回调函数</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">原语</a><ul>
<li><a class="reference internal" href="#canvas-chain">链</a><ul>
<li><a class="reference internal" href="#id">任务 ID</a></li>
<li><a class="reference internal" href="#id7">图表</a></li>
</ul>
</li>
<li><a class="reference internal" href="#canvas-group">组</a><ul>
<li><a class="reference internal" href="#group-callbacks">组回调函数和错误处理</a></li>
<li><a class="reference internal" href="#group-results">组结果</a></li>
<li><a class="reference internal" href="#group-unrolling">组展开</a></li>
</ul>
</li>
<li><a class="reference internal" href="#canvas-chord">合集</a><ul>
<li><a class="reference internal" href="#chord-errors">错误处理</a></li>
<li><a class="reference internal" href="#chord-important-notes">重要说明</a></li>
</ul>
</li>
<li><a class="reference internal" href="#map-starmap">map 和 starmap</a></li>
<li><a class="reference internal" href="#canvas-chunks">数据块</a></li>
</ul>
</li>
<li><a class="reference internal" href="#canvas-stamping">标记</a><ul>
<li><a class="reference internal" href="#id17">Canvas 标记</a></li>
<li><a class="reference internal" href="#id18">自定义标记</a></li>
<li><a class="reference internal" href="#id19">回调函数标记</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=8156d91f"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3ee01567"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=5eb1bb1e"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    </body>
</html>