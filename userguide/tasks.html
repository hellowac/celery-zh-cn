<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="copyright" title="版权所有" href="../copyright.html" /><link rel="next" title="调用任务/Tasks" href="calling.html" /><link rel="prev" title="应用程序" href="application.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 8.2.3 and Furo 2024.08.06 -->
        <title>任务/Tasks - Celery 5.5.1 文档</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=3ee1c6c6" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../_static/my.css?v=112ca36d" />
    
    


<style>
  body {
    --color-code-background: #ffffff;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Celery 5.5.1 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/celery_512_1.png" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Celery 5.5.1 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">版权</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 has-children"><a class="reference internal" href="../getting-started/index.html">快速开始</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of 快速开始</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/introduction.html">Celery 简介</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../getting-started/backends-and-brokers/index.html">Backends 和 Brokers</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Backends 和 Brokers</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/rabbitmq.html">使用 RabbitMQ</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/redis.html">使用 Redis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/sqs.html">使用 Amazon SQS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/kafka.html">使用 Kafka</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/backends-and-brokers/gcpubsub.html">使用 Google Pub/Sub</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/first-steps-with-celery.html">使用 Celery 的第一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/next-steps.html">下一步</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/resources.html">资源</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">用户指南</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of 用户指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="application.html">应用程序</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="calling.html">调用任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="canvas.html">Canvas：设计工作流</a></li>
<li class="toctree-l2"><a class="reference internal" href="workers.html">Workers 指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="daemonizing.html">守护进程</a></li>
<li class="toctree-l2"><a class="reference internal" href="periodic-tasks.html">周期性任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="routing.html">路由任务/Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="monitoring.html">监控和管理指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="security.html">安全</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimizing.html">优化</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">调试</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="concurrency/index.html">并发</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of 并发</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="concurrency/eventlet.html">Eventlet 并发</a></li>
<li class="toctree-l3"><a class="reference internal" href="concurrency/gevent.html">gevent 并发</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="signals.html">信号</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">使用 Celery 进行测试</a></li>
<li class="toctree-l2"><a class="reference internal" href="extending.html">扩展 和 Bootsteps</a></li>
<li class="toctree-l2"><a class="reference internal" href="configuration.html">配置和默认值</a></li>
<li class="toctree-l2"><a class="reference internal" href="sphinx.html">使用 Sphinx 文档化任务</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../django/index.html">Django</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of Django</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../django/first-steps-with-django.html">使用 Django 的第一步</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community.html">社区资源</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials/index.html">教程</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 教程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/task-cookbook.html">Task Cookbook</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">更改历史</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">API 参考</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of API 参考</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/cli.html">命令行接口</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.html"><code class="xref py py-mod docutils literal notranslate"><span class="pre">celery</span></code> --- Distributed processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.html">Proxies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.html#functions">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.task.html"><code class="docutils literal notranslate"><span class="pre">celery.app.task</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.amqp.html">AMQP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.amqp.html#queues">Queues</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.defaults.html"><code class="docutils literal notranslate"><span class="pre">celery.app.defaults</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.control.html"><code class="docutils literal notranslate"><span class="pre">celery.app.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.registry.html"><code class="docutils literal notranslate"><span class="pre">celery.app.registry</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.backends.html"><code class="docutils literal notranslate"><span class="pre">celery.app.backends</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.builtins.html"><code class="docutils literal notranslate"><span class="pre">celery.app.builtins</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.events.html"><code class="docutils literal notranslate"><span class="pre">celery.app.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.log.html"><code class="docutils literal notranslate"><span class="pre">celery.app.log</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.app.utils</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.app.autoretry.html"><code class="docutils literal notranslate"><span class="pre">celery.app.autoretry</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bootsteps.html"><code class="docutils literal notranslate"><span class="pre">celery.bootsteps</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.result.html"><code class="docutils literal notranslate"><span class="pre">celery.result</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.schedules.html"><code class="docutils literal notranslate"><span class="pre">celery.schedules</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.signals.html"><code class="docutils literal notranslate"><span class="pre">celery.signals</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.security.html"><code class="docutils literal notranslate"><span class="pre">celery.security</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.utils.debug.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.debug</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.exceptions.html"><code class="docutils literal notranslate"><span class="pre">celery.exceptions</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.app.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.app</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.default.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.default</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.loaders.base.html"><code class="docutils literal notranslate"><span class="pre">celery.loaders.base</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html">States</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#sets">Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#misc">Misc</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.FAILURE"><code class="docutils literal notranslate"><span class="pre">FAILURE</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.PENDING"><code class="docutils literal notranslate"><span class="pre">PENDING</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.RECEIVED"><code class="docutils literal notranslate"><span class="pre">RECEIVED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.RETRY"><code class="docutils literal notranslate"><span class="pre">RETRY</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.REVOKED"><code class="docutils literal notranslate"><span class="pre">REVOKED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.STARTED"><code class="docutils literal notranslate"><span class="pre">STARTED</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.SUCCESS"><code class="docutils literal notranslate"><span class="pre">SUCCESS</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.precedence"><code class="docutils literal notranslate"><span class="pre">precedence()</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.states.html#celery.states.state"><code class="docutils literal notranslate"><span class="pre">state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.abortable.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.abortable</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.django.task.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.django.task</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.migrate.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.migrate</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.pytest.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.pytest</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.sphinx.html">celery.contrib.sphinx</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.app.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.app</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.manager.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.manager</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.testing.mocks.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.testing.mocks</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.contrib.rdb.html"><code class="docutils literal notranslate"><span class="pre">celery.contrib.rdb</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.html"><code class="docutils literal notranslate"><span class="pre">celery.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.receiver.html"><code class="docutils literal notranslate"><span class="pre">celery.events.receiver</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.dispatcher.html"><code class="docutils literal notranslate"><span class="pre">celery.events.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.event.html"><code class="docutils literal notranslate"><span class="pre">celery.events.event</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.events.state.html"><code class="docutils literal notranslate"><span class="pre">celery.events.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.apps.multi.html"><code class="docutils literal notranslate"><span class="pre">celery.apps.multi</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.request.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.request</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.state.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.state</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.strategy.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.strategy</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.agent.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.agent</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.connection.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.connection</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.consumer.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.consumer</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.control.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.events.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.gossip.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.gossip</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.heart.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.heart</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.mingle.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.mingle</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.consumer.tasks.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.consumer.tasks</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.worker.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.base.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.base</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.celery.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.celery</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.worker.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.worker</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.beat.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.beat</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.events.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.events</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.logtool.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.logtool</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.amqp.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.amqp</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.graph.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.graph</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.multi.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.multi</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.call.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.call</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.control.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.control</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.list.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.list</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.migrate.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.migrate</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.purge.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.purge</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.result.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.result</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.shell.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.shell</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/celery.bin.upgrade.html"><code class="docutils literal notranslate"><span class="pre">celery.bin.upgrade</span></code></a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../internals/index.html">内部</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of 内部</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../internals/guide.html">代码贡献指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/deprecation.html">Celery 弃用时间表</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/worker.html">内部的 worker</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/protocol.html">消息协议</a></li>
<li class="toctree-l2"><a class="reference internal" href="../internals/app-overview.html">“大实例”重构</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../internals/reference/index.html">内部模块参考</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 内部模块参考</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.components.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.components</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.loops.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.loops</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.heartbeat.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.heartbeat</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.control.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.control</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.pidbox.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.pidbox</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.worker.autoscale.html"><code class="docutils literal notranslate"><span class="pre">celery.worker.autoscale</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.solo.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.solo</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.prefork.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.prefork</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.eventlet.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.eventlet</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.gevent.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.gevent</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.thread.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.thread</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.concurrency.base.html"><code class="docutils literal notranslate"><span class="pre">celery.concurrency.base</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.html"><code class="docutils literal notranslate"><span class="pre">celery.backends</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.base.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.base</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.asynchronous.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.asynchronous</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.azureblockblob.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.azureblockblob</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.rpc.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.rpc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cache.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cache</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.consul.html">celery.backends.consul</a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.couchdb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.couchdb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.mongodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.mongodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.elasticsearch.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.elasticsearch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.redis.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.redis</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cassandra.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cassandra</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.couchbase.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.couchbase</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.arangodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.arangodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.dynamodb.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.dynamodb</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.filesystem.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.filesystem</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.cosmosdbsql.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.cosmosdbsql</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.s3.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.s3</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.gcs.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.gcs</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.trace.html"><code class="docutils literal notranslate"><span class="pre">celery.app.trace</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.annotations.html"><code class="docutils literal notranslate"><span class="pre">celery.app.annotations</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.app.routes.html"><code class="docutils literal notranslate"><span class="pre">celery.app.routes</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.certificate.html"><code class="docutils literal notranslate"><span class="pre">celery.security.certificate</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.key.html"><code class="docutils literal notranslate"><span class="pre">celery.security.key</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.serialization.html"><code class="docutils literal notranslate"><span class="pre">celery.security.serialization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.security.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.security.utils</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.snapshot.html"><code class="docutils literal notranslate"><span class="pre">celery.events.snapshot</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.cursesmon.html"><code class="docutils literal notranslate"><span class="pre">celery.events.cursesmon</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.events.dumper.html"><code class="docutils literal notranslate"><span class="pre">celery.events.dumper</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.models.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database.models</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.backends.database.session.html"><code class="docutils literal notranslate"><span class="pre">celery.backends.database.session</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.html"><code class="docutils literal notranslate"><span class="pre">celery.utils</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.abstract.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.abstract</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.collections.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.collections</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.nodenames.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.nodenames</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.deprecated.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.deprecated</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.functional.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.functional</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.graph.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.graph</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.objects.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.objects</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.term.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.term</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.time.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.time</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.iso8601.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.iso8601</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.saferepr.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.saferepr</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.serialization.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.serialization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.sysinfo.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.sysinfo</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.threads.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.threads</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.timer2.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.timer2</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.imports.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.imports</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.log.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.log</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.text.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.text</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.dispatch.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.dispatch</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.utils.dispatch.signal.html"><code class="docutils literal notranslate"><span class="pre">celery.utils.dispatch.signal</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery.platforms.html"><code class="docutils literal notranslate"><span class="pre">celery.platforms</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals/reference/celery._state.html"><code class="docutils literal notranslate"><span class="pre">celery._state</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../history/index.html">历史</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of 历史</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.5.html">What's new in Celery 5.5 (Immunity)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.5.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.4.html">What's new in Celery 5.4 (Opalescent)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.4.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.3.html">What's new in Celery 5.3 (Emerald Rush)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.3.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.1.html">What's new in Celery 5.1 (Sun Harmonics)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-5.0.html">What's new in Celery 5.0 (singularity)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-5.0.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.4.html">What's new in Celery 4.4 (Cliffs)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.4.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.3.html">What's new in Celery 4.3 (rhubarb)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.3.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.2.html">What's new in Celery 4.2 (windowlicker)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.2.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.1.html">What's new in Celery 4.1 (latentcall)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-4.0.html">What's new in Celery 4.0 (latentcall)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-4.0.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-3.1.html">What's new in Celery 3.1 (Cipater)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-3.1.html">Change history</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-3.0.html">What's new in Celery 3.0 (Chiastic Slide)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-3.0.html">Change history for Celery 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/whatsnew-2.5.html">What's new in Celery 2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.5.html">Change history for Celery 2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.4.html">Change history for Celery 2.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.3.html">Change history for Celery 2.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.2.html">Change history for Celery 2.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.1.html">Change history for Celery 2.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-2.0.html">Change history for Celery 2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="../history/changelog-1.0.html">Change history for Celery 1.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">术语</a></li>
</ul>

</div>
<!-- <iframe src="https://ghbtns.com/github-btn.html?user=celery&repo=celery&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe> -->
<div id="donate">
  <h5>捐赠</h5>
  <p>请捐赠以支持这个社区项目</p>
  <a href="https://opencollective.com/celery/donate" target="_blank">
    <!-- <img src="https://opencollective.com/celery/donate/button@2x.png?color=blue" /> -->
    <img src="https://opencollective.com/celery/donate/button.png?color=blue" />
  </a>
</div></div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="../_sources/userguide/tasks.rst.txt" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div>
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="tasks">
<span id="guide-tasks"></span><h1>任务/Tasks<a class="headerlink" href="#tasks" title="Link to this heading">¶</a></h1>
<p>Tasks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">中文</label><div class="tab-content docutils container">
<p>任务是 Celery 应用的构建模块。</p>
<p>任务是一个类，可以由任何可调用对象创建。它同时扮演双重角色：
既定义了调用任务时发生的行为（发送消息），也定义了 worker 接收到该消息后发生的行为。</p>
<p>每个任务类都有一个唯一的名称，该名称会在消息中被引用，
以便 worker 能够找到要执行的正确函数。</p>
<p>任务消息在被 worker <a class="reference internal" href="../glossary.html#term-acknowledged"><span class="xref std std-term">确认</span></a> 之前不会从队列中移除。
worker 可以提前预留多个消息，即使 worker 被杀死（如电源故障或其他原因），
消息也会被重新投递给另一个 worker。</p>
<p>理想情况下，任务函数应具备 <a class="reference internal" href="../glossary.html#term-idempotent"><span class="xref std std-term">幂等性</span></a>：即
即使以相同参数调用多次，也不会产生非预期的副作用。
由于 worker 无法检测你的任务是否幂等，默认行为是在任务执行前
立即确认消息，以避免已经开始执行的任务被再次执行。</p>
<p>如果你的任务是幂等的，可以设置 <a class="reference internal" href="#Task.acks_late" title="Task.acks_late"><code class="xref py py-attr docutils literal notranslate"><span class="pre">acks_late</span></code></a> 选项，
使 worker 在任务返回 <em>之后</em> 再确认消息。另见 FAQ 条目 <a class="reference internal" href="../faq.html#faq-acks-late-vs-retry"><span class="std std-ref">我应该使用 retry 还是 acks_late？</span></a>。</p>
<p>请注意，即使启用了 <a class="reference internal" href="#Task.acks_late" title="Task.acks_late"><code class="xref py py-attr docutils literal notranslate"><span class="pre">acks_late</span></code></a>，如果执行任务的子进程终止
（无论是任务调用了 <a class="reference external" href="https://docs.python.org/dev/library/sys.html#sys.exit" title="（在 Python v3.15）"><code class="xref py py-func docutils literal notranslate"><span class="pre">sys.exit()</span></code></a>，还是收到信号），worker 仍然会确认该消息。
此行为是有意为之，原因如下：</p>
<ol class="arabic simple">
<li><p>我们不希望重新执行那些导致内核发送 <code class="xref std std-sig docutils literal notranslate"><span class="pre">SIGSEGV</span></code> （段错误）或类似信号的任务。</p></li>
<li><p>我们假设系统管理员主动杀死任务，是不希望它自动重启。</p></li>
<li><p>占用大量内存的任务可能会触发内核的 OOM 杀手（Out-Of-Memory Killer），
同样的情况可能再次发生。</p></li>
<li><p>若任务在重新投递时总是失败，可能会造成高频消息循环，进而拖垮系统。</p></li>
</ol>
<p>如果你确实希望在上述情形下重新投递任务，可以考虑启用
<a class="reference internal" href="configuration.html#std-setting-task_reject_on_worker_lost"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_reject_on_worker_lost</span></code></a> 配置项。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>阻塞任务若无限期运行，最终可能导致 worker 实例无法处理其他任务。</p>
<p>如果你的任务涉及 I/O 操作，务必为这些操作添加超时，
比如使用 <a class="extlink-pypi reference external" href="https://pypi.org/project/requests/">https://pypi.org/project/requests/</a> 库进行 Web 请求时添加超时参数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">connect_timeout</span><span class="p">,</span> <span class="n">read_timeout</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">30.0</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="p">(</span><span class="n">connect_timeout</span><span class="p">,</span> <span class="n">read_timeout</span><span class="p">))</span>
</pre></div>
</div>
<p><a class="reference internal" href="workers.html#worker-time-limits"><span class="std std-ref">时间限制</span></a> 是确保所有任务及时返回的便捷手段，
但时间限制触发时会强制杀死进程，因此应仅用于那些尚未配置手动超时的场景。</p>
<p>在早期版本中，默认的 prefork 池调度器对长时间运行的任务不太友好，
因此如果你有运行数分钟或数小时的任务，建议在启动 <strong class="program">celery worker</strong> 时
启用命令行选项 <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-O"><code class="xref std std-option docutils literal notranslate"><span class="pre">-Ofair</span></code></a>。
不过，从 4.0 版本起，-Ofair 已成为默认调度策略。
参见 <a class="reference internal" href="optimizing.html#optimizing-prefetch-limit"><span class="std std-ref">预取限制</span></a> 以获取更多信息，
若需获得最佳性能，建议将长任务与短任务路由到专用的 worker 上
（参见 <a class="reference internal" href="routing.html#routing-automatic"><span class="std std-ref">自动路由</span></a>）。</p>
<p>如果你的 worker 出现挂起现象，请先调查哪些任务正在运行再提交问题，
因为挂起通常是某些任务在执行网络操作时阻塞所致。</p>
</div>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">英文</label><div class="tab-content docutils container">
<p>Tasks are the building blocks of Celery applications.</p>
<p>A task is a class that can be created out of any callable. It performs
dual roles in that it defines both what happens when a task is
called (sends a message), and what happens when a worker receives that message.</p>
<p>Every task class has a unique name, and this name is referenced in messages
so the worker can find the right function to execute.</p>
<p>A task message is not removed from the queue
until that message has been <a class="reference internal" href="../glossary.html#term-acknowledged"><span class="xref std std-term">acknowledged</span></a> by a worker. A worker can reserve
many messages in advance and even if the worker is killed -- by power failure
or some other reason -- the message will be redelivered to another worker.</p>
<p>Ideally task functions should be <a class="reference internal" href="../glossary.html#term-idempotent"><span class="xref std std-term">idempotent</span></a>: meaning
the function won't cause unintended effects even if called
multiple times with the same arguments.
Since the worker cannot detect if your tasks are idempotent, the default
behavior is to acknowledge the message in advance, just before it's executed,
so that a task invocation that already started is never executed again.</p>
<p>If your task is idempotent you can set the <a class="reference internal" href="#Task.acks_late" title="Task.acks_late"><code class="xref py py-attr docutils literal notranslate"><span class="pre">acks_late</span></code></a> option
to have the worker acknowledge the message <em>after</em> the task returns
instead. See also the FAQ entry <a class="reference internal" href="../faq.html#faq-acks-late-vs-retry"><span class="std std-ref">我应该使用 retry 还是 acks_late？</span></a>.</p>
<p>Note that the worker will acknowledge the message if the child process executing
the task is terminated (either by the task calling <a class="reference external" href="https://docs.python.org/dev/library/sys.html#sys.exit" title="（在 Python v3.15）"><code class="xref py py-func docutils literal notranslate"><span class="pre">sys.exit()</span></code></a>, or by signal)
even when <a class="reference internal" href="#Task.acks_late" title="Task.acks_late"><code class="xref py py-attr docutils literal notranslate"><span class="pre">acks_late</span></code></a> is enabled.  This behavior is intentional
as...</p>
<ol class="arabic simple">
<li><p>We don't want to rerun tasks that forces the kernel to send
a <code class="xref std std-sig docutils literal notranslate"><span class="pre">SIGSEGV</span></code> (segmentation fault) or similar signals to the process.</p></li>
<li><p>We assume that a system administrator deliberately killing the task
does not want it to automatically restart.</p></li>
<li><p>A task that allocates too much memory is in danger of triggering the kernel
OOM killer, the same may happen again.</p></li>
<li><p>A task that always fails when redelivered may cause a high-frequency
message loop taking down the system.</p></li>
</ol>
<p>If you really want a task to be redelivered in these scenarios you should
consider enabling the <a class="reference internal" href="configuration.html#std-setting-task_reject_on_worker_lost"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_reject_on_worker_lost</span></code></a> setting.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>A task that blocks indefinitely may eventually stop the worker instance
from doing any other work.</p>
<p>If your task does I/O then make sure you add timeouts to these operations,
like adding a timeout to a web request using the <a class="extlink-pypi reference external" href="https://pypi.org/project/requests/">https://pypi.org/project/requests/</a> library:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">connect_timeout</span><span class="p">,</span> <span class="n">read_timeout</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">30.0</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="p">(</span><span class="n">connect_timeout</span><span class="p">,</span> <span class="n">read_timeout</span><span class="p">))</span>
</pre></div>
</div>
<p><a class="reference internal" href="workers.html#worker-time-limits"><span class="std std-ref">Time limits</span></a> are convenient for making sure all
tasks return in a timely manner, but a time limit event will actually kill
the process by force so only use them to detect cases where you haven't
used manual timeouts yet.</p>
<p>In previous versions, the default prefork pool scheduler was not friendly
to long-running tasks, so if you had tasks that ran for minutes/hours, it
was advised to enable the <a class="reference internal" href="../reference/cli.html#cmdoption-celery-worker-O"><code class="xref std std-option docutils literal notranslate"><span class="pre">-Ofair</span></code></a> command-line
argument to the <strong class="program">celery worker</strong>. However, as of version 4.0,
-Ofair is now the default scheduling strategy. See <a class="reference internal" href="optimizing.html#optimizing-prefetch-limit"><span class="std std-ref">预取限制</span></a>
for more information, and for the best performance route long-running and
short-running tasks to dedicated workers (<a class="reference internal" href="routing.html#routing-automatic"><span class="std std-ref">自动路由</span></a>).</p>
<p>If your worker hangs then please investigate what tasks are running
before submitting an issue, as most likely the hanging is caused
by one or more tasks hanging on a network operation.</p>
</div>
</div>
</div>
<section id="task-basics">
<span id="id1"></span><h2>基础知识<a class="headerlink" href="#task-basics" title="Link to this heading">¶</a></h2>
<p>Basics</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">中文</label><div class="tab-content docutils container">
<p>你可以使用 <a class="reference internal" href="../reference/celery.html#celery.Celery.task" title="celery.Celery.task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.task()</span></code></a> 装饰器轻松地将任何可调用对象创建为一个任务：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<p>任务还可以设置多个 <a class="reference internal" href="#task-options"><span class="std std-ref">选项</span></a>，
这些选项可以作为参数传递给装饰器：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">英文</label><div class="tab-content docutils container">
<p>You can easily create a task from any callable by using
the <a class="reference internal" href="../reference/celery.html#celery.Celery.task" title="celery.Celery.task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.task()</span></code></a> decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
<p>There are also many <a class="reference internal" href="#task-options"><span class="std std-ref">options</span></a> that can be set for the task,
these can be specified as arguments to the decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">serializer</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="id2">
<h3>如何导入任务装饰器？<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p>How do I import the task decorator?</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">中文</label><div class="tab-content docutils container">
<p>任务装饰器是在你的 <a class="reference internal" href="../reference/celery.html#celery.Celery" title="celery.Celery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Celery</span></code></a> 应用实例上可用的，
如果你还不了解它，请先阅读 <a class="reference internal" href="../getting-started/first-steps-with-celery.html#first-steps"><span class="std std-ref">使用 Celery 的第一步</span></a>。</p>
<p>如果你在使用 Django（参见 <a class="reference internal" href="../django/first-steps-with-django.html#django-first-steps"><span class="std std-ref">使用 Django 的第一步</span></a>），
或者你是一个库的作者，那你很可能会想使用 <code class="xref py py-func docutils literal notranslate"><span class="pre">shared_task()</span></code> 装饰器：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">shared_task</span>

<span class="nd">@shared_task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">英文</label><div class="tab-content docutils container">
<p>The task decorator is available on your <a class="reference internal" href="../reference/celery.html#celery.Celery" title="celery.Celery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Celery</span></code></a> application instance,
if you don't know what this is then please read <a class="reference internal" href="../getting-started/first-steps-with-celery.html#first-steps"><span class="std std-ref">使用 Celery 的第一步</span></a>.</p>
<p>If you're using Django (see <a class="reference internal" href="../django/first-steps-with-django.html#django-first-steps"><span class="std std-ref">使用 Django 的第一步</span></a>), or you're the author
of a library then you probably want to use the <code class="xref py py-func docutils literal notranslate"><span class="pre">shared_task()</span></code> decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">shared_task</span>

<span class="nd">@shared_task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h3>多个装饰器<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<p>Multiple decorators</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">中文</label><div class="tab-content docutils container">
<p>当你将多个装饰器与任务装饰器组合使用时，
必须确保 <code class="docutils literal notranslate"><span class="pre">task</span></code> 装饰器是最后应用的
（奇怪的是，在 Python 中这意味着它必须出现在列表的最上方）：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="nd">@decorator2</span>
<span class="nd">@decorator1</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">英文</label><div class="tab-content docutils container">
<p>When using multiple decorators in combination with the task
decorator you must make sure that the <cite>task</cite>
decorator is applied last (oddly, in Python this means it must
be first in the list):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="nd">@decorator2</span>
<span class="nd">@decorator1</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h3>绑定任务<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h3>
<p>Bound tasks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">中文</label><div class="tab-content docutils container">
<p>一个任务被绑定（bound）意味着该任务的第一个参数
将始终是任务实例本身（ <code class="docutils literal notranslate"><span class="pre">self</span></code> ），
就像 Python 中绑定方法的行为一样：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>绑定任务在执行重试（通过 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a>）、
访问当前任务请求信息，以及你为自定义任务基类添加其他功能时是必须的。</p>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">英文</label><div class="tab-content docutils container">
<p>A task being bound means the first argument to the task will always
be the task instance (<code class="docutils literal notranslate"><span class="pre">self</span></code>), just like Python bound methods:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</pre></div>
</div>
<p>Bound tasks are needed for retries (using <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a>),
for accessing information about the current task request, and for any
additional functionality you add to custom task base classes.</p>
</div>
</div>
</section>
<section id="id5">
<h3>任务继承<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<p>Task inheritance</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--1">中文</label><div class="tab-content docutils container">
<p><code class="docutils literal notranslate"><span class="pre">base</span></code> 参数用于指定任务所继承的基类：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">celery</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyTask</span><span class="p">(</span><span class="n">celery</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">einfo</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0!r}</span><span class="s1"> failed: </span><span class="si">{1!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">MyTask</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--2">英文</label><div class="tab-content docutils container">
<p>The <code class="docutils literal notranslate"><span class="pre">base</span></code> argument to the task decorator specifies the base class of the task:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">celery</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyTask</span><span class="p">(</span><span class="n">celery</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">task_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">einfo</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0!r}</span><span class="s1"> failed: </span><span class="si">{1!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">exc</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">MyTask</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="task-names">
<span id="id6"></span><h2>名称<a class="headerlink" href="#task-names" title="Link to this heading">¶</a></h2>
<p>Names</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--1">中文</label><div class="tab-content docutils container">
<p>每个任务都必须拥有一个唯一的名称。</p>
<p>如果没有显式指定名称，任务装饰器会自动为你生成一个名称，
该名称基于以下两个因素：1）定义任务的模块名，2）任务函数的名称。</p>
<p>显式指定任务名称的示例：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sum-of-two-numbers&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;sum-of-two-numbers&#39;</span>
</pre></div>
</div>
<p>一个推荐的最佳实践是使用模块名作为命名空间，
这样可以避免任务名称在多个模块之间发生冲突：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tasks.add&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>你可以通过查看任务的 <code class="docutils literal notranslate"><span class="pre">.name</span></code> 属性来获取它的名称：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;tasks.add&#39;</span>
</pre></div>
</div>
<p>这里指定的名称（<code class="docutils literal notranslate"><span class="pre">tasks.add</span></code>）恰好是任务定义在名为
<code class="file docutils literal notranslate"><span class="pre">tasks.py</span></code> 的模块中时会自动生成的名称：</p>
<p><code class="file docutils literal notranslate"><span class="pre">tasks.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;tasks.add&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>你可以在 worker 中使用 <cite>inspect</cite> 命令查看所有已注册任务的名称。
参见用户指南中 <a class="reference internal" href="monitoring.html#monitoring-control"><span class="std std-ref">命令行管理实用程序（inspect/control）</span></a> 部分的 <cite>inspect registered</cite> 命令。</p>
</div>
</div>
<input class="tab-input" id="tab-set--6-input--2" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--2">英文</label><div class="tab-content docutils container">
<p>Every task must have a unique name.</p>
<p>If no explicit name is provided the task decorator will generate one for you,
and this name will be based on 1) the module the task is defined in, and 2)
the name of the task function.</p>
<p>Example setting explicit name:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sum-of-two-numbers&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;sum-of-two-numbers&#39;</span>
</pre></div>
</div>
<p>A best practice is to use the module name as a name-space,
this way names won't collide if there's already a task with that name
defined in another module.</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tasks.add&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>You can tell the name of the task by investigating its <code class="docutils literal notranslate"><span class="pre">.name</span></code> attribute:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;tasks.add&#39;</span>
</pre></div>
</div>
<p>The name we specified here (<code class="docutils literal notranslate"><span class="pre">tasks.add</span></code>) is exactly the name that would've
been automatically generated for us if the task was defined in a module
named <code class="file docutils literal notranslate"><span class="pre">tasks.py</span></code>:</p>
<p><code class="file docutils literal notranslate"><span class="pre">tasks.py</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">add</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;tasks.add&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>You can use the <cite>inspect</cite> command in a worker to view the names of
all registered tasks. See the <cite>inspect registered</cite> command in the
<a class="reference internal" href="monitoring.html#monitoring-control"><span class="std std-ref">命令行管理实用程序（inspect/control）</span></a> section of the User Guide.</p>
</div>
</div>
</div>
<section id="task-name-generator-info">
<span id="id7"></span><h3>更改自动命名行为<a class="headerlink" href="#task-name-generator-info" title="Link to this heading">¶</a></h3>
<p>Changing the automatic naming behavior</p>
<blockquote>
<div><div class="versionadded">
<p><span class="versionmodified added">Added in version 4.0.</span></p>
</div>
</div></blockquote>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--1">中文</label><div class="tab-content docutils container">
<p>在某些情况下，默认的自动命名方式并不适用。
设想你有许多任务分别定义在多个模块中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">project</span><span class="o">/</span>
       <span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
       <span class="o">/</span><span class="n">celery</span><span class="o">.</span><span class="n">py</span>
       <span class="o">/</span><span class="n">moduleA</span><span class="o">/</span>
               <span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
               <span class="o">/</span><span class="n">tasks</span><span class="o">.</span><span class="n">py</span>
       <span class="o">/</span><span class="n">moduleB</span><span class="o">/</span>
               <span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
               <span class="o">/</span><span class="n">tasks</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>使用默认自动命名时，每个任务会生成如下名称：
<cite>moduleA.tasks.taskA</cite>、<cite>moduleA.tasks.taskB</cite>、<cite>moduleB.tasks.test</cite>，等等。
你可能不希望所有任务名称中都包含 <cite>tasks</cite>。
如上所述，你可以显式为所有任务指定名称，
或者你也可以通过重写 <a class="reference internal" href="../reference/celery.html#celery.Celery.gen_task_name" title="celery.Celery.gen_task_name"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.gen_task_name()</span></code></a> 来更改自动命名行为。
继续以上示例，<cite>celery.py</cite> 中可能包含：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyCelery</span><span class="p">(</span><span class="n">Celery</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">gen_task_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tasks&#39;</span><span class="p">):</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">gen_task_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">MyCelery</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>这样，每个任务将拥有名称如 <cite>moduleA.taskA</cite>、<cite>moduleA.taskB</cite> 和 <cite>moduleB.test</cite>。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>请确保你的 <a class="reference internal" href="../reference/celery.html#celery.Celery.gen_task_name" title="celery.Celery.gen_task_name"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.gen_task_name()</span></code></a> 是纯函数：
即对于相同的输入，必须始终返回相同的输出。</p>
</div>
</div>
<input class="tab-input" id="tab-set--7-input--2" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--2">英文</label><div class="tab-content docutils container">
<p>There are some cases when the default automatic naming isn't suitable.
Consider having many tasks within many different modules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">project</span><span class="o">/</span>
       <span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
       <span class="o">/</span><span class="n">celery</span><span class="o">.</span><span class="n">py</span>
       <span class="o">/</span><span class="n">moduleA</span><span class="o">/</span>
               <span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
               <span class="o">/</span><span class="n">tasks</span><span class="o">.</span><span class="n">py</span>
       <span class="o">/</span><span class="n">moduleB</span><span class="o">/</span>
               <span class="o">/</span><span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
               <span class="o">/</span><span class="n">tasks</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Using the default automatic naming, each task will have a generated name
like <cite>moduleA.tasks.taskA</cite>, <cite>moduleA.tasks.taskB</cite>, <cite>moduleB.tasks.test</cite>,
and so on. You may want to get rid of having <cite>tasks</cite> in all task names.
As pointed above, you can explicitly give names for all tasks, or you
can change the automatic naming behavior by overriding
<a class="reference internal" href="../reference/celery.html#celery.Celery.gen_task_name" title="celery.Celery.gen_task_name"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.gen_task_name()</span></code></a>. Continuing with the example, <cite>celery.py</cite>
may contain:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyCelery</span><span class="p">(</span><span class="n">Celery</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">gen_task_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tasks&#39;</span><span class="p">):</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">gen_task_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">MyCelery</span><span class="p">(</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>So each task will have a name like <cite>moduleA.taskA</cite>, <cite>moduleA.taskB</cite> and
<cite>moduleB.test</cite>.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>Make sure that your <a class="reference internal" href="../reference/celery.html#celery.Celery.gen_task_name" title="celery.Celery.gen_task_name"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.gen_task_name()</span></code></a> is a pure function: meaning
that for the same input it must always return the same output.</p>
</div>
</div>
</div>
</section>
</section>
<section id="task-request-info">
<span id="id8"></span><h2>任务请求<a class="headerlink" href="#task-request-info" title="Link to this heading">¶</a></h2>
<p>Task Request</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.request" title="celery.app.task.Task.request"><code class="xref py py-attr docutils literal notranslate"><span class="pre">app.Task.request</span></code></a> 包含与当前执行的任务相关的信息与状态。</p>
<p>该请求对象定义了以下属性：</p>
<dl class="field-list simple">
<dt class="field-odd">id<span class="colon">:</span></dt>
<dd class="field-odd"><p>当前执行任务的唯一 ID。</p>
</dd>
<dt class="field-even">group<span class="colon">:</span></dt>
<dd class="field-even"><p>如果任务属于某个 <a class="reference internal" href="canvas.html#canvas-group"><span class="std std-ref">group</span></a>，则为该组的唯一 ID。</p>
</dd>
<dt class="field-odd">chord<span class="colon">:</span></dt>
<dd class="field-odd"><p>如果任务是某个 chord 的一部分（处于 header 中），则为该 chord 的唯一 ID。</p>
</dd>
<dt class="field-even">correlation_id<span class="colon">:</span></dt>
<dd class="field-even"><p>用于去重等用途的自定义 ID。</p>
</dd>
<dt class="field-odd">args<span class="colon">:</span></dt>
<dd class="field-odd"><p>位置参数。</p>
</dd>
<dt class="field-even">kwargs<span class="colon">:</span></dt>
<dd class="field-even"><p>关键字参数。</p>
</dd>
<dt class="field-odd">origin<span class="colon">:</span></dt>
<dd class="field-odd"><p>发送该任务的主机名。</p>
</dd>
<dt class="field-even">retries<span class="colon">:</span></dt>
<dd class="field-even"><p>当前任务已重试的次数，整数，初始值为 <cite>0</cite>。</p>
</dd>
<dt class="field-odd">is_eager<span class="colon">:</span></dt>
<dd class="field-odd"><p>若任务是在客户端本地执行而非由 worker 执行，则为 <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>。</p>
</dd>
<dt class="field-even">eta<span class="colon">:</span></dt>
<dd class="field-even"><p>任务的原始 ETA（若有）。为 UTC 时间（受 <a class="reference internal" href="configuration.html#std-setting-enable_utc"><code class="xref std std-setting docutils literal notranslate"><span class="pre">enable_utc</span></code></a> 设置影响）。</p>
</dd>
<dt class="field-odd">expires<span class="colon">:</span></dt>
<dd class="field-odd"><p>任务的原始过期时间（若有）。为 UTC 时间（受 <a class="reference internal" href="configuration.html#std-setting-enable_utc"><code class="xref std std-setting docutils literal notranslate"><span class="pre">enable_utc</span></code></a> 设置影响）。</p>
</dd>
<dt class="field-even">hostname<span class="colon">:</span></dt>
<dd class="field-even"><p>正在执行该任务的 worker 实例的节点名称。</p>
</dd>
<dt class="field-odd">delivery_info<span class="colon">:</span></dt>
<dd class="field-odd"><p>其他消息投递信息。为一个映射，包含用于投递该任务的 exchange 和 routing key。
例如 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a> 使用该信息将任务重新发送到相同的队列。
该字典中的键是否可用取决于所使用的消息代理。</p>
</dd>
<dt class="field-even">reply-to<span class="colon">:</span></dt>
<dd class="field-even"><p>回复应发送到的队列名称（例如用于 RPC 结果后端）。</p>
</dd>
<dt class="field-odd">called_directly<span class="colon">:</span></dt>
<dd class="field-odd"><p>如果任务不是由 worker 执行的，此标志将被设置为 True。</p>
</dd>
<dt class="field-even">timelimit<span class="colon">:</span></dt>
<dd class="field-even"><p>当前任务的 <code class="docutils literal notranslate"><span class="pre">(soft,</span> <span class="pre">hard)</span></code> 时间限制（如果有）。</p>
</dd>
<dt class="field-odd">callbacks<span class="colon">:</span></dt>
<dd class="field-odd"><p>任务成功返回时要调用的签名（signature）列表。</p>
</dd>
<dt class="field-even">errbacks<span class="colon">:</span></dt>
<dd class="field-even"><p>任务失败时要调用的签名列表。</p>
</dd>
<dt class="field-odd">utc<span class="colon">:</span></dt>
<dd class="field-odd"><p>若调用者启用了 UTC，则为 True（参见 <a class="reference internal" href="configuration.html#std-setting-enable_utc"><code class="xref std std-setting docutils literal notranslate"><span class="pre">enable_utc</span></code></a>）。</p>
</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.1.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">headers<span class="colon">:</span></dt>
<dd class="field-odd"><p>附带此任务消息发送的消息头映射（可能为 <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code>）。</p>
</dd>
<dt class="field-even">reply_to<span class="colon">:</span></dt>
<dd class="field-even"><p>要将回复发送到的位置（队列名称）。</p>
</dd>
<dt class="field-odd">correlation_id<span class="colon">:</span></dt>
<dd class="field-odd"><p>通常与任务 ID 相同，在 amqp 中常用于追踪回复对应的请求。</p>
</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.0.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">root_id<span class="colon">:</span></dt>
<dd class="field-odd"><p>当前任务所属工作流中的第一个任务的唯一 ID（如果存在）。</p>
</dd>
<dt class="field-even">parent_id<span class="colon">:</span></dt>
<dd class="field-even"><p>调用当前任务的父任务的唯一 ID（如果存在）。</p>
</dd>
<dt class="field-odd">chain<span class="colon">:</span></dt>
<dd class="field-odd"><p>构成任务链的任务列表（反转顺序，如果存在）。
该列表中的最后一个元素是当前任务完成后要接着执行的任务。
如果使用的是任务协议的第一版，链式任务将存在于 <code class="docutils literal notranslate"><span class="pre">request.callbacks</span></code> 中。</p>
</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.2.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">properties<span class="colon">:</span></dt>
<dd class="field-odd"><p>接收该任务消息时附带的消息属性映射（可能为 <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code> 或 <code class="xref py py-const docutils literal notranslate"><span class="pre">{}</span></code>）</p>
</dd>
<dt class="field-even">replaced_task_nesting<span class="colon">:</span></dt>
<dd class="field-even"><p>当前任务被替换的嵌套层级数（如果有，可能为 <code class="xref py py-const docutils literal notranslate"><span class="pre">0</span></code>）</p>
</dd>
</dl>
</div>
<input class="tab-input" id="tab-set--8-input--2" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--2">英文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.request" title="celery.app.task.Task.request"><code class="xref py py-attr docutils literal notranslate"><span class="pre">app.Task.request</span></code></a> contains information and state
related to the currently executing task.</p>
<p>The request defines the following attributes:</p>
<dl class="field-list simple">
<dt class="field-odd">id<span class="colon">:</span></dt>
<dd class="field-odd"><p>The unique id of the executing task.</p>
</dd>
<dt class="field-even">group<span class="colon">:</span></dt>
<dd class="field-even"><p>The unique id of the task's <a class="reference internal" href="canvas.html#canvas-group"><span class="std std-ref">group</span></a>, if this task is a member.</p>
</dd>
<dt class="field-odd">chord<span class="colon">:</span></dt>
<dd class="field-odd"><p>The unique id of the chord this task belongs to (if the task
is part of the header).</p>
</dd>
<dt class="field-even">correlation_id<span class="colon">:</span></dt>
<dd class="field-even"><p>Custom ID used for things like de-duplication.</p>
</dd>
<dt class="field-odd">args<span class="colon">:</span></dt>
<dd class="field-odd"><p>Positional arguments.</p>
</dd>
<dt class="field-even">kwargs<span class="colon">:</span></dt>
<dd class="field-even"><p>Keyword arguments.</p>
</dd>
<dt class="field-odd">origin<span class="colon">:</span></dt>
<dd class="field-odd"><p>Name of host that sent this task.</p>
</dd>
<dt class="field-even">retries<span class="colon">:</span></dt>
<dd class="field-even"><p>How many times the current task has been retried.
An integer starting at <cite>0</cite>.</p>
</dd>
<dt class="field-odd">is_eager<span class="colon">:</span></dt>
<dd class="field-odd"><p>Set to <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code> if the task is executed locally in
the client, not by a worker.</p>
</dd>
<dt class="field-even">eta<span class="colon">:</span></dt>
<dd class="field-even"><p>The original ETA of the task (if any).
This is in UTC time (depending on the <a class="reference internal" href="configuration.html#std-setting-enable_utc"><code class="xref std std-setting docutils literal notranslate"><span class="pre">enable_utc</span></code></a>
setting).</p>
</dd>
<dt class="field-odd">expires<span class="colon">:</span></dt>
<dd class="field-odd"><p>The original expiry time of the task (if any).
This is in UTC time (depending on the <a class="reference internal" href="configuration.html#std-setting-enable_utc"><code class="xref std std-setting docutils literal notranslate"><span class="pre">enable_utc</span></code></a>
setting).</p>
</dd>
<dt class="field-even">hostname<span class="colon">:</span></dt>
<dd class="field-even"><p>Node name of the worker instance executing the task.</p>
</dd>
<dt class="field-odd">delivery_info<span class="colon">:</span></dt>
<dd class="field-odd"><p>Additional message delivery information. This is a mapping
containing the exchange and routing key used to deliver this
task. Used by for example <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a>
to resend the task to the same destination queue.
Availability of keys in this dict depends on the
message broker used.</p>
</dd>
<dt class="field-even">reply-to<span class="colon">:</span></dt>
<dd class="field-even"><p>Name of queue to send replies back to (used with RPC result
backend for example).</p>
</dd>
<dt class="field-odd">called_directly<span class="colon">:</span></dt>
<dd class="field-odd"><p>This flag is set to true if the task wasn't
executed by the worker.</p>
</dd>
<dt class="field-even">timelimit<span class="colon">:</span></dt>
<dd class="field-even"><p>A tuple of the current <code class="docutils literal notranslate"><span class="pre">(soft,</span> <span class="pre">hard)</span></code> time limits active for
this task (if any).</p>
</dd>
<dt class="field-odd">callbacks<span class="colon">:</span></dt>
<dd class="field-odd"><p>A list of signatures to be called if this task returns successfully.</p>
</dd>
<dt class="field-even">errbacks<span class="colon">:</span></dt>
<dd class="field-even"><p>A list of signatures to be called if this task fails.</p>
</dd>
<dt class="field-odd">utc<span class="colon">:</span></dt>
<dd class="field-odd"><p>Set to true the caller has UTC enabled (<a class="reference internal" href="configuration.html#std-setting-enable_utc"><code class="xref std std-setting docutils literal notranslate"><span class="pre">enable_utc</span></code></a>).</p>
</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.1.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">headers<span class="colon">:</span></dt>
<dd class="field-odd"><p>Mapping of message headers sent with this task message
(may be <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code>).</p>
</dd>
<dt class="field-even">reply_to<span class="colon">:</span></dt>
<dd class="field-even"><p>Where to send reply to (queue name).</p>
</dd>
<dt class="field-odd">correlation_id<span class="colon">:</span></dt>
<dd class="field-odd"><p>Usually the same as the task id, often used in amqp
to keep track of what a reply is for.</p>
</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.0.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">root_id<span class="colon">:</span></dt>
<dd class="field-odd"><p>The unique id of the first task in the workflow this task
is part of (if any).</p>
</dd>
<dt class="field-even">parent_id<span class="colon">:</span></dt>
<dd class="field-even"><p>The unique id of the task that called this task (if any).</p>
</dd>
<dt class="field-odd">chain<span class="colon">:</span></dt>
<dd class="field-odd"><p>Reversed list of tasks that form a chain (if any).
The last item in this list will be the next task to succeed the
current task.  If using version one of the task protocol the chain
tasks will be in <code class="docutils literal notranslate"><span class="pre">request.callbacks</span></code> instead.</p>
</dd>
</dl>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.2.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">properties<span class="colon">:</span></dt>
<dd class="field-odd"><p>Mapping of message properties received with this task message
(may be <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code> or <code class="xref py py-const docutils literal notranslate"><span class="pre">{}</span></code>)</p>
</dd>
<dt class="field-even">replaced_task_nesting<span class="colon">:</span></dt>
<dd class="field-even"><p>How many times the task was replaced, if at all.
(may be <code class="xref py py-const docutils literal notranslate"><span class="pre">0</span></code>)</p>
</dd>
</dl>
</div>
</div>
<section id="id9">
<h3>示例<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h3>
<p>Example</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--1">中文</label><div class="tab-content docutils container">
<p>一个访问上下文信息的任务示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dump_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Executing task id </span><span class="si">{0.id}</span><span class="s1">, args: </span><span class="si">{0.args!r}</span><span class="s1"> kwargs: </span><span class="si">{0.kwargs!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<p><cite>bind</cite> 参数表示该函数将成为一个“绑定方法”，因此你可以访问任务类型实例上的属性和方法。</p>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--2">英文</label><div class="tab-content docutils container">
<p>An example task accessing information in the context is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">dump_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Executing task id </span><span class="si">{0.id}</span><span class="s1">, args: </span><span class="si">{0.args!r}</span><span class="s1"> kwargs: </span><span class="si">{0.kwargs!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">bind</span></code> argument means that the function will be a &quot;bound method&quot; so
that you can access attributes and methods on the task type instance.</p>
</div>
</div>
</section>
</section>
<section id="task-logging">
<span id="id10"></span><h2>日志记录<a class="headerlink" href="#task-logging" title="Link to this heading">¶</a></h2>
<p>Logging</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--1">中文</label><div class="tab-content docutils container">
<p>Worker 会自动为你配置日志记录，当然你也可以手动配置。</p>
<p>Celery 提供了一个名为 &quot;celery.task&quot; 的特殊日志记录器，你可以继承该日志记录器来自动在日志中包含任务名和唯一 ID。</p>
<p>最佳实践是在模块顶部为所有任务创建一个通用日志记录器：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.utils.log</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_task_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">{0}</span><span class="s1"> + </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>Celery 使用的是标准的 Python 日志库，相关文档可参见 <a class="reference external" href="https://docs.python.org/dev/library/logging.html#module-logging" title="（在 Python v3.15）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">这里</span></code></a>。</p>
<p>你也可以使用 <a class="reference external" href="https://docs.python.org/dev/library/functions.html#print" title="（在 Python v3.15）"><code class="xref py py-func docutils literal notranslate"><span class="pre">print()</span></code></a>，因为写入标准输出/错误的内容会被重定向到日志系统（你可以禁用此行为，参见  <a class="reference internal" href="configuration.html#std-setting-worker_redirect_stdouts"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_redirect_stdouts</span></code></a>）。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果你在任务或任务模块中创建日志记录器实例，worker 不会更新输出重定向设置。</p>
<p>如果你希望将 <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> 和 <code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code> 重定向到自定义日志记录器，你需要手动启用，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">old_outs</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="n">rlevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">worker_redirect_stdouts_level</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">redirect_stdouts_to_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">rlevel</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">{0}</span><span class="s1"> + </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">old_outs</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果你需要的某个 Celery 日志记录器没有输出日志，应该检查该记录器是否正确传播（propagate）。以下示例启用了 &quot;celery.app.trace&quot;，以便输出 &quot;succeeded in&quot; 之类的日志：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">celery</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="nd">@celery</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">after_setup_logger</span><span class="o">.</span><span class="n">connect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_after_setup_logger</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;celery&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;celery.app.trace&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果你希望完全禁用 Celery 的日志配置，可以使用 <a class="reference internal" href="signals.html#std-signal-setup_logging"><code class="xref std std-signal docutils literal notranslate"><span class="pre">setup_logging</span></code></a> 信号：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">celery</span>

<span class="nd">@celery</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">setup_logging</span><span class="o">.</span><span class="n">connect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_setup_logging</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--2">英文</label><div class="tab-content docutils container">
<p>The worker will automatically set up logging for you, or you can
configure logging manually.</p>
<p>A special logger is available named &quot;celery.task&quot;, you can inherit
from this logger to automatically get the task name and unique id as part
of the logs.</p>
<p>The best practice is to create a common logger
for all of your tasks at the top of your module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.utils.log</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_task_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">{0}</span><span class="s1"> + </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>Celery uses the standard Python logger library,
and the documentation can be found <a class="reference external" href="https://docs.python.org/dev/library/logging.html#module-logging" title="（在 Python v3.15）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">here</span></code></a>.</p>
<p>You can also use <a class="reference external" href="https://docs.python.org/dev/library/functions.html#print" title="（在 Python v3.15）"><code class="xref py py-func docutils literal notranslate"><span class="pre">print()</span></code></a>, as anything written to standard
out/-err will be redirected to the logging system (you can disable this,
see <a class="reference internal" href="configuration.html#std-setting-worker_redirect_stdouts"><code class="xref std std-setting docutils literal notranslate"><span class="pre">worker_redirect_stdouts</span></code></a>).</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The worker won't update the redirection if you create a logger instance
somewhere in your task or task module.</p>
<p>If you want to redirect <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> and <code class="docutils literal notranslate"><span class="pre">sys.stderr</span></code> to a custom
logger you have to enable this manually, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_task_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">old_outs</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
    <span class="n">rlevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">worker_redirect_stdouts_level</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">redirect_stdouts_to_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="n">rlevel</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding </span><span class="si">{0}</span><span class="s1"> + </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">old_outs</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>If a specific Celery logger you need is not emitting logs, you should
check that the logger is propagating properly. In this example
&quot;celery.app.trace&quot; is enabled so that &quot;succeeded in&quot; logs are emitted:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">celery</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="nd">@celery</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">after_setup_logger</span><span class="o">.</span><span class="n">connect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_after_setup_logger</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;celery&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;celery.app.trace&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>If you want to completely disable Celery logging configuration,
use the <a class="reference internal" href="signals.html#std-signal-setup_logging"><code class="xref std std-signal docutils literal notranslate"><span class="pre">setup_logging</span></code></a> signal:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">celery</span>

<span class="nd">@celery</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">setup_logging</span><span class="o">.</span><span class="n">connect</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_setup_logging</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
</div>
</div>
<section id="task-argument-checking">
<span id="id11"></span><h3>参数检查<a class="headerlink" href="#task-argument-checking" title="Link to this heading">¶</a></h3>
<p>Argument checking</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--11-input--1" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.0.</span></p>
</div>
<p>Celery 在你调用任务时会验证传入的参数，就像 Python 调用普通函数一样：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="gp">... </span><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="go"># 使用两个参数调用任务是可行的：</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="go">&lt;AsyncResult: f59d71ca-1549-43e0-be41-4e8821a83c0c&gt;</span>

<span class="go"># 仅使用一个参数调用任务则会报错：</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="gr">File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="gr">File &quot;celery/app/task.py&quot;, line 376, in delay</span>
<span class="gr">    return self.apply_async(args, kwargs)</span>
<span class="gr">File &quot;celery/app/task.py&quot;, line 485, in apply_async</span>
<span class="gr">    check_arguments(*(args or ()), **(kwargs or {}))</span>
<span class="gr">TypeError</span>: <span class="n">add() takes exactly 2 arguments (1 given)</span>
</pre></div>
</div>
<p>你可以通过将任务的 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.typing" title="celery.app.task.Task.typing"><code class="xref py py-attr docutils literal notranslate"><span class="pre">typing</span></code></a> 属性设置为 <code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code> 来禁用参数检查：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">typing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">... </span><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="go"># 在本地调用有效，但当 worker 接收到任务时会报错。</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="go">&lt;AsyncResult: f59d71ca-1549-43e0-be41-4e8821a83c0c&gt;</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--11-input--2" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.0.</span></p>
</div>
<p>Celery will verify the arguments passed when you call the task, just
like Python does when calling a normal function:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="gp">... </span><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="go"># Calling the task with two arguments works:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="go">&lt;AsyncResult: f59d71ca-1549-43e0-be41-4e8821a83c0c&gt;</span>

<span class="go"># Calling the task with only one argument fails:</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="gr">File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span>
<span class="gr">File &quot;celery/app/task.py&quot;, line 376, in delay</span>
<span class="gr">    return self.apply_async(args, kwargs)</span>
<span class="gr">File &quot;celery/app/task.py&quot;, line 485, in apply_async</span>
<span class="gr">    check_arguments(*(args or ()), **(kwargs or {}))</span>
<span class="gr">TypeError</span>: <span class="n">add() takes exactly 2 arguments (1 given)</span>
</pre></div>
</div>
<p>You can disable the argument checking for any task by setting its
<a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.typing" title="celery.app.task.Task.typing"><code class="xref py py-attr docutils literal notranslate"><span class="pre">typing</span></code></a> attribute to <code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code>:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">typing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">... </span><span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="go"># Works locally, but the worker receiving the task will raise an error.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="go">&lt;AsyncResult: f59d71ca-1549-43e0-be41-4e8821a83c0c&gt;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="task-hiding-sensitive-information">
<span id="id12"></span><h3>在参数中隐藏敏感信息<a class="headerlink" href="#task-hiding-sensitive-information" title="Link to this heading">¶</a></h3>
<p>Hiding sensitive information in arguments</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--12-input--1" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.0.</span></p>
</div>
<p>当使用 <a class="reference internal" href="configuration.html#std-setting-task_protocol"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_protocol</span></code></a> 为 2 或更高版本时（自 4.0 起默认），你可以通过 <cite>argsrepr</cite> 和 <cite>kwargsrepr</cite> 调用参数来自定义在日志和监控事件中位置参数和关键字参数的显示方式：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">argsrepr</span><span class="o">=</span><span class="s1">&#39;(&lt;secret-x&gt;, &lt;secret-y&gt;)&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">charge</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">card</span><span class="o">=</span><span class="s1">&#39;1234 5678 1234 5678&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">kwargsrepr</span><span class="o">=</span><span class="nb">repr</span><span class="p">({</span><span class="s1">&#39;card&#39;</span><span class="p">:</span> <span class="s1">&#39;**** **** **** 5678&#39;</span><span class="p">})</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>如果有人能够从消息代理（broker）读取任务消息，或以其他方式拦截消息，那么敏感信息仍然是可访问的。</p>
<p>因此，如果你的消息中包含敏感信息，建议对其进行加密；以信用卡号为例，实际号码应加密存储在安全存储中，并在任务中检索并解密。</p>
</div>
</div>
<input class="tab-input" id="tab-set--12-input--2" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.0.</span></p>
</div>
<p>When using <a class="reference internal" href="configuration.html#std-setting-task_protocol"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_protocol</span></code></a> 2 or higher (default since 4.0), you can
override how positional arguments and keyword arguments are represented in logs
and monitoring events using the <code class="docutils literal notranslate"><span class="pre">argsrepr</span></code> and <code class="docutils literal notranslate"><span class="pre">kwargsrepr</span></code> calling
arguments:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">add</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">argsrepr</span><span class="o">=</span><span class="s1">&#39;(&lt;secret-x&gt;, &lt;secret-y&gt;)&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">charge</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">card</span><span class="o">=</span><span class="s1">&#39;1234 5678 1234 5678&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">kwargsrepr</span><span class="o">=</span><span class="nb">repr</span><span class="p">({</span><span class="s1">&#39;card&#39;</span><span class="p">:</span> <span class="s1">&#39;**** **** **** 5678&#39;</span><span class="p">})</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>Sensitive information will still be accessible to anyone able
to read your task message from the broker, or otherwise able intercept it.</p>
<p>For this reason you should probably encrypt your message if it contains
sensitive information, or in this example with a credit card number
the actual number could be stored encrypted in a secure store that you retrieve
and decrypt in the task itself.</p>
</div>
</div>
</div>
</section>
</section>
<section id="task-retry">
<span id="id13"></span><h2>重试<a class="headerlink" href="#task-retry" title="Link to this heading">¶</a></h2>
<p>Retrying</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--13-input--1" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--1">中文</label><div class="tab-content docutils container">
<p>可以使用 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a> 方法重新执行任务，例如在遇到可恢复的错误时。</p>
<p>调用 <cite>retry</cite> 时会发送一条新消息，使用相同的 task-id，并确保该消息被投递到与原始任务相同的队列中。</p>
<p>任务重试也会被记录为一种任务状态，因此你可以通过结果实例跟踪任务进度（参见 <a class="reference internal" href="#task-states"><span class="std std-ref">状态</span></a>）。</p>
<p>下面是一个使用 <cite>retry</cite> 的示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">send_twitter_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oauth</span><span class="p">,</span> <span class="n">tweet</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">(</span><span class="n">oauth</span><span class="p">)</span>
        <span class="n">twitter</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Twitter</span><span class="o">.</span><span class="n">FailWhaleError</span><span class="p">,</span> <span class="n">Twitter</span><span class="o">.</span><span class="n">LoginError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a> 的调用会抛出一个异常，因此其后的代码不会被执行。该异常为 <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Retry" title="celery.exceptions.Retry"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Retry</span></code></a>，它不会被视为错误，而是一个“半谓词”，表示该任务应被重试，以便在启用了结果后端时记录正确的状态。</p>
<p>这是正常行为，除非将 <code class="docutils literal notranslate"><span class="pre">throw</span></code> 参数设置为 <code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code>，否则总会发生此行为。</p>
</div>
<p><cite>task</cite> 装饰器中的 <cite>bind</cite> 参数会使任务获得对 <cite>self</cite> （任务类型实例）的访问权限。</p>
<p><cite>exc</cite> 参数用于传递异常信息，该信息会被用于日志记录和存储任务结果。
异常及其回溯信息将在任务状态中可用（如果启用了结果后端）。</p>
<p>如果任务定义了 <cite>max_retries</cite> 值，在超过最大重试次数时会重新抛出当前异常，但在以下两种情况下不会抛出原始异常：</p>
<ul>
<li><p>未提供 <cite>exc</cite> 参数：</p>
<p>在这种情况下，将抛出 <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.MaxRetriesExceededError" title="celery.exceptions.MaxRetriesExceededError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">MaxRetriesExceededError</span></code></a> 异常。</p>
</li>
<li><p>当前没有异常可用：</p>
<p>如果没有原始异常可以重新抛出，则会使用 <cite>exc</cite> 参数作为替代，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">Twitter</span><span class="o">.</span><span class="n">LoginError</span><span class="p">())</span>
</pre></div>
</div>
<p>将会抛出提供的 <cite>exc</cite> 参数所指定的异常。</p>
</li>
</ul>
</div>
<input class="tab-input" id="tab-set--13-input--2" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--2">英文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a> can be used to re-execute the task,
for example in the event of recoverable errors.</p>
<p>When you call <code class="docutils literal notranslate"><span class="pre">retry</span></code> it'll send a new message, using the same
task-id, and it'll take care to make sure the message is delivered
to the same queue as the originating task.</p>
<p>When a task is retried this is also recorded as a task state,
so that you can track the progress of the task using the result
instance (see <a class="reference internal" href="#task-states"><span class="std std-ref">状态</span></a>).</p>
<p>Here's an example using <code class="docutils literal notranslate"><span class="pre">retry</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">send_twitter_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oauth</span><span class="p">,</span> <span class="n">tweet</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span> <span class="o">=</span> <span class="n">Twitter</span><span class="p">(</span><span class="n">oauth</span><span class="p">)</span>
        <span class="n">twitter</span><span class="o">.</span><span class="n">update_status</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">Twitter</span><span class="o">.</span><span class="n">FailWhaleError</span><span class="p">,</span> <span class="n">Twitter</span><span class="o">.</span><span class="n">LoginError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.Task.retry()</span></code></a> call will raise an exception so any
code after the retry won't be reached. This is the <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Retry" title="celery.exceptions.Retry"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Retry</span></code></a>
exception, it isn't handled as an error but rather as a semi-predicate
to signify to the worker that the task is to be retried,
so that it can store the correct state when a result backend is enabled.</p>
<p>This is normal operation and always happens unless the
<code class="docutils literal notranslate"><span class="pre">throw</span></code> argument to retry is set to <code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code>.</p>
</div>
<p>The bind argument to the task decorator will give access to <code class="docutils literal notranslate"><span class="pre">self</span></code> (the
task type instance).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">exc</span></code> argument is used to pass exception information that's
used in logs, and when storing task results.
Both the exception and the traceback will
be available in the task state (if a result backend is enabled).</p>
<p>If the task has a <code class="docutils literal notranslate"><span class="pre">max_retries</span></code> value the current exception
will be re-raised if the max number of retries has been exceeded,
but this won't happen if:</p>
<ul>
<li><p>An <code class="docutils literal notranslate"><span class="pre">exc</span></code> argument wasn't given.</p>
<p>In this case the <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.MaxRetriesExceededError" title="celery.exceptions.MaxRetriesExceededError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">MaxRetriesExceededError</span></code></a>
exception will be raised.</p>
</li>
<li><p>There's no current exception</p>
<p>If there's no original exception to re-raise the <code class="docutils literal notranslate"><span class="pre">exc</span></code>
argument will be used instead, so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">Twitter</span><span class="o">.</span><span class="n">LoginError</span><span class="p">())</span>
</pre></div>
</div>
<p>will raise the <code class="docutils literal notranslate"><span class="pre">exc</span></code> argument given.</p>
</li>
</ul>
</div>
</div>
<section id="task-retry-custom-delay">
<span id="id14"></span><h3>使用自定义重试延迟<a class="headerlink" href="#task-retry-custom-delay" title="Link to this heading">¶</a></h3>
<p>Using a custom retry delay</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--14-input--1" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--1">中文</label><div class="tab-content docutils container">
<p>当任务被重试时，可以在重试前等待一段时间，默认的延迟时间由 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.default_retry_delay" title="celery.app.task.Task.default_retry_delay"><code class="xref py py-attr docutils literal notranslate"><span class="pre">default_retry_delay</span></code></a> 属性定义。默认值为 3 分钟。请注意，该值的单位为秒（int 或 float）。</p>
<p>你也可以通过在调用 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">retry()</span></code></a> 时传入 <cite>countdown</cite> 参数来覆盖默认值。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_retry_delay</span><span class="o">=</span><span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># 30 分钟后重试。</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">something_raising</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="c1"># 覆盖默认延迟时间，设置为 1 分钟后重试</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--14-input--2" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--2">英文</label><div class="tab-content docutils container">
<p>When a task is to be retried, it can wait for a given amount of time
before doing so, and the default delay is defined by the
<a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.default_retry_delay" title="celery.app.task.Task.default_retry_delay"><code class="xref py py-attr docutils literal notranslate"><span class="pre">default_retry_delay</span></code></a>
attribute. By default this is set to 3 minutes. Note that the
unit for setting the delay is in seconds (int or float).</p>
<p>You can also provide the <cite>countdown</cite> argument to <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">retry()</span></code></a> to
override this default.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default_retry_delay</span><span class="o">=</span><span class="mi">30</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># retry in 30 minutes.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">something_raising</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="c1"># overrides the default delay to retry after 1 minute</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="task-autoretry">
<span id="id15"></span><h3>已知异常的自动重试<a class="headerlink" href="#task-autoretry" title="Link to this heading">¶</a></h3>
<p>Automatic retry for known exceptions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--15-input--1" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--1">中文</label><div class="tab-content docutils container">
<p>有时候你可能希望在遇到某个特定异常时自动重试任务。</p>
<p>幸运的是，你可以通过 <a class="reference internal" href="../reference/celery.html#celery.Celery.task" title="celery.Celery.task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.task()</span></code></a> 装饰器中的 <cite>autoretry_for</cite> 参数告诉 Celery 自动重试任务：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">twitter.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">FailWhaleError</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="n">FailWhaleError</span><span class="p">,))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">twitter</span><span class="o">.</span><span class="n">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
<p>如果你希望为内部的 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">retry()</span></code></a> 调用指定自定义参数，可以通过 <a class="reference internal" href="../reference/celery.html#celery.Celery.task" title="celery.Celery.task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.task()</span></code></a> 装饰器传递 <cite>retry_kwargs</cite> 参数：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="n">FailWhaleError</span><span class="p">,),</span>
        <span class="n">retry_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_retries&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">twitter</span><span class="o">.</span><span class="n">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
<p>这是一种替代手动处理异常的方法。上述示例等价于将任务主体包裹在 <a class="reference external" href="https://docs.python.org/dev/reference/compound_stmts.html#try" title="（在 Python v3.15）"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">try</span></code></a> ... <a class="reference external" href="https://docs.python.org/dev/reference/compound_stmts.html#except" title="（在 Python v3.15）"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">except</span></code></a> 语句中：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span><span class="o">.</span><span class="n">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">FailWhaleError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">refresh_timeline</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>如果你希望在任意错误发生时都自动重试，可以这样写：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.2.</span></p>
</div>
<p>如果你的任务依赖其他服务，例如向某个 API 发送请求，那么使用 <a class="reference external" href="https://en.wikipedia.org/wiki/Exponential_backoff">指数退避机制</a> 是个不错的选择，可以避免请求过多压垮服务。幸运的是，Celery 的自动重试机制对此提供了良好支持。只需指定 <a class="reference internal" href="#Task.retry_backoff" title="Task.retry_backoff"><code class="xref py py-attr docutils literal notranslate"><span class="pre">retry_backoff</span></code></a> 参数即可，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">requests.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestException</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="n">RequestException</span><span class="p">,),</span> <span class="n">retry_backoff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>默认情况下，该指数退避机制还会引入随机抖动（<a class="reference external" href="https://en.wikipedia.org/wiki/Jitter">jitter</a>），以避免所有任务同时运行。最大的退避延迟默认设置为 10 分钟。你可以根据下方文档说明对这些行为进行自定义。</p>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.4.</span></p>
</div>
<p>你也可以在基于类的任务中设置 <cite>autoretry_for</cite>、 <cite>max_retries</cite>、 <cite>retry_backoff</cite>、 <cite>retry_backoff_max</cite> 和 <cite>retry_jitter</cite> 等选项：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BaseTaskWithRetry</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">autoretry_for</span> <span class="o">=</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,)</span>
    <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">retry_backoff</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">retry_backoff_max</span> <span class="o">=</span> <span class="mi">700</span>
    <span class="n">retry_jitter</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<dl class="py attribute">
<dt class="sig sig-object py" id="Task.autoretry_for">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">autoretry_for</span></span><a class="headerlink" href="#Task.autoretry_for" title="Link to this definition">¶</a></dt>
<dd><p>异常类组成的列表或元组。如果任务在执行期间抛出了这些异常之一，则会自动重试。
默认情况下，不会对任何异常进行自动重试。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.max_retries">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">max_retries</span></span><a class="headerlink" href="#Task.max_retries" title="Link to this definition">¶</a></dt>
<dd><p>一个整数。表示放弃前的最大重试次数。设置为 <code class="docutils literal notranslate"><span class="pre">None</span></code> 表示无限重试。
默认值为 <code class="docutils literal notranslate"><span class="pre">3</span></code>。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.retry_backoff">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">retry_backoff</span></span><a class="headerlink" href="#Task.retry_backoff" title="Link to this definition">¶</a></dt>
<dd><p>布尔值或整数。如果设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code>，自动重试将遵循 <a class="reference external" href="https://en.wikipedia.org/wiki/Exponential_backoff">指数退避机制</a> 的规则。
第一次重试延迟 1 秒，第二次延迟 2 秒，第三次延迟 4 秒，第四次延迟 8 秒，以此类推。
（但该延迟值可能会受到 <a class="reference internal" href="#Task.retry_jitter" title="Task.retry_jitter"><code class="xref py py-attr docutils literal notranslate"><span class="pre">retry_jitter</span></code></a> 启用时的影响。）
如果设置为一个整数，则该值将作为延迟因子使用。例如，若设为 <code class="docutils literal notranslate"><span class="pre">3</span></code>，第一次重试延迟 3 秒，第二次为 6 秒，第三次为 12 秒，第四次为 24 秒，依此类推。
默认值为 <code class="docutils literal notranslate"><span class="pre">False</span></code>，即不启用重试延迟。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.retry_backoff_max">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">retry_backoff_max</span></span><a class="headerlink" href="#Task.retry_backoff_max" title="Link to this definition">¶</a></dt>
<dd><p>一个整数。如果启用了 <code class="docutils literal notranslate"><span class="pre">retry_backoff</span></code>，则该选项用于设置任务自动重试之间的最大延迟时间（单位：秒）。
默认值为 <code class="docutils literal notranslate"><span class="pre">600</span></code> （即 10 分钟）。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.retry_jitter">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">retry_jitter</span></span><a class="headerlink" href="#Task.retry_jitter" title="Link to this definition">¶</a></dt>
<dd><p>布尔值。<a class="reference external" href="https://en.wikipedia.org/wiki/Jitter">抖动（jitter）</a> 用于在指数退避延迟中引入随机性，以避免队列中的所有任务同时被调度执行。
如果设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code>，则由 <a class="reference internal" href="#Task.retry_backoff" title="Task.retry_backoff"><code class="xref py py-attr docutils literal notranslate"><span class="pre">retry_backoff</span></code></a> 计算出的延迟值将被视为最大值，实际延迟时间将在 0 到该最大值之间随机选取。
默认值为 <code class="docutils literal notranslate"><span class="pre">True</span></code>。</p>
</dd></dl>

<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.3.0.</span></p>
</div>
<dl class="py attribute">
<dt class="sig sig-object py" id="Task.dont_autoretry_for">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">dont_autoretry_for</span></span><a class="headerlink" href="#Task.dont_autoretry_for" title="Link to this definition">¶</a></dt>
<dd><p>异常类组成的列表或元组。指定的异常将不会触发自动重试。
这允许你从 <a class="reference internal" href="#Task.autoretry_for" title="Task.autoretry_for"><code class="xref py py-attr docutils literal notranslate"><span class="pre">autoretry_for</span></code></a> 中排除某些不希望自动重试的异常。</p>
</dd></dl>

</div>
<input class="tab-input" id="tab-set--15-input--2" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.0.</span></p>
</div>
<p>Sometimes you just want to retry a task whenever a particular exception
is raised.</p>
<p>Fortunately, you can tell Celery to automatically retry a task using
<cite>autoretry_for</cite> argument in the <a class="reference internal" href="../reference/celery.html#celery.Celery.task" title="celery.Celery.task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.task()</span></code></a> decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">twitter.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">FailWhaleError</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="n">FailWhaleError</span><span class="p">,))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">twitter</span><span class="o">.</span><span class="n">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to specify custom arguments for an internal <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">retry()</span></code></a>
call, pass <cite>retry_kwargs</cite> argument to <a class="reference internal" href="../reference/celery.html#celery.Celery.task" title="celery.Celery.task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.task()</span></code></a> decorator:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="n">FailWhaleError</span><span class="p">,),</span>
          <span class="n">retry_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;max_retries&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
<span class="k">def</span><span class="w"> </span><span class="nf">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">twitter</span><span class="o">.</span><span class="n">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>
<p>This is provided as an alternative to manually handling the exceptions,
and the example above will do the same as wrapping the task body
in a <a class="reference external" href="https://docs.python.org/dev/reference/compound_stmts.html#try" title="（在 Python v3.15）"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">try</span></code></a> ... <a class="reference external" href="https://docs.python.org/dev/reference/compound_stmts.html#except" title="（在 Python v3.15）"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">except</span></code></a> statement:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">twitter</span><span class="o">.</span><span class="n">refresh_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">FailWhaleError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">refresh_timeline</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to automatically retry on any error, simply use:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.2.</span></p>
</div>
<p>If your tasks depend on another service, like making a request to an API,
then it's a good idea to use <a class="reference external" href="https://en.wikipedia.org/wiki/Exponential_backoff">exponential backoff</a> to avoid overwhelming the
service with your requests. Fortunately, Celery's automatic retry support
makes it easy. Just specify the <a class="reference internal" href="#Task.retry_backoff" title="Task.retry_backoff"><code class="xref py py-attr docutils literal notranslate"><span class="pre">retry_backoff</span></code></a> argument, like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">requests.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestException</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">autoretry_for</span><span class="o">=</span><span class="p">(</span><span class="n">RequestException</span><span class="p">,),</span> <span class="n">retry_backoff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>By default, this exponential backoff will also introduce random <a class="reference external" href="https://en.wikipedia.org/wiki/Jitter">jitter</a> to
avoid having all the tasks run at the same moment. It will also cap the
maximum backoff delay to 10 minutes. All these settings can be customized
via options documented below.</p>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 4.4.</span></p>
</div>
<p>You can also set <cite>autoretry_for</cite>, <cite>max_retries</cite>, <cite>retry_backoff</cite>, <cite>retry_backoff_max</cite> and <cite>retry_jitter</cite> options in class-based tasks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BaseTaskWithRetry</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">autoretry_for</span> <span class="o">=</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,)</span>
    <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">retry_backoff</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">retry_backoff_max</span> <span class="o">=</span> <span class="mi">700</span>
    <span class="n">retry_jitter</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">autoretry_for</span></span></dt>
<dd><blockquote>
<div><p>A list/tuple of exception classes. If any of these exceptions are raised
during the execution of the task, the task will automatically be retried.
By default, no exceptions will be autoretried.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">max_retries</span></span></dt>
<dd><blockquote>
<div><p>A number. Maximum number of retries before giving up. A value of <code class="docutils literal notranslate"><span class="pre">None</span></code>
means task will retry forever. By default, this option is set to <code class="docutils literal notranslate"><span class="pre">3</span></code>.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">retry_backoff</span></span></dt>
<dd><blockquote>
<div><p>A boolean, or a number. If this option is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, autoretries
will be delayed following the rules of <a class="reference external" href="https://en.wikipedia.org/wiki/Exponential_backoff">exponential backoff</a>. The first
retry will have a delay of 1 second, the second retry will have a delay
of 2 seconds, the third will delay 4 seconds, the fourth will delay 8
seconds, and so on. (However, this delay value is modified by
<a class="reference internal" href="#Task.retry_jitter" title="Task.retry_jitter"><code class="xref py py-attr docutils literal notranslate"><span class="pre">retry_jitter</span></code></a>, if it is enabled.)
If this option is set to a number, it is used as a
delay factor. For example, if this option is set to <code class="docutils literal notranslate"><span class="pre">3</span></code>, the first retry
will delay 3 seconds, the second will delay 6 seconds, the third will
delay 12 seconds, the fourth will delay 24 seconds, and so on. By default,
this option is set to <code class="docutils literal notranslate"><span class="pre">False</span></code>, and autoretries will not be delayed.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">retry_backoff_max</span></span></dt>
<dd><blockquote>
<div><p>A number. If <code class="docutils literal notranslate"><span class="pre">retry_backoff</span></code> is enabled, this option will set a maximum
delay in seconds between task autoretries. By default, this option is set to <code class="docutils literal notranslate"><span class="pre">600</span></code>,
which is 10 minutes.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">retry_jitter</span></span></dt>
<dd><blockquote>
<div><p>A boolean. <a class="reference external" href="https://en.wikipedia.org/wiki/Jitter">Jitter</a> is used to introduce randomness into
exponential backoff delays, to prevent all tasks in the queue from being
executed simultaneously. If this option is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, the delay
value calculated by <a class="reference internal" href="#Task.retry_backoff" title="Task.retry_backoff"><code class="xref py py-attr docutils literal notranslate"><span class="pre">retry_backoff</span></code></a> is treated as a maximum,
and the actual delay value will be a random number between zero and that
maximum. By default, this option is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
</div></blockquote>
</dd></dl>

<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.3.0.</span></p>
</div>
<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">dont_autoretry_for</span></span></dt>
<dd><blockquote>
<div><p>A list/tuple of exception classes.  These exceptions won't be autoretried.
This allows to exclude some exceptions that match <a class="reference internal" href="#Task.autoretry_for" title="Task.autoretry_for"><code class="xref py py-attr docutils literal notranslate"><span class="pre">autoretry_for</span></code></a> but for which you don't want a retry.</p>
</div></blockquote>
</dd></dl>

</div>
</div>
</section>
</section>
<section id="pydantic">
<span id="task-pydantic"></span><h2>使用 Pydantic 进行参数验证<a class="headerlink" href="#pydantic" title="Link to this heading">¶</a></h2>
<p>Argument validation with Pydantic</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--16-input--1" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.5.0.</span></p>
</div>
<p>你可以通过传入 <code class="docutils literal notranslate"><span class="pre">pydantic=True</span></code> 来使用 <a class="reference external" href="https://docs.pydantic.dev/">Pydantic</a> 对参数进行校验与转换，
以及基于类型提示对返回结果进行序列化。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>参数校验仅涵盖任务端的参数和返回值。你在使用 <code class="docutils literal notranslate"><span class="pre">delay()</span></code> 或 <code class="docutils literal notranslate"><span class="pre">apply_async()</span></code>
调用任务时仍需自行序列化参数。</p>
</div>
<p>例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ArgModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ReturnModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">pydantic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">ArgModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnModel</span><span class="p">:</span>
    <span class="c1"># 使用 Pydantic 模型进行类型提示的参数会被自动转换</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ArgModel</span><span class="p">)</span>

    <span class="c1"># 返回的模型会被自动转换为字典</span>
    <span class="k">return</span> <span class="n">ReturnModel</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;example: </span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>随后，你可以使用一个符合模型的字典调用该任务，并获得经 <code class="docutils literal notranslate"><span class="pre">BaseModel.model_dump()</span></code>
序列化后的返回结果：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">delay</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">{&#39;value&#39;: &#39;example: 1&#39;}</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--16-input--2" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.5.0.</span></p>
</div>
<p>You can use <a class="reference external" href="https://docs.pydantic.dev/">Pydantic</a> to validate and convert arguments as well as serializing
results based on typehints by passing <code class="docutils literal notranslate"><span class="pre">pydantic=True</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Argument validation only covers arguments/return values on the task side. You still have
serialize arguments yourself when invoking a task with <code class="docutils literal notranslate"><span class="pre">delay()</span></code> or <code class="docutils literal notranslate"><span class="pre">apply_async()</span></code>.</p>
</div>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ArgModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ReturnModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">pydantic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">ArgModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReturnModel</span><span class="p">:</span>
    <span class="c1"># args/kwargs type hinted as Pydantic model will be converted</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">ArgModel</span><span class="p">)</span>

    <span class="c1"># The returned model will be converted to a dict automatically</span>
    <span class="k">return</span> <span class="n">ReturnModel</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;example: </span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The task can then be called using a dict matching the model, and you'll receive
the returned model &quot;dumped&quot; (serialized using <code class="docutils literal notranslate"><span class="pre">BaseModel.model_dump()</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">delay</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">{&#39;value&#39;: &#39;example: 1&#39;}</span>
</pre></div>
</div>
</div>
</div>
<section id="id17">
<h3>联合类型、泛型参数<a class="headerlink" href="#id17" title="Link to this heading">¶</a></h3>
<p>Union types, arguments to generics</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--17-input--1" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--1">中文</label><div class="tab-content docutils container">
<p>联合类型（例如 <code class="docutils literal notranslate"><span class="pre">Union[SomeModel,</span> <span class="pre">OtherModel]</span></code>）或用于泛型的参数类型（例如
<code class="docutils literal notranslate"><span class="pre">list[SomeModel]</span></code>） <strong>不</strong> 受支持。</p>
<p>如果你希望支持列表或类似类型，建议使用 <code class="docutils literal notranslate"><span class="pre">pydantic.RootModel</span></code>。</p>
</div>
<input class="tab-input" id="tab-set--17-input--2" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--2">英文</label><div class="tab-content docutils container">
<p>Union types (e.g. <code class="docutils literal notranslate"><span class="pre">Union[SomeModel,</span> <span class="pre">OtherModel]</span></code>) or arguments to generics (e.g.
<code class="docutils literal notranslate"><span class="pre">list[SomeModel]</span></code>) are <strong>not</strong> supported.</p>
<p>In case you want to support a list or similar types, it is recommended to use
<code class="docutils literal notranslate"><span class="pre">pydantic.RootModel</span></code>.</p>
</div>
</div>
</section>
<section id="id18">
<h3>可选参数/返回值<a class="headerlink" href="#id18" title="Link to this heading">¶</a></h3>
<p>Optional parameters/return values</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--18-input--1" name="tab-set--18" type="radio"><label class="tab-label" for="tab-set--18-input--1">中文</label><div class="tab-content docutils container">
<p>可选参数和可选返回值也会被正确处理。例如，给定如下任务：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="c1"># 模型与上方相同</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">pydantic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArgModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ReturnModel</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">ReturnModel</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;example: </span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>你将会获得如下行为：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">delay</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">{&#39;value&#39;: &#39;example: 1&#39;}</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--18-input--2" name="tab-set--18" type="radio"><label class="tab-label" for="tab-set--18-input--2">英文</label><div class="tab-content docutils container">
<p>Optional parameters or return values are also handled properly. For example, given this task:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="c1"># models are the same as above</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">pydantic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ArgModel</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ReturnModel</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">ReturnModel</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;example: </span><span class="si">{</span><span class="n">arg</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>You'll get the following behavior:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">delay</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="go">{&#39;value&#39;: &#39;example: 1&#39;}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id19">
<h3>返回值处理<a class="headerlink" href="#id19" title="Link to this heading">¶</a></h3>
<p>Return value handling</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--19-input--1" name="tab-set--19" type="radio"><label class="tab-label" for="tab-set--19-input--1">中文</label><div class="tab-content docutils container">
<p>只有当返回的模型实例与注解完全匹配时，返回值才会被序列化。如果你返回的是一个不同类型的模型实例，它将 <em>不会</em> 被序列化。 <code class="docutils literal notranslate"><span class="pre">mypy</span></code> 应该能够捕捉到这类错误，因此你应当据此修正类型提示。</p>
</div>
<input class="tab-input" id="tab-set--19-input--2" name="tab-set--19" type="radio"><label class="tab-label" for="tab-set--19-input--2">英文</label><div class="tab-content docutils container">
<p>Return values will only be serialized if the returned model matches the annotation. If you pass a
model instance of a different type, it will <em>not</em> be serialized. <code class="docutils literal notranslate"><span class="pre">mypy</span></code> should already catch such
errors and you should fix your typehints then.</p>
</div>
</div>
</section>
<section id="id20">
<h3>Pydantic 参数<a class="headerlink" href="#id20" title="Link to this heading">¶</a></h3>
<p>Pydantic parameters</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--20-input--1" name="tab-set--20" type="radio"><label class="tab-label" for="tab-set--20-input--1">中文</label><div class="tab-content docutils container">
<p>还有一些额外的选项可以影响 Pydantic 的行为：</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="Task.pydantic_strict">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">pydantic_strict</span></span><a class="headerlink" href="#Task.pydantic_strict" title="Link to this definition">¶</a></dt>
<dd><p>默认情况下， <a class="reference external" href="https://docs.pydantic.dev/dev/concepts/strict_mode/">strict mode</a>
是关闭的。你可以传入 <code class="docutils literal notranslate"><span class="pre">True</span></code> 以启用严格的模型校验。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.pydantic_context">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">pydantic_context</span></span><a class="headerlink" href="#Task.pydantic_context" title="Link to this definition">¶</a></dt>
<dd><p>在 Pydantic 模型校验过程中传入 <a class="reference external" href="https://docs.pydantic.dev/dev/concepts/validators/#validation-context">额外的校验上下文</a>。
默认情况下，上下文中已经包含了应用对象（ <code class="docutils literal notranslate"><span class="pre">celery_app</span></code> ）和任务名称（ <code class="docutils literal notranslate"><span class="pre">celery_task_name</span></code> ）。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.pydantic_dump_kwargs">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">pydantic_dump_kwargs</span></span><a class="headerlink" href="#Task.pydantic_dump_kwargs" title="Link to this definition">¶</a></dt>
<dd><p>在序列化结果时，将这些额外参数传递给 <code class="docutils literal notranslate"><span class="pre">dump_kwargs()</span></code>。默认情况下，仅传入 <code class="docutils literal notranslate"><span class="pre">mode='json'</span></code>。</p>
</dd></dl>

</div>
<input class="tab-input" id="tab-set--20-input--2" name="tab-set--20" type="radio"><label class="tab-label" for="tab-set--20-input--2">英文</label><div class="tab-content docutils container">
<p>There are a few more options influencing Pydantic behavior:</p>
<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">pydantic_strict</span></span></dt>
<dd><p>By default, <a class="reference external" href="https://docs.pydantic.dev/dev/concepts/strict_mode/">strict mode</a>
is disabled. You can pass <code class="docutils literal notranslate"><span class="pre">True</span></code> to enable strict model validation.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">pydantic_context</span></span></dt>
<dd><p>Pass <a class="reference external" href="https://docs.pydantic.dev/dev/concepts/validators/#validation-context">additional validation context</a> during
Pydantic model validation. The context already includes the application object as
<code class="docutils literal notranslate"><span class="pre">celery_app</span></code> and the task name as <code class="docutils literal notranslate"><span class="pre">celery_task_name</span></code> by default.</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">pydantic_dump_kwargs</span></span></dt>
<dd><p>When serializing a result, pass these additional arguments to <code class="docutils literal notranslate"><span class="pre">dump_kwargs()</span></code>.
By default, only <code class="docutils literal notranslate"><span class="pre">mode='json'</span></code> is passed.</p>
</dd></dl>

</div>
</div>
</section>
</section>
<section id="task-options">
<span id="id23"></span><h2>选项列表<a class="headerlink" href="#task-options" title="Link to this heading">¶</a></h2>
<p>List of Options</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--21-input--1" name="tab-set--21" type="radio"><label class="tab-label" for="tab-set--21-input--1">中文</label><div class="tab-content docutils container">
<p>任务装饰器可以接受多个选项，用以改变任务的行为。例如，你可以使用 <code class="xref py py-attr docutils literal notranslate"><span class="pre">rate_limit</span></code> 选项来设置任务的速率限制。</p>
<p>传递给任务装饰器的任意关键字参数，实际上都会被设为最终任务类的属性，以下是内置属性的列表。</p>
</div>
<input class="tab-input" id="tab-set--21-input--2" name="tab-set--21" type="radio"><label class="tab-label" for="tab-set--21-input--2">英文</label><div class="tab-content docutils container">
<p>The task decorator can take a number of options that change the way
the task behaves, for example you can set the rate limit for a task
using the <code class="xref py py-attr docutils literal notranslate"><span class="pre">rate_limit</span></code> option.</p>
<p>Any keyword argument passed to the task decorator will actually be set
as an attribute of the resulting task class, and this is a list
of the built-in attributes.</p>
</div>
</div>
<section id="task-general-options">
<span id="id24"></span><h3>常规<a class="headerlink" href="#task-general-options" title="Link to this heading">¶</a></h3>
<p>General</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--22-input--1" name="tab-set--22" type="radio"><label class="tab-label" for="tab-set--22-input--1">中文</label><div class="tab-content docutils container">
<dl class="py attribute">
<dt class="sig sig-object py" id="Task.name">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">name</span></span><a class="headerlink" href="#Task.name" title="Link to this definition">¶</a></dt>
<dd><p>任务的注册名称。</p>
<p>你可以手动设置该名称，或者默认会使用模块名和类名自动生成。</p>
<p>另见 <a class="reference internal" href="#task-names"><span class="std std-ref">名称</span></a>。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.request">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">request</span></span><a class="headerlink" href="#Task.request" title="Link to this definition">¶</a></dt>
<dd><p>如果任务正在被执行，该属性将包含当前请求的信息。该信息使用线程本地存储。</p>
<p>参见 <a class="reference internal" href="#task-request-info"><span class="std std-ref">任务请求</span></a>。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="id0">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">max_retries</span></span><a class="headerlink" href="#id0" title="Link to this definition">¶</a></dt>
<dd><p>仅在任务调用 <code class="docutils literal notranslate"><span class="pre">self.retry</span></code> 或装饰器使用了 <a class="reference internal" href="#task-autoretry"><span class="std std-ref">autoretry_for</span></a> 参数时适用。</p>
<p>表示在放弃之前最多允许重试的次数。
如果重试次数超过此值，则会引发 <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.MaxRetriesExceededError" title="celery.exceptions.MaxRetriesExceededError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">MaxRetriesExceededError</span></code></a> 异常。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>必须手动调用 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">retry()</span></code></a>，
它不会在异常发生时自动重试。</p>
</div>
<p>默认值为 <code class="docutils literal notranslate"><span class="pre">3</span></code>。
若设置为 <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code>，则表示禁用重试限制，任务将无限重试直到成功。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.throws">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">throws</span></span><a class="headerlink" href="#Task.throws" title="Link to this definition">¶</a></dt>
<dd><p>一个可选的异常类型元组，表示这些错误类型不应视为真正的错误。</p>
<p>属于该列表中的错误仍会被报告为任务失败（发送到结果后端），
但 worker 不会将其记录为错误，也不会包含 traceback。</p>
<p>示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">throws</span><span class="o">=</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">HttpNotFound</span><span class="p">)):</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_foo</span><span class="p">():</span>
    <span class="n">something</span><span class="p">()</span>
</pre></div>
</div>
<p>错误类型行为如下：</p>
<ul>
<li><p>预期错误（出现在 <code class="docutils literal notranslate"><span class="pre">Task.throws</span></code> 中）</p>
<blockquote>
<div><p>使用 <code class="docutils literal notranslate"><span class="pre">INFO</span></code> 等级记录日志，不包含 traceback。</p>
</div></blockquote>
</li>
<li><p>未预期错误</p>
<blockquote>
<div><p>使用 <code class="docutils literal notranslate"><span class="pre">ERROR</span></code> 等级记录日志，并包含 traceback。</p>
</div></blockquote>
</li>
</ul>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.default_retry_delay">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">default_retry_delay</span></span><a class="headerlink" href="#Task.default_retry_delay" title="Link to this definition">¶</a></dt>
<dd><p>重试前的默认等待时间（以秒为单位）。可以是 <a class="reference external" href="https://docs.python.org/dev/library/functions.html#int" title="（在 Python v3.15）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> 或 <a class="reference external" href="https://docs.python.org/dev/library/functions.html#float" title="（在 Python v3.15）"><code class="xref py py-class docutils literal notranslate"><span class="pre">float</span></code></a>。
默认值为三分钟。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.rate_limit">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">rate_limit</span></span><a class="headerlink" href="#Task.rate_limit" title="Link to this definition">¶</a></dt>
<dd><p>设置该任务类型的速率限制（即在特定时间段内允许运行的任务数量）。
即使启用了速率限制，任务仍然会完成，只是可能会被延迟启动。</p>
<p>如果设置为 <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code>，则不启用速率限制。
如果设置为整数或浮点数，则被解释为「每秒任务数」。</p>
<p>可通过附加 <cite>&quot;/s&quot;</cite>、<cite>&quot;/m&quot;</cite> 或 <cite>&quot;/h&quot;</cite> 来指定速率单位为秒、分钟或小时。
任务将在指定时间范围内均匀分布。</p>
<p>示例： <cite>&quot;100/m&quot;</cite> （每分钟最多 100 个任务）。这将强制两个任务之间至少间隔 600 毫秒。</p>
<p>默认值取自 <a class="reference internal" href="configuration.html#std-setting-task_default_rate_limit"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_default_rate_limit</span></code></a> 设置项：
若未设置，则默认不启用任务速率限制。</p>
<p>注意，该限制是 <em>每个 worker 实例</em> 的限制，而非全局限制。
若需实施全局速率限制（例如 API 请求的最大频率），应限制任务到特定队列中。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.time_limit">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">time_limit</span></span><a class="headerlink" href="#Task.time_limit" title="Link to this definition">¶</a></dt>
<dd><p>该任务的强制时间限制（以秒为单位）。
若未设置，则使用 worker 的默认值。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.soft_time_limit">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">soft_time_limit</span></span><a class="headerlink" href="#Task.soft_time_limit" title="Link to this definition">¶</a></dt>
<dd><p>该任务的软性时间限制。
若未设置，则使用 worker 的默认值。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.ignore_result">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">ignore_result</span></span><a class="headerlink" href="#Task.ignore_result" title="Link to this definition">¶</a></dt>
<dd><p>不存储任务状态。请注意，这意味着你无法使用
<a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult" title="celery.result.AsyncResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncResult</span></code></a> 来检查任务是否完成，
或获取其返回值。</p>
<p>注意：禁用任务结果存储会影响某些功能的使用。
更多详情请查阅 Canvas 文档。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.store_errors_even_if_ignored">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">store_errors_even_if_ignored</span></span><a class="headerlink" href="#Task.store_errors_even_if_ignored" title="Link to this definition">¶</a></dt>
<dd><p>若设置为 <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>，即使任务配置为忽略结果，错误也会被记录。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.serializer">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">serializer</span></span><a class="headerlink" href="#Task.serializer" title="Link to this definition">¶</a></dt>
<dd><p>指定默认使用的序列化方法（字符串形式）。默认为 <a class="reference internal" href="configuration.html#std-setting-task_serializer"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_serializer</span></code></a> 设置项的值。
可选值包括 <cite>pickle</cite>、<cite>json</cite>、<cite>yaml</cite>，或使用
<code class="xref py py-mod docutils literal notranslate"><span class="pre">kombu.serialization.registry</span></code> 注册的自定义序列化方法。</p>
<p>更多信息请参见 <a class="reference internal" href="calling.html#calling-serializers"><span class="std std-ref">序列化器</span></a>。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.compression">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">compression</span></span><a class="headerlink" href="#Task.compression" title="Link to this definition">¶</a></dt>
<dd><p>指定默认使用的压缩方案（字符串形式）。</p>
<p>默认为 <a class="reference internal" href="configuration.html#std-setting-task_compression"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_compression</span></code></a> 设置项的值。
可选值包括 <cite>gzip</cite>、<cite>bzip2</cite>，或使用 <a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.compression.html#module-kombu.compression" title="（在 Kombu v5.5）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">kombu.compression</span></code></a> 注册的自定义压缩方法。</p>
<p>更多信息请参见 <a class="reference internal" href="calling.html#calling-compression"><span class="std std-ref">压缩</span></a>。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.backend">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">backend</span></span><a class="headerlink" href="#Task.backend" title="Link to this definition">¶</a></dt>
<dd><p>指定该任务使用的结果存储后端。应为 <cite>celery.backends</cite> 中某个后端类的实例。
默认使用 <cite>app.backend</cite>，由 <a class="reference internal" href="configuration.html#std-setting-result_backend"><code class="xref std std-setting docutils literal notranslate"><span class="pre">result_backend</span></code></a> 设置项定义。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="Task.acks_late">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">acks_late</span></span><a class="headerlink" href="#Task.acks_late" title="Link to this definition">¶</a></dt>
<dd><p>若设置为 <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>，该任务的消息将在任务执行**之后**被确认；
而默认行为是在任务开始执行前确认消息。</p>
<p>注意：这意味着如果 worker 在执行中崩溃，任务可能会被多次执行。
因此确保你的任务是 <a class="reference internal" href="../glossary.html#term-idempotent"><span class="xref std std-term">idempotent</span></a> 的至关重要。</p>
<p>全局默认值可通过 <a class="reference internal" href="configuration.html#std-setting-task_acks_late"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_acks_late</span></code></a> 设置项覆盖。</p>
</dd></dl>

<dl class="py attribute" id="task-track-started">
<dt class="sig sig-object py" id="Task.track_started">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">track_started</span></span><a class="headerlink" href="#Task.track_started" title="Link to this definition">¶</a></dt>
<dd><p>若设置为 <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>，任务在被 worker 执行时会报告其状态为 &quot;started&quot;。
默认值为 <code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code>，即任务状态仅包括 pending、finished 或 waiting-to-retry。
对于长时间运行的任务，该状态有助于报告当前运行的任务。</p>
<p>执行该任务的 worker 的主机名与进程 ID 会包含在状态元数据中（如：<cite>result.info['pid']</cite>）。</p>
<p>全局默认值可通过 <a class="reference internal" href="configuration.html#std-setting-task_track_started"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_track_started</span></code></a> 设置项覆盖。</p>
</dd></dl>

<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task" title="celery.app.task.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">Task</span></code></a> 的 API 参考文档。</p>
</div>
</div>
<input class="tab-input" id="tab-set--22-input--2" name="tab-set--22" type="radio"><label class="tab-label" for="tab-set--22-input--2">英文</label><div class="tab-content docutils container">
<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">name</span></span></dt>
<dd><blockquote>
<div><p>The name the task is registered as.</p>
<p>You can set this name manually, or a name will be
automatically generated using the module and class name.</p>
<p>See also <a class="reference internal" href="#task-names"><span class="std std-ref">名称</span></a>.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">request</span></span></dt>
<dd><blockquote>
<div><p>If the task is being executed this will contain information
about the current request. Thread local storage is used.</p>
<p>See <a class="reference internal" href="#task-request-info"><span class="std std-ref">任务请求</span></a>.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">max_retries</span></span></dt>
<dd><blockquote>
<div><p>Only applies if the task calls <code class="docutils literal notranslate"><span class="pre">self.retry</span></code> or if the task is decorated
with the <a class="reference internal" href="#task-autoretry"><span class="std std-ref">autoretry_for</span></a> argument.</p>
<p>The maximum number of attempted retries before giving up.
If the number of retries exceeds this value a <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.MaxRetriesExceededError" title="celery.exceptions.MaxRetriesExceededError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">MaxRetriesExceededError</span></code></a>
exception will be raised.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>You have to call <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">retry()</span></code></a>
manually, as it won't automatically retry on exception..</p>
</div>
<p>The default is <code class="docutils literal notranslate"><span class="pre">3</span></code>.
A value of <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code> will disable the retry limit and the
task will retry forever until it succeeds.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">throws</span></span></dt>
<dd><blockquote>
<div><p>Optional tuple of expected error classes that shouldn't be regarded
as an actual error.</p>
<p>Errors in this list will be reported as a failure to the result backend,
but the worker won't log the event as an error, and no traceback will
be included.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@task</span><span class="p">(</span><span class="n">throws</span><span class="o">=</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">HttpNotFound</span><span class="p">)):</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_foo</span><span class="p">():</span>
    <span class="n">something</span><span class="p">()</span>
</pre></div>
</div>
<p>Error types:</p>
<ul>
<li><p>Expected errors (in <code class="docutils literal notranslate"><span class="pre">Task.throws</span></code>)</p>
<blockquote>
<div><p>Logged with severity <code class="docutils literal notranslate"><span class="pre">INFO</span></code>, traceback excluded.</p>
</div></blockquote>
</li>
<li><p>Unexpected errors</p>
<blockquote>
<div><p>Logged with severity <code class="docutils literal notranslate"><span class="pre">ERROR</span></code>, with traceback included.</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">default_retry_delay</span></span></dt>
<dd><blockquote>
<div><p>Default time in seconds before a retry of the task
should be executed. Can be either <a class="reference external" href="https://docs.python.org/dev/library/functions.html#int" title="（在 Python v3.15）"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> or <a class="reference external" href="https://docs.python.org/dev/library/functions.html#float" title="（在 Python v3.15）"><code class="xref py py-class docutils literal notranslate"><span class="pre">float</span></code></a>.
Default is a three minute delay.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">rate_limit</span></span></dt>
<dd><blockquote>
<div><p>Set the rate limit for this task type (limits the number of tasks
that can be run in a given time frame). Tasks will still complete when
a rate limit is in effect, but it may take some time before it's allowed to
start.</p>
<p>If this is <code class="xref py py-const docutils literal notranslate"><span class="pre">None</span></code> no rate limit is in effect.
If it is an integer or float, it is interpreted as &quot;tasks per second&quot;.</p>
<p>The rate limits can be specified in seconds, minutes or hours
by appending <cite>&quot;/s&quot;</cite>, <cite>&quot;/m&quot;</cite> or <cite>&quot;/h&quot;</cite> to the value. Tasks will be evenly
distributed over the specified time frame.</p>
<p>Example: <cite>&quot;100/m&quot;</cite> (hundred tasks a minute). This will enforce a minimum
delay of 600ms between starting two tasks on the same worker instance.</p>
<p>Default is the <a class="reference internal" href="configuration.html#std-setting-task_default_rate_limit"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_default_rate_limit</span></code></a> setting:
if not specified means rate limiting for tasks is disabled by default.</p>
<p>Note that this is a <em>per worker instance</em> rate limit, and not a global
rate limit. To enforce a global rate limit (e.g., for an API with a
maximum number of  requests per second), you must restrict to a given
queue.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">time_limit</span></span></dt>
<dd><blockquote>
<div><p>The hard time limit, in seconds, for this task.
When not set the workers default is used.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">soft_time_limit</span></span></dt>
<dd><blockquote>
<div><p>The soft time limit for this task.
When not set the workers default is used.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">ignore_result</span></span></dt>
<dd><blockquote>
<div><p>Don't store task state. Note that this means you can't use
<a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult" title="celery.result.AsyncResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncResult</span></code></a> to check if the task is ready,
or get its return value.</p>
<p>Note: Certain features will not work if task results are disabled.
For more details check the Canvas documentation.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">store_errors_even_if_ignored</span></span></dt>
<dd><blockquote>
<div><p>If <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code>, errors will be stored even if the task is configured
to ignore results.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">serializer</span></span></dt>
<dd><blockquote>
<div><p>A string identifying the default serialization
method to use. Defaults to the <a class="reference internal" href="configuration.html#std-setting-task_serializer"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_serializer</span></code></a>
setting. Can be <cite>pickle</cite>, <cite>json</cite>, <cite>yaml</cite>, or any custom
serialization methods that have been registered with
<code class="xref py py-mod docutils literal notranslate"><span class="pre">kombu.serialization.registry</span></code>.</p>
<p>Please see <a class="reference internal" href="calling.html#calling-serializers"><span class="std std-ref">序列化器</span></a> for more information.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">compression</span></span></dt>
<dd><blockquote>
<div><p>A string identifying the default compression scheme to use.</p>
<p>Defaults to the <a class="reference internal" href="configuration.html#std-setting-task_compression"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_compression</span></code></a> setting.
Can be <cite>gzip</cite>, or <cite>bzip2</cite>, or any custom compression schemes
that have been registered with the <a class="reference external" href="https://docs.celeryq.dev/projects/kombu/en/main/reference/kombu.compression.html#module-kombu.compression" title="（在 Kombu v5.5）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">kombu.compression</span></code></a> registry.</p>
<p>Please see <a class="reference internal" href="calling.html#calling-compression"><span class="std std-ref">压缩</span></a> for more information.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">backend</span></span></dt>
<dd><blockquote>
<div><p>The result store backend to use for this task. An instance of one of the
backend classes in <cite>celery.backends</cite>. Defaults to <cite>app.backend</cite>,
defined by the <a class="reference internal" href="configuration.html#std-setting-result_backend"><code class="xref std std-setting docutils literal notranslate"><span class="pre">result_backend</span></code></a> setting.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">acks_late</span></span></dt>
<dd><blockquote>
<div><p>If set to <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code> messages for this task will be acknowledged
<strong>after</strong> the task has been executed, not <em>just before</em> (the default
behavior).</p>
<p>Note: This means the task may be executed multiple times should the worker
crash in the middle of execution.  Make sure your tasks are
<a class="reference internal" href="../glossary.html#term-idempotent"><span class="xref std std-term">idempotent</span></a>.</p>
<p>The global default can be overridden by the <a class="reference internal" href="configuration.html#std-setting-task_acks_late"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_acks_late</span></code></a>
setting.</p>
</div></blockquote>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">Task.</span></span><span class="sig-name descname"><span class="pre">track_started</span></span></dt>
<dd><blockquote>
<div><p>If <code class="xref py py-const docutils literal notranslate"><span class="pre">True</span></code> the task will report its status as &quot;started&quot;
when the task is executed by a worker.
The default value is <code class="xref py py-const docutils literal notranslate"><span class="pre">False</span></code> as the normal behavior is to not
report that level of granularity. Tasks are either pending, finished,
or waiting to be retried. Having a &quot;started&quot; status can be useful for
when there are long running tasks and there's a need to report what
task is currently running.</p>
<p>The host name and process id of the worker executing the task
will be available in the state meta-data (e.g., <cite>result.info['pid']</cite>)</p>
<p>The global default can be overridden by the
<a class="reference internal" href="configuration.html#std-setting-task_track_started"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_track_started</span></code></a> setting.</p>
</div></blockquote>
</dd></dl>

<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p>The API reference for <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task" title="celery.app.task.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">Task</span></code></a>.</p>
</div>
</div>
</div>
</section>
</section>
<section id="task-states">
<span id="id25"></span><h2>状态<a class="headerlink" href="#task-states" title="Link to this heading">¶</a></h2>
<p>States</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--23-input--1" name="tab-set--23" type="radio"><label class="tab-label" for="tab-set--23-input--1">中文</label><div class="tab-content docutils container">
<p>Celery 可以跟踪任务的当前状态。状态信息中还包含了
成功任务的返回结果，或者失败任务的异常与回溯（traceback）信息。</p>
<p>Celery 提供了多种 <em>结果后端</em> （result backend）供选择，
每种后端都有其各自的优缺点（参见 <a class="reference internal" href="#task-result-backends"><span class="std std-ref">结果后端</span></a>）。</p>
<p>在任务的生命周期中，它将经历多个可能的状态变迁，
且每个状态都可以附加任意的元数据（meta-data）。
当任务进入一个新的状态时，之前的状态将被遗忘，
但某些状态变迁可以被推断出来（例如，
如果一个任务当前处于 <code class="xref std std-state docutils literal notranslate"><span class="pre">FAILED</span></code> 状态，
可以推断出它之前曾处于 <a class="reference internal" href="#std-state-STARTED"><code class="xref std std-state docutils literal notranslate"><span class="pre">STARTED</span></code></a> 状态）。</p>
<p>同时，Celery 还定义了一些状态集合，
比如 <code class="xref std std-state docutils literal notranslate"><span class="pre">FAILURE_STATES</span></code> 集合和 <a class="reference internal" href="../reference/celery.states.html#std-state-READY_STATES"><code class="xref std std-state docutils literal notranslate"><span class="pre">READY_STATES</span></code></a> 集合。</p>
<p>客户端可以通过判断任务状态是否属于这些集合来决定后续行为，
例如，是否需要重新抛出异常（如果任务状态属于 <a class="reference internal" href="../reference/celery.states.html#std-state-PROPAGATE_STATES"><code class="xref std std-state docutils literal notranslate"><span class="pre">PROPAGATE_STATES</span></code></a>），
或者是否可以缓存该任务状态（如果任务已准备就绪，则可以缓存）。</p>
<p>此外，你也可以定义 <a class="reference internal" href="#custom-states"><span class="std std-ref">自定义状态</span></a> 来扩展状态管理。</p>
</div>
<input class="tab-input" id="tab-set--23-input--2" name="tab-set--23" type="radio"><label class="tab-label" for="tab-set--23-input--2">英文</label><div class="tab-content docutils container">
<p>Celery can keep track of the tasks current state. The state also contains the
result of a successful task, or the exception and traceback information of a
failed task.</p>
<p>There are several <em>result backends</em> to choose from, and they all have
different strengths and weaknesses (see <a class="reference internal" href="#task-result-backends"><span class="std std-ref">结果后端</span></a>).</p>
<p>During its lifetime a task will transition through several possible states,
and each state may have arbitrary meta-data attached to it. When a task
moves into a new state the previous state is
forgotten about, but some transitions can be deduced, (e.g., a task now
in the <code class="xref std std-state docutils literal notranslate"><span class="pre">FAILED</span></code> state, is implied to have been in the
<a class="reference internal" href="#std-state-STARTED"><code class="xref std std-state docutils literal notranslate"><span class="pre">STARTED</span></code></a> state at some point).</p>
<p>There are also sets of states, like the set of
<code class="xref std std-state docutils literal notranslate"><span class="pre">FAILURE_STATES</span></code>, and the set of <a class="reference internal" href="../reference/celery.states.html#std-state-READY_STATES"><code class="xref std std-state docutils literal notranslate"><span class="pre">READY_STATES</span></code></a>.</p>
<p>The client uses the membership of these sets to decide whether
the exception should be re-raised (<a class="reference internal" href="../reference/celery.states.html#std-state-PROPAGATE_STATES"><code class="xref std std-state docutils literal notranslate"><span class="pre">PROPAGATE_STATES</span></code></a>), or whether
the state can be cached (it can if the task is ready).</p>
<p>You can also define <a class="reference internal" href="#custom-states"><span class="std std-ref">自定义状态</span></a>.</p>
</div>
</div>
<section id="task-result-backends">
<span id="id26"></span><h3>结果后端<a class="headerlink" href="#task-result-backends" title="Link to this heading">¶</a></h3>
<p>Result Backends</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--24-input--1" name="tab-set--24" type="radio"><label class="tab-label" for="tab-set--24-input--1">中文</label><div class="tab-content docutils container">
<p>如果你希望跟踪任务或需要获取返回值，那么 Celery 必须将状态存储或发送到某个地方，以便之后能够检索。
Celery 提供了多种内置的结果后端供选择：SQLAlchemy/Django ORM、Memcached、RabbitMQ/QPid（<code class="docutils literal notranslate"><span class="pre">rpc</span></code>）和 Redis —— 当然你也可以自定义自己的后端。</p>
<p>没有任何一个后端能在所有使用场景中都表现良好。
你应当了解每种后端的优缺点，并根据自己的需求选择最合适的方案。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>后端在存储和传输结果时会占用资源。为了确保资源能够及时释放，
你必须在调用任务之后，对每一个返回的 <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult" title="celery.result.AsyncResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncResult</span></code></a> 实例，
最终调用一次 <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult.get" title="celery.result.AsyncResult.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get()</span></code></a> 或 <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult.forget" title="celery.result.AsyncResult.forget"><code class="xref py py-meth docutils literal notranslate"><span class="pre">forget()</span></code></a> 方法。</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="configuration.html#conf-result-backend"><span class="std std-ref">任务结果后端设置</span></a></p>
</div>
</div>
<input class="tab-input" id="tab-set--24-input--2" name="tab-set--24" type="radio"><label class="tab-label" for="tab-set--24-input--2">英文</label><div class="tab-content docutils container">
<p>If you want to keep track of tasks or need the return values, then Celery
must store or send the states somewhere so that they can be retrieved later.
There are several built-in result backends to choose from: SQLAlchemy/Django ORM,
Memcached, RabbitMQ/QPid (<code class="docutils literal notranslate"><span class="pre">rpc</span></code>), and Redis -- or you can define your own.</p>
<p>No backend works well for every use case.
You should read about the strengths and weaknesses of each backend, and choose
the most appropriate for your needs.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>Backends use resources to store and transmit results. To ensure
that resources are released, you must eventually call
<a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult.get" title="celery.result.AsyncResult.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get()</span></code></a> or <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult.forget" title="celery.result.AsyncResult.forget"><code class="xref py py-meth docutils literal notranslate"><span class="pre">forget()</span></code></a> on
EVERY <a class="reference internal" href="../reference/celery.result.html#celery.result.AsyncResult" title="celery.result.AsyncResult"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncResult</span></code></a> instance returned after calling
a task.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="configuration.html#conf-result-backend"><span class="std std-ref">任务结果后端设置</span></a></p>
</div>
</div>
</div>
<section id="rpc-rabbitmq-qpid">
<h4>RPC 结果后端 (RabbitMQ/QPid)<a class="headerlink" href="#rpc-rabbitmq-qpid" title="Link to this heading">¶</a></h4>
<p>RPC Result Backend (RabbitMQ/QPid)</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--25-input--1" name="tab-set--25" type="radio"><label class="tab-label" for="tab-set--25-input--1">中文</label><div class="tab-content docutils container">
<p>RPC 结果后端（ <code class="docutils literal notranslate"><span class="pre">rpc://</span></code> ）比较特殊，因为它实际上并不 <em>存储</em> 状态，
而是将其作为消息发送出去。这一点非常重要，因为它意味着：</p>
<ul class="simple">
<li><p>一个结果 <em>只能被检索一次</em>。</p></li>
<li><p><em>只能由发起该任务的客户端</em> 进行检索。</p></li>
</ul>
<p>两个不同的进程无法同时等待同一个结果。</p>
<p>尽管有这些限制，如果你需要实时接收状态变更信息，RPC 后端依然是一个非常优秀的选择。
使用消息传递机制意味着客户端无需轮询即可接收新状态。</p>
<p>默认情况下，消息是瞬时（非持久化）的，因此如果代理（broker）重启，结果将会丢失。
你可以通过设置 <a class="reference internal" href="configuration.html#std-setting-result_persistent"><code class="xref std std-setting docutils literal notranslate"><span class="pre">result_persistent</span></code></a> 来配置后端发送持久化消息。</p>
</div>
<input class="tab-input" id="tab-set--25-input--2" name="tab-set--25" type="radio"><label class="tab-label" for="tab-set--25-input--2">英文</label><div class="tab-content docutils container">
<p>The RPC result backend (<cite>rpc://</cite>) is special as it doesn't actually <em>store</em>
the states, but rather sends them as messages. This is an important difference as it
means that a result <em>can only be retrieved once</em>, and <em>only by the client
that initiated the task</em>. Two different processes can't wait for the same result.</p>
<p>Even with that limitation, it is an excellent choice if you need to receive
state changes in real-time. Using messaging means the client doesn't have to
poll for new states.</p>
<p>The messages are transient (non-persistent) by default, so the results will
disappear if the broker restarts. You can configure the result backend to send
persistent messages using the <a class="reference internal" href="configuration.html#std-setting-result_persistent"><code class="xref std std-setting docutils literal notranslate"><span class="pre">result_persistent</span></code></a> setting.</p>
</div>
</div>
</section>
<section id="id27">
<h4>数据库结果后端<a class="headerlink" href="#id27" title="Link to this heading">¶</a></h4>
<p>Database Result Backend</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--26-input--1" name="tab-set--26" type="radio"><label class="tab-label" for="tab-set--26-input--1">中文</label><div class="tab-content docutils container">
<p>将状态存储在数据库中对许多人来说非常方便，特别是当已有数据库基础设施（例如 Web 应用）时，
但这种方式也存在一些局限性：</p>
<ul>
<li><p>轮询数据库以获取新状态的代价很高，因此你应当增加操作的轮询间隔，比如在调用 <cite>result.get()</cite> 时。</p></li>
<li><p>有些数据库的默认事务隔离级别并不适合用于轮询数据表以检测变化。</p>
<p>以 MySQL 为例，其默认的事务隔离级别是 <cite>REPEATABLE-READ</cite>：
这意味着在当前事务提交之前，该事务无法看到其他事务所做的更改。</p>
<p>因此，推荐将事务隔离级别修改为 <cite>READ-COMMITTED</cite>。</p>
</li>
</ul>
</div>
<input class="tab-input" id="tab-set--26-input--2" name="tab-set--26" type="radio"><label class="tab-label" for="tab-set--26-input--2">英文</label><div class="tab-content docutils container">
<p>Keeping state in the database can be convenient for many, especially for
web applications with a database already in place, but it also comes with
limitations.</p>
<ul>
<li><p>Polling the database for new states is expensive, and so you should
increase the polling intervals of operations, such as <cite>result.get()</cite>.</p></li>
<li><p>Some databases use a default transaction isolation level that
isn't suitable for polling tables for changes.</p>
<p>In MySQL the default transaction isolation level is <cite>REPEATABLE-READ</cite>:
meaning the transaction won't see changes made by other transactions until
the current transaction is committed.</p>
<p>Changing that to the <cite>READ-COMMITTED</cite> isolation level is recommended.</p>
</li>
</ul>
</div>
</div>
</section>
</section>
<section id="task-builtin-states">
<span id="id28"></span><h3>内置状态<a class="headerlink" href="#task-builtin-states" title="Link to this heading">¶</a></h3>
<p>Built-in States</p>
<section id="pending">
<span id="std-state-PENDING"></span><h4>PENDING<a class="headerlink" href="#pending" title="Link to this heading">¶</a></h4>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--27-input--1" name="tab-set--27" type="radio"><label class="tab-label" for="tab-set--27-input--1">中文</label><div class="tab-content docutils container">
<p>任务正在等待执行或未知.
任何未知的任务 ID 都暗示处于待处理状态.</p>
</div>
<input class="tab-input" id="tab-set--27-input--2" name="tab-set--27" type="radio"><label class="tab-label" for="tab-set--27-input--2">英文</label><div class="tab-content docutils container">
<p>Task is waiting for execution or unknown.
Any task id that's not known is implied to be in the pending state.</p>
</div>
</div>
</section>
<section id="started">
<span id="std-state-STARTED"></span><h4>STARTED<a class="headerlink" href="#started" title="Link to this heading">¶</a></h4>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--28-input--1" name="tab-set--28" type="radio"><label class="tab-label" for="tab-set--28-input--1">中文</label><div class="tab-content docutils container">
<p>任务已开始.
默认情况下不报告，要启用请参阅 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.track_started" title="celery.app.task.Task.track_started"><code class="xref py py-attr docutils literal notranslate"><span class="pre">app.Task.track_started</span></code></a> 。</p>
<dl class="field-list simple">
<dt class="field-odd">meta-data<span class="colon">:</span></dt>
<dd class="field-odd"><p>执行任务的工作进程的 <cite>pid</cite> 和 <cite>hostname</cite> 。</p>
</dd>
</dl>
</div>
<input class="tab-input" id="tab-set--28-input--2" name="tab-set--28" type="radio"><label class="tab-label" for="tab-set--28-input--2">英文</label><div class="tab-content docutils container">
<p>Task has been started.
Not reported by default, to enable please see <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.track_started" title="celery.app.task.Task.track_started"><code class="xref py py-attr docutils literal notranslate"><span class="pre">app.Task.track_started</span></code></a>.</p>
<dl class="field-list simple">
<dt class="field-odd">meta-data<span class="colon">:</span></dt>
<dd class="field-odd"><p><cite>pid</cite> and <cite>hostname</cite> of the worker process executing the task.</p>
</dd>
</dl>
</div>
</div>
</section>
<section id="success">
<span id="std-state-SUCCESS"></span><h4>SUCCESS<a class="headerlink" href="#success" title="Link to this heading">¶</a></h4>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--29-input--1" name="tab-set--29" type="radio"><label class="tab-label" for="tab-set--29-input--1">中文</label><div class="tab-content docutils container">
<p>任务已成功执行。</p>
<dl class="field-list simple">
<dt class="field-odd">meta-data<span class="colon">:</span></dt>
<dd class="field-odd"><p><cite>result</cite> 包含任务的返回值。</p>
</dd>
<dt class="field-even">propagates<span class="colon">:</span></dt>
<dd class="field-even"><p>Yes</p>
</dd>
<dt class="field-odd">ready<span class="colon">:</span></dt>
<dd class="field-odd"><p>Yes</p>
</dd>
</dl>
</div>
<input class="tab-input" id="tab-set--29-input--2" name="tab-set--29" type="radio"><label class="tab-label" for="tab-set--29-input--2">英文</label><div class="tab-content docutils container">
<p>Task has been successfully executed.</p>
<dl class="field-list simple">
<dt class="field-odd">meta-data<span class="colon">:</span></dt>
<dd class="field-odd"><p><cite>result</cite> contains the return value of the task.</p>
</dd>
<dt class="field-even">propagates<span class="colon">:</span></dt>
<dd class="field-even"><p>Yes</p>
</dd>
<dt class="field-odd">ready<span class="colon">:</span></dt>
<dd class="field-odd"><p>Yes</p>
</dd>
</dl>
</div>
</div>
</section>
<section id="failure">
<span id="std-state-FAILURE"></span><h4>FAILURE<a class="headerlink" href="#failure" title="Link to this heading">¶</a></h4>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--30-input--1" name="tab-set--30" type="radio"><label class="tab-label" for="tab-set--30-input--1">中文</label><div class="tab-content docutils container">
<p>任务执行失败.</p>
<dl class="field-list simple">
<dt class="field-odd">meta-data<span class="colon">:</span></dt>
<dd class="field-odd"><p><cite>result</cite> 包含发生的异常， <cite>traceback</cite> 包含引发异常时堆栈的回溯。</p>
</dd>
<dt class="field-even">propagates<span class="colon">:</span></dt>
<dd class="field-even"><p>Yes</p>
</dd>
</dl>
</div>
<input class="tab-input" id="tab-set--30-input--2" name="tab-set--30" type="radio"><label class="tab-label" for="tab-set--30-input--2">英文</label><div class="tab-content docutils container">
<p>Task execution resulted in failure.</p>
<dl class="field-list simple">
<dt class="field-odd">meta-data<span class="colon">:</span></dt>
<dd class="field-odd"><p><cite>result</cite> contains the exception occurred, and <cite>traceback</cite> contains the backtrace of the stack at the point when the exception was raised.</p>
</dd>
<dt class="field-even">propagates<span class="colon">:</span></dt>
<dd class="field-even"><p>Yes</p>
</dd>
</dl>
</div>
</div>
</section>
<section id="retry">
<span id="std-state-RETRY"></span><h4>RETRY<a class="headerlink" href="#retry" title="Link to this heading">¶</a></h4>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--31-input--1" name="tab-set--31" type="radio"><label class="tab-label" for="tab-set--31-input--1">中文</label><div class="tab-content docutils container">
<p>任务正在重试.</p>
<dl class="field-list simple">
<dt class="field-odd">meta-data<span class="colon">:</span></dt>
<dd class="field-odd"><p><cite>result</cite> 包含导致重试的异常， <cite>traceback</cite> 包含引发异常时堆栈的回溯。</p>
</dd>
<dt class="field-even">propagates<span class="colon">:</span></dt>
<dd class="field-even"><p>No</p>
</dd>
</dl>
</div>
<input class="tab-input" id="tab-set--31-input--2" name="tab-set--31" type="radio"><label class="tab-label" for="tab-set--31-input--2">英文</label><div class="tab-content docutils container">
<p>Task is being retried.</p>
<dl class="field-list simple">
<dt class="field-odd">meta-data<span class="colon">:</span></dt>
<dd class="field-odd"><p><cite>result</cite> contains the exception that caused the retry, and <cite>traceback</cite> contains the backtrace of the stack at the point when the exceptions was raised.</p>
</dd>
<dt class="field-even">propagates<span class="colon">:</span></dt>
<dd class="field-even"><p>No</p>
</dd>
</dl>
</div>
</div>
</section>
<section id="revoked">
<span id="std-state-REVOKED"></span><h4>REVOKED<a class="headerlink" href="#revoked" title="Link to this heading">¶</a></h4>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--32-input--1" name="tab-set--32" type="radio"><label class="tab-label" for="tab-set--32-input--1">中文</label><div class="tab-content docutils container">
<p>任务已被撤销.</p>
<dl class="field-list simple">
<dt class="field-odd">propagates<span class="colon">:</span></dt>
<dd class="field-odd"><p>Yes</p>
</dd>
</dl>
</div>
<input class="tab-input" id="tab-set--32-input--2" name="tab-set--32" type="radio"><label class="tab-label" for="tab-set--32-input--2">英文</label><div class="tab-content docutils container">
<p>Task has been revoked.</p>
<dl class="field-list simple">
<dt class="field-odd">propagates<span class="colon">:</span></dt>
<dd class="field-odd"><p>Yes</p>
</dd>
</dl>
</div>
</div>
</section>
</section>
<section id="custom-states">
<span id="id29"></span><h3>自定义状态<a class="headerlink" href="#custom-states" title="Link to this heading">¶</a></h3>
<p>Custom states</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--33-input--1" name="tab-set--33" type="radio"><label class="tab-label" for="tab-set--33-input--1">中文</label><div class="tab-content docutils container">
<p>你可以轻松地定义自己的任务状态，只需要一个唯一的名称即可。
状态名通常是一个大写字符串。例如，你可以参考 <code class="xref py py-mod docutils literal notranslate"><span class="pre">可中止任务</span></code> ，
其中定义了一个自定义的 <code class="xref std std-state docutils literal notranslate"><span class="pre">ABORTED</span></code> 状态。</p>
<p>使用 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.update_state" title="celery.app.task.Task.update_state"><code class="xref py py-meth docutils literal notranslate"><span class="pre">update_state()</span></code></a> 方法可以更新任务的状态：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">upload_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filenames</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">called_directly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;PROGRESS&#39;</span><span class="p">,</span>
                <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)})</span>
</pre></div>
</div>
<p>在上面的例子中，我创建了状态 <cite>&quot;PROGRESS&quot;</cite>，
用于告知了解此状态的应用程序当前任务正在进行中，
并通过 <cite>current</cite> 和 <cite>total</cite> 这两个计数值来表示任务的进度。
例如，可以基于这些元数据来创建进度条显示。</p>
</div>
<input class="tab-input" id="tab-set--33-input--2" name="tab-set--33" type="radio"><label class="tab-label" for="tab-set--33-input--2">英文</label><div class="tab-content docutils container">
<p>You can easily define your own states, all you need is a unique name.
The name of the state is usually an uppercase string. As an example
you could have a look at the <code class="xref py py-mod docutils literal notranslate"><span class="pre">abortable</span> <span class="pre">tasks</span></code>
which defines a custom <code class="xref std std-state docutils literal notranslate"><span class="pre">ABORTED</span></code> state.</p>
<p>Use <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.update_state" title="celery.app.task.Task.update_state"><code class="xref py py-meth docutils literal notranslate"><span class="pre">update_state()</span></code></a> to update a task's state:.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">upload_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filenames</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">called_directly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s1">&#39;PROGRESS&#39;</span><span class="p">,</span>
                <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;current&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filenames</span><span class="p">)})</span>
</pre></div>
</div>
<p>Here I created the state <cite>&quot;PROGRESS&quot;</cite>, telling any application
aware of this state that the task is currently in progress, and also where
it is in the process by having <cite>current</cite> and <cite>total</cite> counts as part of the
state meta-data. This can then be used to create progress bars for example.</p>
</div>
</div>
</section>
<section id="pickle">
<span id="pickling-exceptions"></span><h3>创建可 pickle 的异常<a class="headerlink" href="#pickle" title="Link to this heading">¶</a></h3>
<p>Creating pickleable exceptions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--34-input--1" name="tab-set--34" type="radio"><label class="tab-label" for="tab-set--34-input--1">中文</label><div class="tab-content docutils container">
<p>一个鲜为人知的 Python 事实是：异常要能被 <cite>pickle</cite> 模块序列化，必须遵循一些简单的规则。</p>
<p>如果任务抛出了无法被 pickle 序列化的异常，那么在使用 Pickle 作为序列化器时，任务将无法正常工作。</p>
<p>为了确保异常对象可以被 pickle 正确序列化，
异常类 <em>必须</em> 在其 <code class="docutils literal notranslate"><span class="pre">.args</span></code> 属性中保存创建实例时的原始参数。
最简单的方式就是在自定义异常的构造函数中调用 <code class="docutils literal notranslate"><span class="pre">Exception.__init__</span></code> 方法。</p>
<p>下面是一些可以正常工作的示例，以及一个错误示例：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># 正确示例：</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># 错误示例：</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>

<span class="c1"># 正确示例：</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>  <span class="c1"># &lt;-- 必须调用</span>
</pre></div>
</div>
<p>因此，规则总结如下：
如果异常类支持自定义参数 <code class="docutils literal notranslate"><span class="pre">*args</span></code>，
则必须在构造函数中调用 <code class="docutils literal notranslate"><span class="pre">Exception.__init__(self,</span> <span class="pre">*args)</span></code>。</p>
<p>需要注意的是：
目前对于 <em>关键字参数（keyword arguments）</em> 并没有特别的支持，
因此如果希望在反序列化（unpickle）时保留关键字参数，
必须将它们作为普通的位置参数（args）传递：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">HttpError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--34-input--2" name="tab-set--34" type="radio"><label class="tab-label" for="tab-set--34-input--2">英文</label><div class="tab-content docutils container">
<p>A rarely known Python fact is that exceptions must conform to some
simple rules to support being serialized by the pickle module.</p>
<p>Tasks that raise exceptions that aren't pickleable won't work
properly when Pickle is used as the serializer.</p>
<p>To make sure that your exceptions are pickleable the exception
<em>MUST</em> provide the original arguments it was instantiated
with in its <code class="docutils literal notranslate"><span class="pre">.args</span></code> attribute. The simplest way
to ensure this is to have the exception call <code class="docutils literal notranslate"><span class="pre">Exception.__init__</span></code>.</p>
<p>Let's look at some examples that work, and one that doesn't:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># OK:</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># BAD:</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>

<span class="c1"># OK:</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span>  <span class="c1"># &lt;-- REQUIRED</span>
</pre></div>
</div>
<p>So the rule is:
For any exception that supports custom arguments <code class="docutils literal notranslate"><span class="pre">*args</span></code>,
<code class="docutils literal notranslate"><span class="pre">Exception.__init__(self,</span> <span class="pre">*args)</span></code> must be used.</p>
<p>There's no special support for <em>keyword arguments</em>, so if you
want to preserve keyword arguments when the exception is unpickled
you have to pass them as regular args:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HttpError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">HttpError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="task-semipredicates">
<span id="id30"></span><h2>任务半谓词<a class="headerlink" href="#task-semipredicates" title="Link to this heading">¶</a></h2>
<p>Semipredicates</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--35-input--1" name="tab-set--35" type="radio"><label class="tab-label" for="tab-set--35-input--1">中文</label><div class="tab-content docutils container">
<p>worker 将任务包装在一个跟踪函数中，用于记录任务的最终状态。可以使用多种异常来通知此函数，以改变其处理任务返回的方式。</p>
<div class="toggle admonition">
<p class="admonition-title">译注: Semipredicates</p>
<p>在 Celery 的上下文中，&quot;task semipredicates&quot; 是一个相对专业的术语，其翻译需要结合技术语义和中文表达习惯。以下是针对该术语的详细解析和推荐译法：</p>
<ol class="arabic simple">
<li><p><strong>术语解析</strong></p></li>
</ol>
<ul>
<li><p><strong>Semipredicate（半谓词）</strong>：</p>
<ul class="simple">
<li><p><strong>计算机科学中的原意</strong>：指既返回结果又返回状态（如成功/失败）的函数，例如 C 语言的 <code class="docutils literal notranslate"><span class="pre">fopen()</span></code> 在失败时返回 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 同时设置 <code class="docutils literal notranslate"><span class="pre">errno</span></code>。</p></li>
<li><p><strong>在 Celery 中的延伸</strong>：可能指任务（task）在执行时既产生返回值，又隐含状态信息（如 <code class="docutils literal notranslate"><span class="pre">SUCCESS</span></code>、<code class="docutils literal notranslate"><span class="pre">FAILURE</span></code> 或重试状态）。</p></li>
</ul>
</li>
<li><p><strong>Task Semipredicates</strong>：</p>
<ul>
<li><p>指 Celery 任务设计中同时承载业务逻辑结果和自身执行状态的特性，例如：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>  <span class="c1"># 业务结果</span>
    <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">countdown</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># 状态控制</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
<ol class="arabic simple" start="2">
<li><p><strong>推荐翻译方案</strong></p></li>
</ol>
<p>根据上下文可选择以下译法：</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>英文术语</p></td>
<td><p>推荐中文翻译</p></td>
<td><p>适用场景</p></td>
</tr>
<tr class="row-even"><td><p>Task Semipredicates</p></td>
<td><p>任务半谓词</p></td>
<td><p>强调技术实现（学术/底层文档）</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>任务状态复合体</p></td>
<td><p>强调状态与结果的结合（设计文档）</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>双态任务</p></td>
<td><p>简洁表达（非正式场合）</p></td>
</tr>
</tbody>
</table>
</div>
<ol class="arabic simple" start="3">
<li><p><strong>使用示例</strong></p></li>
</ol>
<p><strong>(1) 技术文档中的翻译</strong></p>
<p>原文：</p>
<blockquote>
<div><p>Celery tasks act as semipredicates, returning both computed values and their own execution status.</p>
</div></blockquote>
<p>译文：</p>
<blockquote>
<div><p>Celery 任务作为任务半谓词，既返回计算结果，又携带自身执行状态。</p>
</div></blockquote>
<p><strong>(2) 设计文档中的翻译</strong></p>
<p>原文：</p>
<blockquote>
<div><p>The semipredicate nature of tasks allows for robust error handling.</p>
</div></blockquote>
<p>译文：</p>
<blockquote>
<div><p>任务的状态复合体特性使其支持健壮的错误处理。</p>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p><strong>注意事项</strong></p></li>
</ol>
<ul class="simple">
<li><p><strong>一致性</strong>：在同一个项目中保持术语翻译统一。</p></li>
<li><p><strong>注释说明</strong>：首次出现时可添加英文原词和简要解释，例如：</p></li>
</ul>
<p>任务半谓词（Task Semipredicates，指同时返回结果和状态的任务）</p>
<ul class="simple">
<li><p><strong>受众适配</strong>：面向开发者可直接用英文术语，面向非技术读者建议意译。</p></li>
</ul>
<ol class="arabic simple" start="5">
<li><p><strong>相关术语对照表</strong></p></li>
</ol>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>英文术语</p></td>
<td><p>中文翻译</p></td>
</tr>
<tr class="row-even"><td><p>Task</p></td>
<td><p>任务</p></td>
</tr>
<tr class="row-odd"><td><p>Predicate Function</p></td>
<td><p>谓词函数</p></td>
</tr>
<tr class="row-even"><td><p>Stateful Task</p></td>
<td><p>有状态任务</p></td>
</tr>
<tr class="row-odd"><td><p>Idempotent Task</p></td>
<td><p>幂等任务</p></td>
</tr>
</tbody>
</table>
</div>
<p>通过以上方式，可以准确传达 &quot;task semipredicates&quot; 在 Celery 中的技术内涵。</p>
</div>
</div>
<input class="tab-input" id="tab-set--35-input--2" name="tab-set--35" type="radio"><label class="tab-label" for="tab-set--35-input--2">英文</label><div class="tab-content docutils container">
<p>The worker wraps the task in a tracing function that records the final state of the task. There are a number of exceptions that can be used to signal this function to change how it treats the return of the task.</p>
</div>
</div>
<section id="task-semipred-ignore">
<span id="id31"></span><h3>忽略<a class="headerlink" href="#task-semipred-ignore" title="Link to this heading">¶</a></h3>
<p>Ignore</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--36-input--1" name="tab-set--36" type="radio"><label class="tab-label" for="tab-set--36-input--1">中文</label><div class="tab-content docutils container">
<p>任务可以抛出 <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Ignore" title="celery.exceptions.Ignore"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Ignore</span></code></a> 异常以强制 Worker 忽略该任务。
这意味着任务的状态不会被记录，但消息仍会被确认（从队列中移除）。</p>
<p>这可用于实现自定义的类似撤销（revoke）的功能，或者手动存储任务结果。</p>
<p>示例：将撤销的任务保存在 Redis 的集合中：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ignore</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">some_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">redis</span><span class="o">.</span><span class="n">ismember</span><span class="p">(</span><span class="s1">&#39;tasks.revoked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Ignore</span><span class="p">()</span>
</pre></div>
</div>
<p>示例：手动存储任务结果：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">states</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ignore</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_tweets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="n">timeline</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">get_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">called_directly</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">timeline</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">Ignore</span><span class="p">()</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--36-input--2" name="tab-set--36" type="radio"><label class="tab-label" for="tab-set--36-input--2">英文</label><div class="tab-content docutils container">
<p>The task may raise <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Ignore" title="celery.exceptions.Ignore"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Ignore</span></code></a> to force the worker to ignore the
task. This means that no state will be recorded for the task, but the
message is still acknowledged (removed from queue).</p>
<p>This can be used if you want to implement custom revoke-like
functionality, or manually store the result of a task.</p>
<p>Example keeping revoked tasks in a Redis set:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ignore</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">some_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">redis</span><span class="o">.</span><span class="n">ismember</span><span class="p">(</span><span class="s1">&#39;tasks.revoked&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Ignore</span><span class="p">()</span>
</pre></div>
</div>
<p>Example that stores results manually:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">states</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ignore</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_tweets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="n">timeline</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">get_timeline</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">called_directly</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">states</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="n">timeline</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">Ignore</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="task-semipred-reject">
<span id="id32"></span><h3>拒绝<a class="headerlink" href="#task-semipred-reject" title="Link to this heading">¶</a></h3>
<p>Reject</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--37-input--1" name="tab-set--37" type="radio"><label class="tab-label" for="tab-set--37-input--1">中文</label><div class="tab-content docutils container">
<p>任务可以抛出 <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Reject" title="celery.exceptions.Reject"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Reject</span></code></a> 异常，以使用 AMQP 的 <code class="docutils literal notranslate"><span class="pre">basic_reject</span></code> 方法拒绝任务消息。
除非启用了 <a class="reference internal" href="#Task.acks_late" title="Task.acks_late"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Task.acks_late</span></code></a>，否则此操作不会产生任何效果。</p>
<p>拒绝一条消息的效果与确认（ack）类似，但某些消息代理还可能实现了其他功能可供利用。
例如，RabbitMQ 支持 <a class="reference external" href="DeadLetterExchanges">死信交换器（Dead Letter Exchanges）</a> 的概念，
可以将队列配置为使用一个死信交换器，拒绝的消息会被重新投递到该交换器。</p>
<p>拒绝还可以用于重新排队消息，但请务必谨慎使用，因为这可能很容易导致无限的消息循环。</p>
<p>示例：当任务导致内存溢出时使用 reject：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">errno</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Reject</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">acks_late</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">render_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">get_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">renderer</span><span class="o">.</span><span class="n">render_scene</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="c1"># 如果文件太大无法载入内存，</span>
    <span class="c1"># 则拒绝该任务，使其被投递到死信交换器，</span>
    <span class="c1"># 以便我们手动检查具体情况。</span>
    <span class="k">except</span> <span class="ne">MemoryError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Reject</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOMEM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Reject</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># 对于其他错误，10 秒后重试。</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>示例：重新排队消息：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Reject</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">acks_late</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">requeues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">delivery_info</span><span class="p">[</span><span class="s1">&#39;redelivered&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">Reject</span><span class="p">(</span><span class="s1">&#39;no reason&#39;</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;received two times&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>有关 <code class="docutils literal notranslate"><span class="pre">basic_reject</span></code> 方法的更多信息，请参阅所使用消息代理的文档。</p>
</div>
<input class="tab-input" id="tab-set--37-input--2" name="tab-set--37" type="radio"><label class="tab-label" for="tab-set--37-input--2">英文</label><div class="tab-content docutils container">
<p>The task may raise <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Reject" title="celery.exceptions.Reject"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Reject</span></code></a> to reject the task message using
AMQPs <code class="docutils literal notranslate"><span class="pre">basic_reject</span></code> method. This won't have any effect unless
<a class="reference internal" href="#Task.acks_late" title="Task.acks_late"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Task.acks_late</span></code></a> is enabled.</p>
<p>Rejecting a message has the same effect as acking it, but some
brokers may implement additional functionality that can be used.
For example RabbitMQ supports the concept of <a class="reference external" href="http://www.rabbitmq.com/dlx.html">Dead Letter Exchanges</a>
where a queue can be configured to use a dead letter exchange that rejected
messages are redelivered to.</p>
<p>Reject can also be used to re-queue messages, but please be very careful
when using this as it can easily result in an infinite message loop.</p>
<p>Example using reject when a task causes an out of memory condition:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">errno</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Reject</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">acks_late</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">render_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">get_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">renderer</span><span class="o">.</span><span class="n">render_scene</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="c1"># if the file is too big to fit in memory</span>
    <span class="c1"># we reject it so that it&#39;s redelivered to the dead letter exchange</span>
    <span class="c1"># and we can manually inspect the situation.</span>
    <span class="k">except</span> <span class="ne">MemoryError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Reject</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOMEM</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Reject</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># For any other error we retry after 10 seconds.</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">retry</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Example re-queuing the message:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Reject</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">acks_late</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">requeues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">delivery_info</span><span class="p">[</span><span class="s1">&#39;redelivered&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="n">Reject</span><span class="p">(</span><span class="s1">&#39;no reason&#39;</span><span class="p">,</span> <span class="n">requeue</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;received two times&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Consult your broker documentation for more details about the <code class="docutils literal notranslate"><span class="pre">basic_reject</span></code>
method.</p>
</div>
</div>
</section>
<section id="task-semipred-retry">
<span id="id34"></span><h3>重试<a class="headerlink" href="#task-semipred-retry" title="Link to this heading">¶</a></h3>
<p>Retry</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--38-input--1" name="tab-set--38" type="radio"><label class="tab-label" for="tab-set--38-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Retry" title="celery.exceptions.Retry"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Retry</span></code></a> 异常由 <code class="docutils literal notranslate"><span class="pre">Task.retry</span></code> 方法抛出，用于告知 Worker 该任务正在被重试。</p>
</div>
<input class="tab-input" id="tab-set--38-input--2" name="tab-set--38" type="radio"><label class="tab-label" for="tab-set--38-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="../reference/celery.exceptions.html#celery.exceptions.Retry" title="celery.exceptions.Retry"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Retry</span></code></a> exception is raised by the <code class="docutils literal notranslate"><span class="pre">Task.retry</span></code> method
to tell the worker that the task is being retried.</p>
</div>
</div>
</section>
</section>
<section id="task-custom-classes">
<span id="id35"></span><h2>自定义任务类<a class="headerlink" href="#task-custom-classes" title="Link to this heading">¶</a></h2>
<p>Custom task classes</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--39-input--1" name="tab-set--39" type="radio"><label class="tab-label" for="tab-set--39-input--1">中文</label><div class="tab-content docutils container">
<p>所有任务都继承自 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task" title="celery.app.task.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">app.Task</span></code></a> 类。
<a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.run" title="celery.app.task.Task.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run()</span></code></a> 方法将作为任务的主体执行。</p>
<p>例如，以下代码：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>其背后大致等价于如下实现：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">_AddTask</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="n">add</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">_AddTask</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--39-input--2" name="tab-set--39" type="radio"><label class="tab-label" for="tab-set--39-input--2">英文</label><div class="tab-content docutils container">
<p>All tasks inherit from the <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task" title="celery.app.task.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">app.Task</span></code></a> class.
The <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.run" title="celery.app.task.Task.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run()</span></code></a> method becomes the task body.</p>
<p>As an example, the following code,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
</pre></div>
</div>
<p>will do roughly this behind the scenes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">_AddTask</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="n">add</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">_AddTask</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<section id="id36">
<h3>实例化<a class="headerlink" href="#id36" title="Link to this heading">¶</a></h3>
<p>Instantiation</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--40-input--1" name="tab-set--40" type="radio"><label class="tab-label" for="tab-set--40-input--1">中文</label><div class="tab-content docutils container">
<p>任务在每次请求时 <strong>不会</strong> 重新实例化，而是以全局实例的形式注册在任务注册表中。</p>
<p>这意味着 <code class="docutils literal notranslate"><span class="pre">__init__</span></code> 构造函数在每个进程中只会被调用一次，并且任务类在语义上更接近于一个 Actor 模型。</p>
<p>如果你定义了如下任务：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span><span class="w"> </span><span class="nc">NaiveAuthenticateServer</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;george&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">==</span> <span class="n">password</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
<p>并且将每次请求都路由到同一个进程中执行，那么它将在请求之间保持状态。</p>
<p>这对于缓存资源也很有用，例如以下用于缓存数据库连接的 Task 基类：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DatabaseTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">_db</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--40-input--2" name="tab-set--40" type="radio"><label class="tab-label" for="tab-set--40-input--2">英文</label><div class="tab-content docutils container">
<p>A task is <strong>not</strong> instantiated for every request, but is registered
in the task registry as a global instance.</p>
<p>This means that the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> constructor will only be called
once per process, and that the task class is semantically closer to an
Actor.</p>
<p>If you have a task,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span><span class="w"> </span><span class="nc">NaiveAuthenticateServer</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;george&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">username</span><span class="p">]</span> <span class="o">==</span> <span class="n">password</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
<p>And you route every request to the same process, then it
will keep state between requests.</p>
<p>This can also be useful to cache resources,
For example, a base Task class that caches a database connection:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DatabaseTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">_db</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">Database</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>
</pre></div>
</div>
</div>
</div>
<section id="id37">
<h4>每个任务的使用<a class="headerlink" href="#id37" title="Link to this heading">¶</a></h4>
<p>Per task usage</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--41-input--1" name="tab-set--41" type="radio"><label class="tab-label" for="tab-set--41-input--1">中文</label><div class="tab-content docutils container">
<p>可以像下面这样将上述基类应用于每个任务中：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.app</span><span class="w"> </span><span class="kn">import</span> <span class="n">task</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">DatabaseTask</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">task</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>这样， <code class="docutils literal notranslate"><span class="pre">process_rows</span></code> 任务中的 <code class="docutils literal notranslate"><span class="pre">db</span></code> 属性在每个进程中将始终保持一致。</p>
</div>
<input class="tab-input" id="tab-set--41-input--2" name="tab-set--41" type="radio"><label class="tab-label" for="tab-set--41-input--2">英文</label><div class="tab-content docutils container">
<p>The above can be added to each task like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery.app</span><span class="w"> </span><span class="kn">import</span> <span class="n">task</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">DatabaseTask</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">task</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">db</span></code> attribute of the <code class="docutils literal notranslate"><span class="pre">process_rows</span></code> task will then
always stay the same in each process.</p>
</div>
</div>
</section>
<section id="app">
<span id="custom-task-cls-app-wide"></span><h4>App范围的使用<a class="headerlink" href="#app" title="Link to this heading">¶</a></h4>
<p>App-wide usage</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--42-input--1" name="tab-set--42" type="radio"><label class="tab-label" for="tab-set--42-input--1">中文</label><div class="tab-content docutils container">
<p>你还可以通过在实例化应用时传入 <code class="docutils literal notranslate"><span class="pre">task_cls</span></code> 参数，指定整个 Celery 应用使用你自定义的任务类。
该参数可以是表示任务类的 Python 路径字符串，或是类对象本身：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">task_cls</span><span class="o">=</span><span class="s1">&#39;your.module.path:DatabaseTask&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>这样，所有使用装饰器语法声明的任务都将使用你自定义的 <code class="docutils literal notranslate"><span class="pre">DatabaseTask</span></code> 类，并且都将具备一个 <code class="docutils literal notranslate"><span class="pre">db</span></code> 属性。</p>
<p>默认值是 Celery 提供的类： <code class="docutils literal notranslate"><span class="pre">'celery.app.task:Task'</span></code> 。</p>
</div>
<input class="tab-input" id="tab-set--42-input--2" name="tab-set--42" type="radio"><label class="tab-label" for="tab-set--42-input--2">英文</label><div class="tab-content docutils container">
<p>You can also use your custom class in your whole Celery app by passing it as
the <code class="docutils literal notranslate"><span class="pre">task_cls</span></code> argument when instantiating the app. This argument should be
either a string giving the python path to your Task class or the class itself:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;tasks&#39;</span><span class="p">,</span> <span class="n">task_cls</span><span class="o">=</span><span class="s1">&#39;your.module.path:DatabaseTask&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will make all your tasks declared using the decorator syntax within your
app to use your <code class="docutils literal notranslate"><span class="pre">DatabaseTask</span></code> class and will all have a <code class="docutils literal notranslate"><span class="pre">db</span></code> attribute.</p>
<p>The default value is the class provided by Celery: <code class="docutils literal notranslate"><span class="pre">'celery.app.task:Task'</span></code>.</p>
</div>
</div>
</section>
</section>
<section id="id38">
<h3>处理程序<a class="headerlink" href="#id38" title="Link to this heading">¶</a></h3>
<p>Handlers</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--43-input--1" name="tab-set--43" type="radio"><label class="tab-label" for="tab-set--43-input--1">中文</label><div class="tab-content docutils container">
<dl class="py method">
<dt class="sig sig-object py" id="before_start">
<span class="sig-name descname"><span class="pre">before_start</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#before_start" title="Link to this definition">¶</a></dt>
<dd><p>任务在开始执行前由 Worker 调用。</p>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.2.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>task_id</strong> -- 待执行任务的唯一标识符。</p></li>
<li><p><strong>args</strong> -- 待执行任务的原始位置参数。</p></li>
<li><p><strong>kwargs</strong> -- 待执行任务的原始关键字参数。</p></li>
</ul>
</dd>
</dl>
<p>此处理器的返回值将被忽略。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="after_return">
<span class="sig-name descname"><span class="pre">after_return</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">status</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">retval</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kwargs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">einfo</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#after_return" title="Link to this definition">¶</a></dt>
<dd><p>任务返回后调用的处理器。</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> -- 当前任务的状态。</p></li>
<li><p><strong>retval</strong> -- 任务的返回值或异常对象。</p></li>
<li><p><strong>task_id</strong> -- 任务的唯一标识符。</p></li>
<li><p><strong>args</strong> -- 已返回任务的原始位置参数。</p></li>
<li><p><strong>kwargs</strong> -- 已返回任务的原始关键字参数。</p></li>
</ul>
</dd>
<dt class="field-even">关键字参数<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>einfo</strong> -- <code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionInfo</span></code>
实例，包含 traceback（若存在）。</p>
</dd>
</dl>
<p>此处理器的返回值将被忽略。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="on_failure">
<span class="sig-name descname"><span class="pre">on_failure</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exc</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kwargs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">einfo</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#on_failure" title="Link to this definition">¶</a></dt>
<dd><p>当任务失败时由 Worker 调用。</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>exc</strong> -- 任务抛出的异常。</p></li>
<li><p><strong>task_id</strong> -- 失败任务的唯一标识符。</p></li>
<li><p><strong>args</strong> -- 失败任务的原始位置参数。</p></li>
<li><p><strong>kwargs</strong> -- 失败任务的原始关键字参数。</p></li>
</ul>
</dd>
<dt class="field-even">关键字参数<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>einfo</strong> -- <code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionInfo</span></code>
实例，包含 traceback。</p>
</dd>
</dl>
<p>此处理器的返回值将被忽略。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="on_retry">
<span class="sig-name descname"><span class="pre">on_retry</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exc</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kwargs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">einfo</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#on_retry" title="Link to this definition">¶</a></dt>
<dd><p>当任务即将重试时由 Worker 调用。</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>exc</strong> -- 传递给 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">retry()</span></code></a> 的异常。</p></li>
<li><p><strong>task_id</strong> -- 被重试任务的唯一标识符。</p></li>
<li><p><strong>args</strong> -- 被重试任务的原始位置参数。</p></li>
<li><p><strong>kwargs</strong> -- 被重试任务的原始关键字参数。</p></li>
</ul>
</dd>
<dt class="field-even">关键字参数<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>einfo</strong> -- <code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionInfo</span></code>
实例，包含 traceback。</p>
</dd>
</dl>
<p>此处理器的返回值将被忽略。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="on_success">
<span class="sig-name descname"><span class="pre">on_success</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">retval</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#on_success" title="Link to this definition">¶</a></dt>
<dd><p>当任务成功执行时由 Worker 调用。</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>retval</strong> -- 任务的返回值。</p></li>
<li><p><strong>task_id</strong> -- 已执行任务的唯一标识符。</p></li>
<li><p><strong>args</strong> -- 已执行任务的原始位置参数。</p></li>
<li><p><strong>kwargs</strong> -- 已执行任务的原始关键字参数。</p></li>
</ul>
</dd>
</dl>
<p>此处理器的返回值将被忽略。</p>
</dd></dl>

</div>
<input class="tab-input" id="tab-set--43-input--2" name="tab-set--43" type="radio"><label class="tab-label" for="tab-set--43-input--2">英文</label><div class="tab-content docutils container">
<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">before_start</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Run by the worker before the task starts executing.</p>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 5.2.</span></p>
</div>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>task_id</strong> -- Unique id of the task to execute.</p></li>
<li><p><strong>args</strong> -- Original arguments for the task to execute.</p></li>
<li><p><strong>kwargs</strong> -- Original keyword arguments for the task to execute.</p></li>
</ul>
</dd>
</dl>
<p>The return value of this handler is ignored.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">after_return</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">status</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">retval</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kwargs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">einfo</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Handler called after the task returns.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> -- Current task state.</p></li>
<li><p><strong>retval</strong> -- Task return value/exception.</p></li>
<li><p><strong>task_id</strong> -- Unique id of the task.</p></li>
<li><p><strong>args</strong> -- Original arguments for the task that returned.</p></li>
<li><p><strong>kwargs</strong> -- Original keyword arguments for the task
that returned.</p></li>
</ul>
</dd>
<dt class="field-even">关键字参数<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>einfo</strong> -- <code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionInfo</span></code>
instance, containing the traceback (if any).</p>
</dd>
</dl>
<p>The return value of this handler is ignored.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">on_failure</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exc</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kwargs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">einfo</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>This is run by the worker when the task fails.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>exc</strong> -- The exception raised by the task.</p></li>
<li><p><strong>task_id</strong> -- Unique id of the failed task.</p></li>
<li><p><strong>args</strong> -- Original arguments for the task that failed.</p></li>
<li><p><strong>kwargs</strong> -- Original keyword arguments for the task
that failed.</p></li>
</ul>
</dd>
<dt class="field-even">关键字参数<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>einfo</strong> -- <code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionInfo</span></code>
instance, containing the traceback.</p>
</dd>
</dl>
<p>The return value of this handler is ignored.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">on_retry</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exc</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kwargs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">einfo</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>This is run by the worker when the task is to be retried.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>exc</strong> -- The exception sent to <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.retry" title="celery.app.task.Task.retry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">retry()</span></code></a>.</p></li>
<li><p><strong>task_id</strong> -- Unique id of the retried task.</p></li>
<li><p><strong>args</strong> -- Original arguments for the retried task.</p></li>
<li><p><strong>kwargs</strong> -- Original keyword arguments for the retried task.</p></li>
</ul>
</dd>
<dt class="field-even">关键字参数<span class="colon">:</span></dt>
<dd class="field-even"><p><strong>einfo</strong> -- <code class="xref py py-class docutils literal notranslate"><span class="pre">ExceptionInfo</span></code>
instance, containing the traceback.</p>
</dd>
</dl>
<p>The return value of this handler is ignored.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">on_success</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">self</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">retval</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">task_id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Run by the worker if the task executes successfully.</p>
<dl class="field-list simple">
<dt class="field-odd">参数<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>retval</strong> -- The return value of the task.</p></li>
<li><p><strong>task_id</strong> -- Unique id of the executed task.</p></li>
<li><p><strong>args</strong> -- Original arguments for the executed task.</p></li>
<li><p><strong>kwargs</strong> -- Original keyword arguments for the executed task.</p></li>
</ul>
</dd>
</dl>
<p>The return value of this handler is ignored.</p>
</dd></dl>

</div>
</div>
</section>
<section id="task-requests-and-custom-requests">
<span id="id39"></span><h3>请求和自定义请求<a class="headerlink" href="#task-requests-and-custom-requests" title="Link to this heading">¶</a></h3>
<p>Requests and custom requests</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--44-input--1" name="tab-set--44" type="radio"><label class="tab-label" for="tab-set--44-input--1">中文</label><div class="tab-content docutils container">
<p>在收到执行任务的消息时， <a class="reference internal" href="workers.html#guide-workers"><span class="std std-ref">worker</span></a> 会创建一个
<a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request" title="celery.worker.request.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> 来表示这种需求。</p>
<p>自定义任务类可以通过更改属性 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.Request" title="celery.app.task.Task.Request"><code class="xref py py-attr docutils literal notranslate"><span class="pre">celery.app.task.Task.Request</span></code></a>
来重写使用的请求类。你可以直接分配自定义请求类本身，或者
它的完全限定名称。</p>
<p>请求有多个职责。自定义请求类应覆盖所有这些职责——它们负责实际
执行和跟踪任务。我们强烈推荐继承 <a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request" title="celery.worker.request.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">celery.worker.request.Request</span></code></a>。</p>
<p>当使用 <a class="reference internal" href="workers.html#worker-concurrency"><span class="std std-ref">pre-forking worker</span></a> 时，<a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request.on_timeout" title="celery.worker.request.Request.on_timeout"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_timeout()</span></code></a> 和
<a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request.on_failure" title="celery.worker.request.Request.on_failure"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_failure()</span></code></a> 方法将在主工作进程中执行。
应用程序可以利用这一功能来检测 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.on_failure" title="celery.app.task.Task.on_failure"><code class="xref py py-meth docutils literal notranslate"><span class="pre">celery.app.task.Task.on_failure()</span></code></a>
未检测到的失败。</p>
<p>例如，以下自定义请求类会检测并记录硬时间限制和其他失败。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.worker.request</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;my.package&#39;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyRequest</span><span class="p">(</span><span class="n">Request</span><span class="p">):</span>
    <span class="s1">&#39;一个最小的自定义请求，用于记录失败和硬时间限制。&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soft</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyRequest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_timeout</span><span class="p">(</span><span class="n">soft</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">soft</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;任务 </span><span class="si">%s</span><span class="s1"> 强制执行了硬超时&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">,</span> <span class="n">send_failed_event</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span>
            <span class="n">exc_info</span><span class="p">,</span>
            <span class="n">send_failed_event</span><span class="o">=</span><span class="n">send_failed_event</span><span class="p">,</span>
            <span class="n">return_ok</span><span class="o">=</span><span class="n">return_ok</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;任务 </span><span class="si">%s</span><span class="s1"> 检测到失败&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">Request</span> <span class="o">=</span> <span class="n">MyRequest</span>  <span class="c1"># 你可以使用 FQN &#39;my.package:MyRequest&#39;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">MyTask</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">some_longrunning_task</span><span class="p">():</span>
    <span class="c1"># 发挥你的想象力</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--44-input--2" name="tab-set--44" type="radio"><label class="tab-label" for="tab-set--44-input--2">英文</label><div class="tab-content docutils container">
<p>Upon receiving a message to run a task, the <a class="reference internal" href="workers.html#guide-workers"><span class="std std-ref">worker</span></a>
creates a <a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request" title="celery.worker.request.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">request</span></code></a> to represent such
demand.</p>
<p>Custom task classes may override which request class to use by changing the
attribute <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.Request" title="celery.app.task.Task.Request"><code class="xref py py-attr docutils literal notranslate"><span class="pre">celery.app.task.Task.Request</span></code></a>.  You may either assign the
custom request class itself, or its fully qualified name.</p>
<p>The request has several responsibilities.  Custom request classes should cover
them all -- they are responsible to actually run and trace the task.  We
strongly recommend to inherit from <a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request" title="celery.worker.request.Request"><code class="xref py py-class docutils literal notranslate"><span class="pre">celery.worker.request.Request</span></code></a>.</p>
<p>When using the <a class="reference internal" href="workers.html#worker-concurrency"><span class="std std-ref">pre-forking worker</span></a>, the methods
<a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request.on_timeout" title="celery.worker.request.Request.on_timeout"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_timeout()</span></code></a> and
<a class="reference internal" href="../reference/celery.worker.request.html#celery.worker.request.Request.on_failure" title="celery.worker.request.Request.on_failure"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_failure()</span></code></a> are executed in the main
worker process.  An application may leverage such facility to detect failures
which are not detected using <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.on_failure" title="celery.app.task.Task.on_failure"><code class="xref py py-meth docutils literal notranslate"><span class="pre">celery.app.task.Task.on_failure()</span></code></a>.</p>
<p>As an example, the following custom request detects and logs hard time
limits, and other failures.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery.worker.request</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;my.package&#39;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyRequest</span><span class="p">(</span><span class="n">Request</span><span class="p">):</span>
    <span class="s1">&#39;A minimal custom request to log failures and hard time limits.&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soft</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyRequest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_timeout</span><span class="p">(</span><span class="n">soft</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">soft</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;A hard timeout was enforced for task </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">,</span> <span class="n">send_failed_event</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">on_failure</span><span class="p">(</span>
            <span class="n">exc_info</span><span class="p">,</span>
            <span class="n">send_failed_event</span><span class="o">=</span><span class="n">send_failed_event</span><span class="p">,</span>
            <span class="n">return_ok</span><span class="o">=</span><span class="n">return_ok</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Failure detected for task </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyTask</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">Request</span> <span class="o">=</span> <span class="n">MyRequest</span>  <span class="c1"># you can use a FQN &#39;my.package:MyRequest&#39;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">MyTask</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">some_longrunning_task</span><span class="p">():</span>
    <span class="c1"># use your imagination</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="task-how-they-work">
<span id="id40"></span><h2>工作原理<a class="headerlink" href="#task-how-they-work" title="Link to this heading">¶</a></h2>
<p>How it works</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--45-input--1" name="tab-set--45" type="radio"><label class="tab-label" for="tab-set--45-input--1">中文</label><div class="tab-content docutils container">
<p>以下是技术细节。虽然这部分内容不是你必须了解的，但你可能会感兴趣。</p>
<p>所有定义的任务都会列在一个注册表中。注册表包含任务名称和对应的任务类的列表。
你可以自己检查这个注册表：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">proj.celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span>
<span class="go">{&#39;celery.chord_unlock&#39;:</span>
<span class="go">    &lt;@task: celery.chord_unlock&gt;,</span>
<span class="go">&#39;celery.backend_cleanup&#39;:</span>
<span class="go">    &lt;@task: celery.backend_cleanup&gt;,</span>
<span class="go">&#39;celery.chord&#39;:</span>
<span class="go">    &lt;@task: celery.chord&gt;}</span>
</pre></div>
</div>
<p>这是 Celery 内置任务的列表。请注意，只有在定义任务的模块被导入时，
这些任务才会被注册。</p>
<p>默认加载器会导入 <a class="reference internal" href="configuration.html#std-setting-imports"><code class="xref std std-setting docutils literal notranslate"><span class="pre">imports</span></code></a> 配置项中列出的所有模块。</p>
<p><a class="reference internal" href="../reference/celery.html#celery.Celery.task" title="celery.Celery.task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.task()</span></code></a> 装饰器负责将你的任务注册到应用程序的任务注册表中。</p>
<p>当任务被发送时，实际上并不会发送函数代码，只会发送任务名称以便执行。
当 Worker 收到消息时，它可以在任务注册表中查找该名称，找到执行代码。</p>
<p>这意味着你的 Worker 应该始终与客户端使用相同的软件版本。这是一个缺点，
但替代方案是一个尚未解决的技术挑战。</p>
</div>
<input class="tab-input" id="tab-set--45-input--2" name="tab-set--45" type="radio"><label class="tab-label" for="tab-set--45-input--2">英文</label><div class="tab-content docutils container">
<p>Here come the technical details. This part isn't something you need to know,
but you may be interested.</p>
<p>All defined tasks are listed in a registry. The registry contains
a list of task names and their task classes. You can investigate this registry
yourself:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">proj.celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">tasks</span>
<span class="go">{&#39;celery.chord_unlock&#39;:</span>
<span class="go">    &lt;@task: celery.chord_unlock&gt;,</span>
<span class="go">&#39;celery.backend_cleanup&#39;:</span>
<span class="go">    &lt;@task: celery.backend_cleanup&gt;,</span>
<span class="go">&#39;celery.chord&#39;:</span>
<span class="go">    &lt;@task: celery.chord&gt;}</span>
</pre></div>
</div>
<p>This is the list of tasks built into Celery. Note that tasks
will only be registered when the module they're defined in is imported.</p>
<p>The default loader imports any modules listed in the
<a class="reference internal" href="configuration.html#std-setting-imports"><code class="xref std std-setting docutils literal notranslate"><span class="pre">imports</span></code></a> setting.</p>
<p>The <a class="reference internal" href="../reference/celery.html#celery.Celery.task" title="celery.Celery.task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">app.task()</span></code></a> decorator is responsible for registering your task
in the applications task registry.</p>
<p>When tasks are sent, no actual function code is sent with it, just the name
of the task to execute. When the worker then receives the message it can look
up the name in its task registry to find the execution code.</p>
<p>This means that your workers should always be updated with the same software
as the client. This is a drawback, but the alternative is a technical
challenge that's yet to be solved.</p>
</div>
</div>
</section>
<section id="task-best-practices">
<span id="id41"></span><h2>技巧和最佳实践<a class="headerlink" href="#task-best-practices" title="Link to this heading">¶</a></h2>
<p>Tips and Best Practices</p>
<section id="task-ignore-results">
<span id="id42"></span><h3>忽略不需要的结果<a class="headerlink" href="#task-ignore-results" title="Link to this heading">¶</a></h3>
<p>Ignore results you don't want</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--46-input--1" name="tab-set--46" type="radio"><label class="tab-label" for="tab-set--46-input--1">中文</label><div class="tab-content docutils container">
<p>如果你不关心任务的结果，务必设置 <a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.ignore_result" title="celery.app.task.Task.ignore_result"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ignore_result</span></code></a> 选项，
因为存储结果会浪费时间和资源。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mytask</span><span class="p">():</span>
    <span class="n">something</span><span class="p">()</span>
</pre></div>
</div>
<p>也可以使用 <a class="reference internal" href="configuration.html#std-setting-task_ignore_result"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_ignore_result</span></code></a> 配置项全局禁用结果存储。</p>
<p>通过在调用 <code class="docutils literal notranslate"><span class="pre">apply_async</span></code> 时传递 <code class="docutils literal notranslate"><span class="pre">ignore_result</span></code> 布尔参数，可以在每次执行时启用/禁用结果存储。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mytask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="c1"># 不会存储结果</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">mytask</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ignore_result</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="c1"># -&gt; None</span>

<span class="c1"># 会存储结果</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">mytask</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ignore_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="c1"># -&gt; 3</span>
</pre></div>
</div>
<p>默认情况下，当配置了结果后端时，任务会*不忽略结果*（<code class="docutils literal notranslate"><span class="pre">ignore_result=False</span></code>）。</p>
<p>选项优先级顺序如下：</p>
<ol class="arabic simple">
<li><p>全局 <a class="reference internal" href="configuration.html#std-setting-task_ignore_result"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_ignore_result</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.ignore_result" title="celery.app.task.Task.ignore_result"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ignore_result</span></code></a> 选项</p></li>
<li><p>任务执行选项 <code class="docutils literal notranslate"><span class="pre">ignore_result</span></code></p></li>
</ol>
</div>
<input class="tab-input" id="tab-set--46-input--2" name="tab-set--46" type="radio"><label class="tab-label" for="tab-set--46-input--2">英文</label><div class="tab-content docutils container">
<p>If you don't care about the results of a task, be sure to set the
<a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.ignore_result" title="celery.app.task.Task.ignore_result"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ignore_result</span></code></a> option, as storing results
wastes time and resources.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mytask</span><span class="p">():</span>
    <span class="n">something</span><span class="p">()</span>
</pre></div>
</div>
<p>Results can even be disabled globally using the <a class="reference internal" href="configuration.html#std-setting-task_ignore_result"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_ignore_result</span></code></a>
setting.</p>
<p>Results can be enabled/disabled on a per-execution basis, by passing the <code class="docutils literal notranslate"><span class="pre">ignore_result</span></code> boolean parameter,
when calling <code class="docutils literal notranslate"><span class="pre">apply_async</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mytask</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

<span class="c1"># No result will be stored</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">mytask</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ignore_result</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="c1"># -&gt; None</span>

<span class="c1"># Result will be stored</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">mytask</span><span class="o">.</span><span class="n">apply_async</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">ignore_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="c1"># -&gt; 3</span>
</pre></div>
</div>
<p>By default tasks will <em>not ignore results</em> (<code class="docutils literal notranslate"><span class="pre">ignore_result=False</span></code>) when a result backend is configured.</p>
<p>The option precedence order is the following:</p>
<ol class="arabic simple">
<li><p>Global <a class="reference internal" href="configuration.html#std-setting-task_ignore_result"><code class="xref std std-setting docutils literal notranslate"><span class="pre">task_ignore_result</span></code></a></p></li>
<li><p><a class="reference internal" href="../reference/celery.app.task.html#celery.app.task.Task.ignore_result" title="celery.app.task.Task.ignore_result"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ignore_result</span></code></a> option</p></li>
<li><p>Task execution option <code class="docutils literal notranslate"><span class="pre">ignore_result</span></code></p></li>
</ol>
</div>
</div>
</section>
<section id="id43">
<h3>更多优化技巧<a class="headerlink" href="#id43" title="Link to this heading">¶</a></h3>
<p>More optimization tips</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--47-input--1" name="tab-set--47" type="radio"><label class="tab-label" for="tab-set--47-input--1">中文</label><div class="tab-content docutils container">
<p>您可以在 <a class="reference internal" href="optimizing.html#guide-optimizing"><span class="std std-ref">优化指南</span></a> 中找到更多优化技巧。</p>
</div>
<input class="tab-input" id="tab-set--47-input--2" name="tab-set--47" type="radio"><label class="tab-label" for="tab-set--47-input--2">英文</label><div class="tab-content docutils container">
<p>You find additional optimization tips in the <a class="reference internal" href="optimizing.html#guide-optimizing"><span class="std std-ref">Optimizing Guide</span></a>.</p>
</div>
</div>
</section>
<section id="task-synchronous-subtasks">
<span id="id44"></span><h3>避免启动同步子任务<a class="headerlink" href="#task-synchronous-subtasks" title="Link to this heading">¶</a></h3>
<p>Avoid launching synchronous subtasks</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--48-input--1" name="tab-set--48" type="radio"><label class="tab-label" for="tab-set--48-input--1">中文</label><div class="tab-content docutils container">
<p>让一个任务等待另一个任务的结果是非常低效的，
如果工作进程池耗尽，甚至可能导致死锁。</p>
<p>相反，应该使你的设计异步化，例如使用 <em>回调</em>。</p>
<p><strong>不推荐的做法</strong>：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">parse_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">store_page_info</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">store_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>推荐的做法</strong>：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="c1"># fetch_page -&gt; parse_page -&gt; store_page</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">|</span> <span class="n">parse_page</span><span class="o">.</span><span class="n">s</span><span class="p">()</span> <span class="o">|</span> <span class="n">store_page_info</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">chain</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">store_page_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p>在这里，我通过将不同的 <a class="reference internal" href="../reference/celery.html#celery.signature" title="celery.signature"><code class="xref py py-func docutils literal notranslate"><span class="pre">signature()</span></code></a> 任务链接起来创建了任务链。
你可以在 <a class="reference internal" href="../getting-started/next-steps.html#designing-workflows"><span class="std std-ref">Canvas: 设计工作流</span></a> 中阅读有关任务链和其他强大构造的信息。</p>
<p>默认情况下，Celery 不允许在任务内同步运行子任务，
但在极少数或极端情况下，你可能需要这样做。
<strong>警告</strong>：
启用子任务同步执行不推荐！</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">disable_sync_subtasks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">parse_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">disable_sync_subtasks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">store_page_info</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">store_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--48-input--2" name="tab-set--48" type="radio"><label class="tab-label" for="tab-set--48-input--2">英文</label><div class="tab-content docutils container">
<p>Having a task wait for the result of another task is really inefficient,
and may even cause a deadlock if the worker pool is exhausted.</p>
<p>Make your design asynchronous instead, for example by using <em>callbacks</em>.</p>
<p><strong>Bad</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">parse_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">store_page_info</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">store_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Good</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="c1"># fetch_page -&gt; parse_page -&gt; store_page</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">|</span> <span class="n">parse_page</span><span class="o">.</span><span class="n">s</span><span class="p">()</span> <span class="o">|</span> <span class="n">store_page_info</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">chain</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">ignore_result</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">store_page_info</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
<p>Here I instead created a chain of tasks by linking together
different <a class="reference internal" href="../reference/celery.html#celery.signature" title="celery.signature"><code class="xref py py-func docutils literal notranslate"><span class="pre">signature()</span></code></a>'s.
You can read about chains and other powerful constructs
at <a class="reference internal" href="../getting-started/next-steps.html#designing-workflows"><span class="std std-ref">Canvas: 设计工作流</span></a>.</p>
<p>By default Celery will not allow you to run subtasks synchronously within a task,
but in rare or extreme cases you might need to do so.
<strong>WARNING</strong>:
enabling subtasks to run synchronously is not recommended!</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">fetch_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">disable_sync_subtasks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">parse_page</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">disable_sync_subtasks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">store_page_info</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_page</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myhttplib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_page</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">myparser</span><span class="o">.</span><span class="n">parse_document</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">store_page_info</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">PageInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="task-performance-and-strategies">
<span id="id45"></span><h2>性能和策略<a class="headerlink" href="#task-performance-and-strategies" title="Link to this heading">¶</a></h2>
<p>Performance and Strategies</p>
<section id="task-granularity">
<span id="id46"></span><h3>粒度<a class="headerlink" href="#task-granularity" title="Link to this heading">¶</a></h3>
<p>Granularity</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--49-input--1" name="tab-set--49" type="radio"><label class="tab-label" for="tab-set--49-input--1">中文</label><div class="tab-content docutils container">
<p>任务粒度是每个子任务所需的计算量。
通常来说，将问题拆分成许多小任务比将其拆分成少数几个长时间运行的任务要好。</p>
<p>使用较小的任务，你可以并行处理更多的任务，并且这些任务的运行时间不会长到阻塞工作进程，进而影响其它等待任务的处理。</p>
<p>然而，执行任务确实会有开销。需要发送消息，数据可能不在本地等等。所以，如果任务过于细粒度，添加的开销可能会消除任何潜在的好处。</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p>《 <a class="reference external" href="ArtofConcurrency">并发的艺术</a> 》一书专门讨论了任务粒度这一主题 <a class="reference internal" href="#aoc1" id="id48"><span>[AOC1]</span></a> 。</p>
</div>
</div>
<input class="tab-input" id="tab-set--49-input--2" name="tab-set--49" type="radio"><label class="tab-label" for="tab-set--49-input--2">英文</label><div class="tab-content docutils container">
<p>The task granularity is the amount of computation needed by each subtask.
In general it is better to split the problem up into many small tasks rather
than have a few long running tasks.</p>
<p>With smaller tasks you can process more tasks in parallel and the tasks
won't run long enough to block the worker from processing other waiting tasks.</p>
<p>However, executing a task does have overhead. A message needs to be sent, data
may not be local, etc. So if the tasks are too fine-grained the
overhead added probably removes any benefit.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p>The book <a class="reference external" href="http://oreilly.com/catalog/9780596521547">Art of Concurrency</a> has a section dedicated to the topic
of task granularity <a class="reference internal" href="#aoc1" id="id49"><span>[AOC1]</span></a>.</p>
</div>
</div>
</div>
<div role="list" class="citation-list">
<div class="citation" id="aoc1" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>AOC1<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id48">1</a>,<a role="doc-backlink" href="#id49">2</a>)</span>
<p>Breshears, Clay. Section 2.2.1, &quot;The Art of Concurrency&quot;.
O'Reilly Media, Inc. May 15, 2009. ISBN-13 978-0-596-52153-0.</p>
</div>
</div>
</section>
<section id="task-data-locality">
<span id="id50"></span><h3>数据本地性<a class="headerlink" href="#task-data-locality" title="Link to this heading">¶</a></h3>
<p>Data locality</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--50-input--1" name="tab-set--50" type="radio"><label class="tab-label" for="tab-set--50-input--1">中文</label><div class="tab-content docutils container">
<p>处理任务的工作进程应该尽可能接近数据。最好的情况是数据存在内存中，最坏的情况是需要从另一个大陆进行完全传输。</p>
<p>如果数据距离较远，可以尝试在该位置运行另一个工作进程，或者如果不可能的话，可以缓存经常使用的数据，或者预加载你知道将会使用的数据。</p>
<p>在工作进程之间共享数据的最简单方法是使用分布式缓存系统，比如 <a class="reference external" href="http://memcached.org/">memcached</a>。</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p>Jim Gray 的论文 <a class="reference external" href="DistributedComputingEconomics">分布式计算经济</a> 是关于数据本地化主题的极好介绍。</p>
</div>
</div>
<input class="tab-input" id="tab-set--50-input--2" name="tab-set--50" type="radio"><label class="tab-label" for="tab-set--50-input--2">英文</label><div class="tab-content docutils container">
<p>The worker processing the task should be as close to the data as
possible. The best would be to have a copy in memory, the worst would be a
full transfer from another continent.</p>
<p>If the data is far away, you could try to run another worker at location, or
if that's not possible - cache often used data, or preload data you know
is going to be used.</p>
<p>The easiest way to share data between workers is to use a distributed cache
system, like <a class="reference external" href="http://memcached.org/">memcached</a>.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p>The paper <a class="reference external" href="http://research.microsoft.com/pubs/70001/tr-2003-24.pdf">Distributed Computing Economics</a> by Jim Gray is an excellent
introduction to the topic of data locality.</p>
</div>
</div>
</div>
</section>
<section id="task-state">
<span id="id52"></span><h3>状态<a class="headerlink" href="#task-state" title="Link to this heading">¶</a></h3>
<p>State</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--51-input--1" name="tab-set--51" type="radio"><label class="tab-label" for="tab-set--51-input--1">中文</label><div class="tab-content docutils container">
<p>由于 Celery 是一个分布式系统，你无法知道任务将在哪个进程或机器上执行。你甚至无法知道任务是否会及时运行。</p>
<p>古老的异步格言告诉我们：“确认世界的状态是任务的责任”。这意味着，世界观可能在任务请求之后发生变化，因此任务有责任确保世界是应该有的样子；如果你有一个重新索引搜索引擎的任务，并且该搜索引擎应该每隔最多 5 分钟才重新索引一次，那么它必须由任务来确认，而不是调用者。</p>
<p>另一个问题是 Django 模型对象。它们不应该作为任务的参数传递。通常最好在任务运行时重新从数据库中获取对象，因为使用旧数据可能会导致竞争条件。</p>
<p>设想以下场景，你有一篇文章和一个任务，该任务自动扩展其中的一些缩写：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">expand_abbreviations</span><span class="p">(</span><span class="n">article</span><span class="p">):</span>
    <span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MyCorp&#39;</span><span class="p">,</span> <span class="s1">&#39;My Corporation&#39;</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>首先，一个作者创建并保存了一篇文章，然后该作者点击按钮，启动了缩写扩展任务：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">102</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</pre></div>
</div>
<p>现在，队列非常忙碌，因此任务将在 2 分钟后才执行。
与此同时，另一个作者对文章进行了修改，因此，当任务最终执行时，文章的正文被恢复到了旧版本，因为任务参数中的文章正文是旧的。</p>
<p>解决竞争条件很容易，只需改用文章的 ID，并在任务体内重新获取文章：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">expand_abbreviations</span><span class="p">(</span><span class="n">article_id</span><span class="p">):</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MyCorp&#39;</span><span class="p">,</span> <span class="s1">&#39;My Corporation&#39;</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">article_id</span><span class="p">)</span>
</pre></div>
</div>
<p>这种方法甚至可能带来性能上的好处，因为发送大消息可能非常昂贵。</p>
</div>
<input class="tab-input" id="tab-set--51-input--2" name="tab-set--51" type="radio"><label class="tab-label" for="tab-set--51-input--2">英文</label><div class="tab-content docutils container">
<p>Since Celery is a distributed system, you can't know which process, or
on what machine the task will be executed. You can't even know if the task will
run in a timely manner.</p>
<p>The ancient async sayings tells us that “asserting the world is the
responsibility of the task”. What this means is that the world view may
have changed since the task was requested, so the task is responsible for
making sure the world is how it should be;  If you have a task
that re-indexes a search engine, and the search engine should only be
re-indexed at maximum every 5 minutes, then it must be the tasks
responsibility to assert that, not the callers.</p>
<p>Another gotcha is Django model objects. They shouldn't be passed on as
arguments to tasks. It's almost always better to re-fetch the object from
the database when the task is running instead,  as using old data may lead
to race conditions.</p>
<p>Imagine the following scenario where you have an article and a task
that automatically expands some abbreviations in it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">expand_abbreviations</span><span class="p">(</span><span class="n">article</span><span class="p">):</span>
    <span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MyCorp&#39;</span><span class="p">,</span> <span class="s1">&#39;My Corporation&#39;</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>First, an author creates an article and saves it, then the author
clicks on a button that initiates the abbreviation task:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">102</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, the queue is very busy, so the task won't be run for another 2 minutes.
In the meantime another author makes changes to the article, so
when the task is finally run, the body of the article is reverted to the old
version because the task had the old body in its argument.</p>
<p>Fixing the race condition is easy, just use the article id instead, and
re-fetch the article in the task body:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">expand_abbreviations</span><span class="p">(</span><span class="n">article_id</span><span class="p">):</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">article_id</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;MyCorp&#39;</span><span class="p">,</span> <span class="s1">&#39;My Corporation&#39;</span><span class="p">)</span>
    <span class="n">article</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">article_id</span><span class="p">)</span>
</pre></div>
</div>
<p>There might even be performance benefits to this approach, as sending large
messages may be expensive.</p>
</div>
</div>
</section>
<section id="task-database-transactions">
<span id="id53"></span><h3>数据库事务<a class="headerlink" href="#task-database-transactions" title="Link to this heading">¶</a></h3>
<p>Database transactions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--52-input--1" name="tab-set--52" type="radio"><label class="tab-label" for="tab-set--52-input--1">中文</label><div class="tab-content docutils container">
<p>我们来看另一个例子：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseRedirect</span>

<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s1">&#39;/articles/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>这是一个 Django 视图，它在数据库中创建了一个文章对象，
然后将主键传递给任务。它使用了 <cite>transaction.atomic</cite> 装饰器，当视图返回时，事务会被提交，或者如果视图抛出异常，事务会被回滚。</p>
<p>这里有一个竞争条件，因为事务是原子的。这意味着文章对象在视图函数返回响应之前不会持久化到数据库。如果异步任务在事务提交之前开始执行，它可能会尝试在文章对象不存在时查询该对象。为了解决这个问题，我们需要确保在触发任务之前提交事务。</p>
<p>解决方法是使用 <a class="reference internal" href="../reference/celery.contrib.django.task.html#celery.contrib.django.task.DjangoTask.delay_on_commit" title="celery.contrib.django.task.DjangoTask.delay_on_commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">delay_on_commit()</span></code></a>：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseRedirect</span>

<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay_on_commit</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s1">&#39;/articles/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>该方法在 Celery 5.4 中添加。它是一个快捷方式，使用 Django 的 <code class="docutils literal notranslate"><span class="pre">on_commit</span></code> 回调，在所有事务成功提交后启动你的 Celery 任务。</p>
</div>
<input class="tab-input" id="tab-set--52-input--2" name="tab-set--52" type="radio"><label class="tab-label" for="tab-set--52-input--2">英文</label><div class="tab-content docutils container">
<p>Let's have a look at another example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseRedirect</span>

<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s1">&#39;/articles/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a Django view creating an article object in the database,
then passing the primary key to a task. It uses the <cite>transaction.atomic</cite>
decorator, that will commit the transaction when the view returns, or
roll back if the view raises an exception.</p>
<p>There is a race condition because transactions are atomic. This means the article object is not persisted to the database until after the view function returns a response. If the asynchronous task starts executing before the transaction is committed, it may attempt to query the article object before it exists. To prevent this, we need to ensure that the transaction is committed before triggering the task.</p>
<p>The solution is to use <a class="reference internal" href="../reference/celery.contrib.django.task.html#celery.contrib.django.task.DjangoTask.delay_on_commit" title="celery.contrib.django.task.DjangoTask.delay_on_commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">delay_on_commit()</span></code></a> instead：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseRedirect</span>

<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay_on_commit</span><span class="p">(</span><span class="n">article</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s1">&#39;/articles/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This method was added in Celery 5.4. It's a shortcut that uses Django's
<code class="docutils literal notranslate"><span class="pre">on_commit</span></code> callback to launch your Celery task once all transactions
have been committed successfully.</p>
</div>
</div>
<section id="celery-5-4">
<h4>使用 Celery 5.4 及以下版本<a class="headerlink" href="#celery-5-4" title="Link to this heading">¶</a></h4>
<p>With Celery &lt;5.4</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--53-input--1" name="tab-set--53" type="radio"><label class="tab-label" for="tab-set--53-input--1">中文</label><div class="tab-content docutils container">
<p>如果你使用的是较旧版本的 Celery，可以直接使用 Django 的回调来复制这种行为，如下所示：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseRedirect</span>

<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">on_commit</span><span class="p">(</span>
        <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">,</span> <span class="n">article</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s1">&#39;/articles/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">on_commit</span></code> 在 Django 1.9 及以上版本中可用。如果你使用的是更早版本，则可以通过 <a class="reference external" href="https://github.com/carljm/django-transaction-hooks">django-transaction-hooks</a> 库来添加对其的支持。</p>
</div>
</div>
<input class="tab-input" id="tab-set--53-input--2" name="tab-set--53" type="radio"><label class="tab-label" for="tab-set--53-input--2">英文</label><div class="tab-content docutils container">
<p>If you're using an older version of Celery, you can replicate this behaviour
using the Django callback directly as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseRedirect</span>

<span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_article</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">on_commit</span><span class="p">(</span>
        <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">expand_abbreviations</span><span class="o">.</span><span class="n">delay</span><span class="p">,</span> <span class="n">article</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s1">&#39;/articles/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><code class="docutils literal notranslate"><span class="pre">on_commit</span></code> is available in Django 1.9 and above, if you are using a
version prior to that then the <a class="reference external" href="https://github.com/carljm/django-transaction-hooks">django-transaction-hooks</a> library
adds support for this.</p>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="task-example">
<span id="id54"></span><h2>示例<a class="headerlink" href="#task-example" title="Link to this heading">¶</a></h2>
<p>Example</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--54-input--1" name="tab-set--54" type="radio"><label class="tab-label" for="tab-set--54-input--1">中文</label><div class="tab-content docutils container">
<p>让我们看一个实际的例子：一个博客，评论需要进行垃圾邮件过滤。当评论被创建时，垃圾邮件过滤器在后台运行，因此用户无需等待其完成。</p>
<p>我有一个 Django 博客应用，允许对博客文章进行评论。下面是我为这个应用描述的部分模型、视图和任务。</p>
</div>
<input class="tab-input" id="tab-set--54-input--2" name="tab-set--54" type="radio"><label class="tab-label" for="tab-set--54-input--2">英文</label><div class="tab-content docutils container">
<p>Let's take a real world example: a blog where comments posted need to be
filtered for spam. When the comment is created, the spam filter runs in the
background, so the user doesn't have to wait for it to finish.</p>
<p>I have a Django blog application allowing comments
on blog posts. I'll describe parts of the models/views and tasks for this
application.</p>
</div>
</div>
<section id="blog-models-py">
<h3><code class="docutils literal notranslate"><span class="pre">blog/models.py</span></code><a class="headerlink" href="#blog-models-py" title="Link to this heading">¶</a></h3>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--55-input--1" name="tab-set--55" type="radio"><label class="tab-label" for="tab-set--55-input--1">中文</label><div class="tab-content docutils container">
<p>评论模型如下所示：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.translation</span><span class="w"> </span><span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">email_address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;email address&#39;</span><span class="p">))</span>
    <span class="n">homepage</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;home page&#39;</span><span class="p">),</span>
                            <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verify_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">))</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Published date&#39;</span><span class="p">),</span>
                                    <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto_add_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">is_spam</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;spam?&#39;</span><span class="p">),</span>
                                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>在发表评论的视图中，我首先将评论写入数据库，然后在后台启动垃圾邮件过滤任务。</p>
</div>
<input class="tab-input" id="tab-set--55-input--2" name="tab-set--55" type="radio"><label class="tab-label" for="tab-set--55-input--2">英文</label><div class="tab-content docutils container">
<p>The comment model looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.translation</span><span class="w"> </span><span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Comment</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
    <span class="n">email_address</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;email address&#39;</span><span class="p">))</span>
    <span class="n">homepage</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;home page&#39;</span><span class="p">),</span>
                            <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verify_exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">))</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Published date&#39;</span><span class="p">),</span>
                                    <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto_add_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">is_spam</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;spam?&#39;</span><span class="p">),</span>
                                <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">verbose_name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">)</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;comments&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the view where the comment is posted, I first write the comment
to the database, then I launch the spam filter task in the background.</p>
</div>
</div>
</section>
<section id="blog-views-py">
<span id="task-example-blog-views"></span><h3><code class="docutils literal notranslate"><span class="pre">blog/views.py</span></code><a class="headerlink" href="#blog-views-py" title="Link to this heading">¶</a></h3>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--56-input--1" name="tab-set--56" type="radio"><label class="tab-label" for="tab-set--56-input--1">中文</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django</span><span class="w"> </span><span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.template.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render_to_response</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">blog</span><span class="w"> </span><span class="kn">import</span> <span class="n">tasks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">blog.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Comment</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CommentForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Comment</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_comment</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">slug</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="s1">&#39;comments/create.html&#39;</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Entry</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">slug</span><span class="p">)</span>
    <span class="n">remote_addr</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># 异步检查垃圾邮件。</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">spam_filter</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">comment_id</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="n">remote_addr</span><span class="o">=</span><span class="n">remote_addr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>为了过滤评论中的垃圾邮件，我使用了 <a class="reference external" href="http://akismet.com/faq/">Akismet</a> ，这是一个用于过滤 <cite>Wordpress</cite> 免费博客平台中发布评论的垃圾邮件服务。 <a class="reference external" href="http://akismet.com/faq/">Akismet</a> 对个人使用是免费的，但商业使用需要付费。你需要注册该服务以获得 API 密钥。</p>
<p>为了调用 <a class="reference external" href="http://akismet.com/faq/">Akismet</a> 的 API，我使用了 <a class="reference external" href="http://www.voidspace.org.uk/">Michael Foord</a> 编写的 <a class="reference external" href="http://www.voidspace.org.uk/downloads/akismet.py">akismet.py</a> 库。</p>
</div>
<input class="tab-input" id="tab-set--56-input--2" name="tab-set--56" type="radio"><label class="tab-label" for="tab-set--56-input--2">英文</label><div class="tab-content docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django</span><span class="w"> </span><span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.template.context</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render_to_response</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">blog</span><span class="w"> </span><span class="kn">import</span> <span class="n">tasks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">blog.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Comment</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CommentForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Comment</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_comment</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">slug</span><span class="p">,</span> <span class="n">template_name</span><span class="o">=</span><span class="s1">&#39;comments/create.html&#39;</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Entry</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="n">slug</span><span class="p">)</span>
    <span class="n">remote_addr</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;post&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">comment</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1"># Check spam asynchronously.</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">spam_filter</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">comment_id</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="n">remote_addr</span><span class="o">=</span><span class="n">remote_addr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">CommentForm</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>To filter spam in comments I use <a class="reference external" href="http://akismet.com/faq/">Akismet</a>, the service
used to filter spam in comments posted to the free blog platform
<cite>Wordpress</cite>. <a class="reference external" href="http://akismet.com/faq/">Akismet</a> is free for personal use, but for commercial use you
need to pay. You have to sign up to their service to get an API key.</p>
<p>To make API calls to <a class="reference external" href="http://akismet.com/faq/">Akismet</a> I use the <a class="reference external" href="http://www.voidspace.org.uk/downloads/akismet.py">akismet.py</a> library written by
<a class="reference external" href="http://www.voidspace.org.uk/">Michael Foord</a>.</p>
</div>
</div>
</section>
<section id="blog-tasks-py">
<span id="task-example-blog-tasks"></span><h3><code class="docutils literal notranslate"><span class="pre">blog/tasks.py</span></code><a class="headerlink" href="#blog-tasks-py" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">akismet</span><span class="w"> </span><span class="kn">import</span> <span class="n">Akismet</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.sites.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Site</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">blog.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Comment</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="n">broker</span><span class="o">=</span><span class="s1">&#39;amqp://&#39;</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">task</span>
<span class="k">def</span><span class="w"> </span><span class="nf">spam_filter</span><span class="p">(</span><span class="n">comment_id</span><span class="p">,</span> <span class="n">remote_addr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">spam_filter</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running spam filter for comment </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">comment_id</span><span class="p">)</span>

    <span class="n">comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">comment_id</span><span class="p">)</span>
    <span class="n">current_domain</span> <span class="o">=</span> <span class="n">Site</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_current</span><span class="p">()</span><span class="o">.</span><span class="n">domain</span>
    <span class="n">akismet</span> <span class="o">=</span> <span class="n">Akismet</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AKISMET_KEY</span><span class="p">,</span> <span class="s1">&#39;http://</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">domain</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">akismet</span><span class="o">.</span><span class="n">verify_key</span><span class="p">():</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s1">&#39;Invalid AKISMET_KEY&#39;</span><span class="p">)</span>


    <span class="n">is_spam</span> <span class="o">=</span> <span class="n">akismet</span><span class="o">.</span><span class="n">comment_check</span><span class="p">(</span><span class="n">user_ip</span><span class="o">=</span><span class="n">remote_addr</span><span class="p">,</span>
                        <span class="n">comment_content</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
                        <span class="n">comment_author</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">comment_author_email</span><span class="o">=</span><span class="n">comment</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_spam</span><span class="p">:</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">is_spam</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">comment</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">is_spam</span>
</pre></div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="calling.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">调用任务/Tasks</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="application.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">应用程序</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../copyright.html">Copyright</a> &#169; 2009-2023, Ask Solem &amp; contributors
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">任务/Tasks</a><ul>
<li><a class="reference internal" href="#task-basics">基础知识</a><ul>
<li><a class="reference internal" href="#id2">如何导入任务装饰器？</a></li>
<li><a class="reference internal" href="#id3">多个装饰器</a></li>
<li><a class="reference internal" href="#id4">绑定任务</a></li>
<li><a class="reference internal" href="#id5">任务继承</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-names">名称</a><ul>
<li><a class="reference internal" href="#task-name-generator-info">更改自动命名行为</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-request-info">任务请求</a><ul>
<li><a class="reference internal" href="#id9">示例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-logging">日志记录</a><ul>
<li><a class="reference internal" href="#task-argument-checking">参数检查</a></li>
<li><a class="reference internal" href="#task-hiding-sensitive-information">在参数中隐藏敏感信息</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-retry">重试</a><ul>
<li><a class="reference internal" href="#task-retry-custom-delay">使用自定义重试延迟</a></li>
<li><a class="reference internal" href="#task-autoretry">已知异常的自动重试</a><ul>
<li><a class="reference internal" href="#Task.autoretry_for"><code class="docutils literal notranslate"><span class="pre">Task.autoretry_for</span></code></a></li>
<li><a class="reference internal" href="#Task.max_retries"><code class="docutils literal notranslate"><span class="pre">Task.max_retries</span></code></a></li>
<li><a class="reference internal" href="#Task.retry_backoff"><code class="docutils literal notranslate"><span class="pre">Task.retry_backoff</span></code></a></li>
<li><a class="reference internal" href="#Task.retry_backoff_max"><code class="docutils literal notranslate"><span class="pre">Task.retry_backoff_max</span></code></a></li>
<li><a class="reference internal" href="#Task.retry_jitter"><code class="docutils literal notranslate"><span class="pre">Task.retry_jitter</span></code></a></li>
<li><a class="reference internal" href="#Task.dont_autoretry_for"><code class="docutils literal notranslate"><span class="pre">Task.dont_autoretry_for</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#pydantic">使用 Pydantic 进行参数验证</a><ul>
<li><a class="reference internal" href="#id17">联合类型、泛型参数</a></li>
<li><a class="reference internal" href="#id18">可选参数/返回值</a></li>
<li><a class="reference internal" href="#id19">返回值处理</a></li>
<li><a class="reference internal" href="#id20">Pydantic 参数</a><ul>
<li><a class="reference internal" href="#Task.pydantic_strict"><code class="docutils literal notranslate"><span class="pre">Task.pydantic_strict</span></code></a></li>
<li><a class="reference internal" href="#Task.pydantic_context"><code class="docutils literal notranslate"><span class="pre">Task.pydantic_context</span></code></a></li>
<li><a class="reference internal" href="#Task.pydantic_dump_kwargs"><code class="docutils literal notranslate"><span class="pre">Task.pydantic_dump_kwargs</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#task-options">选项列表</a><ul>
<li><a class="reference internal" href="#task-general-options">常规</a><ul>
<li><a class="reference internal" href="#Task.name"><code class="docutils literal notranslate"><span class="pre">Task.name</span></code></a></li>
<li><a class="reference internal" href="#Task.request"><code class="docutils literal notranslate"><span class="pre">Task.request</span></code></a></li>
<li><a class="reference internal" href="#id0"><code class="docutils literal notranslate"><span class="pre">Task.max_retries</span></code></a></li>
<li><a class="reference internal" href="#Task.throws"><code class="docutils literal notranslate"><span class="pre">Task.throws</span></code></a></li>
<li><a class="reference internal" href="#Task.default_retry_delay"><code class="docutils literal notranslate"><span class="pre">Task.default_retry_delay</span></code></a></li>
<li><a class="reference internal" href="#Task.rate_limit"><code class="docutils literal notranslate"><span class="pre">Task.rate_limit</span></code></a></li>
<li><a class="reference internal" href="#Task.time_limit"><code class="docutils literal notranslate"><span class="pre">Task.time_limit</span></code></a></li>
<li><a class="reference internal" href="#Task.soft_time_limit"><code class="docutils literal notranslate"><span class="pre">Task.soft_time_limit</span></code></a></li>
<li><a class="reference internal" href="#Task.ignore_result"><code class="docutils literal notranslate"><span class="pre">Task.ignore_result</span></code></a></li>
<li><a class="reference internal" href="#Task.store_errors_even_if_ignored"><code class="docutils literal notranslate"><span class="pre">Task.store_errors_even_if_ignored</span></code></a></li>
<li><a class="reference internal" href="#Task.serializer"><code class="docutils literal notranslate"><span class="pre">Task.serializer</span></code></a></li>
<li><a class="reference internal" href="#Task.compression"><code class="docutils literal notranslate"><span class="pre">Task.compression</span></code></a></li>
<li><a class="reference internal" href="#Task.backend"><code class="docutils literal notranslate"><span class="pre">Task.backend</span></code></a></li>
<li><a class="reference internal" href="#Task.acks_late"><code class="docutils literal notranslate"><span class="pre">Task.acks_late</span></code></a></li>
<li><a class="reference internal" href="#Task.track_started"><code class="docutils literal notranslate"><span class="pre">Task.track_started</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#task-states">状态</a><ul>
<li><a class="reference internal" href="#task-result-backends">结果后端</a><ul>
<li><a class="reference internal" href="#rpc-rabbitmq-qpid">RPC 结果后端 (RabbitMQ/QPid)</a></li>
<li><a class="reference internal" href="#id27">数据库结果后端</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-builtin-states">内置状态</a><ul>
<li><a class="reference internal" href="#pending">PENDING</a></li>
<li><a class="reference internal" href="#started">STARTED</a></li>
<li><a class="reference internal" href="#success">SUCCESS</a></li>
<li><a class="reference internal" href="#failure">FAILURE</a></li>
<li><a class="reference internal" href="#retry">RETRY</a></li>
<li><a class="reference internal" href="#revoked">REVOKED</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-states">自定义状态</a></li>
<li><a class="reference internal" href="#pickle">创建可 pickle 的异常</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-semipredicates">任务半谓词</a><ul>
<li><a class="reference internal" href="#task-semipred-ignore">忽略</a></li>
<li><a class="reference internal" href="#task-semipred-reject">拒绝</a></li>
<li><a class="reference internal" href="#task-semipred-retry">重试</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-custom-classes">自定义任务类</a><ul>
<li><a class="reference internal" href="#id36">实例化</a><ul>
<li><a class="reference internal" href="#id37">每个任务的使用</a></li>
<li><a class="reference internal" href="#app">App范围的使用</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id38">处理程序</a><ul>
<li><a class="reference internal" href="#before_start"><code class="docutils literal notranslate"><span class="pre">before_start()</span></code></a></li>
<li><a class="reference internal" href="#after_return"><code class="docutils literal notranslate"><span class="pre">after_return()</span></code></a></li>
<li><a class="reference internal" href="#on_failure"><code class="docutils literal notranslate"><span class="pre">on_failure()</span></code></a></li>
<li><a class="reference internal" href="#on_retry"><code class="docutils literal notranslate"><span class="pre">on_retry()</span></code></a></li>
<li><a class="reference internal" href="#on_success"><code class="docutils literal notranslate"><span class="pre">on_success()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-requests-and-custom-requests">请求和自定义请求</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-how-they-work">工作原理</a></li>
<li><a class="reference internal" href="#task-best-practices">技巧和最佳实践</a><ul>
<li><a class="reference internal" href="#task-ignore-results">忽略不需要的结果</a></li>
<li><a class="reference internal" href="#id43">更多优化技巧</a></li>
<li><a class="reference internal" href="#task-synchronous-subtasks">避免启动同步子任务</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-performance-and-strategies">性能和策略</a><ul>
<li><a class="reference internal" href="#task-granularity">粒度</a></li>
<li><a class="reference internal" href="#task-data-locality">数据本地性</a></li>
<li><a class="reference internal" href="#task-state">状态</a></li>
<li><a class="reference internal" href="#task-database-transactions">数据库事务</a><ul>
<li><a class="reference internal" href="#celery-5-4">使用 Celery 5.4 及以下版本</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#task-example">示例</a><ul>
<li><a class="reference internal" href="#blog-models-py"><code class="docutils literal notranslate"><span class="pre">blog/models.py</span></code></a></li>
<li><a class="reference internal" href="#blog-views-py"><code class="docutils literal notranslate"><span class="pre">blog/views.py</span></code></a></li>
<li><a class="reference internal" href="#blog-tasks-py"><code class="docutils literal notranslate"><span class="pre">blog/tasks.py</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=8156d91f"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3ee01567"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=5eb1bb1e"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    </body>
</html>